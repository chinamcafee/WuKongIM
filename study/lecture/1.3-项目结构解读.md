# 1.3 项目结构解读

> **学习目标**：深入理解 WuKongIM 的代码组织结构，掌握各个目录的职责，为后续源码学习打好基础。

---

## 📊 项目整体概览

WuKongIM 采用 **Go 语言标准项目布局**，代码总量约 **105,000 行**：

```
WuKongIM/
├── internal/          28,458 行（业务逻辑）
├── pkg/               76,538 行（核心包）
└── cmd/                  442 行（命令行）
─────────────────────────────────────
总计：                 ~105,438 行 Go 代码
```

---

## 🗂️ 根目录结构全景

```
WuKongIM/
├── 📁 核心源码目录
│   ├── cmd/                  # 命令行入口（4 个文件）
│   ├── internal/             # 内部业务逻辑（127 个文件）
│   ├── pkg/                  # 可复用核心包（368 个文件）
│   └── main.go               # 程序入口
│
├── 📁 配置与部署
│   ├── config/               # 配置文件模板
│   ├── exampleconfig/        # 集群配置示例
│   ├── docker/               # Docker 部署资源
│   ├── Dockerfile            # 镜像构建文件
│   └── docker-compose.yaml   # 容器编排
│
├── 📁 前端与演示
│   ├── web/                  # 管理后台前端（Vue.js）
│   └── demo/                 # 聊天 Demo（React）
│
├── 📁 文档与测试
│   ├── docs/                 # 文档、架构图
│   ├── test/                 # E2E 测试
│   └── README.md             # 项目说明文档
│
└── 📁 其他
    ├── version/              # 版本信息
    ├── study/                # 学习笔记（自定义）
    ├── go.mod                # Go 依赖管理
    └── wukongim              # 编译后的可执行文件
```

---

## 🎯 核心目录详解

### 1️⃣ `/cmd` - 命令行接口层

**职责**：处理命令行参数、启动/停止服务、配置解析

| 文件 | 代码行数 | 作用 |
|------|---------|------|
| **root.go** | 307 | 根命令定义、配置加载、Cobra CLI 框架集成 |
| **run.go** | 13 | 启动命令实现 |
| **stop.go** | 771 | 停止命令实现（守护进程管理） |
| **common.go** | 129 | 公共工具函数 |

**关键代码**：`cmd/root.go:42-50`

```go
rootCmd = &cobra.Command{
    Use:   "wk",
    Short: "WuKongIM, a sleek and high-performance instant messaging platform.",
    RunE: func(cmd *cobra.Command, args []string) error {
        return cmdRun()  // ← 调用启动逻辑
    },
}
```

**使用的框架**：
- **Cobra** - CLI 框架（Docker、Kubernetes 同款）
- **Viper** - 配置管理（支持 YAML、JSON、环境变量）

**启动流程**：
```
./wukongim
  ↓
main.go:48 → cmd.Execute()
  ↓
root.go:49 → cmdRun()
  ↓
server.New() & server.Start()
```

---

### 2️⃣ `/internal` - 业务逻辑核心

**职责**：所有业务逻辑实现，遵循 Go 语言 `internal` 包约定（不对外暴露）

#### **目录结构**（28,458 行代码）

```
internal/
├── 🔥 核心服务层
│   ├── server/                 (12 个文件 - 服务器主体)
│   │   ├── server.go          # Server 结构体，协调所有组件
│   │   ├── datasource.go      # 数据源接口
│   │   ├── proto.go           # 协议处理
│   │   └── server_cluster.go  # 集群模式
│   │
│   ├── api/                    (25 个文件 - HTTP API)
│   │   ├── api.go             # API 服务器
│   │   ├── message.go         # 消息相关接口
│   │   ├── channel.go         # 频道相关接口
│   │   ├── conversation.go    # 会话相关接口
│   │   └── user.go            # 用户相关接口
│   │
│   ├── eventbus/               (9 个文件 - 事件总线 ⭐⭐⭐)
│   │   ├── eventbus.go        # 事件路由核心
│   │   ├── event.go           # 事件类型定义
│   │   ├── user.go            # 用户事件
│   │   ├── channel.go         # 频道事件
│   │   └── pusher.go          # 推送事件
│   │
│   └── options/                (5 个文件 - 配置管理)
│       ├── options.go         # 配置结构体
│       └── common.go          # FakeChannelID 生成 ⭐
│
├── 🎪 业务处理层
│   ├── user/                   (用户连接管理)
│   │   ├── handler/           # 用户事件处理器
│   │   │   ├── base.go        # Handler 基类
│   │   │   ├── event_connect.go      # 连接事件
│   │   │   ├── event_onsend.go       # 发送事件
│   │   │   └── event_connclose.go    # 断开事件
│   │   └── event/             # 用户事件池
│   │       └── event_pool.go  # 事件池实现
│   │
│   ├── channel/                (频道消息处理)
│   │   ├── handler/           # 频道事件处理器
│   │   │   ├── base.go
│   │   │   ├── event_onsend.go       # 频道消息发送
│   │   │   └── event_distribute.go   # 消息分发
│   │   └── event/             # 频道事件池
│   │
│   ├── pusher/                 (消息推送)
│   │   ├── handler/           # 推送处理器
│   │   │   ├── base.go
│   │   │   └── event_pushonline.go   # 在线推送
│   │   └── event/             # 推送事件池
│   │
│   └── manager/                (各种管理器)
│       ├── manager_conversation.go   # 会话管理器
│       ├── manager_retry.go          # 重试管理器
│       ├── manager_tag.go            # 标签管理器（订阅者）
│       └── manager_conn.go           # 连接管理器
│
├── 🔌 扩展与集成
│   ├── webhook/                (Webhook 回调)
│   │   └── webhook.go
│   │
│   ├── plugin/                 (插件系统)
│   │   ├── server.go          # 插件服务器
│   │   └── manager.go         # 插件管理
│   │
│   └── ingress/                (集群内部 RPC)
│       ├── ingress.go
│       └── client.go
│
└── 🛠️ 基础设施
    ├── service/                (公共服务)
    │   ├── service.go         # 服务注册中心
    │   └── permission.go      # 权限验证
    │
    ├── types/                  (类型定义)
    │   ├── message.go
    │   ├── webhook.go
    │   └── plugin.go
    │
    ├── common/                 (通用工具)
    │   └── common.go          # Tag 获取、Stream 处理
    │
    ├── errors/                 (错误定义)
    │   └── errors.go
    │
    └── track/                  (追踪统计)
        └── track.go
```

---

#### **🔥 核心组件详解**

##### **A. Server 结构体**（`internal/server/server.go:50-88`）

```go
type Server struct {
    // ==================== 基础设施 ====================
    opts          *options.Options   // 配置选项
    ctx           context.Context    // 上下文
    cancel        context.CancelFunc // 取消函数
    start         time.Time          // 启动时间
    Log           wklog.Log          // 日志器

    // ==================== 核心引擎 ====================
    engine        *wknet.Engine      // 🔥 网络引擎（Reactor 模式）
    store         *store.Store       // 💾 存储引擎（WuKongDB）
    clusterServer *cluster.Server    // 🌐 集群服务（分布式）

    // ==================== 三大事件池 ⭐⭐⭐ ====================
    // 用户事件池
    userHandler   *userhandler.Handler
    userEventPool *userevent.EventPool

    // 频道事件池
    channelHandler   *channelhandler.Handler
    channelEventPool *channelevent.EventPool

    // 推送事件池
    pushHandler   *pusherhandler.Handler
    pushEventPool *pusherevent.EventPool

    // ==================== 管理器 ====================
    retryManager        *manager.RetryManager        // 🔄 消息重试
    conversationManager *manager.ConversationManager // 💬 会话管理
    tagManager          *manager.TagManager          // 🏷️ 订阅者标签

    // ==================== 扩展组件 ====================
    apiServer    *api.Server        // 🌐 HTTP API 服务器
    webhook      *webhook.Webhook   // 🪝 Webhook 回调
    pluginServer *plugin.Server     // 🧩 插件服务器
    trace        *trace.Trace       // 📊 监控追踪
    datasource   IDatasource        // 📡 数据源接口
    ingress      *ingress.Ingress   // 🚪 集群内部 RPC
    streamCache  *wkcache.StreamCache // 📝 流式消息缓存

    // ==================== 其他 ====================
    demoServer   *DemoServer        # Demo 服务器
    commonService *common.Service   # 通用服务
}
```

**职责分工**：
1. **协调者**：统筹所有组件的生命周期
2. **事件分发**：将网络事件分发到对应的事件池
3. **资源管理**：管理连接、会话、标签等资源

---

##### **B. EventBus - 事件总线**（`internal/eventbus/` ⭐⭐⭐）

**设计模式**：**发布-订阅模式 + 责任链模式**

**核心代码**：`internal/eventbus/eventbus.go`

```go
// 三大事件路由表
var userEventRouteMap = make(map[EventType][]UserHandlerFunc)
var channelEventRouteMap = make(map[EventType][]ChannelHandlerFunc)
var pusherEventRouteMap = make(map[EventType][]PusherHandlerFunc)

// 注册事件处理器
func RegisterUserHandlers(eventType EventType, handlers ...UserHandlerFunc) {
    userEventRouteMap[eventType] = handlers
}

// 执行事件处理链
func ExecuteUserEvent(ctx *UserContext) {
    handlers, ok := userEventRouteMap[ctx.EventType]
    if !ok {
        return
    }
    for _, handler := range handlers {
        handler(ctx)  // 依次执行处理器
    }
}
```

**三大事件池**：

```
┌─────────────────────────────────────────────────────────────┐
│                        EventBus                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌───────────────────┐   ┌───────────────────┐   ┌────────────────┐
│  │  UserEventPool    │   │ ChannelEventPool  │   │ PusherEventPool│
│  ├───────────────────┤   ├───────────────────┤   ├────────────────┤
│  │                   │   │                   │   │                │
│  │ • EventConnect    │   │ • EventOnSend     │   │ • EventPush    │
│  │ • EventConnack    │   │ • EventDistribute │   │   Online       │
│  │ • EventOnSend     │   │ • EventWebhook    │   │ • EventPush    │
│  │ • EventConnWrite  │   │ • EventOnStream   │   │   Offline      │
│  │ • EventConnClose  │   │                   │   │                │
│  │                   │   │                   │   │                │
│  └───────────────────┘   └───────────────────┘   └────────────────┘
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**消息流转示例**：

```
客户端发送消息
    ↓
wknet.Engine 接收数据
    ↓
解析为 SEND Frame
    ↓
eventbus.User.AddEvent(EventOnSend)
    ↓
UserEventPool 处理
    ↓
转发到 ChannelEventPool
    ↓
ChannelHandler.onSend()
    ├─ 权限检查
    ├─ Webhook 回调
    ├─ Raft 共识
    └─ 存储持久化
    ↓
eventbus.Channel.AddEvent(EventDistribute)
    ↓
PusherEventPool 处理
    ↓
推送给订阅者
```

---

##### **C. 业务处理层结构**

**三层处理架构**：

```
┌────────────────────────────────────────────────────────┐
│              用户层（User Layer）                       │
│  处理：连接、认证、用户消息接收                          │
├────────────────────────────────────────────────────────┤
│  internal/user/
│    ├── handler/
│    │   ├── event_connect.go      # 连接建立
│    │   ├── event_connack.go      # 连接确认
│    │   ├── event_onsend.go       # 消息发送
│    │   └── event_connclose.go    # 连接关闭
│    └── event/
│        └── event_pool.go         # 用户事件池
└────────────────────────────────────────────────────────┘
                        ↓
┌────────────────────────────────────────────────────────┐
│             频道层（Channel Layer）                     │
│  处理：频道消息、权限、存储、分发                        │
├────────────────────────────────────────────────────────┤
│  internal/channel/
│    ├── handler/
│    │   ├── event_onsend.go       # 频道消息处理
│    │   ├── event_distribute.go   # 消息分发
│    │   └── event_webhook.go      # Webhook 回调
│    └── event/
│        └── event_pool.go         # 频道事件池
└────────────────────────────────────────────────────────┘
                        ↓
┌────────────────────────────────────────────────────────┐
│             推送层（Pusher Layer）                      │
│  处理：在线推送、离线存储                                │
├────────────────────────────────────────────────────────┤
│  internal/pusher/
│    ├── handler/
│    │   ├── event_pushonline.go   # 在线推送
│    │   └── event_pushoffline.go  # 离线存储
│    └── event/
│        └── event_pool.go         # 推送事件池
└────────────────────────────────────────────────────────┘
```

---

##### **D. API 层**（`internal/api/` - 25 个文件）

**职责**：提供 HTTP RESTful API

| 文件 | 作用 |
|------|------|
| **api.go** | API 服务器主体、路由注册 |
| **message.go** | 消息发送接口 `/message/send` |
| **channel.go** | 频道管理接口 |
| **conversation.go** | 会话同步接口 `/channel/messagesync` |
| **user.go** | 用户管理接口 |
| **webhook.go** | Webhook 配置接口 |

**路由结构**：

```
/v1
├── /message
│   ├── POST /send           # 发送消息
│   └── GET  /sync           # 同步消息
├── /channel
│   ├── POST /create         # 创建频道
│   ├── GET  /info           # 获取频道信息
│   └── POST /messagesync    # 消息同步 ⭐
├── /conversation
│   ├── GET  /sync           # 同步会话列表
│   └── POST /clear          # 清空会话
├── /user
│   ├── GET  /online         # 在线用户
│   └── POST /kick           # 踢出用户
└── /varz                     # 服务器状态 ⭐
```

---

##### **E. Manager 层**（`internal/manager/` - 8 个文件）

**职责**：各种资源管理器

| 管理器 | 文件 | 作用 |
|-------|------|------|
| **ConversationManager** | manager_conversation.go | 最近会话管理 |
| **RetryManager** | manager_retry.go | 消息重试队列 |
| **TagManager** | manager_tag.go | 订阅者标签管理（用于消息分发） |
| **ConnManager** | manager_conn.go | 连接管理 |
| **SystemAccountManager** | manager_systemaccount.go | 系统账号管理 |

---

### 3️⃣ `/pkg` - 可复用核心包

**职责**：提供底层能力，可被其他项目复用

#### **目录结构**（76,538 行代码，368 个文件）

```
pkg/
├── 🌐 网络层
│   ├── wknet/              # 网络引擎（Reactor 模式）⭐⭐⭐
│   │   ├── engine.go       # Engine 主体
│   │   ├── reactor_main.go # 主 Reactor
│   │   ├── reactor_sub.go  # 子 Reactor
│   │   ├── conn.go         # 连接封装
│   │   └── poller_*.go     # 多平台 Poller（epoll/kqueue）
│   │
│   ├── network/            # 网络工具
│   ├── wkhttp/             # HTTP 工具
│   └── jsonrpc/            # JSON-RPC 支持
│
├── 💾 存储层
│   ├── wkdb/               # 自研存储引擎 ⭐⭐⭐
│   │   ├── wukongdb.go     # WuKongDB 主体
│   │   ├── message.go      # 消息存储
│   │   ├── channel.go      # 频道存储
│   │   ├── conversation.go # 会话存储
│   │   ├── subscriber.go   # 订阅者存储
│   │   └── shard.go        # 分片实现
│   │
│   └── wkcache/            # 缓存层
│       └── stream.go       # 流式消息缓存
│
├── 🌍 分布式层
│   ├── cluster/            # 集群服务 ⭐⭐⭐
│   │   ├── cluster/        # Node 层（ConfigServer）
│   │   ├── slot/           # Slot 层（SlotServer）
│   │   └── channel/        # Channel 层（ChannelServer）
│   │
│   ├── raft/               # Raft 共识算法 ⭐⭐⭐
│   │   ├── raft/           # Raft 核心
│   │   ├── raftgroup/      # Raft 组管理
│   │   └── types/          # 类型定义
│   │
│   └── wkserver/           # 集群 RPC
│
├── 🔧 基础工具
│   ├── wklog/              # 日志系统
│   ├── wkutil/             # 通用工具
│   ├── auth/               # 认证
│   ├── client/             # 客户端 SDK
│   ├── trace/              # 监控追踪
│   └── wkhook/             # Hook 系统
│
└── 🚀 性能优化
    ├── pool/               # 对象池
    ├── bytequeue/          # 字节队列
    ├── fasthash/           # 快速哈希
    ├── fasttime/           # 快速时间
    ├── ring/               # 环形缓冲区
    ├── keylock/            # 分段锁
    └── wait/               # 等待队列
```

---

#### **🔥 核心包详解**

##### **A. wknet - 网络引擎**（`pkg/wknet/` ⭐⭐⭐）

**设计模式**：**Reactor 模式**（高性能网络 I/O）

**架构**：

```
┌─────────────────────────────────────────────────────────┐
│                      wknet.Engine                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │          ReactorMain（主 Reactor）                │  │
│  │  职责：Accept 新连接 → 分发到 SubReactor        │  │
│  └──────────────────────────────────────────────────┘  │
│                          ↓                              │
│  ┌──────────────────────────────────────────────────┐  │
│  │         ReactorSub[]（子 Reactor 数组）           │  │
│  │  职责：处理连接的读写事件                         │  │
│  ├──────────────────────────────────────────────────┤  │
│  │  SubReactor 1  │  SubReactor 2  │ ... │  Sub N   │  │
│  │  ├─ Poller     │  ├─ Poller     │     │          │  │
│  │  ├─ ConnMatrix │  ├─ ConnMatrix │     │          │  │
│  │  └─ TimingWheel│  └─ TimingWheel│     │          │  │
│  └──────────────────────────────────────────────────┘  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

**关键特性**：
- **Epoll/Kqueue**：高效 I/O 多路复用
- **负载均衡**：新连接轮询分配到子 Reactor
- **TimingWheel**：O(1) 超时管理
- **零拷贝**：减少内存拷贝

**文件列表**：

| 文件 | 作用 |
|------|------|
| `engine.go` | Engine 主体 |
| `reactor_main.go` | 主 Reactor（Accept） |
| `reactor_sub.go` | 子 Reactor（I/O 处理） |
| `poller_epoll_linux.go` | Linux epoll 实现 |
| `poller_kqueue_bsd.go` | macOS/BSD kqueue 实现 |
| `conn.go` | 连接封装 |
| `conn_matrix.go` | 连接矩阵（快速查找） |

---

##### **B. wkdb - 存储引擎**（`pkg/wkdb/` ⭐⭐⭐）

**架构**：自研分布式 KV 数据库，基于 **PebbleDB**（LSM-Tree）

```
┌───────────────────────────────────────────────────────┐
│                    WuKongDB                           │
├───────────────────────────────────────────────────────┤
│                                                       │
│  ┌─────────────────────────────────────────────┐    │
│  │         Shard[]（多个分片）                  │    │
│  ├─────────────────────────────────────────────┤    │
│  │  Shard 0   │  Shard 1   │ ... │  Shard 15  │    │
│  │  PebbleDB  │  PebbleDB  │     │  PebbleDB  │    │
│  └─────────────────────────────────────────────┘    │
│                      ↑                                │
│                      │ Hash 分片                      │
│                      │                                │
│  ┌─────────────────────────────────────────────┐    │
│  │            BatchDB（批量优化）               │    │
│  │  聚合多个写入 → 批量提交                     │    │
│  └─────────────────────────────────────────────┘    │
│                      ↑                                │
│  ┌─────────────────────────────────────────────┐    │
│  │          Cache Layer（缓存层）               │    │
│  │  ChannelCache | ConversationCache | etc.    │    │
│  └─────────────────────────────────────────────┘    │
│                                                       │
└───────────────────────────────────────────────────────┘
```

**数据模型**：

| 表 | 文件 | 存储内容 |
|----|------|---------|
| **Message** | message.go | 消息数据 |
| **Channel** | channel.go | 频道配置 |
| **Conversation** | conversation.go | 最近会话 |
| **Subscriber** | subscriber.go | 订阅关系 |
| **User** | user.go | 用户数据 |
| **Device** | device.go | 设备信息 |
| **StreamV2** | stream.go | 流式消息 |

**关键特性**：
- **分片**：默认 16 个分片，并行处理
- **批量写入**：聚合写操作，提升吞吐
- **LSM-Tree**：写入优化，适合 IM 场景
- **多级缓存**：减少磁盘 I/O

---

##### **C. cluster - 集群服务**（`pkg/cluster/` ⭐⭐⭐）

**三层架构**：

```
┌─────────────────────────────────────────────────────┐
│       第一层：Node Raft（ConfigServer）              │
│  管理：集群节点、槽位分配                             │
│  Raft 组数：1 个（全局）                             │
├─────────────────────────────────────────────────────┤
│  cluster/cluster/server.go                          │
└─────────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────┐
│       第二层：Slot Raft（SlotServer）                │
│  管理：频道配置、用户数据、会话元数据                 │
│  Raft 组数：1024 个（默认）                          │
├─────────────────────────────────────────────────────┤
│  cluster/slot/server.go                             │
└─────────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────┐
│      第三层：Channel Raft（ChannelServer）           │
│  管理：消息日志                                       │
│  Raft 组数：动态创建（每个活跃频道一个）              │
├─────────────────────────────────────────────────────┤
│  cluster/channel/server.go                          │
└─────────────────────────────────────────────────────┘
```

---

##### **D. raft - 改进版 Raft**（`pkg/raft/` ⭐⭐⭐）

**创新点**：**Pull 模式 Raft**

```
传统 Push 模式：
  Leader ─[push logs]→ Follower

WuKongIM Pull 模式：
  Leader ─[notify]→ Follower
  Follower ─[request logs]→ Leader
  Leader ─[respond logs]→ Follower
```

**目录结构**：

```
raft/
├── raft/              # Raft 核心实现
│   ├── raft.go       # Raft 状态机
│   ├── node.go       # 节点管理
│   └── log.go        # 日志复制
├── raftgroup/         # Raft 组管理
│   └── group.go      # 动态创建/销毁 Raft 组
└── types/            # 类型定义
    └── types.go      # Event、Message 等
```

---

### 4️⃣ 其他目录

#### **`/config` - 配置文件**

```
config/
└── wk.yaml           # 默认配置模板
```

#### **`/exampleconfig` - 集群配置示例**

```
exampleconfig/
├── cluster1.yaml     # 节点 1 配置
├── cluster2.yaml     # 节点 2 配置
└── cluster3.yaml     # 节点 3 配置
```

#### **`/web` - 管理后台**

```
web/
├── src/              # Vue.js 源码
├── dist/             # 编译后的静态资源（嵌入到 Go 二进制）
└── package.json
```

#### **`/demo` - 聊天 Demo**

```
demo/
├── chatdemo/         # React 聊天 Demo
│   ├── src/
│   ├── dist/        # 编译后的静态资源（嵌入）
│   └── package.json
```

---

## 🎯 代码组织原则

### 1. **Internal 包原则**

Go 语言的 `internal` 包有特殊语义：
- **不可被外部导入**：只能被同一模块内的代码使用
- **隐藏实现细节**：强制封装

**示例**：
```go
// ✅ 正确：internal 包内互相导入
import "github.com/WuKongIM/WuKongIM/internal/server"

// ❌ 错误：外部项目无法导入
import "github.com/WuKongIM/WuKongIM/internal/server"
// 编译错误：use of internal package not allowed
```

---

### 2. **Pkg 包设计**

- **可复用**：设计为独立的库
- **无业务逻辑**：只提供通用能力
- **可独立测试**

**设计理念**：
```
pkg/wknet    → 可以被其他 IM 项目使用
pkg/wkdb     → 可以被其他需要 KV 存储的项目使用
pkg/raft     → 可以被其他需要共识的项目使用
```

---

### 3. **分层架构**

```
┌─────────────────────────────────────────┐
│          cmd/（命令行层）                │
├─────────────────────────────────────────┤
│       internal/（业务逻辑层）            │
│  ├─ server（服务器）                     │
│  ├─ api（HTTP API）                     │
│  ├─ eventbus（事件总线）                │
│  └─ user/channel/pusher（业务处理）     │
├─────────────────────────────────────────┤
│         pkg/（基础能力层）               │
│  ├─ wknet（网络）                        │
│  ├─ wkdb（存储）                         │
│  ├─ cluster（集群）                      │
│  └─ raft（共识）                         │
└─────────────────────────────────────────┘
```

**依赖关系**：
- `cmd` → `internal` → `pkg`
- **单向依赖**，避免循环引用

---

## 📊 代码统计

### **各层代码量占比**

| 层级 | 文件数 | 代码行数 | 占比 |
|------|--------|---------|------|
| **pkg/** | 368 | 76,538 | 72.6% |
| **internal/** | 127 | 28,458 | 27.0% |
| **cmd/** | 4 | 442 | 0.4% |
| **总计** | 499 | **105,438** | 100% |

### **核心包代码量**

| 包 | 代码行数 | 占比 |
|----|---------|------|
| **wkdb** | ~25,000 | 32.7% |
| **cluster** | ~15,000 | 19.6% |
| **wknet** | ~8,000 | 10.5% |
| **raft** | ~6,000 | 7.8% |
| **其他** | ~22,538 | 29.4% |

---

## 🎓 学习路径建议

### **新手路径**（自顶向下）

```
1. main.go               # 入口
   ↓
2. cmd/root.go           # 命令行
   ↓
3. internal/server/      # 服务器主体
   ↓
4. internal/eventbus/    # 事件总线（核心！）
   ↓
5. pkg/wknet/            # 网络层
   ↓
6. pkg/wkdb/             # 存储层
   ↓
7. pkg/cluster/          # 分布式层
```

### **进阶路径**（自底向上）

```
1. pkg/wknet/            # 网络基础
   ↓
2. pkg/wkdb/             # 存储基础
   ↓
3. pkg/raft/             # 共识基础
   ↓
4. pkg/cluster/          # 集群架构
   ↓
5. internal/eventbus/    # 事件驱动
   ↓
6. internal/user/channel/pusher/  # 业务逻辑
```

---

## 💡 关键设计亮点

### 1. **事件驱动架构**
- **解耦**：各层通过事件通信
- **异步**：事件池异步处理
- **可扩展**：容易添加新事件类型

### 2. **Reactor 网络模型**
- **高并发**：单线程事件循环
- **高性能**：Epoll/Kqueue
- **低延迟**：无锁设计

### 3. **三层 Raft 架构**
- **职责分离**：不同数据不同 Raft 组
- **动态扩展**：按需创建 Raft 组
- **故障隔离**：局部故障不影响全局

### 4. **自研存储引擎**
- **场景优化**：针对 IM 特性设计
- **高性能**：分片 + 批量 + 缓存
- **可靠性**：LSM-Tree + Raft

---

## 📚 相关文档

- **第二章**：服务启动流程（详细解析启动链路）
- **第三章**：Reactor 网络模型（深入 wknet）
- **第五章**：EventBus 事件总线（事件驱动核心）
- **第七章**：WuKongDB 存储引擎（存储层详解）
- **第九章~第十四章**：分布式架构（集群、Raft、分片）

---

## 📝 本节要点

✅ WuKongIM 采用标准 Go 项目布局
✅ `/internal` 存放业务逻辑（不对外暴露）
✅ `/pkg` 存放可复用核心包
✅ 三大核心：wknet（网络）、wkdb（存储）、cluster（集群）
✅ 事件驱动架构是核心设计模式
✅ 代码总量约 10 万行，结构清晰、职责分明

---

**🎉 恭喜！你已经掌握了 WuKongIM 的整体项目结构！**

下一节我们将深入 **第二章：服务启动流程**，追踪从 `main.go` 到服务完全启动的完整链路。
