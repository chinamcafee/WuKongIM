# 1.3 é¡¹ç›®ç»“æ„è§£è¯»

> **å­¦ä¹ ç›®æ ‡**ï¼šæ·±å…¥ç†è§£ WuKongIM çš„ä»£ç ç»„ç»‡ç»“æ„ï¼ŒæŒæ¡å„ä¸ªç›®å½•çš„èŒè´£ï¼Œä¸ºåç»­æºç å­¦ä¹ æ‰“å¥½åŸºç¡€ã€‚

---

## ğŸ“Š é¡¹ç›®æ•´ä½“æ¦‚è§ˆ

WuKongIM é‡‡ç”¨ **Go è¯­è¨€æ ‡å‡†é¡¹ç›®å¸ƒå±€**ï¼Œä»£ç æ€»é‡çº¦ **105,000 è¡Œ**ï¼š

```
WuKongIM/
â”œâ”€â”€ internal/          28,458 è¡Œï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
â”œâ”€â”€ pkg/               76,538 è¡Œï¼ˆæ ¸å¿ƒåŒ…ï¼‰
â””â”€â”€ cmd/                  442 è¡Œï¼ˆå‘½ä»¤è¡Œï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡ï¼š                 ~105,438 è¡Œ Go ä»£ç 
```

---

## ğŸ—‚ï¸ æ ¹ç›®å½•ç»“æ„å…¨æ™¯

```
WuKongIM/
â”œâ”€â”€ ğŸ“ æ ¸å¿ƒæºç ç›®å½•
â”‚   â”œâ”€â”€ cmd/                  # å‘½ä»¤è¡Œå…¥å£ï¼ˆ4 ä¸ªæ–‡ä»¶ï¼‰
â”‚   â”œâ”€â”€ internal/             # å†…éƒ¨ä¸šåŠ¡é€»è¾‘ï¼ˆ127 ä¸ªæ–‡ä»¶ï¼‰
â”‚   â”œâ”€â”€ pkg/                  # å¯å¤ç”¨æ ¸å¿ƒåŒ…ï¼ˆ368 ä¸ªæ–‡ä»¶ï¼‰
â”‚   â””â”€â”€ main.go               # ç¨‹åºå…¥å£
â”‚
â”œâ”€â”€ ğŸ“ é…ç½®ä¸éƒ¨ç½²
â”‚   â”œâ”€â”€ config/               # é…ç½®æ–‡ä»¶æ¨¡æ¿
â”‚   â”œâ”€â”€ exampleconfig/        # é›†ç¾¤é…ç½®ç¤ºä¾‹
â”‚   â”œâ”€â”€ docker/               # Docker éƒ¨ç½²èµ„æº
â”‚   â”œâ”€â”€ Dockerfile            # é•œåƒæ„å»ºæ–‡ä»¶
â”‚   â””â”€â”€ docker-compose.yaml   # å®¹å™¨ç¼–æ’
â”‚
â”œâ”€â”€ ğŸ“ å‰ç«¯ä¸æ¼”ç¤º
â”‚   â”œâ”€â”€ web/                  # ç®¡ç†åå°å‰ç«¯ï¼ˆVue.jsï¼‰
â”‚   â””â”€â”€ demo/                 # èŠå¤© Demoï¼ˆReactï¼‰
â”‚
â”œâ”€â”€ ğŸ“ æ–‡æ¡£ä¸æµ‹è¯•
â”‚   â”œâ”€â”€ docs/                 # æ–‡æ¡£ã€æ¶æ„å›¾
â”‚   â”œâ”€â”€ test/                 # E2E æµ‹è¯•
â”‚   â””â”€â”€ README.md             # é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”‚
â””â”€â”€ ğŸ“ å…¶ä»–
    â”œâ”€â”€ version/              # ç‰ˆæœ¬ä¿¡æ¯
    â”œâ”€â”€ study/                # å­¦ä¹ ç¬”è®°ï¼ˆè‡ªå®šä¹‰ï¼‰
    â”œâ”€â”€ go.mod                # Go ä¾èµ–ç®¡ç†
    â””â”€â”€ wukongim              # ç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶
```

---

## ğŸ¯ æ ¸å¿ƒç›®å½•è¯¦è§£

### 1ï¸âƒ£ `/cmd` - å‘½ä»¤è¡Œæ¥å£å±‚

**èŒè´£**ï¼šå¤„ç†å‘½ä»¤è¡Œå‚æ•°ã€å¯åŠ¨/åœæ­¢æœåŠ¡ã€é…ç½®è§£æ

| æ–‡ä»¶ | ä»£ç è¡Œæ•° | ä½œç”¨ |
|------|---------|------|
| **root.go** | 307 | æ ¹å‘½ä»¤å®šä¹‰ã€é…ç½®åŠ è½½ã€Cobra CLI æ¡†æ¶é›†æˆ |
| **run.go** | 13 | å¯åŠ¨å‘½ä»¤å®ç° |
| **stop.go** | 771 | åœæ­¢å‘½ä»¤å®ç°ï¼ˆå®ˆæŠ¤è¿›ç¨‹ç®¡ç†ï¼‰ |
| **common.go** | 129 | å…¬å…±å·¥å…·å‡½æ•° |

**å…³é”®ä»£ç **ï¼š`cmd/root.go:42-50`

```go
rootCmd = &cobra.Command{
    Use:   "wk",
    Short: "WuKongIM, a sleek and high-performance instant messaging platform.",
    RunE: func(cmd *cobra.Command, args []string) error {
        return cmdRun()  // â† è°ƒç”¨å¯åŠ¨é€»è¾‘
    },
}
```

**ä½¿ç”¨çš„æ¡†æ¶**ï¼š
- **Cobra** - CLI æ¡†æ¶ï¼ˆDockerã€Kubernetes åŒæ¬¾ï¼‰
- **Viper** - é…ç½®ç®¡ç†ï¼ˆæ”¯æŒ YAMLã€JSONã€ç¯å¢ƒå˜é‡ï¼‰

**å¯åŠ¨æµç¨‹**ï¼š
```
./wukongim
  â†“
main.go:48 â†’ cmd.Execute()
  â†“
root.go:49 â†’ cmdRun()
  â†“
server.New() & server.Start()
```

---

### 2ï¸âƒ£ `/internal` - ä¸šåŠ¡é€»è¾‘æ ¸å¿ƒ

**èŒè´£**ï¼šæ‰€æœ‰ä¸šåŠ¡é€»è¾‘å®ç°ï¼Œéµå¾ª Go è¯­è¨€ `internal` åŒ…çº¦å®šï¼ˆä¸å¯¹å¤–æš´éœ²ï¼‰

#### **ç›®å½•ç»“æ„**ï¼ˆ28,458 è¡Œä»£ç ï¼‰

```
internal/
â”œâ”€â”€ ğŸ”¥ æ ¸å¿ƒæœåŠ¡å±‚
â”‚   â”œâ”€â”€ server/                 (12 ä¸ªæ–‡ä»¶ - æœåŠ¡å™¨ä¸»ä½“)
â”‚   â”‚   â”œâ”€â”€ server.go          # Server ç»“æ„ä½“ï¼Œåè°ƒæ‰€æœ‰ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ datasource.go      # æ•°æ®æºæ¥å£
â”‚   â”‚   â”œâ”€â”€ proto.go           # åè®®å¤„ç†
â”‚   â”‚   â””â”€â”€ server_cluster.go  # é›†ç¾¤æ¨¡å¼
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                    (25 ä¸ªæ–‡ä»¶ - HTTP API)
â”‚   â”‚   â”œâ”€â”€ api.go             # API æœåŠ¡å™¨
â”‚   â”‚   â”œâ”€â”€ message.go         # æ¶ˆæ¯ç›¸å…³æ¥å£
â”‚   â”‚   â”œâ”€â”€ channel.go         # é¢‘é“ç›¸å…³æ¥å£
â”‚   â”‚   â”œâ”€â”€ conversation.go    # ä¼šè¯ç›¸å…³æ¥å£
â”‚   â”‚   â””â”€â”€ user.go            # ç”¨æˆ·ç›¸å…³æ¥å£
â”‚   â”‚
â”‚   â”œâ”€â”€ eventbus/               (9 ä¸ªæ–‡ä»¶ - äº‹ä»¶æ€»çº¿ â­â­â­)
â”‚   â”‚   â”œâ”€â”€ eventbus.go        # äº‹ä»¶è·¯ç”±æ ¸å¿ƒ
â”‚   â”‚   â”œâ”€â”€ event.go           # äº‹ä»¶ç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ user.go            # ç”¨æˆ·äº‹ä»¶
â”‚   â”‚   â”œâ”€â”€ channel.go         # é¢‘é“äº‹ä»¶
â”‚   â”‚   â””â”€â”€ pusher.go          # æ¨é€äº‹ä»¶
â”‚   â”‚
â”‚   â””â”€â”€ options/                (5 ä¸ªæ–‡ä»¶ - é…ç½®ç®¡ç†)
â”‚       â”œâ”€â”€ options.go         # é…ç½®ç»“æ„ä½“
â”‚       â””â”€â”€ common.go          # FakeChannelID ç”Ÿæˆ â­
â”‚
â”œâ”€â”€ ğŸª ä¸šåŠ¡å¤„ç†å±‚
â”‚   â”œâ”€â”€ user/                   (ç”¨æˆ·è¿æ¥ç®¡ç†)
â”‚   â”‚   â”œâ”€â”€ handler/           # ç”¨æˆ·äº‹ä»¶å¤„ç†å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ base.go        # Handler åŸºç±»
â”‚   â”‚   â”‚   â”œâ”€â”€ event_connect.go      # è¿æ¥äº‹ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ event_onsend.go       # å‘é€äº‹ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ event_connclose.go    # æ–­å¼€äº‹ä»¶
â”‚   â”‚   â””â”€â”€ event/             # ç”¨æˆ·äº‹ä»¶æ± 
â”‚   â”‚       â””â”€â”€ event_pool.go  # äº‹ä»¶æ± å®ç°
â”‚   â”‚
â”‚   â”œâ”€â”€ channel/                (é¢‘é“æ¶ˆæ¯å¤„ç†)
â”‚   â”‚   â”œâ”€â”€ handler/           # é¢‘é“äº‹ä»¶å¤„ç†å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ base.go
â”‚   â”‚   â”‚   â”œâ”€â”€ event_onsend.go       # é¢‘é“æ¶ˆæ¯å‘é€
â”‚   â”‚   â”‚   â””â”€â”€ event_distribute.go   # æ¶ˆæ¯åˆ†å‘
â”‚   â”‚   â””â”€â”€ event/             # é¢‘é“äº‹ä»¶æ± 
â”‚   â”‚
â”‚   â”œâ”€â”€ pusher/                 (æ¶ˆæ¯æ¨é€)
â”‚   â”‚   â”œâ”€â”€ handler/           # æ¨é€å¤„ç†å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ base.go
â”‚   â”‚   â”‚   â””â”€â”€ event_pushonline.go   # åœ¨çº¿æ¨é€
â”‚   â”‚   â””â”€â”€ event/             # æ¨é€äº‹ä»¶æ± 
â”‚   â”‚
â”‚   â””â”€â”€ manager/                (å„ç§ç®¡ç†å™¨)
â”‚       â”œâ”€â”€ manager_conversation.go   # ä¼šè¯ç®¡ç†å™¨
â”‚       â”œâ”€â”€ manager_retry.go          # é‡è¯•ç®¡ç†å™¨
â”‚       â”œâ”€â”€ manager_tag.go            # æ ‡ç­¾ç®¡ç†å™¨ï¼ˆè®¢é˜…è€…ï¼‰
â”‚       â””â”€â”€ manager_conn.go           # è¿æ¥ç®¡ç†å™¨
â”‚
â”œâ”€â”€ ğŸ”Œ æ‰©å±•ä¸é›†æˆ
â”‚   â”œâ”€â”€ webhook/                (Webhook å›è°ƒ)
â”‚   â”‚   â””â”€â”€ webhook.go
â”‚   â”‚
â”‚   â”œâ”€â”€ plugin/                 (æ’ä»¶ç³»ç»Ÿ)
â”‚   â”‚   â”œâ”€â”€ server.go          # æ’ä»¶æœåŠ¡å™¨
â”‚   â”‚   â””â”€â”€ manager.go         # æ’ä»¶ç®¡ç†
â”‚   â”‚
â”‚   â””â”€â”€ ingress/                (é›†ç¾¤å†…éƒ¨ RPC)
â”‚       â”œâ”€â”€ ingress.go
â”‚       â””â”€â”€ client.go
â”‚
â””â”€â”€ ğŸ› ï¸ åŸºç¡€è®¾æ–½
    â”œâ”€â”€ service/                (å…¬å…±æœåŠ¡)
    â”‚   â”œâ”€â”€ service.go         # æœåŠ¡æ³¨å†Œä¸­å¿ƒ
    â”‚   â””â”€â”€ permission.go      # æƒé™éªŒè¯
    â”‚
    â”œâ”€â”€ types/                  (ç±»å‹å®šä¹‰)
    â”‚   â”œâ”€â”€ message.go
    â”‚   â”œâ”€â”€ webhook.go
    â”‚   â””â”€â”€ plugin.go
    â”‚
    â”œâ”€â”€ common/                 (é€šç”¨å·¥å…·)
    â”‚   â””â”€â”€ common.go          # Tag è·å–ã€Stream å¤„ç†
    â”‚
    â”œâ”€â”€ errors/                 (é”™è¯¯å®šä¹‰)
    â”‚   â””â”€â”€ errors.go
    â”‚
    â””â”€â”€ track/                  (è¿½è¸ªç»Ÿè®¡)
        â””â”€â”€ track.go
```

---

#### **ğŸ”¥ æ ¸å¿ƒç»„ä»¶è¯¦è§£**

##### **A. Server ç»“æ„ä½“**ï¼ˆ`internal/server/server.go:50-88`ï¼‰

```go
type Server struct {
    // ==================== åŸºç¡€è®¾æ–½ ====================
    opts          *options.Options   // é…ç½®é€‰é¡¹
    ctx           context.Context    // ä¸Šä¸‹æ–‡
    cancel        context.CancelFunc // å–æ¶ˆå‡½æ•°
    start         time.Time          // å¯åŠ¨æ—¶é—´
    Log           wklog.Log          // æ—¥å¿—å™¨

    // ==================== æ ¸å¿ƒå¼•æ“ ====================
    engine        *wknet.Engine      // ğŸ”¥ ç½‘ç»œå¼•æ“ï¼ˆReactor æ¨¡å¼ï¼‰
    store         *store.Store       // ğŸ’¾ å­˜å‚¨å¼•æ“ï¼ˆWuKongDBï¼‰
    clusterServer *cluster.Server    // ğŸŒ é›†ç¾¤æœåŠ¡ï¼ˆåˆ†å¸ƒå¼ï¼‰

    // ==================== ä¸‰å¤§äº‹ä»¶æ±  â­â­â­ ====================
    // ç”¨æˆ·äº‹ä»¶æ± 
    userHandler   *userhandler.Handler
    userEventPool *userevent.EventPool

    // é¢‘é“äº‹ä»¶æ± 
    channelHandler   *channelhandler.Handler
    channelEventPool *channelevent.EventPool

    // æ¨é€äº‹ä»¶æ± 
    pushHandler   *pusherhandler.Handler
    pushEventPool *pusherevent.EventPool

    // ==================== ç®¡ç†å™¨ ====================
    retryManager        *manager.RetryManager        // ğŸ”„ æ¶ˆæ¯é‡è¯•
    conversationManager *manager.ConversationManager // ğŸ’¬ ä¼šè¯ç®¡ç†
    tagManager          *manager.TagManager          // ğŸ·ï¸ è®¢é˜…è€…æ ‡ç­¾

    // ==================== æ‰©å±•ç»„ä»¶ ====================
    apiServer    *api.Server        // ğŸŒ HTTP API æœåŠ¡å™¨
    webhook      *webhook.Webhook   // ğŸª Webhook å›è°ƒ
    pluginServer *plugin.Server     // ğŸ§© æ’ä»¶æœåŠ¡å™¨
    trace        *trace.Trace       // ğŸ“Š ç›‘æ§è¿½è¸ª
    datasource   IDatasource        // ğŸ“¡ æ•°æ®æºæ¥å£
    ingress      *ingress.Ingress   // ğŸšª é›†ç¾¤å†…éƒ¨ RPC
    streamCache  *wkcache.StreamCache // ğŸ“ æµå¼æ¶ˆæ¯ç¼“å­˜

    // ==================== å…¶ä»– ====================
    demoServer   *DemoServer        # Demo æœåŠ¡å™¨
    commonService *common.Service   # é€šç”¨æœåŠ¡
}
```

**èŒè´£åˆ†å·¥**ï¼š
1. **åè°ƒè€…**ï¼šç»Ÿç­¹æ‰€æœ‰ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸ
2. **äº‹ä»¶åˆ†å‘**ï¼šå°†ç½‘ç»œäº‹ä»¶åˆ†å‘åˆ°å¯¹åº”çš„äº‹ä»¶æ± 
3. **èµ„æºç®¡ç†**ï¼šç®¡ç†è¿æ¥ã€ä¼šè¯ã€æ ‡ç­¾ç­‰èµ„æº

---

##### **B. EventBus - äº‹ä»¶æ€»çº¿**ï¼ˆ`internal/eventbus/` â­â­â­ï¼‰

**è®¾è®¡æ¨¡å¼**ï¼š**å‘å¸ƒ-è®¢é˜…æ¨¡å¼ + è´£ä»»é“¾æ¨¡å¼**

**æ ¸å¿ƒä»£ç **ï¼š`internal/eventbus/eventbus.go`

```go
// ä¸‰å¤§äº‹ä»¶è·¯ç”±è¡¨
var userEventRouteMap = make(map[EventType][]UserHandlerFunc)
var channelEventRouteMap = make(map[EventType][]ChannelHandlerFunc)
var pusherEventRouteMap = make(map[EventType][]PusherHandlerFunc)

// æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
func RegisterUserHandlers(eventType EventType, handlers ...UserHandlerFunc) {
    userEventRouteMap[eventType] = handlers
}

// æ‰§è¡Œäº‹ä»¶å¤„ç†é“¾
func ExecuteUserEvent(ctx *UserContext) {
    handlers, ok := userEventRouteMap[ctx.EventType]
    if !ok {
        return
    }
    for _, handler := range handlers {
        handler(ctx)  // ä¾æ¬¡æ‰§è¡Œå¤„ç†å™¨
    }
}
```

**ä¸‰å¤§äº‹ä»¶æ± **ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        EventBus                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  UserEventPool    â”‚   â”‚ ChannelEventPool  â”‚   â”‚ PusherEventPoolâ”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”‚                   â”‚   â”‚                   â”‚   â”‚                â”‚
â”‚  â”‚ â€¢ EventConnect    â”‚   â”‚ â€¢ EventOnSend     â”‚   â”‚ â€¢ EventPush    â”‚
â”‚  â”‚ â€¢ EventConnack    â”‚   â”‚ â€¢ EventDistribute â”‚   â”‚   Online       â”‚
â”‚  â”‚ â€¢ EventOnSend     â”‚   â”‚ â€¢ EventWebhook    â”‚   â”‚ â€¢ EventPush    â”‚
â”‚  â”‚ â€¢ EventConnWrite  â”‚   â”‚ â€¢ EventOnStream   â”‚   â”‚   Offline      â”‚
â”‚  â”‚ â€¢ EventConnClose  â”‚   â”‚                   â”‚   â”‚                â”‚
â”‚  â”‚                   â”‚   â”‚                   â”‚   â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ¶ˆæ¯æµè½¬ç¤ºä¾‹**ï¼š

```
å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯
    â†“
wknet.Engine æ¥æ”¶æ•°æ®
    â†“
è§£æä¸º SEND Frame
    â†“
eventbus.User.AddEvent(EventOnSend)
    â†“
UserEventPool å¤„ç†
    â†“
è½¬å‘åˆ° ChannelEventPool
    â†“
ChannelHandler.onSend()
    â”œâ”€ æƒé™æ£€æŸ¥
    â”œâ”€ Webhook å›è°ƒ
    â”œâ”€ Raft å…±è¯†
    â””â”€ å­˜å‚¨æŒä¹…åŒ–
    â†“
eventbus.Channel.AddEvent(EventDistribute)
    â†“
PusherEventPool å¤„ç†
    â†“
æ¨é€ç»™è®¢é˜…è€…
```

---

##### **C. ä¸šåŠ¡å¤„ç†å±‚ç»“æ„**

**ä¸‰å±‚å¤„ç†æ¶æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç”¨æˆ·å±‚ï¼ˆUser Layerï¼‰                       â”‚
â”‚  å¤„ç†ï¼šè¿æ¥ã€è®¤è¯ã€ç”¨æˆ·æ¶ˆæ¯æ¥æ”¶                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  internal/user/
â”‚    â”œâ”€â”€ handler/
â”‚    â”‚   â”œâ”€â”€ event_connect.go      # è¿æ¥å»ºç«‹
â”‚    â”‚   â”œâ”€â”€ event_connack.go      # è¿æ¥ç¡®è®¤
â”‚    â”‚   â”œâ”€â”€ event_onsend.go       # æ¶ˆæ¯å‘é€
â”‚    â”‚   â””â”€â”€ event_connclose.go    # è¿æ¥å…³é—­
â”‚    â””â”€â”€ event/
â”‚        â””â”€â”€ event_pool.go         # ç”¨æˆ·äº‹ä»¶æ± 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             é¢‘é“å±‚ï¼ˆChannel Layerï¼‰                     â”‚
â”‚  å¤„ç†ï¼šé¢‘é“æ¶ˆæ¯ã€æƒé™ã€å­˜å‚¨ã€åˆ†å‘                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  internal/channel/
â”‚    â”œâ”€â”€ handler/
â”‚    â”‚   â”œâ”€â”€ event_onsend.go       # é¢‘é“æ¶ˆæ¯å¤„ç†
â”‚    â”‚   â”œâ”€â”€ event_distribute.go   # æ¶ˆæ¯åˆ†å‘
â”‚    â”‚   â””â”€â”€ event_webhook.go      # Webhook å›è°ƒ
â”‚    â””â”€â”€ event/
â”‚        â””â”€â”€ event_pool.go         # é¢‘é“äº‹ä»¶æ± 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             æ¨é€å±‚ï¼ˆPusher Layerï¼‰                      â”‚
â”‚  å¤„ç†ï¼šåœ¨çº¿æ¨é€ã€ç¦»çº¿å­˜å‚¨                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  internal/pusher/
â”‚    â”œâ”€â”€ handler/
â”‚    â”‚   â”œâ”€â”€ event_pushonline.go   # åœ¨çº¿æ¨é€
â”‚    â”‚   â””â”€â”€ event_pushoffline.go  # ç¦»çº¿å­˜å‚¨
â”‚    â””â”€â”€ event/
â”‚        â””â”€â”€ event_pool.go         # æ¨é€äº‹ä»¶æ± 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

##### **D. API å±‚**ï¼ˆ`internal/api/` - 25 ä¸ªæ–‡ä»¶ï¼‰

**èŒè´£**ï¼šæä¾› HTTP RESTful API

| æ–‡ä»¶ | ä½œç”¨ |
|------|------|
| **api.go** | API æœåŠ¡å™¨ä¸»ä½“ã€è·¯ç”±æ³¨å†Œ |
| **message.go** | æ¶ˆæ¯å‘é€æ¥å£ `/message/send` |
| **channel.go** | é¢‘é“ç®¡ç†æ¥å£ |
| **conversation.go** | ä¼šè¯åŒæ­¥æ¥å£ `/channel/messagesync` |
| **user.go** | ç”¨æˆ·ç®¡ç†æ¥å£ |
| **webhook.go** | Webhook é…ç½®æ¥å£ |

**è·¯ç”±ç»“æ„**ï¼š

```
/v1
â”œâ”€â”€ /message
â”‚   â”œâ”€â”€ POST /send           # å‘é€æ¶ˆæ¯
â”‚   â””â”€â”€ GET  /sync           # åŒæ­¥æ¶ˆæ¯
â”œâ”€â”€ /channel
â”‚   â”œâ”€â”€ POST /create         # åˆ›å»ºé¢‘é“
â”‚   â”œâ”€â”€ GET  /info           # è·å–é¢‘é“ä¿¡æ¯
â”‚   â””â”€â”€ POST /messagesync    # æ¶ˆæ¯åŒæ­¥ â­
â”œâ”€â”€ /conversation
â”‚   â”œâ”€â”€ GET  /sync           # åŒæ­¥ä¼šè¯åˆ—è¡¨
â”‚   â””â”€â”€ POST /clear          # æ¸…ç©ºä¼šè¯
â”œâ”€â”€ /user
â”‚   â”œâ”€â”€ GET  /online         # åœ¨çº¿ç”¨æˆ·
â”‚   â””â”€â”€ POST /kick           # è¸¢å‡ºç”¨æˆ·
â””â”€â”€ /varz                     # æœåŠ¡å™¨çŠ¶æ€ â­
```

---

##### **E. Manager å±‚**ï¼ˆ`internal/manager/` - 8 ä¸ªæ–‡ä»¶ï¼‰

**èŒè´£**ï¼šå„ç§èµ„æºç®¡ç†å™¨

| ç®¡ç†å™¨ | æ–‡ä»¶ | ä½œç”¨ |
|-------|------|------|
| **ConversationManager** | manager_conversation.go | æœ€è¿‘ä¼šè¯ç®¡ç† |
| **RetryManager** | manager_retry.go | æ¶ˆæ¯é‡è¯•é˜Ÿåˆ— |
| **TagManager** | manager_tag.go | è®¢é˜…è€…æ ‡ç­¾ç®¡ç†ï¼ˆç”¨äºæ¶ˆæ¯åˆ†å‘ï¼‰ |
| **ConnManager** | manager_conn.go | è¿æ¥ç®¡ç† |
| **SystemAccountManager** | manager_systemaccount.go | ç³»ç»Ÿè´¦å·ç®¡ç† |

---

### 3ï¸âƒ£ `/pkg` - å¯å¤ç”¨æ ¸å¿ƒåŒ…

**èŒè´£**ï¼šæä¾›åº•å±‚èƒ½åŠ›ï¼Œå¯è¢«å…¶ä»–é¡¹ç›®å¤ç”¨

#### **ç›®å½•ç»“æ„**ï¼ˆ76,538 è¡Œä»£ç ï¼Œ368 ä¸ªæ–‡ä»¶ï¼‰

```
pkg/
â”œâ”€â”€ ğŸŒ ç½‘ç»œå±‚
â”‚   â”œâ”€â”€ wknet/              # ç½‘ç»œå¼•æ“ï¼ˆReactor æ¨¡å¼ï¼‰â­â­â­
â”‚   â”‚   â”œâ”€â”€ engine.go       # Engine ä¸»ä½“
â”‚   â”‚   â”œâ”€â”€ reactor_main.go # ä¸» Reactor
â”‚   â”‚   â”œâ”€â”€ reactor_sub.go  # å­ Reactor
â”‚   â”‚   â”œâ”€â”€ conn.go         # è¿æ¥å°è£…
â”‚   â”‚   â””â”€â”€ poller_*.go     # å¤šå¹³å° Pollerï¼ˆepoll/kqueueï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ network/            # ç½‘ç»œå·¥å…·
â”‚   â”œâ”€â”€ wkhttp/             # HTTP å·¥å…·
â”‚   â””â”€â”€ jsonrpc/            # JSON-RPC æ”¯æŒ
â”‚
â”œâ”€â”€ ğŸ’¾ å­˜å‚¨å±‚
â”‚   â”œâ”€â”€ wkdb/               # è‡ªç ”å­˜å‚¨å¼•æ“ â­â­â­
â”‚   â”‚   â”œâ”€â”€ wukongdb.go     # WuKongDB ä¸»ä½“
â”‚   â”‚   â”œâ”€â”€ message.go      # æ¶ˆæ¯å­˜å‚¨
â”‚   â”‚   â”œâ”€â”€ channel.go      # é¢‘é“å­˜å‚¨
â”‚   â”‚   â”œâ”€â”€ conversation.go # ä¼šè¯å­˜å‚¨
â”‚   â”‚   â”œâ”€â”€ subscriber.go   # è®¢é˜…è€…å­˜å‚¨
â”‚   â”‚   â””â”€â”€ shard.go        # åˆ†ç‰‡å®ç°
â”‚   â”‚
â”‚   â””â”€â”€ wkcache/            # ç¼“å­˜å±‚
â”‚       â””â”€â”€ stream.go       # æµå¼æ¶ˆæ¯ç¼“å­˜
â”‚
â”œâ”€â”€ ğŸŒ åˆ†å¸ƒå¼å±‚
â”‚   â”œâ”€â”€ cluster/            # é›†ç¾¤æœåŠ¡ â­â­â­
â”‚   â”‚   â”œâ”€â”€ cluster/        # Node å±‚ï¼ˆConfigServerï¼‰
â”‚   â”‚   â”œâ”€â”€ slot/           # Slot å±‚ï¼ˆSlotServerï¼‰
â”‚   â”‚   â””â”€â”€ channel/        # Channel å±‚ï¼ˆChannelServerï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ raft/               # Raft å…±è¯†ç®—æ³• â­â­â­
â”‚   â”‚   â”œâ”€â”€ raft/           # Raft æ ¸å¿ƒ
â”‚   â”‚   â”œâ”€â”€ raftgroup/      # Raft ç»„ç®¡ç†
â”‚   â”‚   â””â”€â”€ types/          # ç±»å‹å®šä¹‰
â”‚   â”‚
â”‚   â””â”€â”€ wkserver/           # é›†ç¾¤ RPC
â”‚
â”œâ”€â”€ ğŸ”§ åŸºç¡€å·¥å…·
â”‚   â”œâ”€â”€ wklog/              # æ—¥å¿—ç³»ç»Ÿ
â”‚   â”œâ”€â”€ wkutil/             # é€šç”¨å·¥å…·
â”‚   â”œâ”€â”€ auth/               # è®¤è¯
â”‚   â”œâ”€â”€ client/             # å®¢æˆ·ç«¯ SDK
â”‚   â”œâ”€â”€ trace/              # ç›‘æ§è¿½è¸ª
â”‚   â””â”€â”€ wkhook/             # Hook ç³»ç»Ÿ
â”‚
â””â”€â”€ ğŸš€ æ€§èƒ½ä¼˜åŒ–
    â”œâ”€â”€ pool/               # å¯¹è±¡æ± 
    â”œâ”€â”€ bytequeue/          # å­—èŠ‚é˜Ÿåˆ—
    â”œâ”€â”€ fasthash/           # å¿«é€Ÿå“ˆå¸Œ
    â”œâ”€â”€ fasttime/           # å¿«é€Ÿæ—¶é—´
    â”œâ”€â”€ ring/               # ç¯å½¢ç¼“å†²åŒº
    â”œâ”€â”€ keylock/            # åˆ†æ®µé”
    â””â”€â”€ wait/               # ç­‰å¾…é˜Ÿåˆ—
```

---

#### **ğŸ”¥ æ ¸å¿ƒåŒ…è¯¦è§£**

##### **A. wknet - ç½‘ç»œå¼•æ“**ï¼ˆ`pkg/wknet/` â­â­â­ï¼‰

**è®¾è®¡æ¨¡å¼**ï¼š**Reactor æ¨¡å¼**ï¼ˆé«˜æ€§èƒ½ç½‘ç»œ I/Oï¼‰

**æ¶æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      wknet.Engine                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          ReactorMainï¼ˆä¸» Reactorï¼‰                â”‚  â”‚
â”‚  â”‚  èŒè´£ï¼šAccept æ–°è¿æ¥ â†’ åˆ†å‘åˆ° SubReactor        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†“                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         ReactorSub[]ï¼ˆå­ Reactor æ•°ç»„ï¼‰           â”‚  â”‚
â”‚  â”‚  èŒè´£ï¼šå¤„ç†è¿æ¥çš„è¯»å†™äº‹ä»¶                         â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  SubReactor 1  â”‚  SubReactor 2  â”‚ ... â”‚  Sub N   â”‚  â”‚
â”‚  â”‚  â”œâ”€ Poller     â”‚  â”œâ”€ Poller     â”‚     â”‚          â”‚  â”‚
â”‚  â”‚  â”œâ”€ ConnMatrix â”‚  â”œâ”€ ConnMatrix â”‚     â”‚          â”‚  â”‚
â”‚  â”‚  â””â”€ TimingWheelâ”‚  â””â”€ TimingWheelâ”‚     â”‚          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‰¹æ€§**ï¼š
- **Epoll/Kqueue**ï¼šé«˜æ•ˆ I/O å¤šè·¯å¤ç”¨
- **è´Ÿè½½å‡è¡¡**ï¼šæ–°è¿æ¥è½®è¯¢åˆ†é…åˆ°å­ Reactor
- **TimingWheel**ï¼šO(1) è¶…æ—¶ç®¡ç†
- **é›¶æ‹·è´**ï¼šå‡å°‘å†…å­˜æ‹·è´

**æ–‡ä»¶åˆ—è¡¨**ï¼š

| æ–‡ä»¶ | ä½œç”¨ |
|------|------|
| `engine.go` | Engine ä¸»ä½“ |
| `reactor_main.go` | ä¸» Reactorï¼ˆAcceptï¼‰ |
| `reactor_sub.go` | å­ Reactorï¼ˆI/O å¤„ç†ï¼‰ |
| `poller_epoll_linux.go` | Linux epoll å®ç° |
| `poller_kqueue_bsd.go` | macOS/BSD kqueue å®ç° |
| `conn.go` | è¿æ¥å°è£… |
| `conn_matrix.go` | è¿æ¥çŸ©é˜µï¼ˆå¿«é€ŸæŸ¥æ‰¾ï¼‰ |

---

##### **B. wkdb - å­˜å‚¨å¼•æ“**ï¼ˆ`pkg/wkdb/` â­â­â­ï¼‰

**æ¶æ„**ï¼šè‡ªç ”åˆ†å¸ƒå¼ KV æ•°æ®åº“ï¼ŒåŸºäº **PebbleDB**ï¼ˆLSM-Treeï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WuKongDB                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚         Shard[]ï¼ˆå¤šä¸ªåˆ†ç‰‡ï¼‰                  â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚  Shard 0   â”‚  Shard 1   â”‚ ... â”‚  Shard 15  â”‚    â”‚
â”‚  â”‚  PebbleDB  â”‚  PebbleDB  â”‚     â”‚  PebbleDB  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                      â†‘                                â”‚
â”‚                      â”‚ Hash åˆ†ç‰‡                      â”‚
â”‚                      â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚            BatchDBï¼ˆæ‰¹é‡ä¼˜åŒ–ï¼‰               â”‚    â”‚
â”‚  â”‚  èšåˆå¤šä¸ªå†™å…¥ â†’ æ‰¹é‡æäº¤                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                      â†‘                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚          Cache Layerï¼ˆç¼“å­˜å±‚ï¼‰               â”‚    â”‚
â”‚  â”‚  ChannelCache | ConversationCache | etc.    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°æ®æ¨¡å‹**ï¼š

| è¡¨ | æ–‡ä»¶ | å­˜å‚¨å†…å®¹ |
|----|------|---------|
| **Message** | message.go | æ¶ˆæ¯æ•°æ® |
| **Channel** | channel.go | é¢‘é“é…ç½® |
| **Conversation** | conversation.go | æœ€è¿‘ä¼šè¯ |
| **Subscriber** | subscriber.go | è®¢é˜…å…³ç³» |
| **User** | user.go | ç”¨æˆ·æ•°æ® |
| **Device** | device.go | è®¾å¤‡ä¿¡æ¯ |
| **StreamV2** | stream.go | æµå¼æ¶ˆæ¯ |

**å…³é”®ç‰¹æ€§**ï¼š
- **åˆ†ç‰‡**ï¼šé»˜è®¤ 16 ä¸ªåˆ†ç‰‡ï¼Œå¹¶è¡Œå¤„ç†
- **æ‰¹é‡å†™å…¥**ï¼šèšåˆå†™æ“ä½œï¼Œæå‡åå
- **LSM-Tree**ï¼šå†™å…¥ä¼˜åŒ–ï¼Œé€‚åˆ IM åœºæ™¯
- **å¤šçº§ç¼“å­˜**ï¼šå‡å°‘ç£ç›˜ I/O

---

##### **C. cluster - é›†ç¾¤æœåŠ¡**ï¼ˆ`pkg/cluster/` â­â­â­ï¼‰

**ä¸‰å±‚æ¶æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       ç¬¬ä¸€å±‚ï¼šNode Raftï¼ˆConfigServerï¼‰              â”‚
â”‚  ç®¡ç†ï¼šé›†ç¾¤èŠ‚ç‚¹ã€æ§½ä½åˆ†é…                             â”‚
â”‚  Raft ç»„æ•°ï¼š1 ä¸ªï¼ˆå…¨å±€ï¼‰                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  cluster/cluster/server.go                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       ç¬¬äºŒå±‚ï¼šSlot Raftï¼ˆSlotServerï¼‰                â”‚
â”‚  ç®¡ç†ï¼šé¢‘é“é…ç½®ã€ç”¨æˆ·æ•°æ®ã€ä¼šè¯å…ƒæ•°æ®                 â”‚
â”‚  Raft ç»„æ•°ï¼š1024 ä¸ªï¼ˆé»˜è®¤ï¼‰                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  cluster/slot/server.go                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ç¬¬ä¸‰å±‚ï¼šChannel Raftï¼ˆChannelServerï¼‰           â”‚
â”‚  ç®¡ç†ï¼šæ¶ˆæ¯æ—¥å¿—                                       â”‚
â”‚  Raft ç»„æ•°ï¼šåŠ¨æ€åˆ›å»ºï¼ˆæ¯ä¸ªæ´»è·ƒé¢‘é“ä¸€ä¸ªï¼‰              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  cluster/channel/server.go                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

##### **D. raft - æ”¹è¿›ç‰ˆ Raft**ï¼ˆ`pkg/raft/` â­â­â­ï¼‰

**åˆ›æ–°ç‚¹**ï¼š**Pull æ¨¡å¼ Raft**

```
ä¼ ç»Ÿ Push æ¨¡å¼ï¼š
  Leader â”€[push logs]â†’ Follower

WuKongIM Pull æ¨¡å¼ï¼š
  Leader â”€[notify]â†’ Follower
  Follower â”€[request logs]â†’ Leader
  Leader â”€[respond logs]â†’ Follower
```

**ç›®å½•ç»“æ„**ï¼š

```
raft/
â”œâ”€â”€ raft/              # Raft æ ¸å¿ƒå®ç°
â”‚   â”œâ”€â”€ raft.go       # Raft çŠ¶æ€æœº
â”‚   â”œâ”€â”€ node.go       # èŠ‚ç‚¹ç®¡ç†
â”‚   â””â”€â”€ log.go        # æ—¥å¿—å¤åˆ¶
â”œâ”€â”€ raftgroup/         # Raft ç»„ç®¡ç†
â”‚   â””â”€â”€ group.go      # åŠ¨æ€åˆ›å»º/é”€æ¯ Raft ç»„
â””â”€â”€ types/            # ç±»å‹å®šä¹‰
    â””â”€â”€ types.go      # Eventã€Message ç­‰
```

---

### 4ï¸âƒ£ å…¶ä»–ç›®å½•

#### **`/config` - é…ç½®æ–‡ä»¶**

```
config/
â””â”€â”€ wk.yaml           # é»˜è®¤é…ç½®æ¨¡æ¿
```

#### **`/exampleconfig` - é›†ç¾¤é…ç½®ç¤ºä¾‹**

```
exampleconfig/
â”œâ”€â”€ cluster1.yaml     # èŠ‚ç‚¹ 1 é…ç½®
â”œâ”€â”€ cluster2.yaml     # èŠ‚ç‚¹ 2 é…ç½®
â””â”€â”€ cluster3.yaml     # èŠ‚ç‚¹ 3 é…ç½®
```

#### **`/web` - ç®¡ç†åå°**

```
web/
â”œâ”€â”€ src/              # Vue.js æºç 
â”œâ”€â”€ dist/             # ç¼–è¯‘åçš„é™æ€èµ„æºï¼ˆåµŒå…¥åˆ° Go äºŒè¿›åˆ¶ï¼‰
â””â”€â”€ package.json
```

#### **`/demo` - èŠå¤© Demo**

```
demo/
â”œâ”€â”€ chatdemo/         # React èŠå¤© Demo
â”‚   â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ dist/        # ç¼–è¯‘åçš„é™æ€èµ„æºï¼ˆåµŒå…¥ï¼‰
â”‚   â””â”€â”€ package.json
```

---

## ğŸ¯ ä»£ç ç»„ç»‡åŸåˆ™

### 1. **Internal åŒ…åŸåˆ™**

Go è¯­è¨€çš„ `internal` åŒ…æœ‰ç‰¹æ®Šè¯­ä¹‰ï¼š
- **ä¸å¯è¢«å¤–éƒ¨å¯¼å…¥**ï¼šåªèƒ½è¢«åŒä¸€æ¨¡å—å†…çš„ä»£ç ä½¿ç”¨
- **éšè—å®ç°ç»†èŠ‚**ï¼šå¼ºåˆ¶å°è£…

**ç¤ºä¾‹**ï¼š
```go
// âœ… æ­£ç¡®ï¼šinternal åŒ…å†…äº’ç›¸å¯¼å…¥
import "github.com/WuKongIM/WuKongIM/internal/server"

// âŒ é”™è¯¯ï¼šå¤–éƒ¨é¡¹ç›®æ— æ³•å¯¼å…¥
import "github.com/WuKongIM/WuKongIM/internal/server"
// ç¼–è¯‘é”™è¯¯ï¼šuse of internal package not allowed
```

---

### 2. **Pkg åŒ…è®¾è®¡**

- **å¯å¤ç”¨**ï¼šè®¾è®¡ä¸ºç‹¬ç«‹çš„åº“
- **æ— ä¸šåŠ¡é€»è¾‘**ï¼šåªæä¾›é€šç”¨èƒ½åŠ›
- **å¯ç‹¬ç«‹æµ‹è¯•**

**è®¾è®¡ç†å¿µ**ï¼š
```
pkg/wknet    â†’ å¯ä»¥è¢«å…¶ä»– IM é¡¹ç›®ä½¿ç”¨
pkg/wkdb     â†’ å¯ä»¥è¢«å…¶ä»–éœ€è¦ KV å­˜å‚¨çš„é¡¹ç›®ä½¿ç”¨
pkg/raft     â†’ å¯ä»¥è¢«å…¶ä»–éœ€è¦å…±è¯†çš„é¡¹ç›®ä½¿ç”¨
```

---

### 3. **åˆ†å±‚æ¶æ„**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          cmd/ï¼ˆå‘½ä»¤è¡Œå±‚ï¼‰                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       internal/ï¼ˆä¸šåŠ¡é€»è¾‘å±‚ï¼‰            â”‚
â”‚  â”œâ”€ serverï¼ˆæœåŠ¡å™¨ï¼‰                     â”‚
â”‚  â”œâ”€ apiï¼ˆHTTP APIï¼‰                     â”‚
â”‚  â”œâ”€ eventbusï¼ˆäº‹ä»¶æ€»çº¿ï¼‰                â”‚
â”‚  â””â”€ user/channel/pusherï¼ˆä¸šåŠ¡å¤„ç†ï¼‰     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         pkg/ï¼ˆåŸºç¡€èƒ½åŠ›å±‚ï¼‰               â”‚
â”‚  â”œâ”€ wknetï¼ˆç½‘ç»œï¼‰                        â”‚
â”‚  â”œâ”€ wkdbï¼ˆå­˜å‚¨ï¼‰                         â”‚
â”‚  â”œâ”€ clusterï¼ˆé›†ç¾¤ï¼‰                      â”‚
â”‚  â””â”€ raftï¼ˆå…±è¯†ï¼‰                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¾èµ–å…³ç³»**ï¼š
- `cmd` â†’ `internal` â†’ `pkg`
- **å•å‘ä¾èµ–**ï¼Œé¿å…å¾ªç¯å¼•ç”¨

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

### **å„å±‚ä»£ç é‡å æ¯”**

| å±‚çº§ | æ–‡ä»¶æ•° | ä»£ç è¡Œæ•° | å æ¯” |
|------|--------|---------|------|
| **pkg/** | 368 | 76,538 | 72.6% |
| **internal/** | 127 | 28,458 | 27.0% |
| **cmd/** | 4 | 442 | 0.4% |
| **æ€»è®¡** | 499 | **105,438** | 100% |

### **æ ¸å¿ƒåŒ…ä»£ç é‡**

| åŒ… | ä»£ç è¡Œæ•° | å æ¯” |
|----|---------|------|
| **wkdb** | ~25,000 | 32.7% |
| **cluster** | ~15,000 | 19.6% |
| **wknet** | ~8,000 | 10.5% |
| **raft** | ~6,000 | 7.8% |
| **å…¶ä»–** | ~22,538 | 29.4% |

---

## ğŸ“ å­¦ä¹ è·¯å¾„å»ºè®®

### **æ–°æ‰‹è·¯å¾„**ï¼ˆè‡ªé¡¶å‘ä¸‹ï¼‰

```
1. main.go               # å…¥å£
   â†“
2. cmd/root.go           # å‘½ä»¤è¡Œ
   â†“
3. internal/server/      # æœåŠ¡å™¨ä¸»ä½“
   â†“
4. internal/eventbus/    # äº‹ä»¶æ€»çº¿ï¼ˆæ ¸å¿ƒï¼ï¼‰
   â†“
5. pkg/wknet/            # ç½‘ç»œå±‚
   â†“
6. pkg/wkdb/             # å­˜å‚¨å±‚
   â†“
7. pkg/cluster/          # åˆ†å¸ƒå¼å±‚
```

### **è¿›é˜¶è·¯å¾„**ï¼ˆè‡ªåº•å‘ä¸Šï¼‰

```
1. pkg/wknet/            # ç½‘ç»œåŸºç¡€
   â†“
2. pkg/wkdb/             # å­˜å‚¨åŸºç¡€
   â†“
3. pkg/raft/             # å…±è¯†åŸºç¡€
   â†“
4. pkg/cluster/          # é›†ç¾¤æ¶æ„
   â†“
5. internal/eventbus/    # äº‹ä»¶é©±åŠ¨
   â†“
6. internal/user/channel/pusher/  # ä¸šåŠ¡é€»è¾‘
```

---

## ğŸ’¡ å…³é”®è®¾è®¡äº®ç‚¹

### 1. **äº‹ä»¶é©±åŠ¨æ¶æ„**
- **è§£è€¦**ï¼šå„å±‚é€šè¿‡äº‹ä»¶é€šä¿¡
- **å¼‚æ­¥**ï¼šäº‹ä»¶æ± å¼‚æ­¥å¤„ç†
- **å¯æ‰©å±•**ï¼šå®¹æ˜“æ·»åŠ æ–°äº‹ä»¶ç±»å‹

### 2. **Reactor ç½‘ç»œæ¨¡å‹**
- **é«˜å¹¶å‘**ï¼šå•çº¿ç¨‹äº‹ä»¶å¾ªç¯
- **é«˜æ€§èƒ½**ï¼šEpoll/Kqueue
- **ä½å»¶è¿Ÿ**ï¼šæ— é”è®¾è®¡

### 3. **ä¸‰å±‚ Raft æ¶æ„**
- **èŒè´£åˆ†ç¦»**ï¼šä¸åŒæ•°æ®ä¸åŒ Raft ç»„
- **åŠ¨æ€æ‰©å±•**ï¼šæŒ‰éœ€åˆ›å»º Raft ç»„
- **æ•…éšœéš”ç¦»**ï¼šå±€éƒ¨æ•…éšœä¸å½±å“å…¨å±€

### 4. **è‡ªç ”å­˜å‚¨å¼•æ“**
- **åœºæ™¯ä¼˜åŒ–**ï¼šé’ˆå¯¹ IM ç‰¹æ€§è®¾è®¡
- **é«˜æ€§èƒ½**ï¼šåˆ†ç‰‡ + æ‰¹é‡ + ç¼“å­˜
- **å¯é æ€§**ï¼šLSM-Tree + Raft

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **ç¬¬äºŒç« **ï¼šæœåŠ¡å¯åŠ¨æµç¨‹ï¼ˆè¯¦ç»†è§£æå¯åŠ¨é“¾è·¯ï¼‰
- **ç¬¬ä¸‰ç« **ï¼šReactor ç½‘ç»œæ¨¡å‹ï¼ˆæ·±å…¥ wknetï¼‰
- **ç¬¬äº”ç« **ï¼šEventBus äº‹ä»¶æ€»çº¿ï¼ˆäº‹ä»¶é©±åŠ¨æ ¸å¿ƒï¼‰
- **ç¬¬ä¸ƒç« **ï¼šWuKongDB å­˜å‚¨å¼•æ“ï¼ˆå­˜å‚¨å±‚è¯¦è§£ï¼‰
- **ç¬¬ä¹ç« ~ç¬¬åå››ç« **ï¼šåˆ†å¸ƒå¼æ¶æ„ï¼ˆé›†ç¾¤ã€Raftã€åˆ†ç‰‡ï¼‰

---

## ğŸ“ æœ¬èŠ‚è¦ç‚¹

âœ… WuKongIM é‡‡ç”¨æ ‡å‡† Go é¡¹ç›®å¸ƒå±€
âœ… `/internal` å­˜æ”¾ä¸šåŠ¡é€»è¾‘ï¼ˆä¸å¯¹å¤–æš´éœ²ï¼‰
âœ… `/pkg` å­˜æ”¾å¯å¤ç”¨æ ¸å¿ƒåŒ…
âœ… ä¸‰å¤§æ ¸å¿ƒï¼šwknetï¼ˆç½‘ç»œï¼‰ã€wkdbï¼ˆå­˜å‚¨ï¼‰ã€clusterï¼ˆé›†ç¾¤ï¼‰
âœ… äº‹ä»¶é©±åŠ¨æ¶æ„æ˜¯æ ¸å¿ƒè®¾è®¡æ¨¡å¼
âœ… ä»£ç æ€»é‡çº¦ 10 ä¸‡è¡Œï¼Œç»“æ„æ¸…æ™°ã€èŒè´£åˆ†æ˜

---

**ğŸ‰ æ­å–œï¼ä½ å·²ç»æŒæ¡äº† WuKongIM çš„æ•´ä½“é¡¹ç›®ç»“æ„ï¼**

ä¸‹ä¸€èŠ‚æˆ‘ä»¬å°†æ·±å…¥ **ç¬¬äºŒç« ï¼šæœåŠ¡å¯åŠ¨æµç¨‹**ï¼Œè¿½è¸ªä» `main.go` åˆ°æœåŠ¡å®Œå…¨å¯åŠ¨çš„å®Œæ•´é“¾è·¯ã€‚
