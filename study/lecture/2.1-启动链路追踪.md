# 2.1 å¯åŠ¨é“¾è·¯è¿½è¸ª

> **å­¦ä¹ ç›®æ ‡**ï¼šè¿½è¸ª WuKongIM ä»å¯æ‰§è¡Œæ–‡ä»¶å¯åŠ¨åˆ°æœåŠ¡å®Œå…¨å°±ç»ªçš„å®Œæ•´è°ƒç”¨é“¾è·¯ï¼Œç†è§£æ¯ä¸€æ­¥çš„ä½œç”¨ã€‚

---

## ğŸ“Š å®Œæ•´å¯åŠ¨æµç¨‹æ¦‚è§ˆ

```
./wukongim
    â†“
main.go:25 â†’ main()
    â”œâ”€ è®¾ç½®ç‰ˆæœ¬ä¿¡æ¯
    â”œâ”€ åµŒå…¥é™æ€èµ„æº
    â”œâ”€ è‡ªåŠ¨è®¾ç½® GOMAXPROCS
    â””â”€ æ‰§è¡Œ CLI æ¡†æ¶
    â†“
cmd/root.go:48 â†’ cmd.Execute()
    â†“
cmd/root.go:49 â†’ rootCmd.RunE â†’ cmdRun()
    â”œâ”€ åˆå§‹åŒ–é…ç½® (initConfig)
    â”œâ”€ é…ç½®æ—¥å¿—ç³»ç»Ÿ
    â””â”€ åˆ›å»ºå¹¶å¯åŠ¨æœåŠ¡å™¨
    â†“
cmd/root.go:116 â†’ server.New(serverOpts)
    â†“
internal/server/server.go:90 â†’ Server.New()
    â”œâ”€ åˆå§‹åŒ–ä¸‰å¤§äº‹ä»¶æ± 
    â”œâ”€ åˆå§‹åŒ–ç½‘ç»œå¼•æ“
    â”œâ”€ åˆå§‹åŒ–é›†ç¾¤æœåŠ¡
    â””â”€ åˆå§‹åŒ–å„ç§ç®¡ç†å™¨
    â†“
cmd/root.go:117 â†’ s.Start()
    â†“
internal/server/server.go:287 â†’ Server.Start()
    â”œâ”€ å¯åŠ¨å„ä¸ªå­ç³»ç»Ÿ
    â”œâ”€ æ³¨å†Œç½‘ç»œå›è°ƒ
    â””â”€ å¼€å§‹ç›‘å¬ç«¯å£
    â†“
æœåŠ¡å¯åŠ¨å®Œæˆ âœ…
    â†“
cmd/root.go:138-143 â†’ ç­‰å¾…é€€å‡ºä¿¡å·
```

---

## 1ï¸âƒ£ ç¬¬ä¸€æ­¥ï¼šmain.go å…¥å£

**æ–‡ä»¶ä½ç½®**ï¼š`main.go:25-50`

### **å®Œæ•´ä»£ç **

```go
func main() {
    // 1. è®¾ç½®ç‰ˆæœ¬ä¿¡æ¯
    version.Version = Version
    version.Commit = Commit
    version.CommitDate = CommitDate
    version.TreeState = TreeState
    version.WebFs = webFS
    version.DemoFs = demoFS

    // 2. è‡ªåŠ¨è®¾ç½® GOMAXPROCS
    undo, err := maxprocs.Set()
    defer undo()
    if err != nil {
        wklog.Warn("maxprocs set error", zap.Error(err))
    }

    // 3. æ‰§è¡Œå‘½ä»¤è¡Œæ¡†æ¶
    cmd.Execute()
}
```

---

### **é€æ­¥è§£æ**

#### **ç¬¬ 1 æ­¥ï¼šåµŒå…¥é™æ€èµ„æº**ï¼ˆç¼–è¯‘æ—¶ï¼‰

```go
//go:embed web/dist
var webFS embed.FS

//go:embed demo
var demoFS embed.FS
```

**ä½œç”¨**ï¼šå°†å‰ç«¯èµ„æºåµŒå…¥åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ä¸­

**åŸç†**ï¼šGo 1.16+ çš„ `embed` ç‰¹æ€§ï¼Œç¼–è¯‘æ—¶å°†æŒ‡å®šç›®å½•æ‰“åŒ…

**å¥½å¤„**ï¼š
- âœ… å•ä¸€å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ— éœ€å•ç‹¬éƒ¨ç½²å‰ç«¯
- âœ… ç®€åŒ–éƒ¨ç½²ï¼Œé¿å…æ–‡ä»¶ä¸¢å¤±
- âœ… æå‡å®‰å…¨æ€§ï¼ˆå‰ç«¯èµ„æºä¸å¯ç›´æ¥è®¿é—®ï¼‰

**æŸ¥çœ‹åµŒå…¥çš„èµ„æº**ï¼š

```bash
# æŸ¥çœ‹ç®¡ç†åå°
ls -lh web/dist/

# æŸ¥çœ‹èŠå¤© Demo
ls -lh demo/chatdemo/dist/
```

---

#### **ç¬¬ 2 æ­¥ï¼šç‰ˆæœ¬ä¿¡æ¯è®¾ç½®**

```go
var Version string    // version
var Commit string     // git commit id
var CommitDate string // git commit date
var TreeState string  // git tree state

version.Version = Version
version.Commit = Commit
version.CommitDate = CommitDate
version.TreeState = TreeState
```

**ä½œç”¨**ï¼šä¿å­˜ç‰ˆæœ¬å…ƒä¿¡æ¯ï¼Œç”¨äºï¼š
- æ—¥å¿—è®°å½•
- `/varz` API è¿”å›
- é—®é¢˜æ’æŸ¥ï¼ˆç¡®å®šè¿è¡Œç‰ˆæœ¬ï¼‰

**æ³¨å…¥æ–¹å¼**ï¼šé€šè¿‡ `go build -ldflags` åœ¨ç¼–è¯‘æ—¶æ³¨å…¥

```bash
# æ„å»ºæ—¶æ³¨å…¥ç‰ˆæœ¬ä¿¡æ¯
go build -ldflags "
  -X main.Version=v2.2.1
  -X main.Commit=$(git rev-parse HEAD)
  -X main.CommitDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)
  -X main.TreeState=clean
"
```

---

#### **ç¬¬ 3 æ­¥ï¼šè‡ªåŠ¨è®¾ç½® GOMAXPROCS** â­â­â­

```go
undo, err := maxprocs.Set()
defer undo()
```

**å…³é”®åŒ…**ï¼š`go.uber.org/automaxprocs`

**é—®é¢˜èƒŒæ™¯**ï¼š

åœ¨å®¹å™¨ç¯å¢ƒï¼ˆDocker/Kubernetesï¼‰ä¸­ï¼ŒGo é»˜è®¤è¯»å–**å®¿ä¸»æœº**çš„ CPU æ ¸å¿ƒæ•°è®¾ç½® `GOMAXPROCS`ï¼Œè€Œä¸æ˜¯å®¹å™¨çš„ CPU é™åˆ¶ã€‚

```
åœºæ™¯ç¤ºä¾‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¿ä¸»æœºï¼š64 æ ¸                          â”‚
â”‚  â”œâ”€ å®¹å™¨ Aï¼šCPU é™åˆ¶ 2 æ ¸               â”‚
â”‚  â”‚   â””â”€ Go æœåŠ¡ï¼šGOMAXPROCS=64 âŒ     â”‚
â”‚  â”‚       é—®é¢˜ï¼šåˆ›å»º 64 ä¸ª Pï¼Œä½†åªæœ‰ 2  â”‚
â”‚  â”‚            æ ¸å¯ç”¨ â†’ æ€§èƒ½ä¸‹é™        â”‚
â”‚  â””â”€ å®¹å™¨ Bï¼šCPU é™åˆ¶ 4 æ ¸               â”‚
â”‚      â””â”€ Go æœåŠ¡ï¼šGOMAXPROCS=64 âŒ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**`automaxprocs` è§£å†³æ–¹æ¡ˆ**ï¼š

```
è‡ªåŠ¨æ£€æµ‹å®¹å™¨ CPU é…é¢
  â†“
è¯»å– cgroup é™åˆ¶
  â”œâ”€ Linux: /sys/fs/cgroup/cpu/cpu.cfs_quota_us
  â””â”€ Linux: /sys/fs/cgroup/cpu/cpu.cfs_period_us
  â†“
è®¡ç®—å®é™…å¯ç”¨æ ¸å¿ƒæ•°
  â†“
è‡ªåŠ¨è®¾ç½® GOMAXPROCS = min(å®¹å™¨é…é¢, å®¿ä¸»æœºæ ¸å¿ƒæ•°)
```

**æ•ˆæœå¯¹æ¯”**ï¼š

| åœºæ™¯ | ä¸ä½¿ç”¨ automaxprocs | ä½¿ç”¨ automaxprocs |
|------|-------------------|------------------|
| å®¹å™¨é™åˆ¶ 2 æ ¸ | GOMAXPROCS=64 âŒ | GOMAXPROCS=2 âœ… |
| å®¹å™¨é™åˆ¶ 4 æ ¸ | GOMAXPROCS=64 âŒ | GOMAXPROCS=4 âœ… |
| è£¸æœºéƒ¨ç½² 8 æ ¸ | GOMAXPROCS=8 âœ… | GOMAXPROCS=8 âœ… |

**å‚è€ƒèµ„æ–™**ï¼š
- [Uber å·¥ç¨‹åšå®¢](https://eng.uber.com/optimizing-m3-for-kubernetes/)
- [automaxprocs GitHub](https://github.com/uber-go/automaxprocs)

---

#### **ç¬¬ 4 æ­¥ï¼šæ‰§è¡Œå‘½ä»¤è¡Œæ¡†æ¶**

```go
cmd.Execute()
```

**ä½œç”¨**ï¼šè¿›å…¥ Cobra CLI æ¡†æ¶ï¼Œè§£æå‘½ä»¤è¡Œå‚æ•°å¹¶æ‰§è¡Œå¯¹åº”å‘½ä»¤

**è·³è½¬åˆ°**ï¼š`cmd/root.go:42-52`

---

## 2ï¸âƒ£ ç¬¬äºŒæ­¥ï¼šå‘½ä»¤è¡Œè§£æ - cmd/root.go

**æ–‡ä»¶ä½ç½®**ï¼š`cmd/root.go:42-52`

### **Cobra å‘½ä»¤å®šä¹‰**

```go
rootCmd = &cobra.Command{
    Use:   "wk",
    Short: "WuKongIM, a sleek and high-performance instant messaging platform.",
    Long:  `WuKongIM, a sleek and high-performance instant messaging platform...`,
    CompletionOptions: cobra.CompletionOptions{
        DisableDefaultCmd: true,
    },
    RunE: func(cmd *cobra.Command, args []string) error {
        return cmdRun()  // â† æ ¸å¿ƒå¯åŠ¨é€»è¾‘
    },
}
```

**å…³é”®ç‚¹**ï¼š
- `Use: "wk"`ï¼šå‘½ä»¤åç§°
- `RunE`ï¼šæ‰§è¡Œå‡½æ•°ï¼ˆè¿”å› errorï¼‰
- `cmdRun()`ï¼šå®é™…çš„å¯åŠ¨é€»è¾‘

---

### **init() å‡½æ•° - å‚æ•°å®šä¹‰**

**æ–‡ä»¶ä½ç½®**ï¼š`cmd/root.go:55-68`

```go
func init() {
    cobra.OnInitialize(initConfig)  // æ³¨å†Œé…ç½®åˆå§‹åŒ–å‡½æ•°

    // å®šä¹‰å‘½ä»¤è¡Œå‚æ•°
    rootCmd.PersistentFlags().StringVar(&cfgFile, "config", "", "config file")
    rootCmd.PersistentFlags().BoolVarP(&ignoreMissingConfig, "ignoreMissingConfig", "i", false, "...")
    rootCmd.PersistentFlags().StringVar(&mode, "mode", "debug", "mode")
    rootCmd.PersistentFlags().BoolVarP(&daemon, "daemon", "d", false, "run in daemon mode")
    rootCmd.PersistentFlags().StringVar(&pingback, "pingback", "", "pingback address")
    rootCmd.PersistentFlags().BoolVarP(&noStdout, "noStdout", "", false, "no stdout")
}
```

**æ”¯æŒçš„å‚æ•°**ï¼š

| å‚æ•° | ç®€å†™ | ç±»å‹ | é»˜è®¤å€¼ | ä½œç”¨ |
|------|------|------|--------|------|
| `--config` | - | string | "" | é…ç½®æ–‡ä»¶è·¯å¾„ |
| `--mode` | - | string | "debug" | è¿è¡Œæ¨¡å¼ï¼ˆdebug/releaseï¼‰ |
| `--daemon` | `-d` | bool | false | åå°è¿è¡Œ |
| `--ignoreMissingConfig` | `-i` | bool | false | å¿½ç•¥é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ |
| `--pingback` | - | string | "" | Pingback åœ°å€ï¼ˆå®ˆæŠ¤è¿›ç¨‹ï¼‰ |
| `--noStdout` | - | bool | false | ä¸è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡º |

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```bash
# æŒ‡å®šé…ç½®æ–‡ä»¶å¯åŠ¨
./wukongim --config ./config/wk.yaml

# åå°è¿è¡Œ
./wukongim -d

# Release æ¨¡å¼
./wukongim --mode release

# æŒ‡å®šé›†ç¾¤é…ç½®å¯åŠ¨
./wukongim --config ./exampleconfig/cluster1.yaml
```

---

### **initConfig() - é…ç½®åŠ è½½**

**æ–‡ä»¶ä½ç½®**ï¼š`cmd/root.go:70-96`

```go
func initConfig() {
    vp := viper.New()

    // 1. è¯»å–é…ç½®æ–‡ä»¶
    if strings.TrimSpace(cfgFile) != "" {
        vp.SetConfigFile(cfgFile)
        if err := vp.ReadInConfig(); err != nil {
            if !ignoreMissingConfig {
                panic(fmt.Errorf("read config file error: %s", err))
            }
        }
    }

    // 2. æ”¯æŒç¯å¢ƒå˜é‡
    vp.SetEnvPrefix("wk")                              // å‰ç¼€ï¼šWK_
    vp.SetEnvKeyReplacer(strings.NewReplacer(".", "_")) // æ”¯æŒåµŒå¥—ï¼šWK_CLUSTER_NODEID
    vp.AutomaticEnv()

    // 3. åˆå§‹åŒ–æœåŠ¡é…ç½®
    if strings.TrimSpace(mode) != "" {
        serverOpts.Mode = options.Mode(mode)
    }
    serverOpts.ConfigureWithViper(vp)

    installDir = serverOpts.RootDir
    initialed = true
}
```

**é…ç½®ä¼˜å…ˆçº§**ï¼š

```
å‘½ä»¤è¡Œå‚æ•° > ç¯å¢ƒå˜é‡ > é…ç½®æ–‡ä»¶ > é»˜è®¤å€¼
```

**ç¯å¢ƒå˜é‡ç¤ºä¾‹**ï¼š

```bash
# è®¾ç½®èŠ‚ç‚¹ ID
export WK_CLUSTER_NODEID=1001

# è®¾ç½®ç›‘å¬åœ°å€
export WK_ADDR=tcp://0.0.0.0:5100

# è®¾ç½®æ•°æ®ç›®å½•
export WK_ROOTDIR=/data/wukongim

# å¯åŠ¨
./wukongim
```

---

## 3ï¸âƒ£ ç¬¬ä¸‰æ­¥ï¼šcmdRun() - å¯åŠ¨é€»è¾‘

**æ–‡ä»¶ä½ç½®**ï¼š`cmd/root.go:98-149`

### **å®Œæ•´æµç¨‹**

```go
func cmdRun() error {
    if !initialed {
        return nil
    }

    // 1. é…ç½®æ—¥å¿—ç³»ç»Ÿ
    logOpts := wklog.NewOptions()
    logOpts.Level = serverOpts.Logger.Level
    logOpts.LogDir = serverOpts.Logger.Dir
    logOpts.LineNum = serverOpts.Logger.LineNum
    logOpts.NodeId = serverOpts.Cluster.NodeId
    logOpts.TraceOn = serverOpts.Logger.TraceOn
    logOpts.NoStdout = noStdout
    wklog.Configure(logOpts)

    // 2. æ£€æŸ¥æ˜¯å¦åå°è¿è¡Œ
    if daemon {
        startAsChildProcess()  // ä»¥å­è¿›ç¨‹æ–¹å¼å¯åŠ¨
    } else {
        // 3. åˆ›å»ºæœåŠ¡å™¨å®ä¾‹
        s := server.New(serverOpts)

        // 4. å¯åŠ¨æœåŠ¡å™¨ â­â­â­
        err := s.Start()
        if err != nil {
            wklog.Error("start server error", zap.Error(err))
            return err
        }

        // 5. ç­‰å¾…é›†ç¾¤å‡†å¤‡å¥½
        s.MustWaitAllSlotsReady(time.Minute)

        // 6. å¤„ç† pingbackï¼ˆå®ˆæŠ¤è¿›ç¨‹ç›¸å…³ï¼‰
        if pingback != "" {
            if err := handlePingback(); err != nil {
                s.Stop()
                return err
            }
            if err := writePIDFile(); err != nil {
                s.Stop()
                return err
            }
        }

        // 7. è®¾ç½®ä¿¡å·ç›‘å¬ï¼Œç­‰å¾…é€€å‡ºä¿¡å·
        quit := make(chan os.Signal, 1)
        signal.Notify(quit, os.Interrupt, syscall.SIGTERM)
        wklog.Info("WuKongIM server started successfully. Press Ctrl+C to exit.")

        // 8. é˜»å¡ç›´åˆ°æ”¶åˆ°é€€å‡ºä¿¡å·
        <-quit

        // 9. ä¼˜é›…å…³é—­
        s.Stop()
        wklog.Info("WuKongIM server stopped.")
    }
    return nil
}
```

---

### **å…³é”®æ­¥éª¤è¯¦è§£**

#### **æ­¥éª¤ 1ï¼šé…ç½®æ—¥å¿—ç³»ç»Ÿ**

```go
logOpts := wklog.NewOptions()
logOpts.Level = serverOpts.Logger.Level       // æ—¥å¿—çº§åˆ«
logOpts.LogDir = serverOpts.Logger.Dir        // æ—¥å¿—ç›®å½•
logOpts.LineNum = serverOpts.Logger.LineNum   // æ˜¯å¦æ˜¾ç¤ºè¡Œå·
logOpts.NodeId = serverOpts.Cluster.NodeId    // èŠ‚ç‚¹ IDï¼ˆé›†ç¾¤ç¯å¢ƒï¼‰
wklog.Configure(logOpts)
```

**æ—¥å¿—çº§åˆ«**ï¼š

| çº§åˆ« | å€¼ | è¯´æ˜ |
|------|---|------|
| DEBUG | 1 | è°ƒè¯•ä¿¡æ¯ï¼ˆå¼€å‘ç¯å¢ƒï¼‰ |
| INFO | 2 | ä¸€èˆ¬ä¿¡æ¯ï¼ˆé»˜è®¤ï¼‰ |
| WARN | 3 | è­¦å‘Šä¿¡æ¯ |
| ERROR | 4 | é”™è¯¯ä¿¡æ¯ |

**é…ç½®ç¤ºä¾‹**ï¼ˆ`config/wk.yaml`ï¼‰ï¼š

```yaml
logger:
  level: 2           # INFO çº§åˆ«
  dir: "./logs"      # æ—¥å¿—ç›®å½•
  lineNum: true      # æ˜¾ç¤ºè¡Œå·
```

---

#### **æ­¥éª¤ 3ï¼šåˆ›å»ºæœåŠ¡å™¨å®ä¾‹** â­

```go
s := server.New(serverOpts)
```

**è·³è½¬åˆ°**ï¼š`internal/server/server.go:90`

è¿™æ˜¯**æ ¸å¿ƒåˆå§‹åŒ–**çš„å…¥å£ï¼Œä¸‹ä¸€èŠ‚ï¼ˆ2.2ï¼‰å°†è¯¦ç»†è®²è§£ã€‚

---

#### **æ­¥éª¤ 4ï¼šå¯åŠ¨æœåŠ¡å™¨** â­â­â­

```go
err := s.Start()
```

**è·³è½¬åˆ°**ï¼š`internal/server/server.go:287`

è¿™æ˜¯**å¯åŠ¨æ‰€æœ‰å­ç³»ç»Ÿ**çš„å…¥å£ï¼ŒåŒ…æ‹¬ï¼š
- ç½‘ç»œå¼•æ“å¯åŠ¨
- é›†ç¾¤æœåŠ¡å¯åŠ¨
- äº‹ä»¶æ± å¯åŠ¨
- API æœåŠ¡å¯åŠ¨

ä¸‹ä¸€èŠ‚ï¼ˆ2.2ï¼‰å°†è¯¦ç»†è®²è§£ã€‚

---

#### **æ­¥éª¤ 5ï¼šç­‰å¾…é›†ç¾¤å‡†å¤‡**

```go
s.MustWaitAllSlotsReady(time.Minute)
```

**ä½œç”¨**ï¼šç­‰å¾…é›†ç¾¤æ‰€æœ‰æ§½ä½ï¼ˆSlotï¼‰å°±ç»ª

**ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ**

åœ¨é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œå¯åŠ¨åéœ€è¦ï¼š
1. åŠ å…¥é›†ç¾¤
2. åˆ†é…æ§½ä½
3. æ•°æ®åŒæ­¥

è¿™ä¸ªæ­¥éª¤ç¡®ä¿æœåŠ¡å™¨å®Œå…¨å‡†å¤‡å¥½æ¥æ”¶è¯·æ±‚ã€‚

**è¶…æ—¶æ—¶é—´**ï¼š1 åˆ†é’Ÿ

---

#### **æ­¥éª¤ 7-8ï¼šä¿¡å·ç›‘å¬ä¸ä¼˜é›…å…³é—­**

```go
quit := make(chan os.Signal, 1)
signal.Notify(quit, os.Interrupt, syscall.SIGTERM)
wklog.Info("WuKongIM server started successfully. Press Ctrl+C to exit.")

<-quit  // é˜»å¡ï¼Œç­‰å¾…ä¿¡å·

s.Stop()  // ä¼˜é›…å…³é—­
```

**ç›‘å¬çš„ä¿¡å·**ï¼š
- `SIGINT`ï¼ˆCtrl+Cï¼‰
- `SIGTERM`ï¼ˆ`kill` å‘½ä»¤é»˜è®¤ä¿¡å·ï¼‰

**ä¼˜é›…å…³é—­æµç¨‹**ï¼š
1. åœæ­¢æ¥æ”¶æ–°è¿æ¥
2. ç­‰å¾…ç°æœ‰è¯·æ±‚å¤„ç†å®Œæˆ
3. å…³é—­æ‰€æœ‰å­ç³»ç»Ÿ
4. åˆ·æ–°ç¼“å†²åŒº
5. é€€å‡ºè¿›ç¨‹

---

## ğŸ¯ å¯åŠ¨é“¾è·¯æ€»ç»“

### **è°ƒç”¨é“¾è·¯å›¾**

```
./wukongim
  â†“
main() [main.go:25]
  â”œâ”€ è®¾ç½®ç‰ˆæœ¬ä¿¡æ¯
  â”œâ”€ åµŒå…¥é™æ€èµ„æº
  â”œâ”€ maxprocs.Set() â­
  â””â”€ cmd.Execute()
      â†“
rootCmd.RunE [cmd/root.go:49]
  â””â”€ cmdRun()
      â”œâ”€ initConfig()           # é…ç½®åŠ è½½
      â”œâ”€ wklog.Configure()      # æ—¥å¿—é…ç½®
      â”œâ”€ server.New()           # åˆ›å»ºæœåŠ¡å™¨ â­
      â”œâ”€ s.Start()              # å¯åŠ¨æœåŠ¡å™¨ â­â­â­
      â”œâ”€ MustWaitAllSlotsReady() # ç­‰å¾…é›†ç¾¤å°±ç»ª
      â””â”€ ä¿¡å·ç›‘å¬ â†’ s.Stop()    # ä¼˜é›…å…³é—­
```

---

### **å…³é”®æ–‡ä»¶ä¸è¡Œå·**

| æ­¥éª¤ | æ–‡ä»¶ | è¡Œå· | ä½œç”¨ |
|------|------|------|------|
| å…¥å£ | `main.go` | 25-50 | ç¨‹åºå…¥å£ |
| CLI | `cmd/root.go` | 42-52 | å‘½ä»¤å®šä¹‰ |
| é…ç½® | `cmd/root.go` | 70-96 | é…ç½®åŠ è½½ |
| å¯åŠ¨ | `cmd/root.go` | 98-149 | å¯åŠ¨é€»è¾‘ |
| åˆ›å»º | `internal/server/server.go` | 90 | Server.New() |
| å¯åŠ¨ | `internal/server/server.go` | 287 | Server.Start() |

---

### **æ—¶é—´çº¿**

```
T0: ./wukongim æ‰§è¡Œ
  â†“ ~1ms
T1: main() å®Œæˆç‰ˆæœ¬è®¾ç½®å’Œ GOMAXPROCS
  â†“ ~5ms
T2: é…ç½®æ–‡ä»¶åŠ è½½å®Œæˆ
  â†“ ~10ms
T3: æ—¥å¿—ç³»ç»Ÿé…ç½®å®Œæˆ
  â†“ ~50ms
T4: Server.New() å®Œæˆï¼ˆç»„ä»¶åˆå§‹åŒ–ï¼‰
  â†“ ~200-500ms
T5: Server.Start() å®Œæˆï¼ˆæ‰€æœ‰å­ç³»ç»Ÿå¯åŠ¨ï¼‰
  â†“
T6: é›†ç¾¤å°±ç»ªï¼ˆå¦‚æœæ˜¯é›†ç¾¤æ¨¡å¼ï¼‰
  â†“
T7: æœåŠ¡å®Œå…¨å°±ç»ª âœ…

å…¸å‹å¯åŠ¨æ—¶é—´ï¼š300-600msï¼ˆå•æœºï¼‰/ 1-2sï¼ˆé›†ç¾¤ï¼‰
```

---

## ğŸ’¡ è®¾è®¡äº®ç‚¹

1. **è‡ªåŠ¨ GOMAXPROCS è°ƒæ•´**
   - å®¹å™¨ç¯å¢ƒè‡ªé€‚åº”
   - æ€§èƒ½ä¼˜åŒ–

2. **çµæ´»çš„é…ç½®ç³»ç»Ÿ**
   - æ”¯æŒé…ç½®æ–‡ä»¶ã€ç¯å¢ƒå˜é‡ã€å‘½ä»¤è¡Œå‚æ•°
   - ä¼˜å…ˆçº§æ˜ç¡®

3. **åµŒå…¥å¼é™æ€èµ„æº**
   - å•ä¸€å¯æ‰§è¡Œæ–‡ä»¶
   - ç®€åŒ–éƒ¨ç½²

4. **ä¼˜é›…çš„ä¿¡å·å¤„ç†**
   - æ•è·é€€å‡ºä¿¡å·
   - ä¼˜é›…å…³é—­

5. **å®ˆæŠ¤è¿›ç¨‹æ”¯æŒ**
   - `-d` å‚æ•°åå°è¿è¡Œ
   - PID æ–‡ä»¶ç®¡ç†

---

## ğŸ“ æœ¬èŠ‚è¦ç‚¹

âœ… å¯åŠ¨å…¥å£æ˜¯ `main.go`
âœ… ä½¿ç”¨ Cobra æ¡†æ¶å¤„ç†å‘½ä»¤è¡Œ
âœ… ä½¿ç”¨ Viper æ¡†æ¶å¤„ç†é…ç½®
âœ… `automaxprocs` è‡ªåŠ¨ä¼˜åŒ–å®¹å™¨ç¯å¢ƒæ€§èƒ½
âœ… æ ¸å¿ƒåˆ›å»ºåœ¨ `server.New()`
âœ… æ ¸å¿ƒå¯åŠ¨åœ¨ `server.Start()`
âœ… æ”¯æŒä¼˜é›…å…³é—­

---

## ğŸ¯ æ€è€ƒé¢˜

1. **ä¸ºä»€ä¹ˆéœ€è¦ `automaxprocs`ï¼Ÿä¸ç”¨ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ**
   - æç¤ºï¼šå®¹å™¨ç¯å¢ƒ vs å®¿ä¸»æœº

2. **é…ç½®çš„ä¼˜å…ˆçº§æ˜¯æ€æ ·çš„ï¼Ÿ**
   - æç¤ºï¼šå‘½ä»¤è¡Œã€ç¯å¢ƒå˜é‡ã€é…ç½®æ–‡ä»¶

3. **ä¿¡å·ç›‘å¬ä¸ºä»€ä¹ˆè¦ç”¨ channel é˜»å¡ï¼Ÿ**
   - æç¤ºï¼šå¦‚æœä¸é˜»å¡ä¼šæ€æ ·ï¼Ÿ

---

**ä¸‹ä¸€èŠ‚é¢„å‘Š**ï¼š**2.2 æ ¸å¿ƒç»„ä»¶åˆå§‹åŒ–** - æ·±å…¥ `server.New()` å‡½æ•°ï¼Œçœ‹çœ‹å¦‚ä½•åˆå§‹åŒ–ä¸‰å¤§äº‹ä»¶æ± ã€ç½‘ç»œå¼•æ“ã€é›†ç¾¤æœåŠ¡ç­‰æ ¸å¿ƒç»„ä»¶ã€‚ğŸš€
