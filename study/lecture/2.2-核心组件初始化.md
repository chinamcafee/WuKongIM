# 2.2 æ ¸å¿ƒç»„ä»¶åˆå§‹åŒ–

> **å­¦ä¹ ç›®æ ‡**ï¼šæ·±å…¥ç†è§£ `Server.New()` å‡½æ•°çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼ŒæŒæ¡å„æ ¸å¿ƒç»„ä»¶çš„åˆ›å»ºé¡ºåºã€é…ç½®æ–¹å¼åŠå…¶ç›¸äº’ä¾èµ–å…³ç³»ã€‚

---

## ğŸ“Š åˆå§‹åŒ–æµç¨‹æ¦‚è§ˆ

```
cmd/root.go:116 â†’ s := server.New(serverOpts)
    â†“
internal/server/server.go:90 â†’ Server.New()
    â”œâ”€ 1. é…ç½®æ£€æŸ¥
    â”œâ”€ 2. åˆ›å»ºä¸‰å¤§äº‹ä»¶æ±  â­â­â­
    â”œâ”€ 3. ä¸Šä¸‹æ–‡ä¸ç›‘æ§
    â”œâ”€ 4. ç½‘ç»œå¼•æ“åˆå§‹åŒ– â­â­
    â”œâ”€ 5. æµå¼æ¶ˆæ¯ç¼“å­˜
    â”œâ”€ 6. å„ç§ç®¡ç†å™¨ â­
    â”œâ”€ 7. é›†ç¾¤æœåŠ¡å™¨ â­â­â­
    â”œâ”€ 8. API æœåŠ¡å™¨
    â””â”€ 9. æ’ä»¶æœåŠ¡å™¨
    â†“
è¿”å› *Serverï¼ˆæ‰€æœ‰ç»„ä»¶å·²å°±ç»ªï¼‰
```

---

## ğŸ” å®Œæ•´æºç è§£æ

**æ–‡ä»¶ä½ç½®**ï¼š`internal/server/server.go:90-277`

### **å‡½æ•°ç­¾å**

```go
func New(opts *options.Options) *Server
```

**å‚æ•°**ï¼š
- `opts *options.Options`ï¼šæœåŠ¡å™¨é…ç½®é€‰é¡¹

**è¿”å›å€¼**ï¼š
- `*Server`ï¼šå®Œå…¨åˆå§‹åŒ–çš„æœåŠ¡å™¨å®ä¾‹

---

## 1ï¸âƒ£ åŸºç¡€è®¾ç½®ï¼ˆLines 91-106ï¼‰

### **ä»£ç **

```go
func New(opts *options.Options) *Server {
    now := time.Now().UTC()
    options.G = opts  // è®¾ç½®å…¨å±€é…ç½®

    s := &Server{
        opts:  opts,
        Log:   wklog.NewWKLog("Server"),
        start: now,
    }
    s.ctx, s.cancel = context.WithCancel(context.Background())

    // é…ç½®æ£€æŸ¥
    err := opts.Check()
    if err != nil {
        panic(err)
    }

    return s
}
```

---

### **è¯¦ç»†è§£æ**

#### **A. å…¨å±€é…ç½®è®¾ç½®**ï¼ˆLine 92ï¼‰

```go
options.G = opts
```

**ä½œç”¨**ï¼šå°†é…ç½®è®¾ç½®ä¸ºå…¨å±€å˜é‡ï¼Œæ–¹ä¾¿å„æ¨¡å—è®¿é—®

**è®¾è®¡åŸå› **ï¼š
- é¿å…åœ¨æ¯ä¸ªå‡½æ•°è°ƒç”¨æ—¶ä¼ é€’é…ç½®å‚æ•°
- ç®€åŒ–ä»£ç ï¼ˆä½†ç‰ºç‰²äº†ä¸€å®šçš„å¯æµ‹è¯•æ€§ï¼‰

**è®¿é—®æ–¹å¼**ï¼š

```go
// åœ¨å…¶ä»–åŒ…ä¸­è®¿é—®
import "github.com/WuKongIM/WuKongIM/internal/options"

func someFunction() {
    addr := options.G.Addr  // ç›´æ¥è®¿é—®å…¨å±€é…ç½®
}
```

---

#### **B. Server ç»“æ„ä½“åˆ›å»º**ï¼ˆLines 94-98ï¼‰

```go
s := &Server{
    opts:  opts,
    Log:   wklog.NewWKLog("Server"),
    start: now,
}
```

**åˆå§‹åŒ–çš„å­—æ®µ**ï¼š

| å­—æ®µ | ç±»å‹ | ä½œç”¨ |
|------|------|------|
| `opts` | `*options.Options` | é…ç½®é€‰é¡¹ |
| `Log` | `wklog.Log` | æ—¥å¿—å™¨ï¼ˆå¸¦ "Server" å‰ç¼€ï¼‰ |
| `start` | `time.Time` | å¯åŠ¨æ—¶é—´ï¼ˆUTCï¼‰ |

**ä¸ºä»€ä¹ˆç”¨ UTC æ—¶é—´ï¼Ÿ**
- é¿å…æ—¶åŒºé—®é¢˜
- ä¾¿äºåˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„æ—¶é—´å¯¹æ¯”
- æ—¥å¿—åˆ†ææ—¶ç»Ÿä¸€æ—¶é—´åŸºå‡†

---

#### **C. ä¸Šä¸‹æ–‡åˆ›å»º**ï¼ˆLine 99ï¼‰

```go
s.ctx, s.cancel = context.WithCancel(context.Background())
```

**ä½œç”¨**ï¼š
- åˆ›å»ºå¯å–æ¶ˆçš„ä¸Šä¸‹æ–‡
- ç”¨äºä¼˜é›…å…³é—­æ‰€æœ‰å­ç³»ç»Ÿ

**ä½¿ç”¨åœºæ™¯**ï¼š

```go
// å¯åŠ¨æ—¶ä¼ é€’ç»™æ‰€æœ‰ç»„ä»¶
go someComponent.Run(s.ctx)

// å…³é—­æ—¶å–æ¶ˆä¸Šä¸‹æ–‡
func (s *Server) Stop() {
    s.cancel()  // æ‰€æœ‰ç›‘å¬ ctx.Done() çš„ goroutine éƒ½ä¼šé€€å‡º
}
```

---

#### **D. é…ç½®æ£€æŸ¥**ï¼ˆLines 102-105ï¼‰

```go
err := opts.Check()
if err != nil {
    panic(err)
}
```

**æ£€æŸ¥å†…å®¹**ï¼ˆ`internal/options/options.go:Check()`ï¼‰ï¼š
- å¿…å¡«å­—æ®µæ˜¯å¦è®¾ç½®
- é…ç½®å€¼æ˜¯å¦åˆæ³•ï¼ˆå¦‚ç«¯å£èŒƒå›´ï¼‰
- ç›®å½•æ˜¯å¦å­˜åœ¨ä¸”å¯å†™
- é›†ç¾¤é…ç½®ä¸€è‡´æ€§

**ä¸ºä»€ä¹ˆç”¨ panicï¼Ÿ**
- é…ç½®é”™è¯¯æ˜¯è‡´å‘½é—®é¢˜ï¼Œæ— æ³•ç»§ç»­è¿è¡Œ
- åœ¨å¯åŠ¨é˜¶æ®µå¿«é€Ÿå¤±è´¥ï¼ˆFail Fastï¼‰
- é¿å…å¸¦ç€é”™è¯¯é…ç½®è¿è¡Œå¯¼è‡´æ›´ä¸¥é‡çš„é—®é¢˜

---

## 2ï¸âƒ£ ä¸‰å¤§äº‹ä»¶æ± åˆå§‹åŒ– â­â­â­ï¼ˆLines 108-121ï¼‰

### **ä»£ç **

```go
// ç”¨æˆ·äº‹ä»¶æ± 
s.userHandler = userhandler.NewHandler()
s.userEventPool = userevent.NewEventPool(s.userHandler)
eventbus.RegisterUser(s.userEventPool)

// é¢‘é“äº‹ä»¶æ± 
s.channelHandler = channelhandler.NewHandler()
s.channelEventPool = channelevent.NewEventPool(s.channelHandler)
eventbus.RegisterChannel(s.channelEventPool)

// æ¨é€äº‹ä»¶æ± 
s.pushHandler = pusherhandler.NewHandler()
s.pushEventPool = pusherevent.NewEventPool(s.pushHandler)
eventbus.RegisterPusher(s.pushEventPool)
```

---

### **è¯¦ç»†è§£æ**

#### **A. äº‹ä»¶æ± çš„ä½œç”¨**

äº‹ä»¶æ± æ˜¯ WuKongIM çš„**æ ¸å¿ƒè®¾è®¡**ï¼Œé‡‡ç”¨**äº‹ä»¶é©±åŠ¨æ¶æ„**ï¼š

```
ç½‘ç»œäº‹ä»¶
    â†“
äº‹ä»¶åˆ†ç±»
    â”œâ”€ ç”¨æˆ·äº‹ä»¶ â†’ UserEventPool
    â”œâ”€ é¢‘é“äº‹ä»¶ â†’ ChannelEventPool
    â””â”€ æ¨é€äº‹ä»¶ â†’ PusherEventPool
    â†“
å¼‚æ­¥å¤„ç†
    â†“
ä¸šåŠ¡é€»è¾‘æ‰§è¡Œ
```

---

#### **B. ç”¨æˆ·äº‹ä»¶æ± **

```go
s.userHandler = userhandler.NewHandler()
s.userEventPool = userevent.NewEventPool(s.userHandler)
eventbus.RegisterUser(s.userEventPool)
```

**èŒè´£**ï¼šå¤„ç†ç”¨æˆ·ç›¸å…³äº‹ä»¶

| äº‹ä»¶ç±»å‹ | å¤„ç†æ–‡ä»¶ | ä½œç”¨ |
|---------|---------|------|
| `EventConnect` | `internal/user/handler/event_connect.go` | è¿æ¥å»ºç«‹ |
| `EventConnack` | `internal/user/handler/event_connack.go` | è¿æ¥ç¡®è®¤ |
| `EventOnSend` | `internal/user/handler/event_onsend.go` | ç”¨æˆ·å‘é€æ¶ˆæ¯ |
| `EventConnWrite` | `internal/user/handler/event_connwrite.go` | è¿æ¥å†™æ•°æ® |
| `EventConnClose` | `internal/user/handler/event_connclose.go` | è¿æ¥å…³é—­ |

**åˆå§‹åŒ–æ­¥éª¤**ï¼š

1. **åˆ›å»º Handler**ï¼š`userhandler.NewHandler()`
   - åŒ…å«æ‰€æœ‰äº‹ä»¶å¤„ç†é€»è¾‘
   - æŒæœ‰å¯¹å…¶ä»–ç»„ä»¶çš„å¼•ç”¨ï¼ˆé€šè¿‡ `Start()` æ³¨å…¥ï¼‰

2. **åˆ›å»ºäº‹ä»¶æ± **ï¼š`userevent.NewEventPool(s.userHandler)`
   - å†…éƒ¨ç»´æŠ¤äº‹ä»¶é˜Ÿåˆ—
   - å¯åŠ¨å¤šä¸ª Worker Goroutine å¤„ç†äº‹ä»¶

3. **æ³¨å†Œåˆ°äº‹ä»¶æ€»çº¿**ï¼š`eventbus.RegisterUser(s.userEventPool)`
   - å…¨å±€äº‹ä»¶æ€»çº¿çŸ¥é“å¦‚ä½•åˆ†å‘ç”¨æˆ·äº‹ä»¶

---

#### **C. é¢‘é“äº‹ä»¶æ± **

```go
s.channelHandler = channelhandler.NewHandler()
s.channelEventPool = channelevent.NewEventPool(s.channelHandler)
eventbus.RegisterChannel(s.channelEventPool)
```

**èŒè´£**ï¼šå¤„ç†é¢‘é“ç›¸å…³äº‹ä»¶

| äº‹ä»¶ç±»å‹ | å¤„ç†æ–‡ä»¶ | ä½œç”¨ |
|---------|---------|------|
| `EventOnSend` | `internal/channel/handler/event_onsend.go` | é¢‘é“æ¶ˆæ¯å‘é€ |
| `EventDistribute` | `internal/channel/handler/event_distribute.go` | æ¶ˆæ¯åˆ†å‘ |
| `EventWebhook` | `internal/channel/handler/event_webhook.go` | Webhook å›è°ƒ |
| `EventOnStream` | `internal/channel/handler/event_onstream.go` | æµå¼æ¶ˆæ¯å¤„ç† |

**æµç¨‹ç¤ºä¾‹**ï¼š

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
    â†“
UserEventPool.EventOnSend
    â”œâ”€ åŸºæœ¬éªŒè¯
    â””â”€ è½¬å‘åˆ° ChannelEventPool
    â†“
ChannelEventPool.EventOnSend
    â”œâ”€ æƒé™æ£€æŸ¥
    â”œâ”€ Webhook å›è°ƒ
    â”œâ”€ Raft å…±è¯†ï¼ˆé›†ç¾¤æ¨¡å¼ï¼‰
    â””â”€ å­˜å‚¨æŒä¹…åŒ–
    â†“
ChannelEventPool.EventDistribute
    â”œâ”€ æŸ¥æ‰¾è®¢é˜…è€…
    â””â”€ è½¬å‘åˆ° PusherEventPool
```

---

#### **D. æ¨é€äº‹ä»¶æ± **

```go
s.pushHandler = pusherhandler.NewHandler()
s.pushEventPool = pusherevent.NewEventPool(s.pushHandler)
eventbus.RegisterPusher(s.pushEventPool)
```

**èŒè´£**ï¼šå¤„ç†æ¶ˆæ¯æ¨é€

| äº‹ä»¶ç±»å‹ | å¤„ç†æ–‡ä»¶ | ä½œç”¨ |
|---------|---------|------|
| `EventPushOnline` | `internal/pusher/handler/event_pushonline.go` | åœ¨çº¿æ¨é€ |
| `EventPushOffline` | `internal/pusher/handler/event_pushoffline.go` | ç¦»çº¿å­˜å‚¨ |

**æ¨é€æµç¨‹**ï¼š

```
ChannelEventPool.EventDistribute
    â†“
PusherEventPool.EventPushOnline
    â”œâ”€ æ£€æŸ¥ç”¨æˆ·åœ¨çº¿çŠ¶æ€
    â”œâ”€ åœ¨çº¿ç”¨æˆ· â†’ ç›´æ¥æ¨é€
    â””â”€ ç¦»çº¿ç”¨æˆ· â†’ EventPushOffline
    â†“
å­˜å‚¨åˆ°ç¦»çº¿é˜Ÿåˆ—
```

---

#### **E. ä¸ºä»€ä¹ˆå…ˆåˆ›å»ºäº‹ä»¶æ± ï¼Ÿ**

**è®¾è®¡åŸå› **ï¼š

1. **æœ€æ ¸å¿ƒçš„ç»„ä»¶**
   - æ‰€æœ‰ä¸šåŠ¡é€»è¾‘éƒ½é€šè¿‡äº‹ä»¶æ± å¤„ç†
   - å…¶ä»–ç»„ä»¶ï¼ˆç½‘ç»œã€å­˜å‚¨ï¼‰éƒ½ä¾èµ–äº‹ä»¶æ± 

2. **æ³¨å†Œåˆ°å…¨å±€äº‹ä»¶æ€»çº¿**
   - åç»­åˆå§‹åŒ–çš„ç»„ä»¶éœ€è¦é€šè¿‡äº‹ä»¶æ€»çº¿å‘é€äº‹ä»¶
   - å¿…é¡»åœ¨å…¶ä»–ç»„ä»¶ä¹‹å‰å®Œæˆæ³¨å†Œ

3. **ä¾èµ–æ³¨å…¥å‡†å¤‡**
   - äº‹ä»¶æ± åˆ›å»ºå®Œæˆåï¼Œå¯ä»¥æ³¨å…¥ç»™å…¶ä»–ç»„ä»¶
   - å¦‚ï¼šç½‘ç»œå¼•æ“éœ€è¦äº‹ä»¶æ± æ¥åˆ†å‘ç½‘ç»œäº‹ä»¶

---

## 3ï¸âƒ£ ç›‘æ§ä¸è¿½è¸ªï¼ˆLines 123-132ï¼‰

### **ä»£ç **

```go
s.ctx, s.cancel = context.WithCancel(context.Background())

s.trace = trace.New(s.ctx)
err = s.trace.Start()
if err != nil {
    s.Log.Panic("trace start error", zap.Error(err))
}
```

---

### **è¯¦ç»†è§£æ**

#### **A. è¿½è¸ªç³»ç»Ÿ**

**ä½œç”¨**ï¼š
- æ€§èƒ½ç›‘æ§
- è°ƒç”¨é“¾è¿½è¸ª
- ç»Ÿè®¡ä¿¡æ¯æ”¶é›†

**å®ç°**ï¼š`pkg/trace/trace.go`

```go
type Trace struct {
    ctx    context.Context
    cancel context.CancelFunc

    // ç»Ÿè®¡æŒ‡æ ‡
    MessageCount  atomic.Uint64  // æ¶ˆæ¯æ•°é‡
    ConnCount     atomic.Int64   // è¿æ¥æ•°é‡
    LatencySum    atomic.Uint64  // å»¶è¿Ÿæ€»å’Œ
}

func (t *Trace) Start() error {
    go t.collectLoop()  // å®šæœŸæ”¶é›†ç»Ÿè®¡ä¿¡æ¯
    return nil
}
```

**æŸ¥çœ‹ç›‘æ§æ•°æ®**ï¼š

```bash
# è®¿é—® /varz API
curl http://localhost:5001/varz

# è¿”å›ç¤ºä¾‹
{
  "uptime": "2h30m15s",
  "connections": 1523,
  "messages_in": 152341,
  "messages_out": 152341,
  "avg_latency_ms": 2.3
}
```

---

## 4ï¸âƒ£ ç½‘ç»œå¼•æ“åˆå§‹åŒ– â­â­ï¼ˆLines 140-151ï¼‰

### **ä»£ç **

```go
s.engine = wknet.NewEngine(
    wknet.WithAddr(opts.Addr),
    wknet.WithWSAddr(opts.WS.WSAddr),
    wknet.WithWSSAddr(opts.WS.WSSAddr),
    wknet.WithWSTLSConfig(opts.WS.TLSConfig),
    wknet.WithOnConnect(s.onConnect),
    wknet.WithOnClose(s.onClose),
    wknet.WithOnData(s.onData),
)
```

---

### **è¯¦ç»†è§£æ**

#### **A. ç½‘ç»œå¼•æ“é€‰é¡¹**

| é€‰é¡¹ | ä½œç”¨ | ç¤ºä¾‹å€¼ |
|------|------|--------|
| `WithAddr` | TCP ç›‘å¬åœ°å€ | `tcp://0.0.0.0:5100` |
| `WithWSAddr` | WebSocket ç›‘å¬åœ°å€ | `ws://0.0.0.0:5200` |
| `WithWSSAddr` | WebSocket TLS ç›‘å¬åœ°å€ | `wss://0.0.0.0:5210` |
| `WithWSTLSConfig` | TLS é…ç½® | è¯ä¹¦ã€å¯†é’¥ |
| `WithOnConnect` | è¿æ¥å»ºç«‹å›è°ƒ | `s.onConnect` |
| `WithOnClose` | è¿æ¥å…³é—­å›è°ƒ | `s.onClose` |
| `WithOnData` | æ•°æ®åˆ°è¾¾å›è°ƒ | `s.onData` |

---

#### **B. ç½‘ç»œå›è°ƒå‡½æ•°**

##### **è¿æ¥å»ºç«‹å›è°ƒ**ï¼ˆ`internal/server/server.go:onConnect`ï¼‰

```go
func (s *Server) onConnect(conn wknet.Conn) error {
    s.Log.Debug("new connection", zap.String("remote", conn.RemoteAddr().String()))

    // æ·»åŠ äº‹ä»¶åˆ°ç”¨æˆ·äº‹ä»¶æ± 
    eventbus.User.AddEvent(&eventbus.UserContext{
        EventType: eventbus.EventConnect,
        Conn:      conn,
    })

    return nil
}
```

**æµç¨‹**ï¼š

```
å®¢æˆ·ç«¯è¿æ¥
    â†“
wknet.Engine æ¥å—è¿æ¥
    â†“
è°ƒç”¨ s.onConnect(conn)
    â†“
å‘é€ EventConnect äº‹ä»¶
    â†“
UserEventPool å¤„ç†
    â†“
event_connect.go â†’ è®¤è¯ã€åˆå§‹åŒ–è¿æ¥çŠ¶æ€
```

---

##### **æ•°æ®åˆ°è¾¾å›è°ƒ**ï¼ˆ`internal/server/server.go:onData`ï¼‰

```go
func (s *Server) onData(conn wknet.Conn, data []byte) error {
    // è§£æåè®®å¸§
    frame, err := protocol.DecodeFrame(data)
    if err != nil {
        return err
    }

    // æ ¹æ®å¸§ç±»å‹åˆ†å‘äº‹ä»¶
    switch frame.FrameType {
    case protocol.SEND:
        eventbus.User.AddEvent(&eventbus.UserContext{
            EventType: eventbus.EventOnSend,
            Conn:      conn,
            Frame:     frame,
        })
    case protocol.PING:
        // ç›´æ¥å›å¤ PONG
        conn.Write(protocol.EncodePong())
    // ... å…¶ä»–ç±»å‹
    }

    return nil
}
```

**å¸§ç±»å‹**ï¼š

| å¸§ç±»å‹ | å€¼ | ä½œç”¨ |
|-------|---|------|
| `CONNECT` | 1 | è¿æ¥è¯·æ±‚ |
| `CONNACK` | 2 | è¿æ¥ç¡®è®¤ |
| `SEND` | 3 | å‘é€æ¶ˆæ¯ |
| `SENDACK` | 4 | å‘é€ç¡®è®¤ |
| `RECV` | 5 | æ¥æ”¶æ¶ˆæ¯ |
| `RECVACK` | 6 | æ¥æ”¶ç¡®è®¤ |
| `PING` | 7 | å¿ƒè·³è¯·æ±‚ |
| `PONG` | 8 | å¿ƒè·³å“åº” |

---

##### **è¿æ¥å…³é—­å›è°ƒ**ï¼ˆ`internal/server/server.go:onClose`ï¼‰

```go
func (s *Server) onClose(conn wknet.Conn) {
    s.Log.Debug("connection closed", zap.String("remote", conn.RemoteAddr().String()))

    eventbus.User.AddEvent(&eventbus.UserContext{
        EventType: eventbus.EventConnClose,
        Conn:      conn,
    })
}
```

**æ¸…ç†å·¥ä½œ**ï¼š
- ç§»é™¤è¿æ¥æ˜ å°„
- æ›´æ–°åœ¨çº¿çŠ¶æ€
- æ¸…ç†è®¢é˜…å…³ç³»
- è§¦å‘ç¦»çº¿äº‹ä»¶

---

#### **C. Reactor æ¨¡å¼å›é¡¾**

**æ¶æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           wknet.Engine                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ReactorMainï¼ˆä¸» Reactorï¼‰        â”‚ â”‚
â”‚  â”‚  â”œâ”€ Accept æ–°è¿æ¥                 â”‚ â”‚
â”‚  â”‚  â””â”€ åˆ†å‘åˆ° SubReactor            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                  â†“                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ReactorSub[]ï¼ˆå­ Reactor æ•°ç»„ï¼‰  â”‚ â”‚
â”‚  â”‚  â”œâ”€ Epoll/Kqueue ç›‘å¬ I/O         â”‚ â”‚
â”‚  â”‚  â”œâ”€ è¯»å–æ•°æ® â†’ onData()           â”‚ â”‚
â”‚  â”‚  â””â”€ è¿æ¥å…³é—­ â†’ onClose()          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯¦ç»†å­¦ä¹ **ï¼šå‚è§ç¬¬ä¸‰ç« ã€ŠReactor ç½‘ç»œæ¨¡å‹è¯¦è§£ã€‹

---

## 5ï¸âƒ£ æµå¼æ¶ˆæ¯ç¼“å­˜ï¼ˆLines 159-193ï¼‰

### **ä»£ç **

```go
s.streamCache = wkcache.NewStreamCache(
    wkcache.WithOnUserStreamDeleted(func(channelID string, channelType uint8, uid string) {
        // ç”¨æˆ·æµå¼æ¶ˆæ¯åˆ é™¤å›è°ƒ
    }),
    wkcache.WithOnStreamDeleted(func(channelID string, channelType uint8, streamSeq uint32) {
        // æµå¼æ¶ˆæ¯åˆ é™¤å›è°ƒ
    }),
)
```

---

### **è¯¦ç»†è§£æ**

#### **A. ä»€ä¹ˆæ˜¯æµå¼æ¶ˆæ¯ï¼Ÿ**

**æ¦‚å¿µ**ï¼šæ”¯æŒ**å®æ—¶ç¼–è¾‘**çš„æ¶ˆæ¯ç±»å‹ï¼ˆç±»ä¼¼ ChatGPT æ‰“å­—æ•ˆæœï¼‰

**åœºæ™¯**ï¼š
- AI å¯¹è¯ï¼ˆé€å­—è¿”å›ï¼‰
- æ–‡æ¡£ååŒç¼–è¾‘
- ç›´æ’­å¼¹å¹•

**ä¸æ™®é€šæ¶ˆæ¯çš„åŒºåˆ«**ï¼š

| ç‰¹æ€§ | æ™®é€šæ¶ˆæ¯ | æµå¼æ¶ˆæ¯ |
|------|---------|---------|
| å‘é€æ–¹å¼ | ä¸€æ¬¡æ€§å®Œæ•´å‘é€ | åˆ†å¤šæ¬¡å¢é‡å‘é€ |
| åºåˆ—å· | MessageSeq | StreamSeq + StreamNo |
| å­˜å‚¨ | æ°¸ä¹…å­˜å‚¨ | ä¸´æ—¶ç¼“å­˜ |
| æŸ¥è¯¢ | å†å²æ¶ˆæ¯ API | æµå¼æ¶ˆæ¯ API |

---

#### **B. StreamCache çš„ä½œç”¨**

**èŒè´£**ï¼š
- ç¼“å­˜æ­£åœ¨ç¼–è¾‘ä¸­çš„æµå¼æ¶ˆæ¯
- æ¥æ”¶å¢é‡æ›´æ–°
- å®Œæˆåè½¬ä¸ºæ™®é€šæ¶ˆæ¯

**æ•°æ®ç»“æ„**ï¼ˆ`pkg/wkcache/stream.go`ï¼‰ï¼š

```go
type StreamCache struct {
    // channelID+channelType â†’ streamSeq â†’ StreamItem
    cache map[string]map[uint32]*StreamItem
    mu    sync.RWMutex
}

type StreamItem struct {
    ChannelID   string
    ChannelType uint8
    StreamSeq   uint32    // æµå¼æ¶ˆæ¯åºåˆ—å·
    StreamNo    uint32    // å½“å‰ç‰‡æ®µç¼–å·
    Content     []byte    // ç´¯ç§¯çš„å†…å®¹
    UpdateTime  time.Time // æœ€åæ›´æ–°æ—¶é—´
}
```

---

#### **C. æµå¼æ¶ˆæ¯å®Œæ•´æµç¨‹**

```
AI å¼€å§‹å›å¤
    â†“
å‘é€ STREAM_STARTï¼ˆstreamSeq=1, streamNo=0ï¼‰
    â†“
StreamCache.Add(streamSeq=1)
    â†“
å‘é€å¢é‡å†…å®¹ï¼ˆstreamNo=1,2,3...ï¼‰
    â†“
StreamCache.Append(streamSeq=1, content="...")
    â†“
å‘é€ STREAM_ENDï¼ˆstreamNo=999ï¼‰
    â†“
StreamCache.Complete(streamSeq=1)
    â”œâ”€ è½¬æ¢ä¸ºæ™®é€šæ¶ˆæ¯
    â”œâ”€ å­˜å‚¨åˆ° WuKongDB
    â””â”€ æ¸…ç†ç¼“å­˜
```

---

#### **D. åˆ é™¤å›è°ƒ**

##### **ç”¨æˆ·æµå¼æ¶ˆæ¯åˆ é™¤**

```go
wkcache.WithOnUserStreamDeleted(func(channelID string, channelType uint8, uid string) {
    // é€šçŸ¥å®¢æˆ·ç«¯ï¼šæŸç”¨æˆ·çš„æµå¼æ¶ˆæ¯å·²è¢«åˆ é™¤
    eventbus.Pusher.AddEvent(&eventbus.PusherContext{
        EventType:   eventbus.EventPushStreamDeleted,
        ChannelID:   channelID,
        ChannelType: channelType,
        UID:         uid,
    })
})
```

##### **æµå¼æ¶ˆæ¯å®Œæˆåˆ é™¤**

```go
wkcache.WithOnStreamDeleted(func(channelID string, channelType uint8, streamSeq uint32) {
    // æµå¼æ¶ˆæ¯å·²å®Œæˆï¼Œæ¸…ç†ç¼“å­˜
    s.Log.Debug("stream deleted",
        zap.String("channelID", channelID),
        zap.Uint8("channelType", channelType),
        zap.Uint32("streamSeq", streamSeq))
})
```

---

## 6ï¸âƒ£ ç®¡ç†å™¨åˆå§‹åŒ– â­ï¼ˆLines 195-206ï¼‰

### **ä»£ç **

```go
// é‡è¯•ç®¡ç†å™¨
s.retryManager = manager.NewRetryManager()

// ä¼šè¯ç®¡ç†å™¨
s.conversationManager = manager.NewConversationManager(10)

// æ ‡ç­¾ç®¡ç†å™¨ï¼ˆè®¢é˜…è€…ï¼‰
s.tagManager = manager.NewTagManager(
    16,  // åˆ†ç‰‡æ•°é‡
    time.Second*10,  // è¶…æ—¶æ—¶é—´
    func(channelID string, channelType uint8, tagKey string) ([]string, error) {
        // è·å–æ ‡ç­¾è®¢é˜…è€…å›è°ƒ
        return s.store.GetSubscribers(channelID, channelType, tagKey)
    },
)

// è¿æ¥ç®¡ç†å™¨
s.connManager = manager.NewConnManager()

// ç³»ç»Ÿè´¦å·ç®¡ç†å™¨
s.systemAccountManager = manager.NewSystemAccountManager()
```

---

### **è¯¦ç»†è§£æ**

#### **A. é‡è¯•ç®¡ç†å™¨**ï¼ˆ`internal/manager/manager_retry.go`ï¼‰

**èŒè´£**ï¼šç®¡ç†æ¶ˆæ¯å‘é€å¤±è´¥åçš„é‡è¯•é˜Ÿåˆ—

**ä½¿ç”¨åœºæ™¯**ï¼š
- ç½‘ç»œæ³¢åŠ¨å¯¼è‡´å‘é€å¤±è´¥
- æ¥æ”¶æ–¹æš‚æ—¶ç¦»çº¿
- Raft å…±è¯†å¤±è´¥

**å·¥ä½œåŸç†**ï¼š

```go
type RetryManager struct {
    queue  *list.List  // é‡è¯•é˜Ÿåˆ—
    ticker *time.Ticker
}

func (m *RetryManager) Add(msg *RetryMessage) {
    m.queue.PushBack(msg)
}

func (m *RetryManager) Start() {
    go func() {
        for range m.ticker.C {
            // éå†é˜Ÿåˆ—ï¼Œé‡è¯•å‘é€
            for e := m.queue.Front(); e != nil; {
                msg := e.Value.(*RetryMessage)
                if time.Since(msg.LastRetry) > msg.Interval {
                    err := m.retrySend(msg)
                    if err == nil {
                        // æˆåŠŸï¼Œç§»é™¤
                        next := e.Next()
                        m.queue.Remove(e)
                        e = next
                    } else {
                        msg.RetryCount++
                        msg.LastRetry = time.Now()
                        e = e.Next()
                    }
                } else {
                    e = e.Next()
                }
            }
        }
    }()
}
```

**é‡è¯•ç­–ç•¥**ï¼š

| é‡è¯•æ¬¡æ•° | é—´éš”æ—¶é—´ | æœ€å¤§æ¬¡æ•° |
|---------|---------|---------|
| 1 | 1 ç§’ | - |
| 2 | 2 ç§’ | - |
| 3 | 4 ç§’ | - |
| 4+ | 10 ç§’ | 10 æ¬¡ |

---

#### **B. ä¼šè¯ç®¡ç†å™¨**ï¼ˆ`internal/manager/manager_conversation.go`ï¼‰

**èŒè´£**ï¼šç®¡ç†æœ€è¿‘ä¼šè¯åˆ—è¡¨

**å‚æ•°**ï¼š`10` = æ¯ä¸ªç”¨æˆ·ç¼“å­˜æœ€å¤š 10 ä¸ªæœ€è¿‘ä¼šè¯

**æ•°æ®ç»“æ„**ï¼š

```go
type ConversationManager struct {
    // uid â†’ []Conversationï¼ˆLRU ç¼“å­˜ï¼‰
    cache *lru.Cache
}

type Conversation struct {
    ChannelID   string
    ChannelType uint8
    LastMsgSeq  uint64
    UnreadCount int
    UpdateTime  time.Time
}
```

**API ä½¿ç”¨**ï¼š

```bash
# è·å–æœ€è¿‘ä¼šè¯
curl -X POST http://localhost:5001/conversation/sync \
  -H "Content-Type: application/json" \
  -d '{
    "uid": "user001",
    "version": 0
  }'

# è¿”å›
{
  "conversations": [
    {
      "channel_id": "user002",
      "channel_type": 1,
      "unread_count": 3,
      "last_msg_seq": 152
    }
  ]
}
```

---

#### **C. æ ‡ç­¾ç®¡ç†å™¨**ï¼ˆ`internal/manager/manager_tag.go` â­â­ï¼‰

**èŒè´£**ï¼šç®¡ç†è®¢é˜…è€…æ ‡ç­¾ï¼ˆç”¨äºæ¶ˆæ¯åˆ†å‘ä¼˜åŒ–ï¼‰

**å‚æ•°è§£æ**ï¼š

```go
s.tagManager = manager.NewTagManager(
    16,                // shardCountï¼šåˆ†ç‰‡æ•°é‡ï¼ˆæå‡å¹¶å‘ï¼‰
    time.Second*10,    // timeoutï¼šè·å–è®¢é˜…è€…è¶…æ—¶æ—¶é—´
    func(...) ([]string, error) {  // dataSourceï¼šæ•°æ®æºå›è°ƒ
        return s.store.GetSubscribers(channelID, channelType, tagKey)
    },
)
```

---

##### **ä»€ä¹ˆæ˜¯æ ‡ç­¾ï¼ˆTagï¼‰ï¼Ÿ**

**æ¦‚å¿µ**ï¼šè®¢é˜…è€…çš„**åˆ†ç»„æ ‡è¯†**ï¼Œç”¨äºç²¾å‡†æ¨é€

**åœºæ™¯ç¤ºä¾‹**ï¼š

```
ç¾¤èŠï¼ˆ1000 äººï¼‰
â”œâ”€ åœ¨çº¿ç”¨æˆ·ï¼ˆ500 äººï¼‰     â† tag = "online"
â”œâ”€ ç¦»çº¿ç”¨æˆ·ï¼ˆ500 äººï¼‰     â† tag = "offline"
â”œâ”€ iOS è®¾å¤‡ï¼ˆ300 äººï¼‰     â† tag = "ios"
â”œâ”€ Android è®¾å¤‡ï¼ˆ400 äººï¼‰ â† tag = "android"
â””â”€ Web è®¾å¤‡ï¼ˆ300 äººï¼‰     â† tag = "web"
```

**æ¨é€ä¼˜åŒ–**ï¼š

```go
// âŒ ä½æ•ˆï¼šéå†æ‰€æœ‰è®¢é˜…è€…
subscribers := store.GetAllSubscribers(channelID)
for _, uid := range subscribers {
    if isOnline(uid) {
        push(uid, message)
    }
}

// âœ… é«˜æ•ˆï¼šåªè·å–åœ¨çº¿è®¢é˜…è€…
onlineUsers := tagManager.GetSubscribers(channelID, "online")
for _, uid := range onlineUsers {
    push(uid, message)
}
```

---

##### **TagManager å·¥ä½œåŸç†**

**æ•°æ®ç»“æ„**ï¼š

```go
type TagManager struct {
    shards     []*TagShard  // åˆ†ç‰‡æ•°ç»„
    dataSource DataSourceFunc
}

type TagShard struct {
    // channelID+channelType+tagKey â†’ []uid
    cache map[string][]string
    mu    sync.RWMutex
}

func (m *TagManager) GetSubscribers(
    channelID string,
    channelType uint8,
    tagKey string,
) ([]string, error) {
    // 1. è®¡ç®—åˆ†ç‰‡ç´¢å¼•
    shardIdx := hash(channelID) % len(m.shards)
    shard := m.shards[shardIdx]

    // 2. æŸ¥ç¼“å­˜
    key := makeKey(channelID, channelType, tagKey)
    shard.mu.RLock()
    cached, ok := shard.cache[key]
    shard.mu.RUnlock()

    if ok {
        return cached, nil
    }

    // 3. ç¼“å­˜æœªå‘½ä¸­ï¼Œè°ƒç”¨æ•°æ®æº
    subscribers, err := m.dataSource(channelID, channelType, tagKey)
    if err != nil {
        return nil, err
    }

    // 4. å†™å…¥ç¼“å­˜
    shard.mu.Lock()
    shard.cache[key] = subscribers
    shard.mu.Unlock()

    return subscribers, nil
}
```

**åˆ†ç‰‡ä¼˜åŠ¿**ï¼š
- å‡å°‘é”ç«äº‰ï¼ˆ16 ä¸ªåˆ†ç‰‡ = 16 æŠŠé”ï¼‰
- æå‡å¹¶å‘æ€§èƒ½

---

#### **D. è¿æ¥ç®¡ç†å™¨**ï¼ˆ`internal/manager/manager_conn.go`ï¼‰

**èŒè´£**ï¼šç®¡ç† UID åˆ°è¿æ¥çš„æ˜ å°„

**æ•°æ®ç»“æ„**ï¼š

```go
type ConnManager struct {
    // uid â†’ []wknet.Connï¼ˆæ”¯æŒå¤šè®¾å¤‡ï¼‰
    conns map[string][]wknet.Conn
    mu    sync.RWMutex
}

func (m *ConnManager) Add(uid string, conn wknet.Conn) {
    m.mu.Lock()
    defer m.mu.Unlock()
    m.conns[uid] = append(m.conns[uid], conn)
}

func (m *ConnManager) Get(uid string) []wknet.Conn {
    m.mu.RLock()
    defer m.mu.RUnlock()
    return m.conns[uid]
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š

```go
// æ¨é€æ¶ˆæ¯ç»™ç”¨æˆ·
conns := connManager.Get("user001")
for _, conn := range conns {
    conn.Write(encodeMessage(msg))
}
```

---

#### **E. ç³»ç»Ÿè´¦å·ç®¡ç†å™¨**ï¼ˆ`internal/manager/manager_systemaccount.go`ï¼‰

**èŒè´£**ï¼šç®¡ç†ç³»ç»Ÿè´¦å·ï¼ˆå¦‚å®˜æ–¹é€šçŸ¥è´¦å·ï¼‰

**åŠŸèƒ½**ï¼š
- ç³»ç»Ÿæ¶ˆæ¯å‘é€ï¼ˆæ— éœ€æƒé™æ£€æŸ¥ï¼‰
- é€šçŸ¥ç±»æ¶ˆæ¯
- è¿è¥æ¶ˆæ¯

**ç¤ºä¾‹**ï¼š

```go
// æ·»åŠ ç³»ç»Ÿè´¦å·
systemAccountManager.Add("system_notice")

// æ£€æŸ¥æ˜¯å¦ä¸ºç³»ç»Ÿè´¦å·
if systemAccountManager.IsSystemAccount(fromUID) {
    // è·³è¿‡æƒé™æ£€æŸ¥
}
```

---

## 7ï¸âƒ£ é›†ç¾¤æœåŠ¡å™¨åˆå§‹åŒ– â­â­â­ï¼ˆLines 211-257ï¼‰

### **ä»£ç **

```go
clusterServer := cluster.New(
    cluster.WithNodeID(opts.Cluster.NodeId),
    cluster.WithAddr(opts.Cluster.Addr),
    cluster.WithServerAddr(opts.Cluster.ServerAddr),
    cluster.WithInitNodes(opts.Cluster.InitNodes),
    cluster.WithSeed(opts.Cluster.Seed),
    cluster.WithSlotCount(opts.Cluster.SlotCount),
    cluster.WithSlotMaxReplicaCount(opts.Cluster.SlotMaxReplicaCount),
    cluster.WithChannelMaxReplicaCount(opts.Cluster.ChannelMaxReplicaCount),
    cluster.WithOnSlotApply(s.onSlotApply),
    cluster.WithOnChannelApply(s.onChannelApply),
)
s.clusterServer = clusterServer
```

---

### **è¯¦ç»†è§£æ**

#### **A. é›†ç¾¤é…ç½®é€‰é¡¹**

| é€‰é¡¹ | ä½œç”¨ | ç¤ºä¾‹å€¼ |
|------|------|--------|
| `WithNodeID` | èŠ‚ç‚¹ IDï¼ˆå…¨å±€å”¯ä¸€ï¼‰ | `1001` |
| `WithAddr` | é›†ç¾¤é€šä¿¡åœ°å€ | `tcp://192.168.1.10:11110` |
| `WithServerAddr` | å¯¹å¤–æœåŠ¡åœ°å€ | `tcp://192.168.1.10:5100` |
| `WithInitNodes` | åˆå§‹èŠ‚ç‚¹åˆ—è¡¨ | `["1001@192.168.1.10:11110", ...]` |
| `WithSeed` | ç§å­èŠ‚ç‚¹ | `1001` |
| `WithSlotCount` | æ§½ä½æ•°é‡ | `1024` |
| `WithSlotMaxReplicaCount` | æ§½ä½æœ€å¤§å‰¯æœ¬æ•° | `3` |
| `WithChannelMaxReplicaCount` | é¢‘é“æœ€å¤§å‰¯æœ¬æ•° | `3` |

---

#### **B. é›†ç¾¤æ¶æ„å›é¡¾**

**ä¸‰å±‚ Raft æ¶æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ç¬¬ä¸€å±‚ï¼šNode Raftï¼ˆConfigServerï¼‰          â”‚
â”‚  ç®¡ç†ï¼šèŠ‚ç‚¹åˆ—è¡¨ã€æ§½ä½åˆ†é…                        â”‚
â”‚  Raft ç»„æ•°ï¼š1 ä¸ª                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  NodeID: 1001, 1002, 1003                      â”‚
â”‚  Slots: [0-341], [342-682], [683-1023]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ç¬¬äºŒå±‚ï¼šSlot Raftï¼ˆSlotServerï¼‰            â”‚
â”‚  ç®¡ç†ï¼šé¢‘é“é…ç½®ã€ç”¨æˆ·æ•°æ®ã€ä¼šè¯                  â”‚
â”‚  Raft ç»„æ•°ï¼š1024 ä¸ª                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Slot 0    Slot 1    ...    Slot 1023          â”‚
â”‚  (Raft)    (Raft)           (Raft)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ç¬¬ä¸‰å±‚ï¼šChannel Raftï¼ˆChannelServerï¼‰       â”‚
â”‚  ç®¡ç†ï¼šæ¶ˆæ¯æ—¥å¿—                                  â”‚
â”‚  Raft ç»„æ•°ï¼šåŠ¨æ€åˆ›å»ºï¼ˆæ¯ä¸ªæ´»è·ƒé¢‘é“ä¸€ä¸ªï¼‰         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Channel A   Channel B   ...                   â”‚
â”‚  (Raft)      (Raft)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯¦ç»†å­¦ä¹ **ï¼šå‚è§ç¬¬ä¹ç« ~ç¬¬åå››ç« ã€Šåˆ†å¸ƒå¼æ¶æ„ã€‹

---

#### **C. Raft åº”ç”¨å›è°ƒ**

##### **Slot åº”ç”¨å›è°ƒ**

```go
cluster.WithOnSlotApply(s.onSlotApply)

// å®ç°ï¼šinternal/server/server_cluster.go
func (s *Server) onSlotApply(req *cluster.SlotLogReq) (*cluster.SlotLogResp, error) {
    switch req.Type {
    case cluster.SlotLogTypeAddOrUpdateChannel:
        // æ·»åŠ æˆ–æ›´æ–°é¢‘é“é…ç½®
        return s.handleAddOrUpdateChannel(req)

    case cluster.SlotLogTypeAddSubscriber:
        // æ·»åŠ è®¢é˜…è€…
        return s.handleAddSubscriber(req)

    case cluster.SlotLogTypeRemoveSubscriber:
        // ç§»é™¤è®¢é˜…è€…
        return s.handleRemoveSubscriber(req)

    // ... å…¶ä»–ç±»å‹
    }
}
```

**ä½œç”¨**ï¼š
- Slot Raft è¾¾æˆå…±è¯†åï¼Œè°ƒç”¨æ­¤å›è°ƒåº”ç”¨æ—¥å¿—
- å°†é¢‘é“é…ç½®ã€è®¢é˜…å…³ç³»å†™å…¥æœ¬åœ°å­˜å‚¨

---

##### **Channel åº”ç”¨å›è°ƒ**

```go
cluster.WithOnChannelApply(s.onChannelApply)

// å®ç°ï¼šinternal/server/server_cluster.go
func (s *Server) onChannelApply(req *cluster.ChannelLogReq) (*cluster.ChannelLogResp, error) {
    switch req.Type {
    case cluster.ChannelLogTypeMessage:
        // æ¶ˆæ¯æ—¥å¿—
        return s.handleMessageLog(req)

    // ... å…¶ä»–ç±»å‹
    }
}
```

**ä½œç”¨**ï¼š
- Channel Raft è¾¾æˆå…±è¯†åï¼Œè°ƒç”¨æ­¤å›è°ƒåº”ç”¨æ—¥å¿—
- å°†æ¶ˆæ¯å†™å…¥æœ¬åœ°å­˜å‚¨

---

#### **D. é›†ç¾¤é…ç½®ç¤ºä¾‹**

**ä¸‰èŠ‚ç‚¹é›†ç¾¤é…ç½®**ï¼ˆ`exampleconfig/cluster1.yaml`ï¼‰ï¼š

```yaml
cluster:
  nodeId: 1001
  addr: "tcp://127.0.0.1:11110"
  serverAddr: "tcp://127.0.0.1:5100"
  initNodes:
    - "1001@127.0.0.1:11110"
    - "1002@127.0.0.1:11111"
    - "1003@127.0.0.1:11112"
  seed: 1001
  slotCount: 1024
  slotMaxReplicaCount: 3
  channelMaxReplicaCount: 3
```

**å¯åŠ¨é›†ç¾¤**ï¼š

```bash
# èŠ‚ç‚¹ 1
./wukongim --config exampleconfig/cluster1.yaml

# èŠ‚ç‚¹ 2
./wukongim --config exampleconfig/cluster2.yaml

# èŠ‚ç‚¹ 3
./wukongim --config exampleconfig/cluster3.yaml
```

---

## 8ï¸âƒ£ API æœåŠ¡å™¨åˆå§‹åŒ–ï¼ˆLine 265ï¼‰

### **ä»£ç **

```go
s.apiServer = api.New()
```

---

### **è¯¦ç»†è§£æ**

#### **A. API æœåŠ¡å™¨èŒè´£**

**ä½œç”¨**ï¼šæä¾› HTTP RESTful API

**å®ç°**ï¼š`internal/api/server.go` + `internal/api/server_http.go`

```go
// Server ç»“æ„ï¼ˆinternal/api/server.goï¼‰
type Server struct {
    requset       *request
    client        *ingress.Client
    timingWheel   *timingwheel.TimingWheel
    apiServer     *apiServer     // HTTP APIæœåŠ¡å™¨
    managerServer *managerServer // ç®¡ç†APIæœåŠ¡å™¨
    migrateTask   *MigrateTask   // æ•°æ®è¿ç§»ä»»åŠ¡
}

func New() *Server {
    s := &Server{
        Log:         wklog.NewWKLog("ApiServer"),
        requset:     newRequset(),
        timingWheel: timingwheel.NewTimingWheel(...),
        client:      ingress.NewClient(),
    }
    s.apiServer = newApiServer(s)        // åˆ›å»ºAPIæœåŠ¡å™¨
    s.managerServer = newManagerServer(s) // åˆ›å»ºç®¡ç†æœåŠ¡å™¨
    s.migrateTask = NewMigrateTask(s)     // åˆ›å»ºè¿ç§»ä»»åŠ¡
    return s
}

// è·¯ç”±æ³¨å†Œï¼ˆinternal/api/server_http.go:setRoutesï¼‰
func (s *apiServer) setRoutes() {
    // å¥åº·æ£€æŸ¥
    s.r.GET("/health", ...)

    // å„æ¨¡å—è·¯ç”±æ³¨å†Œ
    newRoute(s.s).route(s.r)         // è·¯ç”±æ¨¡å—
    newConnz(s.s).route(s.r)         // è¿æ¥ç›‘æ§
    newVarz(s.s).route(s.r)          // æœåŠ¡å™¨çŠ¶æ€
    newUser(s.s).route(s.r)          // ç”¨æˆ·æ¨¡å—
    newConnApi(s.s).route(s.r)       // è¿æ¥ç®¡ç†
    newChannel(s.s).route(s.r)       // é¢‘é“æ¨¡å—
    newMessage(s.s).route(s.r)       // æ¶ˆæ¯æ¨¡å— â­
    newConversation(s.s).route(s.r)  // ä¼šè¯æ¨¡å—
    newManager(s.s).route(s.r)       // ç®¡ç†æ¨¡å—
    newStream(s.s).route(s.r)        // æµå¼æ¶ˆæ¯
    newEvent(s.s).route(s.r)         // äº‹ä»¶æ¨¡å—
    newTag(s.s).route(s.r)           // æ ‡ç­¾æ¨¡å—
    newDocs(s.s).route(s.r)          // APIæ–‡æ¡£(Swagger)
}
```

---

#### **B. æ¶ˆæ¯æ¨¡å—æ ¸å¿ƒ API**ï¼ˆ`internal/api/message.go:route` â­ï¼‰

**æ³¨å†Œè·¯ç”±**ï¼š

```go
func (m *message) route(r *wkhttp.WKHttp) {
    // æ¶ˆæ¯å‘é€
    r.POST("/message/send", m.send)           // å‘é€æ¶ˆæ¯
    r.POST("/message/sendbatch", m.sendBatch) // æ‰¹é‡å‘é€æ¶ˆæ¯

    // æ¶ˆæ¯åŒæ­¥ï¼ˆå°†åºŸå¼ƒï¼‰
    r.POST("/message/sync", m.sync)           // æ¶ˆæ¯åŒæ­¥(å†™æ¨¡å¼)
    r.POST("/message/syncack", m.syncack)     // æ¶ˆæ¯åŒæ­¥å›æ‰§

    // æ¶ˆæ¯æŸ¥è¯¢
    r.POST("/messages", m.searchMessages)     // æ‰¹é‡æŸ¥è¯¢æ¶ˆæ¯
    r.POST("/message", m.searchMessage)       // æœç´¢å•æ¡æ¶ˆæ¯

    // é¢‘é“æ¶ˆæ¯ç›¸å…³ï¼ˆä» channel.go ç§»åŠ¨è¿‡æ¥ï¼‰
    r.POST("/channel/messagesync", m.syncMessages)               // åŒæ­¥é¢‘é“æ¶ˆæ¯ â­
    r.GET("/channel/max_message_seq", m.getChannelMaxMessageSeq) // è·å–é¢‘é“æœ€å¤§æ¶ˆæ¯åºå·
}
```

---

#### **C. æ ¸å¿ƒ API åˆ—è¡¨**

| æ¨¡å— | API | æ–¹æ³• | ä½œç”¨ |
|------|-----|------|------|
| **æ¶ˆæ¯** | `/message/send` | POST | å‘é€æ¶ˆæ¯ â­ |
| | `/message/sendbatch` | POST | æ‰¹é‡å‘é€æ¶ˆæ¯ |
| | `/messages` | POST | æ‰¹é‡æŸ¥è¯¢æ¶ˆæ¯ |
| | `/message` | POST | æŸ¥è¯¢å•æ¡æ¶ˆæ¯ |
| **é¢‘é“æ¶ˆæ¯** | `/channel/messagesync` | POST | åŒæ­¥é¢‘é“æ¶ˆæ¯ â­â­ |
| | `/channel/max_message_seq` | GET | è·å–é¢‘é“æœ€å¤§åºå· |
| **é¢‘é“ç®¡ç†** | `/channel` | POST | åˆ›å»º/æ›´æ–°é¢‘é“ |
| | `/channel/info` | POST | æ›´æ–°é¢‘é“ä¿¡æ¯ |
| | `/channel/subscriber_add` | POST | æ·»åŠ è®¢é˜…è€… |
| **ä¼šè¯** | `/conversation/sync` | POST | åŒæ­¥æœ€è¿‘ä¼šè¯ |
| **ç”¨æˆ·** | `/user/online` | GET | è·å–åœ¨çº¿ç”¨æˆ· |
| **ç³»ç»Ÿ** | `/varz` | GET | æœåŠ¡å™¨çŠ¶æ€ â­ |
| | `/health` | GET | å¥åº·æ£€æŸ¥ |

**API åˆ†å¸ƒè¯´æ˜**ï¼š
- æ¶ˆæ¯APIï¼š`internal/api/message.go`
- é¢‘é“APIï¼š`internal/api/channel.go`
- ä¼šè¯APIï¼š`internal/api/conversation.go`
- ç”¨æˆ·APIï¼š`internal/api/user.go`
- ç³»ç»ŸAPIï¼š`internal/api/varz.go`

---

#### **D. API ä½¿ç”¨ç¤ºä¾‹**

##### **1. å‘é€æ¶ˆæ¯**ï¼ˆ`/message/send`ï¼‰

```bash
curl -X POST http://127.0.0.1:5001/message/send \
  -H "Content-Type: application/json" \
  -d '{
    "header": {
      "no_persist": 0,
      "red_dot": 1,
      "sync_once": 0
    },
    "from_uid": "user001",
    "channel_id": "user002",
    "channel_type": 1,
    "payload": "SGVsbG8gV3VLb25nSU0h"
  }'

# è¿”å›
{
  "message_id": 123456789,
  "client_msg_no": "uuid-123-0"
}
```

##### **2. åŒæ­¥é¢‘é“æ¶ˆæ¯**ï¼ˆ`/channel/messagesync` â­ï¼‰

```bash
curl -X POST http://127.0.0.1:5001/channel/messagesync \
  -H "Content-Type: application/json" \
  -d '{
    "login_uid": "user002",
    "channel_id": "user001",
    "channel_type": 1,
    "start_message_seq": 0,
    "pull_mode": 1,
    "limit": 10
  }'

# è¿”å›
{
  "start_message_seq": 0,
  "end_message_seq": 0,
  "more": 0,
  "messages": [
    {
      "message_id": 123456789,
      "message_seq": 1,
      "from_uid": "user001",
      "channel_id": "user002",
      "channel_type": 1,
      "payload": "SGVsbG8gV3VLb25nSU0h",
      "timestamp": 1735689600
    }
  ]
}
```

##### **3. æœåŠ¡å™¨çŠ¶æ€**ï¼ˆ`/varz`ï¼‰

```bash
curl http://127.0.0.1:5001/varz

# è¿”å›
{
  "server_id": "1001",
  "version": "v1.0.0",
  "uptime": "2h15m30s",
  "connections": 1250,
  "in_msgs": 156789,
  "out_msgs": 234567,
  "in_bytes": 15678900,
  "out_bytes": 23456700
}
```

---

## 9ï¸âƒ£ æ’ä»¶æœåŠ¡å™¨åˆå§‹åŒ–ï¼ˆLines 268-275ï¼‰

### **ä»£ç **

```go
s.pluginServer = plugin.NewServer(
    plugin.WithAddr(opts.Plugin.HTTPAddr),
)
```

---

### **è¯¦ç»†è§£æ**

#### **A. æ’ä»¶ç³»ç»Ÿ**

**ä½œç”¨**ï¼šæ‰©å±• WuKongIM åŠŸèƒ½

**æ¶æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          WuKongIM æ ¸å¿ƒ                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚       Plugin Server                   â”‚ â”‚
â”‚  â”‚  â”œâ”€ HTTP APIï¼ˆæ’ä»¶è°ƒç”¨ï¼‰              â”‚ â”‚
â”‚  â”‚  â””â”€ gRPC APIï¼ˆé«˜æ€§èƒ½è°ƒç”¨ï¼‰            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                  â†“                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         Plugin Manager                â”‚ â”‚
â”‚  â”‚  â”œâ”€ åŠ è½½æ’ä»¶                          â”‚ â”‚
â”‚  â”‚  â”œâ”€ ç”Ÿå‘½å‘¨æœŸç®¡ç†                      â”‚ â”‚
â”‚  â”‚  â””â”€ æ’ä»¶é—´é€šä¿¡                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                  â†“                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         æ’ä»¶å®ä¾‹                       â”‚ â”‚
â”‚  â”‚  â”œâ”€ è‡ªå®šä¹‰æ¶ˆæ¯å¤„ç†                    â”‚ â”‚
â”‚  â”‚  â”œâ”€ è‡ªå®šä¹‰å­˜å‚¨                        â”‚ â”‚
â”‚  â”‚  â””â”€ è‡ªå®šä¹‰æ¨é€                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### **B. æ’ä»¶ç±»å‹**

| ç±»å‹ | ä½œç”¨ | ç¤ºä¾‹ |
|------|------|------|
| **æ¶ˆæ¯å¤„ç†æ’ä»¶** | è‡ªå®šä¹‰æ¶ˆæ¯æ ¼å¼ã€å†…å®¹å®¡æ ¸ | æ•æ„Ÿè¯è¿‡æ»¤ |
| **å­˜å‚¨æ’ä»¶** | è‡ªå®šä¹‰å­˜å‚¨åç«¯ | MySQLã€MongoDB |
| **æ¨é€æ’ä»¶** | è‡ªå®šä¹‰æ¨é€æ¸ é“ | APNsã€FCM |
| **è®¤è¯æ’ä»¶** | è‡ªå®šä¹‰è®¤è¯é€»è¾‘ | OAuthã€LDAP |

---

#### **C. æ’ä»¶ç¤ºä¾‹**

**æ•æ„Ÿè¯è¿‡æ»¤æ’ä»¶**ï¼š

```go
package main

import (
    "github.com/WuKongIM/WuKongIM/pkg/plugin"
)

type SensitiveWordPlugin struct{}

func (p *SensitiveWordPlugin) OnMessage(msg *plugin.Message) error {
    // æ£€æŸ¥æ•æ„Ÿè¯
    if containsSensitiveWord(msg.Content) {
        return errors.New("message contains sensitive word")
    }
    return nil
}

func main() {
    plugin.Register(&SensitiveWordPlugin{})
}
```

---

## ğŸ¯ åˆå§‹åŒ–é¡ºåºæ€»ç»“

### **ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªé¡ºåºï¼Ÿ**

```
1. é…ç½®æ£€æŸ¥
   â†“ ï¼ˆå¿…é¡»å…ˆéªŒè¯é…ç½®ï¼‰
2. äº‹ä»¶æ± 
   â†“ ï¼ˆæ ¸å¿ƒï¼Œå…¶ä»–ç»„ä»¶ä¾èµ–å®ƒï¼‰
3. ç›‘æ§è¿½è¸ª
   â†“ ï¼ˆè¶Šæ—©å¯åŠ¨è¶Šå¥½ï¼Œç›‘æ§æ‰€æœ‰ç»„ä»¶ï¼‰
4. ç½‘ç»œå¼•æ“
   â†“ ï¼ˆéœ€è¦äº‹ä»¶æ± æ¥åˆ†å‘ç½‘ç»œäº‹ä»¶ï¼‰
5. æµå¼æ¶ˆæ¯ç¼“å­˜
   â†“ ï¼ˆç‹¬ç«‹ç»„ä»¶ï¼Œæ— ä¾èµ–ï¼‰
6. ç®¡ç†å™¨
   â†“ ï¼ˆä¸šåŠ¡é€»è¾‘ç»„ä»¶ï¼‰
7. é›†ç¾¤æœåŠ¡å™¨
   â†“ ï¼ˆä¾èµ–å­˜å‚¨ã€ç½‘ç»œï¼‰
8. API æœåŠ¡å™¨
   â†“ ï¼ˆä¾èµ–æ‰€æœ‰ä¸šåŠ¡ç»„ä»¶ï¼‰
9. æ’ä»¶æœåŠ¡å™¨
   â†“ ï¼ˆæ‰©å±•ï¼Œæœ€ååˆå§‹åŒ–ï¼‰
```

---

### **ä¾èµ–å…³ç³»å›¾**

```
é…ç½®é€‰é¡¹ (Options)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           äº‹ä»¶æ± ï¼ˆEventPoolï¼‰              â”‚ â† æ ¸å¿ƒ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“                      â†“
ç½‘ç»œå¼•æ“                ç®¡ç†å™¨
(wknet.Engine)         (Managers)
    â†“                      â†“
é›†ç¾¤æœåŠ¡å™¨ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
(ClusterServer)
    â†“
API æœåŠ¡å™¨
(APIServer)
    â†“
æ’ä»¶æœåŠ¡å™¨
(PluginServer)
```

---

## ğŸ“ æœ¬èŠ‚è¦ç‚¹

âœ… `Server.New()` è´Ÿè´£åˆå§‹åŒ–æ‰€æœ‰æ ¸å¿ƒç»„ä»¶
âœ… åˆå§‹åŒ–é¡ºåºï¼šé…ç½® â†’ äº‹ä»¶æ±  â†’ ç½‘ç»œ â†’ ç®¡ç†å™¨ â†’ é›†ç¾¤ â†’ API â†’ æ’ä»¶
âœ… ä¸‰å¤§äº‹ä»¶æ± æ˜¯æ ¸å¿ƒè®¾è®¡ï¼Œæ‰€æœ‰ä¸šåŠ¡é€»è¾‘é€šè¿‡äº‹ä»¶é©±åŠ¨
âœ… ç½‘ç»œå¼•æ“ä½¿ç”¨ Reactor æ¨¡å¼ï¼Œé€šè¿‡å›è°ƒå‡½æ•°ä¸äº‹ä»¶æ± å¯¹æ¥
âœ… æ ‡ç­¾ç®¡ç†å™¨ï¼ˆTagManagerï¼‰ç”¨äºä¼˜åŒ–è®¢é˜…è€…æŸ¥è¯¢æ€§èƒ½
âœ… é›†ç¾¤æœåŠ¡å™¨é‡‡ç”¨ä¸‰å±‚ Raft æ¶æ„
âœ… ç»„ä»¶é€šè¿‡ä¾èµ–æ³¨å…¥å®ç°è§£è€¦

---

## ğŸ¯ æ€è€ƒé¢˜

1. **ä¸ºä»€ä¹ˆäº‹ä»¶æ± å¿…é¡»æœ€å…ˆåˆå§‹åŒ–ï¼Ÿ**
   - æç¤ºï¼šå…¶ä»–ç»„ä»¶å¦‚ä½•ä¸äº‹ä»¶æ± äº¤äº’ï¼Ÿ

2. **TagManager çš„åˆ†ç‰‡è®¾è®¡æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ**
   - æç¤ºï¼šé”ç«äº‰ã€å¹¶å‘æ€§èƒ½

3. **é›†ç¾¤æ¨¡å¼ä¸‹ï¼ŒSlot å’Œ Channel åº”ç”¨å›è°ƒçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ**
   - æç¤ºï¼šRaft å…±è¯† â†’ åº”ç”¨æ—¥å¿—

---

**ä¸‹ä¸€èŠ‚é¢„å‘Š**ï¼š**2.3 å¯åŠ¨æµç¨‹ - Server.Start()** - æ·±å…¥ `Server.Start()` å‡½æ•°ï¼Œçœ‹çœ‹å¦‚ä½•å¯åŠ¨æ‰€æœ‰å­ç³»ç»Ÿã€æ³¨å†Œè·¯ç”±ã€å¼€å§‹ç›‘å¬ç«¯å£ã€‚ğŸš€
