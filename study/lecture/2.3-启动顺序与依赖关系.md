# 2.3 å¯åŠ¨é¡ºåºä¸ä¾èµ–å…³ç³»

> **æœ¬èŠ‚ç›®æ ‡**ï¼šæ·±å…¥ç†è§£ WuKongIM å„ç»„ä»¶çš„å¯åŠ¨é¡ºåºã€ä¾èµ–å…³ç³»ä»¥åŠä¼˜é›…å…³é—­æœºåˆ¶

---

## ğŸ“‹ ç›®å½•
1. [å¯åŠ¨é¡ºåºæ¦‚è§ˆ](#å¯åŠ¨é¡ºåºæ¦‚è§ˆ)
2. [å¯åŠ¨æµç¨‹è¯¦è§£](#å¯åŠ¨æµç¨‹è¯¦è§£)
3. [ä¾èµ–å…³ç³»åˆ†æ](#ä¾èµ–å…³ç³»åˆ†æ)
4. [ä¼˜é›…å…³é—­æœºåˆ¶](#ä¼˜é›…å…³é—­æœºåˆ¶)
5. [å¯åŠ¨ä¼˜åŒ–æŠ€å·§](#å¯åŠ¨ä¼˜åŒ–æŠ€å·§)

---

## 1ï¸âƒ£ å¯åŠ¨é¡ºåºæ¦‚è§ˆ

### **å®Œæ•´å¯åŠ¨åºåˆ—**

> **ä»£ç ä½ç½®**ï¼š`internal/server/server.go:287-380`

```
Start() æ–¹æ³•æ‰§è¡Œé¡ºåºï¼š
â”œâ”€ 1. printEnhancedBanner()           # æ‰“å°å¯åŠ¨æ¨ªå¹…
â”œâ”€ 2. commonService.Start()           # é€šç”¨æœåŠ¡ï¼ˆåˆ†å¸ƒå¼é”ã€æ¶ˆæ¯IDç”Ÿæˆå™¨ç­‰ï¼‰
â”œâ”€ 3. StreamCache è‡ªåŠ¨å¯åŠ¨            # æµå¼æ¶ˆæ¯ç¼“å­˜ï¼ˆæ— éœ€æ˜¾å¼å¯åŠ¨ï¼‰
â”œâ”€ 4. ingress.SetRoutes()             # è®¾ç½®å†…éƒ¨è·¯ç”±ï¼ˆèŠ‚ç‚¹é—´é€šä¿¡ï¼‰
â”œâ”€ 5. retryManager.Start()            # é‡è¯•ç®¡ç†å™¨
â”œâ”€ 6. tagManager.Start()              # æ ‡ç­¾ç®¡ç†å™¨
â”œâ”€ 7. trace.Start()                   # è¿½è¸ªç³»ç»Ÿ
â”œâ”€ 8. clusterServer.Start()           # é›†ç¾¤æœåŠ¡å™¨ â­â­â­
â”œâ”€ 9. engine å›è°ƒæ³¨å†Œ                  # ç½‘ç»œå¼•æ“å›è°ƒï¼ˆonConnectã€onDataã€onCloseï¼‰
â”œâ”€ 10. engine.Start()                 # ç½‘ç»œå¼•æ“å¯åŠ¨ â­â­
â”œâ”€ 11. demoServer.Start()             # DemoæœåŠ¡å™¨ï¼ˆå¯é€‰ï¼‰
â”œâ”€ 12. conversationManager.Start()    # ä¼šè¯ç®¡ç†å™¨ï¼ˆå¯é€‰ï¼‰
â”œâ”€ 13. webhook.Start()                # WebhookæœåŠ¡
â”œâ”€ 14. apiServer.Start()              # APIæœåŠ¡å™¨ â­
â”œâ”€ 15. userEventPool.Start()          # ç”¨æˆ·äº‹ä»¶æ±  â­
â”œâ”€ 16. channelEventPool.Start()       # é¢‘é“äº‹ä»¶æ±  â­
â”œâ”€ 17. pushEventPool.Start()          # æ¨é€äº‹ä»¶æ±  â­
â””â”€ 18. pluginServer.Start()           # æ’ä»¶æœåŠ¡å™¨
```

---

## 2ï¸âƒ£ å¯åŠ¨æµç¨‹è¯¦è§£

### **A. é€šç”¨æœåŠ¡å¯åŠ¨**ï¼ˆLine 300ï¼‰

```go
err = s.commonService.Start()
```

**èŒè´£**ï¼š
- åˆ†å¸ƒå¼æ¶ˆæ¯IDç”Ÿæˆå™¨
- åˆ†å¸ƒå¼é”æœåŠ¡
- é€šç”¨å·¥å…·æœåŠ¡

**ä¸ºä»€ä¹ˆæœ€å…ˆå¯åŠ¨ï¼Ÿ**
- å…¶ä»–ç»„ä»¶å¯èƒ½ä¾èµ–æ¶ˆæ¯IDç”Ÿæˆ
- åˆ†å¸ƒå¼é”æ˜¯åŸºç¡€è®¾æ–½æœåŠ¡

---

### **B. StreamCache åˆå§‹åŒ–**ï¼ˆLine 306ï¼‰

```go
s.Debug("StreamCache initialized and ready")
```

**ç‰¹ç‚¹**ï¼š
- **è‡ªåŠ¨å¯åŠ¨**ï¼šåœ¨åˆ›å»ºæ—¶å·²ç»å¯åŠ¨ï¼Œæ— éœ€æ˜¾å¼è°ƒç”¨ Start()
- **ç”¨é€”**ï¼šç¼“å­˜æµå¼æ¶ˆæ¯ï¼ˆå¦‚ AI å¯¹è¯ï¼‰
- **å®ç°**ï¼š`pkg/wkcache/`

**ä¸ºä»€ä¹ˆè‡ªåŠ¨å¯åŠ¨ï¼Ÿ**
- æµå¼æ¶ˆæ¯éœ€è¦ç«‹å³å¯ç”¨
- é¿å…å¯åŠ¨é¡ºåºä¾èµ–é—®é¢˜

---

### **C. Ingress è·¯ç”±è®¾ç½®**ï¼ˆLine 308ï¼‰

```go
s.ingress.SetRoutes()
```

**ä½œç”¨**ï¼šæ³¨å†ŒèŠ‚ç‚¹é—´é€šä¿¡è·¯ç”±

**è·¯ç”±ç±»å‹**ï¼š
```go
// internal/ingress/ingress.go
func (i *Ingress) SetRoutes() {
    i.r.POST("/sync", i.handleSync)           // åŒæ­¥è¯·æ±‚
    i.r.POST("/forward", i.handleForward)     // è½¬å‘è¯·æ±‚
    i.r.POST("/propose", i.handlePropose)     // Raftæè®®
    i.r.POST("/apply", i.handleApply)         // Raftåº”ç”¨
    // ... æ›´å¤šå†…éƒ¨è·¯ç”±
}
```

**ä¸ºä»€ä¹ˆåœ¨é›†ç¾¤å¯åŠ¨å‰è®¾ç½®ï¼Ÿ**
- é›†ç¾¤å¯åŠ¨åå¯èƒ½ç«‹å³äº§ç”ŸèŠ‚ç‚¹é—´é€šä¿¡
- è·¯ç”±å¿…é¡»æå‰å°±ç»ª

---

### **D. ç®¡ç†å™¨å¯åŠ¨**ï¼ˆLines 311-318ï¼‰

#### **1. é‡è¯•ç®¡ç†å™¨**

```go
if err = s.retryManager.Start(); err != nil {
    return err
}
```

**èŒè´£**ï¼š
- ç®¡ç†æ¶ˆæ¯å‘é€å¤±è´¥é‡è¯•é˜Ÿåˆ—
- å®šæ—¶æ‰«æå¹¶é‡æ–°å‘é€å¤±è´¥æ¶ˆæ¯

**å¯åŠ¨å†…å®¹**ï¼š
- å¯åŠ¨å®šæ—¶å™¨ï¼ˆTickerï¼‰
- å¯åŠ¨é‡è¯•å·¥ä½œåç¨‹

---

#### **2. æ ‡ç­¾ç®¡ç†å™¨**

```go
if err = s.tagManager.Start(); err != nil {
    return err
}
```

**èŒè´£**ï¼š
- ç®¡ç†è®¢é˜…è€…æ ‡ç­¾ï¼ˆç”¨äºæ¶ˆæ¯åˆ†å‘ä¼˜åŒ–ï¼‰
- å¯åŠ¨ç¼“å­˜æ¸…ç†å®šæ—¶å™¨

**å¯åŠ¨å†…å®¹**ï¼š
- åˆå§‹åŒ–åˆ†ç‰‡é”
- å¯åŠ¨è¿‡æœŸç¼“å­˜æ¸…ç†ä»»åŠ¡

---

### **E. è¿½è¸ªç³»ç»Ÿå¯åŠ¨**ï¼ˆLine 320ï¼‰

```go
err = s.trace.Start()
```

**èŒè´£**ï¼š
- æ€§èƒ½è¿½è¸ª
- æŒ‡æ ‡æ”¶é›†
- Prometheus æš´éœ²

**å¯åŠ¨å†…å®¹**ï¼š
- å¯åŠ¨ Prometheus HTTP æœåŠ¡å™¨
- åˆå§‹åŒ–æŒ‡æ ‡æ”¶é›†å™¨
- å¯åŠ¨è¿½è¸ªæ•°æ®åˆ·æ–°åç¨‹

---

### **F. é›†ç¾¤æœåŠ¡å™¨å¯åŠ¨** â­â­â­ï¼ˆLine 326ï¼‰

```go
err = s.clusterServer.Start()
```

**èŒè´£**ï¼šå¯åŠ¨åˆ†å¸ƒå¼é›†ç¾¤æ ¸å¿ƒåŠŸèƒ½

**å¯åŠ¨å†…å®¹**ï¼š
1. **ConfigServer å¯åŠ¨**ï¼ˆNode Raftï¼‰
   - åŠ è½½é›†ç¾¤é…ç½®
   - å¯åŠ¨ Node Raft ç»„
   - é€‰ä¸¾æˆ–åŠ å…¥é›†ç¾¤

2. **SlotServer å¯åŠ¨**ï¼ˆSlot Raftï¼‰
   - åˆ›å»ºæ§½ä½ Raft ç»„ï¼ˆ1024ä¸ªï¼‰
   - åŠ è½½æ§½ä½æ•°æ®
   - å¯åŠ¨æ§½ä½ç®¡ç†åç¨‹

3. **ChannelServer å¯åŠ¨**ï¼ˆChannel Raftï¼‰
   - å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…é¢‘é“æ¿€æ´»
   - åŠ¨æ€åˆ›å»ºé¢‘é“ Raft ç»„

**ä¸ºä»€ä¹ˆåœ¨ç½‘ç»œå¼•æ“å¯åŠ¨å‰ï¼Ÿ**
- é›†ç¾¤å…ƒæ•°æ®éœ€è¦å…ˆåŠ è½½
- èŠ‚ç‚¹è§’è‰²éœ€è¦å…ˆç¡®å®š
- é¿å…å®¢æˆ·ç«¯è¿æ¥æ—¶é›†ç¾¤æœªå°±ç»ª

---

### **G. ç½‘ç»œå¼•æ“å¯åŠ¨** â­â­ï¼ˆLines 331-338ï¼‰

#### **1. æ³¨å†Œå›è°ƒå‡½æ•°**ï¼ˆLines 331-333ï¼‰

```go
s.engine.OnConnect(s.onConnect)  // è¿æ¥å»ºç«‹å›è°ƒ
s.engine.OnData(s.onData)        // æ•°æ®åˆ°è¾¾å›è°ƒ
s.engine.OnClose(s.onClose)      // è¿æ¥å…³é—­å›è°ƒ
```

**ä¸ºä»€ä¹ˆå…ˆæ³¨å†Œå›è°ƒå†å¯åŠ¨ï¼Ÿ**
- å¯åŠ¨åå¯èƒ½ç«‹å³æœ‰è¿æ¥è¿›æ¥
- å›è°ƒå‡½æ•°å¿…é¡»æå‰æ³¨å†Œå¥½

---

#### **2. å¯åŠ¨ç½‘ç»œå¼•æ“**ï¼ˆLine 335ï¼‰

```go
err = s.engine.Start()
```

**å¯åŠ¨å†…å®¹**ï¼š
1. å¯åŠ¨ **MainReactor**ï¼ˆAccept æ–°è¿æ¥ï¼‰
2. å¯åŠ¨ **SubReactor æ•°ç»„**ï¼ˆå¤„ç† I/O äº‹ä»¶ï¼‰
3. ç»‘å®šç›‘å¬ç«¯å£ï¼ˆTCPã€WebSocketï¼‰
4. å¯åŠ¨æ—¶é—´è½®å®šæ—¶å™¨ï¼ˆTimingWheelï¼‰

**å…³é”®æ—¥å¿—**ï¼š
```
[wknet] MainReactor started
[wknet] SubReactor[0] started
[wknet] SubReactor[1] started
...
[wknet] Listening on tcp://0.0.0.0:5100
[wknet] Listening on ws://0.0.0.0:5200
```

---

### **H. Demo æœåŠ¡å™¨å¯åŠ¨**ï¼ˆLines 340-342ï¼‰

```go
if s.opts.Demo.On {
    s.demoServer.Start()
}
```

**èŒè´£**ï¼š
- æä¾›æ¼”ç¤ºèŠå¤©ç•Œé¢
- ç”¨äºå¿«é€Ÿä½“éªŒå’Œæµ‹è¯•

**é»˜è®¤åœ°å€**ï¼š`http://localhost:5172/chatdemo`

**å¯é€‰å¯åŠ¨**ï¼šé€šè¿‡é…ç½®æ§åˆ¶

---

### **I. ä¼šè¯ç®¡ç†å™¨å¯åŠ¨**ï¼ˆLines 344-349ï¼‰

```go
if s.opts.Conversation.On {
    err = s.conversationManager.Start()
}
```

**èŒè´£**ï¼š
- ç»´æŠ¤ç”¨æˆ·æœ€è¿‘ä¼šè¯åˆ—è¡¨
- æ›´æ–°æœªè¯»æ•°
- åŒæ­¥ä¼šè¯çŠ¶æ€

**å¯åŠ¨å†…å®¹**ï¼š
- å¯åŠ¨ä¼šè¯æ›´æ–°åç¨‹
- å¯åŠ¨ä¼šè¯ç¼“å­˜æ¸…ç†å®šæ—¶å™¨

**å¯é€‰å¯åŠ¨**ï¼šé€šè¿‡é…ç½® `conversation.on` æ§åˆ¶

---

### **J. Webhook æœåŠ¡å¯åŠ¨**ï¼ˆLines 351-354ï¼‰

```go
err = s.webhook.Start()
if err != nil {
    s.Panic("webhook start error", zap.Error(err))
}
```

**èŒè´£**ï¼š
- å›è°ƒä¸šåŠ¡æœåŠ¡å™¨ï¼ˆå¦‚æ¶ˆæ¯å‘é€å‰ã€å‘é€åï¼‰
- æ‰©å±•ç‚¹æœºåˆ¶

**å¯åŠ¨å†…å®¹**ï¼š
- å¯åŠ¨ HTTP å®¢æˆ·ç«¯æ± 
- å¯åŠ¨å›è°ƒé˜Ÿåˆ—å¤„ç†åç¨‹
- åŠ è½½ Webhook é…ç½®

**æ³¨æ„**ï¼šWebhook å¯åŠ¨å¤±è´¥ä¼šå¯¼è‡´æ•´ä¸ªæœåŠ¡ Panic

---

### **K. API æœåŠ¡å™¨å¯åŠ¨**ï¼ˆLine 356ï¼‰

```go
if err = s.apiServer.Start(); err != nil {
    return err
}
```

**èŒè´£**ï¼š
- æä¾› HTTP RESTful API
- æ³¨å†Œæ‰€æœ‰æ¨¡å—è·¯ç”±

**å¯åŠ¨å†…å®¹**ï¼š
- å¯åŠ¨ HTTP æœåŠ¡å™¨ï¼ˆé»˜è®¤ç«¯å£ 5001ï¼‰
- æ³¨å†Œè·¯ç”±ï¼ˆæ¶ˆæ¯ã€é¢‘é“ã€ç”¨æˆ·ç­‰ï¼‰
- å¯åŠ¨ Swagger æ–‡æ¡£æœåŠ¡

**å…³é”®æ—¥å¿—**ï¼š
```
[ApiServer] started, addr=0.0.0.0:5001
```

---

### **L. äº‹ä»¶æ± å¯åŠ¨** â­ï¼ˆLines 360-373ï¼‰

#### **1. ç”¨æˆ·äº‹ä»¶æ± **

```go
err = s.userEventPool.Start()
```

**èŒè´£**ï¼šå¤„ç†ç”¨æˆ·è¿æ¥ç›¸å…³äº‹ä»¶

**å¯åŠ¨å†…å®¹**ï¼š
- å¯åŠ¨äº‹ä»¶å¤„ç†åç¨‹ï¼ˆPool Workerï¼‰
- å¯åŠ¨äº‹ä»¶é˜Ÿåˆ—æ¶ˆè´¹è€…

---

#### **2. é¢‘é“äº‹ä»¶æ± **

```go
err = s.channelEventPool.Start()
```

**èŒè´£**ï¼šå¤„ç†é¢‘é“æ¶ˆæ¯ç›¸å…³äº‹ä»¶

**å¯åŠ¨å†…å®¹**ï¼š
- å¯åŠ¨äº‹ä»¶å¤„ç†åç¨‹
- å¯åŠ¨é¢‘é“é˜Ÿåˆ—æ¶ˆè´¹è€…

---

#### **3. æ¨é€äº‹ä»¶æ± **

```go
err = s.pushEventPool.Start()
```

**èŒè´£**ï¼šå¤„ç†æ¶ˆæ¯æ¨é€ç›¸å…³äº‹ä»¶

**å¯åŠ¨å†…å®¹**ï¼š
- å¯åŠ¨æ¨é€å¤„ç†åç¨‹
- å¯åŠ¨æ¨é€é˜Ÿåˆ—æ¶ˆè´¹è€…

**ä¸ºä»€ä¹ˆäº‹ä»¶æ± æœ€åå¯åŠ¨ï¼Ÿ**
- ä¾èµ–ç½‘ç»œå¼•æ“ï¼ˆéœ€è¦è¿æ¥å·²å»ºç«‹ï¼‰
- ä¾èµ–é›†ç¾¤æœåŠ¡ï¼ˆéœ€è¦è·¯ç”±ä¿¡æ¯ï¼‰
- ä¾èµ– API æœåŠ¡ï¼ˆéœ€è¦ Webhook å›è°ƒï¼‰

---

### **M. æ’ä»¶æœåŠ¡å™¨å¯åŠ¨**ï¼ˆLines 375-378ï¼‰

```go
err = s.pluginServer.Start()
```

**èŒè´£**ï¼š
- åŠ è½½å’Œç®¡ç†æ’ä»¶
- æä¾›æ’ä»¶è°ƒç”¨æ¥å£

**å¯åŠ¨å†…å®¹**ï¼š
- æ‰«ææ’ä»¶ç›®å½•
- åŠ è½½æ’ä»¶é…ç½®
- å¯åŠ¨æ’ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†

**ä¸ºä»€ä¹ˆæœ€åå¯åŠ¨ï¼Ÿ**
- æ’ä»¶å¯èƒ½ä¾èµ–æ‰€æœ‰æœåŠ¡å·²å°±ç»ª
- æ’ä»¶æ˜¯æ‰©å±•åŠŸèƒ½ï¼Œä¸å½±å“æ ¸å¿ƒå¯åŠ¨

---

## 3ï¸âƒ£ ä¾èµ–å…³ç³»åˆ†æ

### **ä¾èµ–å±‚æ¬¡å›¾**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 5: æ‰©å±•å±‚                                 â”‚
â”‚  â”œâ”€ pluginServer                                â”‚
â”‚  â””â”€ demoServer                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†‘ ä¾èµ–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 4: äº‹ä»¶å¤„ç†å±‚                             â”‚
â”‚  â”œâ”€ userEventPool                               â”‚
â”‚  â”œâ”€ channelEventPool                            â”‚
â”‚  â””â”€ pushEventPool                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†‘ ä¾èµ–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: æœåŠ¡å±‚                                 â”‚
â”‚  â”œâ”€ apiServer                                   â”‚
â”‚  â”œâ”€ webhook                                     â”‚
â”‚  â””â”€ conversationManager                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†‘ ä¾èµ–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 2: æ ¸å¿ƒå±‚                                 â”‚
â”‚  â”œâ”€ engineï¼ˆç½‘ç»œå¼•æ“ï¼‰                           â”‚
â”‚  â””â”€ clusterServerï¼ˆé›†ç¾¤æœåŠ¡ï¼‰                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†‘ ä¾èµ–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: åŸºç¡€è®¾æ–½å±‚                             â”‚
â”‚  â”œâ”€ commonService                               â”‚
â”‚  â”œâ”€ retryManager                                â”‚
â”‚  â”œâ”€ tagManager                                  â”‚
â”‚  â”œâ”€ trace                                       â”‚
â”‚  â””â”€ ingressï¼ˆå†…éƒ¨è·¯ç”±ï¼‰                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **å…³é”®ä¾èµ–å…³ç³»**

| ç»„ä»¶ | ä¾èµ–çš„ç»„ä»¶ | ä¾èµ–åŸå›  |
|------|----------|---------|
| **engine** | clusterServer | éœ€è¦çŸ¥é“èŠ‚ç‚¹è§’è‰²å’Œè·¯ç”±ä¿¡æ¯ |
| **apiServer** | engine, clusterServer | APIéœ€è¦æŸ¥è¯¢é›†ç¾¤çŠ¶æ€ã€è½¬å‘è¯·æ±‚ |
| **userEventPool** | engine, clusterServer | å¤„ç†è¿æ¥äº‹ä»¶éœ€è¦ç½‘ç»œå’Œé›†ç¾¤ä¿¡æ¯ |
| **channelEventPool** | clusterServer, webhook | æ¶ˆæ¯å¤„ç†éœ€è¦é›†ç¾¤å…±è¯†å’Œä¸šåŠ¡å›è°ƒ |
| **pushEventPool** | engine, channelEventPool | æ¨é€ä¾èµ–è¿æ¥ç®¡ç†å’Œæ¶ˆæ¯å¤„ç† |
| **webhook** | æ—  | ç‹¬ç«‹çš„å›è°ƒæœåŠ¡ |
| **pluginServer** | æ‰€æœ‰æœåŠ¡ | æ’ä»¶å¯èƒ½è®¿é—®ä»»ä½•æœåŠ¡ |

---

### **å¯åŠ¨é¡ºåºçš„å¿…è¦æ€§åˆ†æ**

#### **ä¸ºä»€ä¹ˆ clusterServer è¦åœ¨ engine ä¹‹å‰ï¼Ÿ**

```
åœºæ™¯ï¼šå®¢æˆ·ç«¯è¿æ¥è¿›æ¥
â”œâ”€ engine.onConnect() è§¦å‘
â”œâ”€ æŸ¥è¯¢ç”¨æˆ·æ‰€åœ¨èŠ‚ç‚¹ï¼ˆéœ€è¦é›†ç¾¤è·¯ç”±ä¿¡æ¯ï¼‰
â””â”€ å¦‚æœé›†ç¾¤æœªå°±ç»ª â†’ è¿æ¥å¤±è´¥ âŒ
```

**ç»“è®º**ï¼šé›†ç¾¤å¿…é¡»å…ˆå¯åŠ¨ï¼Œç½‘ç»œå¼•æ“æ‰èƒ½æ­£ç¡®è·¯ç”±è¯·æ±‚

---

#### **ä¸ºä»€ä¹ˆäº‹ä»¶æ± æœ€åå¯åŠ¨ï¼Ÿ**

```
åœºæ™¯ï¼šæ¶ˆæ¯å‘é€
â”œâ”€ userEventPool æ¥æ”¶ EventOnSend
â”œâ”€ éœ€è¦è°ƒç”¨ Webhook â†’ webhook å¿…é¡»å·²å¯åŠ¨
â”œâ”€ éœ€è¦ Raft å…±è¯† â†’ clusterServer å¿…é¡»å·²å¯åŠ¨
â”œâ”€ éœ€è¦æ¨é€æ¶ˆæ¯ â†’ engine å¿…é¡»å·²å¯åŠ¨
â””â”€ æ‰€æœ‰ä¾èµ–éƒ½å°±ç»ªï¼Œæ‰èƒ½æ­£å¸¸å¤„ç†
```

**ç»“è®º**ï¼šäº‹ä»¶æ± ä¾èµ–å‡ ä¹æ‰€æœ‰æœåŠ¡ï¼Œå¿…é¡»æœ€åå¯åŠ¨

---

## 4ï¸âƒ£ ä¼˜é›…å…³é—­æœºåˆ¶

### **A. åœæ­¢é¡ºåº**ï¼ˆ`server.go:390-436`ï¼‰

```go
func (s *Server) Stop() error {
    // 1. å–æ¶ˆä¸Šä¸‹æ–‡ï¼ˆé€šçŸ¥æ‰€æœ‰åç¨‹é€€å‡ºï¼‰
    s.cancel()

    // 2. åœæ­¢æ‰©å±•å±‚
    s.pluginServer.Stop()

    // 3. åœæ­¢äº‹ä»¶å¤„ç†å±‚
    s.userEventPool.Stop()
    s.channelEventPool.Stop()
    s.pushEventPool.Stop()

    // 4. åœæ­¢æœåŠ¡å±‚
    s.apiServer.Stop()
    s.retryManager.Stop()
    s.commonService.Stop()

    // 5. å…³é—­ç¼“å­˜
    if s.streamCache != nil {
        s.streamCache.Close()
    }

    // 6. åœæ­¢ä¼šè¯ç®¡ç†
    if s.opts.Conversation.On {
        s.conversationManager.Stop()
    }

    // 7. åœæ­¢é›†ç¾¤æœåŠ¡
    s.clusterServer.Stop()

    // 8. åœæ­¢DemoæœåŠ¡
    if s.opts.Demo.On {
        s.demoServer.Stop()
    }

    // 9. åœæ­¢ç½‘ç»œå¼•æ“
    err := s.engine.Stop()

    // 10. åœæ­¢è¿½è¸ªç³»ç»Ÿ
    s.trace.Stop()

    // 11. åœæ­¢æ ‡ç­¾ç®¡ç†
    s.tagManager.Stop()

    // 12. åœæ­¢Webhook
    s.webhook.Stop()

    s.Info("Server is stopped")
    return nil
}
```

---

### **B. åœæ­¢é¡ºåºåŸåˆ™**

**åŸåˆ™**ï¼š**ä¸å¯åŠ¨é¡ºåºç›¸å**

```
å¯åŠ¨ï¼šåŸºç¡€è®¾æ–½ â†’ æ ¸å¿ƒå±‚ â†’ æœåŠ¡å±‚ â†’ äº‹ä»¶å¤„ç†å±‚ â†’ æ‰©å±•å±‚
åœæ­¢ï¼šæ‰©å±•å±‚ â†’ äº‹ä»¶å¤„ç†å±‚ â†’ æœåŠ¡å±‚ â†’ æ ¸å¿ƒå±‚ â†’ åŸºç¡€è®¾æ–½
```

**ä¸ºä»€ä¹ˆå€’åºåœæ­¢ï¼Ÿ**

1. **å…ˆåœæ­¢æ¶ˆè´¹è€…ï¼Œå†åœæ­¢ç”Ÿäº§è€…**
   - å…ˆåœæ­¢äº‹ä»¶æ± ï¼ˆæ¶ˆè´¹è€…ï¼‰
   - å†åœæ­¢ç½‘ç»œå¼•æ“ï¼ˆç”Ÿäº§è€…ï¼‰
   - é¿å…æ–°äº‹ä»¶äº§ç”Ÿä½†æ— æ³•å¤„ç†

2. **å…ˆåœæ­¢å¤–éƒ¨æœåŠ¡ï¼Œå†åœæ­¢å†…éƒ¨æœåŠ¡**
   - å…ˆåœæ­¢ API æœåŠ¡å™¨ï¼ˆæ‹’ç»æ–°è¯·æ±‚ï¼‰
   - å†åœæ­¢å†…éƒ¨ä¸šåŠ¡é€»è¾‘
   - é¿å…è¯·æ±‚è¿›æ¥ä½†æ— æ³•å¤„ç†

3. **å…ˆåœæ­¢ä¸šåŠ¡é€»è¾‘ï¼Œå†åœæ­¢åŸºç¡€è®¾æ–½**
   - å…ˆåœæ­¢ä¸šåŠ¡å¤„ç†
   - æœ€ååœæ­¢é›†ç¾¤ã€å­˜å‚¨ç­‰åŸºç¡€è®¾æ–½
   - ç¡®ä¿ä¸šåŠ¡æ•°æ®å®‰å…¨è½ç›˜

---

### **C. ä¼˜é›…å…³é—­ç¤ºä¾‹ï¼šç½‘ç»œå¼•æ“**

```go
// pkg/wknet/engine.go
func (e *Engine) Stop() error {
    e.Info("Stopping engine...")

    // 1. åœæ­¢æ¥å—æ–°è¿æ¥
    e.mainReactor.Stop()

    // 2. ç­‰å¾…ç°æœ‰è¿æ¥å¤„ç†å®Œæˆ
    e.waitExistingConnections()

    // 3. åœæ­¢æ‰€æœ‰ SubReactor
    for _, sub := range e.subReactors {
        sub.Stop()
    }

    // 4. å…³é—­æ‰€æœ‰è¿æ¥
    e.closeAllConnections()

    // 5. åœæ­¢æ—¶é—´è½®
    e.timingWheel.Stop()

    e.Info("Engine stopped")
    return nil
}
```

**å…³é”®ç‚¹**ï¼š
- å…ˆæ‹’ç»æ–°è¿æ¥
- ç­‰å¾…ç°æœ‰è¿æ¥ä¼˜é›…å…³é—­
- æœ€åæ¸…ç†èµ„æº

---

### **D. Context å–æ¶ˆæœºåˆ¶**

```go
// åˆ›å»ºå¯å–æ¶ˆçš„ä¸Šä¸‹æ–‡
s.ctx, s.cancel = context.WithCancel(context.Background())

// å„ç»„ä»¶ç›‘å¬å–æ¶ˆä¿¡å·
func (w *Worker) Run(ctx context.Context) {
    for {
        select {
        case <-ctx.Done():
            // æ”¶åˆ°å–æ¶ˆä¿¡å·ï¼Œé€€å‡º
            return
        case event := <-w.queue:
            // å¤„ç†äº‹ä»¶
            w.handle(event)
        }
    }
}

// åœæ­¢æ—¶è°ƒç”¨ cancel()
s.cancel()  // é€šçŸ¥æ‰€æœ‰åç¨‹é€€å‡º
```

**ä¼˜ç‚¹**ï¼š
- ç»Ÿä¸€çš„é€€å‡ºä¿¡å·
- åç¨‹å¯ä»¥æ„ŸçŸ¥åœæ­¢è¯·æ±‚
- é¿å…æš´åŠ›æ€æ­»åç¨‹

---

## 5ï¸âƒ£ å¯åŠ¨ä¼˜åŒ–æŠ€å·§

### **A. å¹¶è¡Œå¯åŠ¨ä¼˜åŒ–**

**å½“å‰å®ç°**ï¼ˆä¸²è¡Œï¼‰ï¼š
```go
err = s.userEventPool.Start()    // ç­‰å¾…å®Œæˆ
err = s.channelEventPool.Start() // ç­‰å¾…å®Œæˆ
err = s.pushEventPool.Start()    // ç­‰å¾…å®Œæˆ
```

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼ˆå¹¶è¡Œï¼‰ï¼š
```go
var wg sync.WaitGroup
errChan := make(chan error, 3)

// å¹¶è¡Œå¯åŠ¨ä¸‰ä¸ªäº‹ä»¶æ± 
wg.Add(3)
go func() {
    defer wg.Done()
    if err := s.userEventPool.Start(); err != nil {
        errChan <- err
    }
}()
go func() {
    defer wg.Done()
    if err := s.channelEventPool.Start(); err != nil {
        errChan <- err
    }
}()
go func() {
    defer wg.Done()
    if err := s.pushEventPool.Start(); err != nil {
        errChan <- err
    }
}()

wg.Wait()
close(errChan)

// æ£€æŸ¥é”™è¯¯
for err := range errChan {
    if err != nil {
        return err
    }
}
```

**æ”¶ç›Š**ï¼š
- å¯åŠ¨æ—¶é—´ç¼©çŸ­ 30%-50%
- é€‚ç”¨äºæ— ä¾èµ–å…³ç³»çš„ç»„ä»¶

---

### **B. å»¶è¿ŸåŠ è½½ä¼˜åŒ–**

**åœºæ™¯**ï¼šæŸäº›ç»„ä»¶å¯èƒ½ä¸ä¼šç«‹å³ä½¿ç”¨

**ç¤ºä¾‹**ï¼š
```go
// âŒ ç«‹å³å¯åŠ¨æ‰€æœ‰æ’ä»¶
for _, plugin := range s.plugins {
    plugin.Start()  // å¯èƒ½å¾ˆæ…¢
}

// âœ… å»¶è¿ŸåŠ è½½
for _, plugin := range s.plugins {
    go plugin.LazyStart()  // åå°å¼‚æ­¥å¯åŠ¨
}
```

---

### **C. å¥åº·æ£€æŸ¥ä¼˜åŒ–**

**å¯åŠ¨å¥åº·æ£€æŸ¥**ï¼š
```go
func (s *Server) WaitReady(timeout time.Duration) error {
    ctx, cancel := context.WithTimeout(context.Background(), timeout)
    defer cancel()

    ticker := time.NewTicker(100 * time.Millisecond)
    defer ticker.Stop()

    for {
        select {
        case <-ctx.Done():
            return errors.New("startup timeout")
        case <-ticker.C:
            if s.isReady() {
                return nil
            }
        }
    }
}

func (s *Server) isReady() bool {
    return s.engine.IsRunning() &&
           s.clusterServer.IsReady() &&
           s.apiServer.IsRunning()
}
```

**ç”¨é€”**ï¼š
- ç­‰å¾…æ‰€æœ‰ç»„ä»¶å°±ç»ªåå†å¯¹å¤–æœåŠ¡
- é¿å…åŠå¯åŠ¨çŠ¶æ€æ¥å—è¯·æ±‚

---

### **D. å¯åŠ¨è¶…æ—¶æœºåˆ¶**

```go
func (s *Server) StartWithTimeout(timeout time.Duration) error {
    done := make(chan error, 1)

    go func() {
        done <- s.Start()
    }()

    select {
    case err := <-done:
        return err
    case <-time.After(timeout):
        return fmt.Errorf("startup timeout after %v", timeout)
    }
}
```

**ç”¨é€”**ï¼š
- é˜²æ­¢æŸä¸ªç»„ä»¶å¡ä½å¯¼è‡´æ•´ä½“æ— æ³•å¯åŠ¨
- å¿«é€Ÿå¤±è´¥ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜

---

## 6ï¸âƒ£ å¯åŠ¨å¤±è´¥å¤„ç†

### **A. é”™è¯¯ä¼ æ’­**

```go
func (s *Server) Start() error {
    // æ¯ä¸€æ­¥éƒ½æ£€æŸ¥é”™è¯¯
    if err := s.commonService.Start(); err != nil {
        return fmt.Errorf("commonService start failed: %w", err)
    }

    if err := s.clusterServer.Start(); err != nil {
        return fmt.Errorf("clusterServer start failed: %w", err)
    }

    // ... å…¶ä»–ç»„ä»¶
}
```

**ä¼˜ç‚¹**ï¼š
- æ˜ç¡®çŸ¥é“å“ªä¸ªç»„ä»¶å¯åŠ¨å¤±è´¥
- ä¾¿äºæ—¥å¿—æ’æŸ¥

---

### **B. å›æ»šæœºåˆ¶**

```go
func (s *Server) Start() error {
    started := []string{}

    defer func() {
        if r := recover(); r != nil {
            // å¯åŠ¨å¤±è´¥ï¼Œå›æ»šå·²å¯åŠ¨çš„ç»„ä»¶
            s.rollback(started)
        }
    }()

    if err := s.commonService.Start(); err != nil {
        return err
    }
    started = append(started, "commonService")

    if err := s.clusterServer.Start(); err != nil {
        s.rollback(started)  // å›æ»šå·²å¯åŠ¨çš„ç»„ä»¶
        return err
    }
    started = append(started, "clusterServer")

    // ... å…¶ä»–ç»„ä»¶
}

func (s *Server) rollback(started []string) {
    for i := len(started) - 1; i >= 0; i-- {
        switch started[i] {
        case "commonService":
            s.commonService.Stop()
        case "clusterServer":
            s.clusterServer.Stop()
        // ... å…¶ä»–ç»„ä»¶
        }
    }
}
```

**ç”¨é€”**ï¼š
- å¯åŠ¨å¤±è´¥æ—¶æ¸…ç†å·²å¯åŠ¨çš„ç»„ä»¶
- é¿å…èµ„æºæ³„æ¼

---

### **C. é‡è¯•æœºåˆ¶**

```go
func (s *Server) StartWithRetry(maxRetries int) error {
    for i := 0; i < maxRetries; i++ {
        err := s.Start()
        if err == nil {
            return nil
        }

        s.Warn("Start failed, retrying...",
            zap.Int("attempt", i+1),
            zap.Error(err))

        time.Sleep(time.Second * time.Duration(i+1))
    }
    return fmt.Errorf("start failed after %d retries", maxRetries)
}
```

**é€‚ç”¨åœºæ™¯**ï¼š
- ä¸´æ—¶æ€§ç½‘ç»œé—®é¢˜
- ä¾èµ–æœåŠ¡æœªå°±ç»ª

---

## 7ï¸âƒ£ å¯åŠ¨æ€§èƒ½åˆ†æ

### **å¯åŠ¨è€—æ—¶ç»Ÿè®¡**

```go
func (s *Server) Start() error {
    startTime := time.Now()

    // å„ç»„ä»¶å¯åŠ¨è€—æ—¶ç»Ÿè®¡
    componentTimes := make(map[string]time.Duration)

    t := time.Now()
    s.commonService.Start()
    componentTimes["commonService"] = time.Since(t)

    t = time.Now()
    s.clusterServer.Start()
    componentTimes["clusterServer"] = time.Since(t)

    // ... å…¶ä»–ç»„ä»¶

    // æ‰“å°è€—æ—¶ç»Ÿè®¡
    s.printStartupStats(componentTimes, time.Since(startTime))
}

func (s *Server) printStartupStats(times map[string]time.Duration, total time.Duration) {
    s.Info("=== Startup Time Statistics ===")
    for name, duration := range times {
        percentage := float64(duration) / float64(total) * 100
        s.Info(fmt.Sprintf("  %s: %v (%.1f%%)", name, duration, percentage))
    }
    s.Info(fmt.Sprintf("Total: %v", total))
}
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
=== Startup Time Statistics ===
  commonService: 50ms (2.5%)
  clusterServer: 800ms (40.0%)
  engine: 100ms (5.0%)
  apiServer: 150ms (7.5%)
  userEventPool: 300ms (15.0%)
  ...
Total: 2s
```

**ç”¨é€”**ï¼š
- è¯†åˆ«å¯åŠ¨ç“¶é¢ˆ
- æŒ‡å¯¼ä¼˜åŒ–æ–¹å‘

---

## 8ï¸âƒ£ å®æˆ˜ç»ƒä¹ 

### **ç»ƒä¹ 1ï¼šæ·»åŠ å¯åŠ¨æ—¥å¿—**

**ç›®æ ‡**ï¼šåœ¨æ¯ä¸ªç»„ä»¶å¯åŠ¨å‰åæ·»åŠ æ—¥å¿—

```go
func (s *Server) Start() error {
    s.Info("Starting commonService...")
    if err := s.commonService.Start(); err != nil {
        return err
    }
    s.Info("âœ“ commonService started")

    s.Info("Starting clusterServer...")
    if err := s.clusterServer.Start(); err != nil {
        return err
    }
    s.Info("âœ“ clusterServer started")

    // ... å…¶ä»–ç»„ä»¶
}
```

**éªŒè¯**ï¼šè§‚å¯Ÿå¯åŠ¨æ—¥å¿—ï¼Œç†è§£å¯åŠ¨æµç¨‹

---

### **ç»ƒä¹ 2ï¼šæ¨¡æ‹Ÿå¯åŠ¨å¤±è´¥**

**ç›®æ ‡**ï¼šç†è§£é”™è¯¯å¤„ç†å’Œå›æ»šæœºåˆ¶

```go
// ä¿®æ”¹é…ç½®ï¼Œä½¿æŸä¸ªç»„ä»¶å¯åŠ¨å¤±è´¥
config.yaml:
  cluster:
    addr: "invalid-address"  # æ— æ•ˆåœ°å€

# è§‚å¯Ÿæ—¥å¿—
clusterServer start failed: listen tcp: address invalid-address: ...
```

**éªŒè¯**ï¼š
- æŸ¥çœ‹é”™è¯¯æ—¥å¿—
- ç¡®è®¤å…¶ä»–ç»„ä»¶æ˜¯å¦æ­£ç¡®å›æ»š

---

### **ç»ƒä¹ 3ï¼šä¼˜åŒ–å¯åŠ¨æ€§èƒ½**

**ç›®æ ‡**ï¼šå¹¶è¡Œå¯åŠ¨æ— ä¾èµ–å…³ç³»çš„ç»„ä»¶

**æ­¥éª¤**ï¼š
1. è¯†åˆ«æ— ä¾èµ–å…³ç³»çš„ç»„ä»¶
2. ä¿®æ”¹ä¸ºå¹¶è¡Œå¯åŠ¨
3. å¯¹æ¯”å¯åŠ¨æ—¶é—´

**éªŒè¯**ï¼š
- è®°å½•ä¼˜åŒ–å‰åçš„å¯åŠ¨æ—¶é—´
- è®¡ç®—æ€§èƒ½æå‡ç™¾åˆ†æ¯”

---

## 9ï¸âƒ£ æ€»ç»“

### **æ ¸å¿ƒè¦ç‚¹**

1. **å¯åŠ¨é¡ºåº**
   - åŸºç¡€è®¾æ–½ â†’ æ ¸å¿ƒå±‚ â†’ æœåŠ¡å±‚ â†’ äº‹ä»¶å¤„ç†å±‚ â†’ æ‰©å±•å±‚
   - éµå¾ªä¾èµ–å…³ç³»ï¼Œç”±åº•å‘ä¸Šå¯åŠ¨

2. **åœæ­¢é¡ºåº**
   - ä¸å¯åŠ¨é¡ºåºç›¸å
   - å…ˆåœæ­¢æ¶ˆè´¹è€…ï¼Œå†åœæ­¢ç”Ÿäº§è€…
   - ç¡®ä¿ä¼˜é›…å…³é—­ï¼Œé¿å…æ•°æ®ä¸¢å¤±

3. **å…³é”®ä¾èµ–**
   - clusterServer å¿…é¡»åœ¨ engine ä¹‹å‰å¯åŠ¨
   - äº‹ä»¶æ± å¿…é¡»åœ¨æ‰€æœ‰ä¾èµ–æœåŠ¡ä¹‹åå¯åŠ¨
   - Webhook å¯åŠ¨å¤±è´¥ä¼šå¯¼è‡´ Panic

4. **ä¼˜åŒ–æ–¹å‘**
   - å¹¶è¡Œå¯åŠ¨æ— ä¾èµ–ç»„ä»¶
   - å»¶è¿ŸåŠ è½½éæ ¸å¿ƒåŠŸèƒ½
   - æ·»åŠ å¥åº·æ£€æŸ¥å’Œè¶…æ—¶æœºåˆ¶

---

### **ä¸‹ä¸€èŠ‚é¢„å‘Š**

**ç¬¬ä¸‰ç« ï¼šReactor ç½‘ç»œæ¨¡å‹**
- Reactor æ¨¡å¼åŸç†
- MainReactor ä¸ SubReactor
- è¿æ¥å¤„ç†æµç¨‹
- æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯

---

> **ğŸ”— ç›¸å…³ä»£ç **ï¼š
> - å¯åŠ¨æµç¨‹ï¼š`internal/server/server.go:287-380`
> - åœæ­¢æµç¨‹ï¼š`internal/server/server.go:390-436`
> - ä¾èµ–å…³ç³»ï¼šå„ç»„ä»¶çš„ `Start()` å’Œ `Stop()` æ–¹æ³•
