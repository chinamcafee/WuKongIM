# 3.2 WuKongIM çš„ Reactor å®ç°

> **æœ¬èŠ‚ç›®æ ‡**ï¼šæ·±å…¥ç†è§£WuKongIMåŸºäºwknetåº“çš„Reactorå®ç°ï¼ŒæŒæ¡Engineã€MainReactorã€SubReactorçš„è®¾è®¡ä¸äº¤äº’

---

## ğŸ“‹ ç›®å½•
1. [æ¶æ„æ€»è§ˆ](#æ¶æ„æ€»è§ˆ)
2. [Engineå¼•æ“è®¾è®¡](#engineå¼•æ“è®¾è®¡)
3. [MainReactorå®ç°](#mainreactorå®ç°)
4. [SubReactorå®ç°](#subreactorå®ç°)
5. [è¿æ¥ç®¡ç†](#è¿æ¥ç®¡ç†)
6. [äº‹ä»¶å¤„ç†æµç¨‹](#äº‹ä»¶å¤„ç†æµç¨‹)

---

## 1ï¸âƒ£ æ¶æ„æ€»è§ˆ

### **A. WuKongIMçš„Reactoræ¶æ„**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Engine å¼•æ“                         â”‚
â”‚  â”œâ”€ connMatrix (è¿æ¥çŸ©é˜µ)                                â”‚
â”‚  â”œâ”€ eventHandler (äº‹ä»¶å¤„ç†å™¨)                            â”‚
â”‚  â”œâ”€ timingWheel (æ—¶é—´è½®)                                â”‚
â”‚  â””â”€ reactorMain (ä¸»Reactor)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ReactorMain (ä¸»Reactor)                â”‚
â”‚  â””â”€ acceptor (æ¥å—å™¨)                                    â”‚
â”‚      â”œâ”€ listenPoller (TCPç›‘å¬)                           â”‚
â”‚      â”œâ”€ listenWSPoller (WebSocketç›‘å¬)                   â”‚
â”‚      â”œâ”€ listenWSSPoller (WebSocket SSLç›‘å¬)              â”‚
â”‚      â””â”€ reactorSubs[] (SubReactoræ•°ç»„)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â†“               â†“               â†“           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” ...
â”‚ ReactorSub-0 â”‚  â”‚ ReactorSub-1 â”‚  â”‚ ReactorSub-2 â”‚
â”‚ â”œâ”€ poller    â”‚  â”‚ â”œâ”€ poller    â”‚  â”‚ â”œâ”€ poller    â”‚
â”‚ â”œâ”€ connCount â”‚  â”‚ â”œâ”€ connCount â”‚  â”‚ â”œâ”€ connCount â”‚
â”‚ â””â”€ conns[]   â”‚  â”‚ â””â”€ conns[]   â”‚  â”‚ â””â”€ conns[]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **B. æ ¸å¿ƒç»„ä»¶èŒè´£**

| ç»„ä»¶ | èŒè´£ | æ–‡ä»¶ä½ç½® |
|------|------|---------|
| **Engine** | æ€»æ§å¼•æ“ï¼Œç®¡ç†æ‰€æœ‰Reactorå’Œè¿æ¥ | `pkg/wknet/engine.go:13-22` |
| **ReactorMain** | ä¸»Reactorï¼Œè´Ÿè´£æ¥å—æ–°è¿æ¥ | `pkg/wknet/reactor_main.go:5-18` |
| **Acceptor** | è¿æ¥æ¥å—å™¨ï¼ŒåŒ…å«ç›‘å¬å’Œåˆ†å‘é€»è¾‘ | `pkg/wknet/acceptor.go:21-34` |
| **ReactorSub** | å­Reactorï¼Œè´Ÿè´£I/Oäº‹ä»¶å¤„ç† | `pkg/wknet/reactor_sub.go:19-29` |
| **connMatrix** | è¿æ¥çŸ©é˜µï¼Œå¿«é€ŸæŸ¥æ‰¾è¿æ¥ | `pkg/wknet/conn.go:872-875` |
| **Poller** | I/Oå¤šè·¯å¤ç”¨å°è£…ï¼ˆepoll/kqueueï¼‰ | `pkg/wknet/netpoll/epoll_default_poller.go:21-27` |

---

## 2ï¸âƒ£ Engine å¼•æ“è®¾è®¡

### **A. Engineç»“æ„å®šä¹‰**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/engine.go:13-22`

```go
type Engine struct {
    connMatrix      *connMatrix              // åœ¨çº¿è¿æ¥çŸ©é˜µ â­
    connsUnixLock   deadlock.RWMutex         // è¿æ¥é”
    options         *Options                 // é…ç½®é€‰é¡¹
    eventHandler    *EventHandler            // äº‹ä»¶å¤„ç†å™¨
    reactorMain     *ReactorMain             // ä¸»Reactor
    timingWheel     *timingwheel.TimingWheel // æ—¶é—´è½®ï¼ˆå»¶è¿Ÿä»»åŠ¡ï¼‰
    defaultConnPool *sync.Pool               // è¿æ¥å¯¹è±¡æ± 
    clientIDGen     atomic.Int64             // å®¢æˆ·ç«¯IDç”Ÿæˆå™¨
}
```

---

### **B. Engineåˆå§‹åŒ–**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/engine.go:24-47`

```go
func NewEngine(opts ...Option) *Engine {
    // 1. åˆ›å»ºé»˜è®¤é…ç½®
    options := NewOptions()
    for _, opt := range opts {
        opt(options)  // åº”ç”¨ç”¨æˆ·é…ç½®
    }

    // 2. åˆ›å»ºEngineå®ä¾‹
    eg := &Engine{
        connMatrix:   newConnMatrix(),        // è¿æ¥çŸ©é˜µ
        options:      options,
        eventHandler: NewEventHandler(),      // äº‹ä»¶å¤„ç†å™¨
        timingWheel:  timingwheel.NewTimingWheel(
            time.Millisecond*10,  // tické—´éš”ï¼š10ms
            1000,                 // æ—¶é—´è½®æ§½ä½æ•°ï¼š1000
        ),
        defaultConnPool: &sync.Pool{         // è¿æ¥å¯¹è±¡æ± 
            New: func() any {
                return &DefaultConn{}
            },
        },
    }

    // 3. åˆ›å»ºä¸»Reactor
    eg.reactorMain = NewReactorMain(eg)

    return eg
}
```

---

### **C. é»˜è®¤é…ç½®**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/options.go:46-55`

```go
func NewOptions() *Options {
    return &Options{
        Addr:               "tcp://127.0.0.1:5100",
        MaxOpenFiles:       GetMaxOpenFiles(),     // ç³»ç»Ÿæœ€å¤§æ–‡ä»¶æ•°
        SubReactorNum:      runtime.NumCPU(),      // SubReactoræ•°é‡ = CPUæ ¸å¿ƒæ•° â­
        ReadBufferSize:     1024 * 32,             // 32KB
        MaxWriteBufferSize: 1024 * 1024 * 50,      // 50MB
        MaxReadBufferSize:  1024 * 1024 * 50,      // 50MB
    }
}
```

**ä¸ºä»€ä¹ˆSubReactoræ•°é‡ç­‰äºCPUæ ¸å¿ƒæ•°ï¼Ÿ**
```
åŸå› ï¼š
1. å……åˆ†åˆ©ç”¨å¤šæ ¸CPU
2. é¿å…çº¿ç¨‹è¿‡å¤šå¯¼è‡´è°ƒåº¦å¼€é”€
3. æ¯ä¸ªSubReactorç‹¬å ä¸€ä¸ªCPUæ ¸å¿ƒï¼Œæ— ç«äº‰

ç¤ºä¾‹ï¼š
â”œâ”€ 16æ ¸CPU â†’ 16ä¸ªSubReactor
â”œâ”€ æ¯ä¸ªSubReactorå¤„ç†çº¦6ä¸‡è¿æ¥ï¼ˆ100ä¸‡/16ï¼‰
â””â”€ æ¯ä¸ªSubReactorç»‘å®šä¸€ä¸ªCPUæ ¸å¿ƒï¼Œæ€§èƒ½æœ€ä¼˜
```

---

### **D. Engineå¯åŠ¨**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/engine.go:49-52`

```go
func (e *Engine) Start() error {
    // 1. å¯åŠ¨æ—¶é—´è½®
    e.timingWheel.Start()

    // 2. å¯åŠ¨ä¸»Reactor
    return e.reactorMain.Start()
}
```

**å¯åŠ¨é¡ºåº**ï¼š
```
1. æ—¶é—´è½®å¯åŠ¨ï¼ˆå¤„ç†è¶…æ—¶ä»»åŠ¡ï¼‰
2. ä¸»Reactorå¯åŠ¨
   â”œâ”€ åˆ›å»ºå¹¶å¯åŠ¨æ‰€æœ‰SubReactor
   â”œâ”€ åˆå§‹åŒ–TCPç›‘å¬
   â”œâ”€ åˆå§‹åŒ–WebSocketç›‘å¬
   â””â”€ å¼€å§‹æ¥å—è¿æ¥
```

---

### **E. è¿æ¥ç®¡ç†æ–¹æ³•**

```go
// æ·»åŠ è¿æ¥åˆ°è¿æ¥çŸ©é˜µ
func (e *Engine) AddConn(conn Conn) {
    e.connsUnixLock.Lock()
    e.connMatrix.addConn(conn)
    e.connsUnixLock.Unlock()
}

// ç§»é™¤è¿æ¥
func (e *Engine) RemoveConn(conn Conn) {
    e.connsUnixLock.Lock()
    e.connMatrix.delConn(conn)
    e.connsUnixLock.Unlock()
}

// æ ¹æ®fdæŸ¥æ‰¾è¿æ¥ï¼ˆO(1)å¤æ‚åº¦ï¼‰
func (e *Engine) GetConn(fd int) Conn {
    e.connsUnixLock.RLock()
    defer e.connsUnixLock.RUnlock()
    return e.connMatrix.getConn(fd)
}

// è·å–æ‰€æœ‰è¿æ¥
func (e *Engine) GetAllConn() []Conn {
    e.connsUnixLock.RLock()
    defer e.connsUnixLock.RUnlock()
    conns := make([]Conn, 0, e.connMatrix.loadCount())
    e.connMatrix.iterate(func(conn Conn) bool {
        conns = append(conns, conn)
        return true
    })
    return conns
}
```

---

### **F. äº‹ä»¶å›è°ƒæ³¨å†Œ**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/engine.go:120-141`

```go
// è¿æ¥å»ºç«‹å›è°ƒ
func (e *Engine) OnConnect(onConnect OnConnect) {
    e.eventHandler.OnConnect = onConnect
}

// æ•°æ®åˆ°è¾¾å›è°ƒ
func (e *Engine) OnData(onData OnData) {
    e.eventHandler.OnData = onData
}

// è¿æ¥å…³é—­å›è°ƒ
func (e *Engine) OnClose(onClose OnClose) {
    e.eventHandler.OnClose = onClose
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼ˆWuKongIMï¼‰ï¼š
```go
// internal/server/server.go:331-333
s.engine.OnConnect(s.onConnect)
s.engine.OnData(s.onData)
s.engine.OnClose(s.onClose)
```

---

## 3ï¸âƒ£ MainReactor å®ç°

### **A. ReactorMainç»“æ„**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/reactor_main.go:5-18`

```go
type ReactorMain struct {
    acceptor *acceptor        // è¿æ¥æ¥å—å™¨
    eg       *Engine          // Engineå¼•ç”¨
    wklog.Log                 // æ—¥å¿—
}

func NewReactorMain(eg *Engine) *ReactorMain {
    return &ReactorMain{
        acceptor: newAcceptor(eg),
        eg:       eg,
        Log:      wklog.NewWKLog("ReactorMain"),
    }
}
```

**èŒè´£**ï¼š
- å¯åŠ¨Acceptor
- ç®¡ç†è¿æ¥æ¥å—æµç¨‹
- ä¸ç›´æ¥å¤„ç†I/Oï¼Œè€Œæ˜¯åˆ†å‘ç»™SubReactor

---

### **B. Acceptorç»“æ„**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/acceptor.go:21-34`

```go
type acceptor struct {
    reactorSubs       []*ReactorSub      // SubReactoræ•°ç»„ â­
    eg                *Engine            // Engineå¼•ç”¨
    listenPoller      *netpoll.Poller    // TCPç›‘å¬Poller
    listenWSPoller    *netpoll.Poller    // WebSocketç›‘å¬Poller
    listenWSSPoller   *netpoll.Poller    // WebSocket SSLç›‘å¬Poller
    listen            *listener          // TCPç›‘å¬å™¨
    listenWS          *listener          // WebSocketç›‘å¬å™¨
    listenWSS         *listener          // WebSocket SSLç›‘å¬å™¨
    tcpRealListenAddr net.Addr           // TCPçœŸå®ç›‘å¬åœ°å€
    wsRealListenAddr  net.Addr           // WebSocketçœŸå®ç›‘å¬åœ°å€
    wklog.Log
}
```

---

### **C. Acceptoråˆå§‹åŒ–**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/acceptor.go:36-51`

```go
func newAcceptor(eg *Engine) *acceptor {
    // 1. åˆ›å»ºSubReactoræ•°ç»„
    reactorSubs := make([]*ReactorSub, eg.options.SubReactorNum)
    for i := 0; i < eg.options.SubReactorNum; i++ {
        reactorSubs[i] = NewReactorSub(eg, i)
    }

    // 2. åˆ›å»ºAcceptorå®ä¾‹
    a := &acceptor{
        eg:              eg,
        reactorSubs:     reactorSubs,
        listenPoller:    netpoll.NewPoller(0, "listenerPoller"),     // TCPç›‘å¬
        listenWSPoller:  netpoll.NewPoller(0, "listenWSPoller"),     // WSç›‘å¬
        listenWSSPoller: netpoll.NewPoller(0, "listenWSSPoller"),    // WSSç›‘å¬
        Log:             wklog.NewWKLog("Acceptor"),
    }

    return a
}
```

**ä¸ºä»€ä¹ˆéœ€è¦ä¸‰ä¸ªPollerï¼Ÿ**
```
åŸå› ï¼š
1. TCPã€WebSocketã€WebSocket SSL æ˜¯ä¸åŒçš„ç›‘å¬socket
2. æ¯ä¸ªç›‘å¬socketéœ€è¦ç‹¬ç«‹çš„epollå®ä¾‹
3. å¹¶è¡Œç›‘å¬ï¼Œæé«˜æ¥å—è¿æ¥çš„æ•ˆç‡

æ¶æ„ï¼š
listenPoller      â†’ ç›‘å¬ tcp://0.0.0.0:5100
listenWSPoller    â†’ ç›‘å¬ ws://0.0.0.0:5200
listenWSSPoller   â†’ ç›‘å¬ wss://0.0.0.0:5300
```

---

### **D. Acceptorå¯åŠ¨æµç¨‹**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/acceptor.go:58-98`

```go
func (a *acceptor) start() error {

    // 1. å¯åŠ¨æ‰€æœ‰SubReactor
    for _, reactorSub := range a.reactorSubs {
        err := reactorSub.Start()
        if err != nil {
            return err
        }
    }

    var wg = &sync.WaitGroup{}

    // 2. å¹¶è¡Œåˆå§‹åŒ–ä¸‰ä¸ªç›‘å¬å™¨
    wg.Add(1)
    go func() {
        err := a.initTCPListener(wg)   // TCPç›‘å¬
        if err != nil {
            a.Panic("initTCPListener() failed", zap.Error(err))
        }
    }()

    if strings.TrimSpace(a.eg.options.WsAddr) != "" {
        wg.Add(1)
        go func() {
            err := a.initWSListener(wg)   // WebSocketç›‘å¬
            if err != nil {
                a.Panic("initWSListener() failed", zap.Error(err))
            }
        }()
    }

    if strings.TrimSpace(a.eg.options.WssAddr) != "" {
        wg.Add(1)
        go func() {
            err := a.initWSSListener(wg)  // WebSocket SSLç›‘å¬
            if err != nil {
                a.Panic("initWSSListener() failed", zap.Error(err))
            }
        }()
    }

    wg.Wait()  // ç­‰å¾…æ‰€æœ‰ç›‘å¬å™¨åˆå§‹åŒ–å®Œæˆ
    return nil
}
```

**å¯åŠ¨é¡ºåºå›¾**ï¼š
```
Acceptor.Start()
    â†“
1. å¯åŠ¨æ‰€æœ‰SubReactor
    â”œâ”€ SubReactor-0.Start()
    â”œâ”€ SubReactor-1.Start()
    â””â”€ ...
    â†“
2. å¹¶è¡Œåˆå§‹åŒ–ç›‘å¬å™¨
    â”œâ”€ initTCPListener()  (goroutine 1)
    â”œâ”€ initWSListener()   (goroutine 2)
    â””â”€ initWSSListener()  (goroutine 3)
    â†“
3. ç­‰å¾…æ‰€æœ‰ç›‘å¬å™¨å°±ç»ª
    â†“
4. å¼€å§‹æ¥å—è¿æ¥
```

---

### **E. TCPç›‘å¬åˆå§‹åŒ–**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/acceptor.go:150-168`

```go
func (a *acceptor) initTCPListener(wg *sync.WaitGroup) error {
    // 1. åˆ›å»ºç›‘å¬å™¨
    a.listen = newListener(a.eg.options.Addr, a.eg.options)
    err := a.listen.init()
    if err != nil {
        return err
    }
    a.tcpRealListenAddr = a.listen.realAddr

    // 2. å°†ç›‘å¬socketçš„fdæ³¨å†Œåˆ°Poller
    if err := a.listenPoller.AddRead(a.listen.fd); err != nil {
        return fmt.Errorf("add listener fd to poller failed %s", err)
    }

    wg.Done()  // é€šçŸ¥åˆå§‹åŒ–å®Œæˆ

    // 3. é˜»å¡è½®è¯¢ï¼Œæ¥å—è¿æ¥
    err = a.listenPoller.Polling(func(fd int, ev netpoll.PollEvent) error {
        return a.acceptConn(fd, false, false)  // ws=false, wss=false
    })
    return err
}
```

**å…³é”®ç‚¹**ï¼š
```
1. newListener() åˆ›å»ºç›‘å¬socketå¹¶bind + listen
2. AddRead() å°†ç›‘å¬socketæ³¨å†Œåˆ°epollï¼ˆç›‘å¬EPOLLINäº‹ä»¶ï¼‰
3. Polling() é˜»å¡ç­‰å¾…æ–°è¿æ¥åˆ°è¾¾
4. acceptConn() æ¥å—æ–°è¿æ¥å¹¶åˆ†å‘åˆ°SubReactor
```

---

### **F. æ¥å—è¿æ¥è¯¦è§£** â­

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/acceptor.go:204-253`

```go
func (a *acceptor) acceptConn(listenFd int, ws bool, wss bool) error {
    // 1. è°ƒç”¨ç³»ç»Ÿè°ƒç”¨Acceptæ¥å—è¿æ¥
    connFd, sa, err := unix.Accept(listenFd)
    if err != nil {
        if err == unix.EAGAIN {
            return nil  // æš‚æ—¶æ— è¿æ¥ï¼Œç»§ç»­ç­‰å¾…
        }
        return perrors.ErrAcceptSocket
    }

    // 2. è®¾ç½®éé˜»å¡æ¨¡å¼
    if err = unix.SetNonblock(connFd, true); err != nil {
        return err
    }

    // 3. è·å–è¿œç¨‹åœ°å€
    remoteAddr := socket.SockaddrToTCPOrUnixAddr(sa)

    // 4. è®¾ç½®TCP KeepAliveï¼ˆå¦‚æœé…ç½®ï¼‰
    if a.eg.options.TCPKeepAlive > 0 && a.listen.customNetwork == "tcp" {
        socket.SetKeepAlivePeriod(connFd,
            int(a.eg.options.TCPKeepAlive.Seconds()))
    }

    // 5. é€‰æ‹©SubReactorï¼ˆè´Ÿè½½å‡è¡¡ï¼‰â­
    subReactor := a.reactorSubByConnFd(connFd)

    // 6. ç”Ÿæˆå®¢æˆ·ç«¯ID
    clientId := a.eg.GenClientID()

    // 7. åˆ›å»ºè¿æ¥å¯¹è±¡
    var conn Conn
    if wss {
        conn, err = a.eg.eventHandler.OnNewWSSConn(
            clientId, newNetFd(connFd),
            a.wssRealAddr(), remoteAddr, a.eg, subReactor)
    } else if ws {
        conn, err = a.eg.eventHandler.OnNewWSConn(
            clientId, newNetFd(connFd),
            a.wsRealAddr(), remoteAddr, a.eg, subReactor)
    } else {
        conn, err = a.eg.eventHandler.OnNewConn(
            clientId, newNetFd(connFd),
            a.tcpRealAddr(), remoteAddr, a.eg, subReactor)
    }

    // 8. å°†è¿æ¥æ·»åŠ åˆ°SubReactor
    err = subReactor.AddConn(conn)
    if err != nil {
        a.Warn("subReactor.AddConn() failed", zap.Error(err))
    }

    // 9. è§¦å‘OnConnectå›è°ƒ
    err = a.eg.eventHandler.OnConnect(conn)
    if err != nil {
        a.Warn("OnConnect() failed", zap.Error(err))
    }

    return nil
}
```

---

### **G. SubReactoré€‰æ‹©ç­–ç•¥** â­

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/acceptor.go:255-258`

```go
func (a *acceptor) reactorSubByConnFd(connfd int) *ReactorSub {
    // ç®€å•å–æ¨¡ï¼šfd % SubReactoræ•°é‡
    return a.reactorSubs[connfd%len(a.reactorSubs)]
}
```

**ä¸ºä»€ä¹ˆç”¨fdå–æ¨¡ï¼Ÿ**
```
ä¼˜ç‚¹ï¼š
âœ… ç®€å•é«˜æ•ˆï¼ˆO(1)ï¼‰
âœ… åˆ†å¸ƒå‡åŒ€ï¼ˆfdæ˜¯é€’å¢çš„ï¼‰
âœ… æ— éœ€ç»´æŠ¤é¢å¤–çŠ¶æ€

ç¤ºä¾‹ï¼š
SubReactoræ•°é‡ = 8
fd = 100 â†’ SubReactor-4 (100 % 8 = 4)
fd = 101 â†’ SubReactor-5 (101 % 8 = 5)
fd = 102 â†’ SubReactor-6 (102 % 8 = 6)
...

ç»“æœï¼šè¿æ¥å‡åŒ€åˆ†å¸ƒåˆ°8ä¸ªSubReactor
```

**å…¶ä»–ç­–ç•¥å¯¹æ¯”**ï¼š
| ç­–ç•¥ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|
| **fdå–æ¨¡** â­ | ç®€å•ã€å¿«é€Ÿã€å‡åŒ€ | æ—  |
| **è½®è¯¢ï¼ˆRound Robinï¼‰** | å‡åŒ€ | éœ€è¦ç»´æŠ¤è®¡æ•°å™¨ |
| **æœ€å°‘è¿æ¥** | è´Ÿè½½æœ€å‡è¡¡ | éœ€è¦éå†æ‰€æœ‰SubReactor |
| **éšæœº** | ç®€å• | å¯èƒ½ä¸å‡åŒ€ |

---

## 4ï¸âƒ£ SubReactor å®ç°

### **A. ReactorSubç»“æ„**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/reactor_sub.go:19-29`

```go
type ReactorSub struct {
    poller    *netpoll.Poller    // epoll/kqueueå®ä¾‹
    eg        *Engine            // Engineå¼•ç”¨
    idx       int                // SubReactorç´¢å¼•
    connCount atomic.Int32       // è¿æ¥è®¡æ•° â­
    wklog.Log
    ReadBuffer []byte            // è¯»ç¼“å†²åŒºï¼ˆå¤ç”¨ï¼‰
    cache      bytes.Buffer      // ä¸´æ—¶ç¼“å†²åŒº
    stopped    atomic.Bool       // åœæ­¢æ ‡å¿—
}
```

---

### **B. ReactorSubåˆå§‹åŒ–**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/reactor_sub.go:32-42`

```go
func NewReactorSub(eg *Engine, index int) *ReactorSub {
    poller := netpoll.NewPoller(index, "connPoller")

    return &ReactorSub{
        eg:         eg,
        poller:     poller,
        idx:        index,
        Log:        wklog.NewWKLog(fmt.Sprintf("ReactorSub-%d", index)),
        ReadBuffer: make([]byte, eg.options.ReadBufferSize),  // 32KB
    }
}
```

---

### **C. ReactorSubå¯åŠ¨**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/reactor_sub.go:52-55`

```go
func (r *ReactorSub) Start() error {
    go r.run()  // å¯åŠ¨ç‹¬ç«‹goroutine
    return nil
}
```

---

### **D. ReactorSubäº‹ä»¶å¾ªç¯** â­â­â­

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/reactor_sub.go:94-121`

```go
func (r *ReactorSub) run() {
    defer func() {
        if err := recover(); err != nil {
            r.Panic("reactorSub panic",
                zap.Any("err", err),
                zap.Stack("stack"))
        }
    }()

    // æ ¸å¿ƒäº‹ä»¶å¾ªç¯
    err := r.poller.Polling(func(fd int, event netpoll.PollEvent) error {
        // 1. æ ¹æ®fdæŸ¥æ‰¾è¿æ¥
        conn := r.eg.GetConn(fd)
        if conn == nil {
            return nil  // è¿æ¥å·²å…³é—­
        }

        // 2. æ ¹æ®äº‹ä»¶ç±»å‹åˆ†å‘
        switch event {
        case netpoll.PollEventClose:
            // è¿æ¥å…³é—­äº‹ä»¶
            r.Debug("conn è¿æ¥å…³é—­ï¼",
                zap.Int64("id", conn.ID()),
                zap.Int("fd", fd))
            _ = r.CloseConn(conn, unix.ECONNRESET)

        case netpoll.PollEventRead:
            // å¯è¯»äº‹ä»¶
            err = r.read(conn)

        case netpoll.PollEventWrite:
            // å¯å†™äº‹ä»¶
            err = r.write(conn)
        }

        return err
    })

    if err != nil && !r.stopped.Load() {
        r.Panic("poller error",
            zap.Error(err),
            zap.Int("idx", r.idx))
    }
}
```

**äº‹ä»¶å¾ªç¯è§£æ**ï¼š
```
SubReactoräº‹ä»¶å¾ªç¯
    â†“
1. epoll_wait() ç­‰å¾…I/Oäº‹ä»¶
    â†“
2. è·å–å°±ç»ªçš„fdåˆ—è¡¨
    â†“
3. å¯¹æ¯ä¸ªfdï¼š
    â”œâ”€ æ ¹æ®fdæŸ¥æ‰¾Connå¯¹è±¡
    â”œâ”€ åˆ¤æ–­äº‹ä»¶ç±»å‹
    â”œâ”€ åˆ†å‘åˆ°å¯¹åº”å¤„ç†å‡½æ•°
    â”‚   â”œâ”€ PollEventRead â†’ read()
    â”‚   â”œâ”€ PollEventWrite â†’ write()
    â”‚   â””â”€ PollEventClose â†’ CloseConn()
    â””â”€ ç»§ç»­ä¸‹ä¸€ä¸ªfd
    â†“
4. å¤„ç†å®Œæ‰€æœ‰äº‹ä»¶ï¼Œç»§ç»­epoll_wait()
```

---

### **E. è¯»äº‹ä»¶å¤„ç†**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/reactor_sub.go:128-154`

```go
func (r *ReactorSub) read(c Conn) error {
    // 1. è¯»å–æ•°æ®åˆ°è¿æ¥çš„InboundBuffer
    var n int
    var err error
    if n, err = c.ReadToInboundBuffer(); err != nil {
        if err == unix.EAGAIN {
            return nil  // æš‚æ—¶æ— æ•°æ®ï¼Œç­‰å¾…ä¸‹æ¬¡
        }
        // è¯»å–é”™è¯¯ï¼Œå…³é—­è¿æ¥
        if err1 := r.CloseConn(c, err); err1 != nil {
            r.Warn("failed to close conn", zap.Error(err1))
        }
        return nil
    }

    // 2. è¯»åˆ°0å­—èŠ‚ï¼Œè¡¨ç¤ºè¿æ¥å…³é—­
    if n == 0 {
        return r.CloseConn(c, os.NewSyscallError("read", unix.ECONNRESET))
    }

    // 3. è§¦å‘OnDataå›è°ƒï¼ˆä¸šåŠ¡å¤„ç†ï¼‰
    if err = r.eg.eventHandler.OnData(c); err != nil {
        if err == unix.EAGAIN {
            return nil
        }
        if err1 := r.CloseConn(c, err); err1 != nil {
            r.Warn("failed to close conn", zap.Error(err1))
        }
        r.Warn("failed to call OnData", zap.Error(err))
        return nil
    }

    return nil
}
```

**è¯»å–æµç¨‹å›¾**ï¼š
```
epollé€šçŸ¥fdå¯è¯»
    â†“
ReactorSub.read()
    â†“
1. c.ReadToInboundBuffer()
    â”œâ”€ è°ƒç”¨ç³»ç»Ÿè°ƒç”¨read()
    â”œâ”€ è¯»å–æ•°æ®åˆ°è¿æ¥ç¼“å†²åŒº
    â””â”€ è¿”å›è¯»å–çš„å­—èŠ‚æ•°
    â†“
2. OnData(c)
    â”œâ”€ è§£æåè®®ï¼ˆWuKongIMåè®®ï¼‰
    â”œâ”€ ä¸šåŠ¡å¤„ç†
    â””â”€ è¿”å›
    â†“
3. ç»§ç»­ç­‰å¾…ä¸‹æ¬¡å¯è¯»äº‹ä»¶
```

---

### **F. å†™äº‹ä»¶å¤„ç†**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/reactor_sub.go:156-166`

```go
func (r *ReactorSub) write(c Conn) error {
    // åˆ·æ–°å‘é€ç¼“å†²åŒº
    err := c.Flush()
    switch err {
    case nil:
        // å‘é€æˆåŠŸï¼Œç»§ç»­
    case unix.EAGAIN:
        // å†…æ ¸ç¼“å†²åŒºæ»¡ï¼Œç­‰å¾…ä¸‹æ¬¡
        return nil
    default:
        // å‘é€é”™è¯¯ï¼Œå…³é—­è¿æ¥
        return r.CloseConn(c, os.NewSyscallError("write", err))
    }
    return nil
}
```

**å†™å…¥æµç¨‹å›¾**ï¼š
```
ä¸šåŠ¡å±‚è°ƒç”¨ conn.Write(data)
    â†“
æ•°æ®å†™å…¥ OutboundBuffer
    â†“
æ³¨å†Œå†™äº‹ä»¶ï¼ˆå¦‚æœæœªæ³¨å†Œï¼‰
    â†“
epollé€šçŸ¥fdå¯å†™
    â†“
ReactorSub.write()
    â†“
c.Flush()
    â”œâ”€ è°ƒç”¨ç³»ç»Ÿè°ƒç”¨write()
    â”œâ”€ ä»OutboundBufferå‘é€æ•°æ®
    â””â”€ å¦‚æœç¼“å†²åŒºæ¸…ç©ºï¼Œç§»é™¤å†™äº‹ä»¶ç›‘å¬
```

---

### **G. æ·»åŠ è¿æ¥åˆ°SubReactor**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/reactor_sub.go:45-49`

```go
func (r *ReactorSub) AddConn(conn Conn) error {
    // 1. æ·»åŠ åˆ°Engineçš„è¿æ¥çŸ©é˜µ
    r.eg.AddConn(conn)

    // 2. å¢åŠ è¿æ¥è®¡æ•°
    r.connCount.Inc()

    // 3. å°†fdæ³¨å†Œåˆ°epollï¼ˆç›‘å¬è¯»äº‹ä»¶ï¼‰
    return r.poller.AddRead(conn.Fd().fd)
}
```

**ä¸ºä»€ä¹ˆåªæ³¨å†Œè¯»äº‹ä»¶ï¼Ÿ**
```
åŸå› ï¼š
1. å¤§éƒ¨åˆ†æ—¶é—´è¿æ¥æ˜¯ç©ºé—²çš„ï¼Œåªéœ€ç›‘å¬è¯»
2. å†™äº‹ä»¶æŒ‰éœ€æ³¨å†Œï¼ˆæœ‰æ•°æ®è¦å‘é€æ—¶æ‰æ³¨å†Œï¼‰
3. å‡å°‘epolläº‹ä»¶æ•°é‡ï¼Œæé«˜æ€§èƒ½

å†™äº‹ä»¶æ³¨å†Œæ—¶æœºï¼š
â”œâ”€ conn.Write(data) è¢«è°ƒç”¨
â”œâ”€ OutboundBufferæœ‰æ•°æ®
â””â”€ è°ƒç”¨ AddWrite() æ³¨å†Œå†™äº‹ä»¶

å†™äº‹ä»¶ç§»é™¤æ—¶æœºï¼š
â”œâ”€ OutboundBufferæ¸…ç©º
â””â”€ è°ƒç”¨ RemoveWrite() ç§»é™¤å†™äº‹ä»¶
```

---

## 5ï¸âƒ£ è¿æ¥ç®¡ç†

### **A. connMatrixï¼ˆè¿æ¥çŸ©é˜µï¼‰**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/conn.go:872-911`

```go
type connMatrix struct {
    connCount atomic.Int32       // è¿æ¥è®¡æ•°ï¼ˆåŸå­æ“ä½œï¼‰
    conns     map[int]Conn       // fd â†’ Conn æ˜ å°„
}

func newConnMatrix() *connMatrix {
    return &connMatrix{
        conns: make(map[int]Conn),
    }
}

// æ·»åŠ è¿æ¥
func (cm *connMatrix) addConn(c Conn) {
    cm.conns[c.Fd().Fd()] = c
    cm.countAdd(1)
}

// åˆ é™¤è¿æ¥
func (cm *connMatrix) delConn(c Conn) {
    delete(cm.conns, c.Fd().Fd())
    cm.countAdd(-1)
}

// æ ¹æ®fdæŸ¥æ‰¾è¿æ¥ï¼ˆO(1)å¤æ‚åº¦ï¼‰
func (cm *connMatrix) getConn(fd int) Conn {
    return cm.conns[fd]
}

// è·å–è¿æ¥æ€»æ•°
func (cm *connMatrix) loadCount() (n int32) {
    return cm.connCount.Load()
}

// éå†æ‰€æœ‰è¿æ¥
func (cm *connMatrix) iterate(f func(Conn) bool) {
    for _, c := range cm.conns {
        if c != nil {
            if !f(c) {
                return  // å¦‚æœå›è°ƒè¿”å›falseï¼Œåœæ­¢éå†
            }
        }
    }
}
```

---

### **B. ä¸ºä»€ä¹ˆç”¨connMatrixï¼Ÿ**

**ä¼ ç»Ÿæ–¹æ¡ˆ**ï¼šéå†æ•°ç»„/åˆ‡ç‰‡æŸ¥æ‰¾è¿æ¥

```go
// âŒ ä½æ•ˆæ–¹æ¡ˆ
type ConnectionManager struct {
    conns []Conn
}

func (cm *ConnectionManager) GetConn(fd int) Conn {
    for _, conn := range cm.conns {
        if conn.Fd().Fd() == fd {
            return conn  // O(n) å¤æ‚åº¦
        }
    }
    return nil
}
```

**connMatrixæ–¹æ¡ˆ**ï¼šä½¿ç”¨mapç›´æ¥æŸ¥æ‰¾

```go
// âœ… é«˜æ•ˆæ–¹æ¡ˆ
type connMatrix struct {
    conns map[int]Conn  // key = fd
}

func (cm *connMatrix) getConn(fd int) Conn {
    return cm.conns[fd]  // O(1) å¤æ‚åº¦
}
```

**æ€§èƒ½å¯¹æ¯”**ï¼š
| æ“ä½œ | æ•°ç»„æ–¹æ¡ˆ | connMatrix | æå‡ |
|------|---------|-----------|------|
| æŸ¥æ‰¾è¿æ¥ | O(n) | O(1) | 100ä¸‡å€+ |
| æ·»åŠ è¿æ¥ | O(1) | O(1) | ç›¸åŒ |
| åˆ é™¤è¿æ¥ | O(n) | O(1) | 100ä¸‡å€+ |

**å®é™…å½±å“**ï¼š
```
åœºæ™¯ï¼š100ä¸‡è¿æ¥ï¼Œæ¯ç§’10ä¸‡æ¬¡æŸ¥æ‰¾

æ•°ç»„æ–¹æ¡ˆï¼š
â”œâ”€ æ¯æ¬¡æŸ¥æ‰¾å¹³å‡éå†50ä¸‡ä¸ªè¿æ¥
â”œâ”€ æ€»è®¡ï¼š10ä¸‡ Ã— 50ä¸‡ = 500äº¿æ¬¡æ¯”è¾ƒ/ç§’
â””â”€ CPUå ç”¨ï¼š100% ğŸ’¥

connMatrixæ–¹æ¡ˆï¼š
â”œâ”€ æ¯æ¬¡æŸ¥æ‰¾ï¼šhashæŸ¥æ‰¾
â”œâ”€ æ€»è®¡ï¼š10ä¸‡æ¬¡hashæŸ¥æ‰¾/ç§’
â””â”€ CPUå ç”¨ï¼š<1% âœ…
```

---

### **C. å®¢æˆ·ç«¯IDç”Ÿæˆ**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/engine.go:143-151`

```go
func (e *Engine) GenClientID() int64 {
    cid := e.clientIDGen.Load()

    // å¦‚æœè¶…è¿‡int32æœ€å¤§å€¼ï¼Œä»0é‡æ–°å¼€å§‹
    if cid >= 1<<32-1 {
        e.clientIDGen.Store(0)
    }

    return e.clientIDGen.Inc()  // åŸå­é€’å¢
}
```

**ä¸ºä»€ä¹ˆä»0é‡æ–°å¼€å§‹ï¼Ÿ**
```
åŸå› ï¼š
1. int32æœ€å¤§å€¼ï¼š2,147,483,647ï¼ˆ21äº¿ï¼‰
2. å¦‚æœæ¯ç§’å»ºç«‹1000ä¸ªè¿æ¥ï¼Œéœ€è¦248ä¸‡å¤©æ‰ä¼šé‡ç½®
3. é‡ç½®æ—¶åŸæ¥çš„è¿æ¥æ—©å·²å…³é—­ï¼Œä¸ä¼šå†²çª

ä¼˜ç‚¹ï¼š
âœ… åŸå­æ“ä½œï¼Œæ— é”
âœ… æ€§èƒ½æé«˜
âœ… IDç”¨å®Œè‡ªåŠ¨å¾ªç¯
```

---

## 6ï¸âƒ£ äº‹ä»¶å¤„ç†æµç¨‹

### **A. å®Œæ•´è¿æ¥å¤„ç†æµç¨‹**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. æ–°è¿æ¥åˆ°è¾¾                                      â”‚
â”‚     tcp://0.0.0.0:5100 æ”¶åˆ°è¿æ¥è¯·æ±‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. MainReactor.Acceptor                           â”‚
â”‚     â”œâ”€ listenPoller.Polling() æ£€æµ‹åˆ°å¯è¯»äº‹ä»¶       â”‚
â”‚     â”œâ”€ è°ƒç”¨ unix.Accept() æ¥å—è¿æ¥                 â”‚
â”‚     â”œâ”€ è·å–connFd = 1024                           â”‚
â”‚     â””â”€ è®¾ç½®éé˜»å¡ï¼šunix.SetNonblock(connFd, true)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. é€‰æ‹©SubReactor                                 â”‚
â”‚     subReactor = reactorSubs[1024 % 8] = Sub-0    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. åˆ›å»ºè¿æ¥å¯¹è±¡                                    â”‚
â”‚     â”œâ”€ ç”ŸæˆclientId = 12345                        â”‚
â”‚     â”œâ”€ åˆ›å»ºConnå¯¹è±¡                                â”‚
â”‚     â””â”€ å…³è” SubReactor-0                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. æ³¨å†Œåˆ°SubReactor                               â”‚
â”‚     â”œâ”€ engine.AddConn(conn)                        â”‚
â”‚     â”‚   â””â”€ connMatrix[1024] = conn                 â”‚
â”‚     â”œâ”€ subReactor.connCount.Inc()                  â”‚
â”‚     â””â”€ poller.AddRead(1024)                        â”‚
â”‚         â””â”€ epoll_ctl(EPOLL_CTL_ADD, 1024, EPOLLIN) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. è§¦å‘OnConnectå›è°ƒ                              â”‚
â”‚     eventHandler.OnConnect(conn)                   â”‚
â”‚     â””â”€ WuKongIM: s.onConnect(conn)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. ç­‰å¾…æ•°æ®åˆ°è¾¾                                    â”‚
â”‚     SubReactor-0æŒç»­ç›‘å¬fd=1024                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **B. æ•°æ®æ¥æ”¶å¤„ç†æµç¨‹**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. å®¢æˆ·ç«¯å‘é€æ•°æ®                                  â”‚
â”‚     send("Hello WuKongIM")                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. epollæ£€æµ‹åˆ°å¯è¯»äº‹ä»¶                            â”‚
â”‚     epoll_wait() è¿”å›ï¼š                            â”‚
â”‚     events[0] = {fd=1024, events=EPOLLIN}         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. SubReactor-0å¤„ç†                               â”‚
â”‚     â”œâ”€ conn = engine.GetConn(1024)                 â”‚
â”‚     â””â”€ reactorSub.read(conn)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. è¯»å–æ•°æ®                                       â”‚
â”‚     n = conn.ReadToInboundBuffer()                 â”‚
â”‚     â”œâ”€ è°ƒç”¨ read(1024, buf, 32768)                 â”‚
â”‚     â””â”€ è¯»å–16å­—èŠ‚ï¼š"Hello WuKongIM"                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. è§¦å‘OnDataå›è°ƒ                                 â”‚
â”‚     eventHandler.OnData(conn)                      â”‚
â”‚     â””â”€ WuKongIM: s.onData(conn, data)              â”‚
â”‚         â”œâ”€ è§£æWuKongIMåè®®                        â”‚
â”‚         â”œâ”€ åˆ†å‘åˆ°UserEventPool                     â”‚
â”‚         â””â”€ ä¸šåŠ¡å¤„ç†                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. ç»§ç»­ç›‘å¬                                       â”‚
â”‚     SubReactor-0ç»§ç»­ epoll_wait()                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **C. æ•°æ®å‘é€å¤„ç†æµç¨‹**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ä¸šåŠ¡å±‚å‘é€æ•°æ®                                  â”‚
â”‚     conn.Write([]byte("Response"))                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. å†™å…¥OutboundBuffer                             â”‚
â”‚     conn.OutboundBuffer.Write(data)                â”‚
â”‚     â””â”€ æ•°æ®æš‚å­˜åœ¨å‘é€ç¼“å†²åŒº                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. æ³¨å†Œå†™äº‹ä»¶ï¼ˆå¦‚æœæœªæ³¨å†Œï¼‰                        â”‚
â”‚     subReactor.AddWrite(conn)                      â”‚
â”‚     â””â”€ epoll_ctl(EPOLL_CTL_MOD, 1024,             â”‚
â”‚                  EPOLLIN|EPOLLOUT)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. epollæ£€æµ‹åˆ°å¯å†™äº‹ä»¶                            â”‚
â”‚     epoll_wait() è¿”å›ï¼š                            â”‚
â”‚     events[0] = {fd=1024, events=EPOLLOUT}        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. SubReactor-0å¤„ç†                               â”‚
â”‚     reactorSub.write(conn)                         â”‚
â”‚     â””â”€ conn.Flush()                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. å‘é€æ•°æ®                                       â”‚
â”‚     write(1024, OutboundBuffer, len)               â”‚
â”‚     â””â”€ å°†OutboundBufferæ•°æ®å‘é€åˆ°socket            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. ç§»é™¤å†™äº‹ä»¶ï¼ˆå¦‚æœç¼“å†²åŒºæ¸…ç©ºï¼‰                    â”‚
â”‚     subReactor.RemoveWrite(conn)                   â”‚
â”‚     â””â”€ epoll_ctl(EPOLL_CTL_MOD, 1024, EPOLLIN)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **D. è¿æ¥å…³é—­å¤„ç†æµç¨‹**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. æ£€æµ‹åˆ°å…³é—­äº‹ä»¶                                  â”‚
â”‚     epoll_wait() è¿”å›ï¼š                            â”‚
â”‚     events[0] = {fd=1024, events=EPOLLHUP}        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. SubReactor-0å¤„ç†                               â”‚
â”‚     reactorSub.CloseConn(conn, unix.ECONNRESET)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. ä»epollç§»é™¤                                    â”‚
â”‚     poller.Delete(1024)                            â”‚
â”‚     â””â”€ epoll_ctl(EPOLL_CTL_DEL, 1024, NULL)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. ä»connMatrixç§»é™¤                               â”‚
â”‚     engine.RemoveConn(conn)                        â”‚
â”‚     â””â”€ delete(connMatrix.conns, 1024)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. è§¦å‘OnCloseå›è°ƒ                                â”‚
â”‚     eventHandler.OnClose(conn)                     â”‚
â”‚     â””â”€ WuKongIM: s.onClose(conn)                   â”‚
â”‚         â”œâ”€ æ¸…ç†ç”¨æˆ·çŠ¶æ€                            â”‚
â”‚         â”œâ”€ è§¦å‘ç¦»çº¿äº‹ä»¶                            â”‚
â”‚         â””â”€ é‡Šæ”¾èµ„æº                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. å…³é—­socket                                     â”‚
â”‚     close(1024)                                    â”‚
â”‚     â””â”€ é‡Šæ”¾æ–‡ä»¶æè¿°ç¬¦                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7ï¸âƒ£ æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯

### **A. å¯¹è±¡æ± ï¼ˆsync.Poolï¼‰**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/engine.go:39-44`

```go
defaultConnPool: &sync.Pool{
    New: func() any {
        return &DefaultConn{}
    },
},
```

**ä½œç”¨**ï¼š
- å¤ç”¨è¿æ¥å¯¹è±¡ï¼Œå‡å°‘å†…å­˜åˆ†é…
- é™ä½GCå‹åŠ›
- æé«˜æ€§èƒ½

**ä½¿ç”¨æµç¨‹**ï¼š
```
1. è·å–è¿æ¥å¯¹è±¡
   conn := pool.Get().(*DefaultConn)

2. åˆå§‹åŒ–è¿æ¥
   conn.init(fd, addr, ...)

3. ä½¿ç”¨è¿æ¥
   ...

4. å…³é—­è¿æ¥åï¼Œå½’è¿˜å¯¹è±¡æ± 
   conn.reset()
   pool.Put(conn)
```

---

### **B. è¯»ç¼“å†²åŒºå¤ç”¨**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/reactor_sub.go:25`

```go
ReadBuffer []byte  // æ¯ä¸ªSubReactorä¸€ä¸ªè¯»ç¼“å†²åŒºï¼ˆ32KBï¼‰
```

**ä¼˜ç‚¹**ï¼š
- å‡å°‘å†…å­˜åˆ†é…
- ç¼“å†²åŒºåœ¨SubReactorçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…å¤ç”¨
- è¯»å–æ€§èƒ½æå‡

---

### **C. åŸå­æ“ä½œ**

**è¿æ¥è®¡æ•°**ï¼š
```go
connCount atomic.Int32  // åŸå­è®¡æ•°ï¼Œæ— é”
```

**å®¢æˆ·ç«¯IDç”Ÿæˆ**ï¼š
```go
clientIDGen atomic.Int64  // åŸå­é€’å¢ï¼Œæ— é”
```

**ä¼˜ç‚¹**ï¼š
- æ— é”æ“ä½œï¼Œæ€§èƒ½æé«˜
- é¿å…é”ç«äº‰
- é€‚åˆé«˜å¹¶å‘åœºæ™¯

---

### **D. éé˜»å¡I/O**

**æ‰€æœ‰socketè®¾ç½®ä¸ºéé˜»å¡**ï¼š
```go
unix.SetNonblock(connFd, true)
```

**å¥½å¤„**ï¼š
- read()ä¸ä¼šé˜»å¡ï¼Œç«‹å³è¿”å›
- write()ä¸ä¼šé˜»å¡ï¼Œç«‹å³è¿”å›
- é…åˆepollå®ç°çœŸæ­£çš„å¼‚æ­¥I/O

---

## 8ï¸âƒ£ æ€»ç»“

### **æ ¸å¿ƒè¦ç‚¹**

1. **ä¸‰å±‚æ¶æ„**ï¼š
   - Engineï¼šæ€»æ§å¼•æ“
   - MainReactorï¼šè´Ÿè´£Accept
   - SubReactorï¼šè´Ÿè´£I/Oå¤„ç†

2. **è¿æ¥åˆ†å‘**ï¼š
   - ä½¿ç”¨fdå–æ¨¡åˆ†é…SubReactor
   - ç®€å•é«˜æ•ˆï¼Œåˆ†å¸ƒå‡åŒ€

3. **è¿æ¥æŸ¥æ‰¾**ï¼š
   - connMatrixä½¿ç”¨mapå®ç°O(1)æŸ¥æ‰¾
   - æ€§èƒ½æ¯”æ•°ç»„æ–¹æ¡ˆæå‡100ä¸‡å€

4. **äº‹ä»¶é©±åŠ¨**ï¼š
   - epollç›‘å¬æ‰€æœ‰è¿æ¥çš„I/Oäº‹ä»¶
   - äº‹ä»¶å°±ç»ªæ‰å¤„ç†ï¼Œæ— é˜»å¡ç­‰å¾…

5. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - å¯¹è±¡æ± å¤ç”¨
   - ç¼“å†²åŒºå¤ç”¨
   - åŸå­æ“ä½œ
   - éé˜»å¡I/O

---

### **è®¾è®¡äº®ç‚¹**

| äº®ç‚¹ | è¯´æ˜ |
|------|------|
| **SubReactoræ•°é‡** | ç­‰äºCPUæ ¸å¿ƒæ•°ï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸ |
| **fdå–æ¨¡åˆ†é…** | ç®€å•é«˜æ•ˆï¼Œåˆ†å¸ƒå‡åŒ€ |
| **connMatrix** | O(1)æŸ¥æ‰¾ï¼Œæ€§èƒ½æä½³ |
| **æŒ‰éœ€æ³¨å†Œå†™äº‹ä»¶** | å‡å°‘epolläº‹ä»¶æ•°é‡ |
| **å¯¹è±¡æ± ** | å‡å°‘å†…å­˜åˆ†é…ï¼Œé™ä½GCå‹åŠ› |
| **åŸå­æ“ä½œ** | æ— é”é«˜å¹¶å‘ |

---

### **ä¸‹ä¸€èŠ‚é¢„å‘Š**

**3.3 è¿æ¥å¤„ç†æµç¨‹**
- å®Œæ•´è¿æ¥ç”Ÿå‘½å‘¨æœŸ
- åè®®è§£ææµç¨‹
- å¿ƒè·³ä¸è¶…æ—¶ç®¡ç†
- ä¼˜é›…å…³é—­æœºåˆ¶

---

> **ğŸ”— ç›¸å…³ä»£ç **ï¼š
> - Engineï¼š`pkg/wknet/engine.go:13-22`
> - ReactorMainï¼š`pkg/wknet/reactor_main.go:5-18`
> - Acceptorï¼š`pkg/wknet/acceptor.go:21-34`
> - ReactorSubï¼š`pkg/wknet/reactor_sub.go:19-29`
> - connMatrixï¼š`pkg/wknet/conn.go:872-911`
> - Pollerï¼š`pkg/wknet/netpoll/epoll_default_poller.go:21-52`
