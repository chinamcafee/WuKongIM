# 3.3 è¿æ¥å¤„ç†æµç¨‹

> **æœ¬èŠ‚ç›®æ ‡**ï¼šæ·±å…¥ç†è§£è¿æ¥çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼ŒæŒæ¡è¿æ¥å»ºç«‹ã€æ•°æ®æ”¶å‘ã€å¿ƒè·³ä¿æ´»ã€ä¼˜é›…å…³é—­çš„å®Œæ•´æµç¨‹

---

## ğŸ“‹ ç›®å½•
1. [è¿æ¥ç”Ÿå‘½å‘¨æœŸæ¦‚è§ˆ](#è¿æ¥ç”Ÿå‘½å‘¨æœŸæ¦‚è§ˆ)
2. [è¿æ¥å»ºç«‹æµç¨‹](#è¿æ¥å»ºç«‹æµç¨‹)
3. [æ•°æ®è¯»å–æµç¨‹](#æ•°æ®è¯»å–æµç¨‹)
4. [æ•°æ®å‘é€æµç¨‹](#æ•°æ®å‘é€æµç¨‹)
5. [å¿ƒè·³ä¸è¶…æ—¶ç®¡ç†](#å¿ƒè·³ä¸è¶…æ—¶ç®¡ç†)
6. [è¿æ¥å…³é—­æµç¨‹](#è¿æ¥å…³é—­æµç¨‹)

---

## 1ï¸âƒ£ è¿æ¥ç”Ÿå‘½å‘¨æœŸæ¦‚è§ˆ

### **A. å®Œæ•´ç”Ÿå‘½å‘¨æœŸ**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿æ¥ç”Ÿå‘½å‘¨æœŸï¼ˆä»å»ºç«‹åˆ°å…³é—­ï¼‰                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. è¿æ¥å»ºç«‹ï¼ˆEstablishï¼‰
   â”œâ”€ Acceptæ¥å—è¿æ¥
   â”œâ”€ åˆ›å»ºConnå¯¹è±¡
   â”œâ”€ æ³¨å†Œåˆ°epoll
   â””â”€ è§¦å‘OnConnectå›è°ƒ

2. è®¤è¯é˜¶æ®µï¼ˆAuthenticationï¼‰
   â”œâ”€ å®¢æˆ·ç«¯å‘é€CONNECTåŒ…
   â”œâ”€ æœåŠ¡ç«¯éªŒè¯token
   â”œâ”€ è®¾ç½®UIDå’ŒDeviceID
   â””â”€ æ ‡è®°ä¸ºå·²è®¤è¯ï¼ˆSetAuthedï¼‰

3. æ´»è·ƒé˜¶æ®µï¼ˆActiveï¼‰
   â”œâ”€ æ•°æ®æ”¶å‘
   â”œâ”€ å¿ƒè·³ä¿æŒ
   â”œâ”€ æ›´æ–°æ´»è·ƒæ—¶é—´
   â””â”€ è¶…æ—¶æ£€æµ‹

4. å…³é—­é˜¶æ®µï¼ˆCloseï¼‰
   â”œâ”€ æ£€æµ‹å…³é—­æ¡ä»¶
   â”œâ”€ è§¦å‘OnCloseå›è°ƒ
   â”œâ”€ æ¸…ç†èµ„æº
   â””â”€ é‡Šæ”¾fd
```

---

### **B. è¿æ¥çŠ¶æ€è½¬æ¢**

```
  [æ–°å»º]
    â”‚
    â†“
  Accept() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ [å·²è¿æ¥]
    â”‚                        â”‚
    â”‚                        â†“
    â”‚                   OnConnect()
    â”‚                        â”‚
    â”‚                        â†“
    â”‚                   ç­‰å¾…CONNECTåŒ…
    â”‚                        â”‚
    â”‚                        â†“
    â”‚                   è®¤è¯æˆåŠŸ
    â”‚                        â”‚
    â”‚                        â†“
    â”‚                   [å·²è®¤è¯] â†â”€â”€â”€â”€â”
    â”‚                        â”‚         â”‚
    â”‚                        â†“         â”‚
    â”‚                   æ´»è·ƒçŠ¶æ€       â”‚ å¿ƒè·³ä¿æŒ
    â”‚                        â”‚         â”‚
    â”‚                        â†“         â”‚
    â”‚                   æ•°æ®æ”¶å‘ â”€â”€â”€â”€â”€â”€â”˜
    â”‚                        â”‚
    â†“                        â†“
è¶…æ—¶/é”™è¯¯/ä¸»åŠ¨å…³é—­ â”€â”€â”€â”€â†’ [å·²å…³é—­]
    â”‚                        â”‚
    â”‚                        â†“
    â”‚                   OnClose()
    â”‚                        â”‚
    â”‚                        â†“
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ èµ„æºé‡Šæ”¾
```

---

## 2ï¸âƒ£ è¿æ¥å»ºç«‹æµç¨‹

### **A. Acceptè¿æ¥**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/acceptor.go:204-253`

```go
func (a *acceptor) acceptConn(listenFd int, ws bool, wss bool) error {
    // 1. ç³»ç»Ÿè°ƒç”¨Accept
    connFd, sa, err := unix.Accept(listenFd)
    if err != nil {
        if err == unix.EAGAIN {
            return nil  // æš‚æ— è¿æ¥
        }
        return perrors.ErrAcceptSocket
    }

    // 2. è®¾ç½®éé˜»å¡
    if err = unix.SetNonblock(connFd, true); err != nil {
        return err
    }

    // 3. è·å–è¿œç¨‹åœ°å€
    remoteAddr := socket.SockaddrToTCPOrUnixAddr(sa)

    // 4. è®¾ç½®TCP KeepAlive
    if a.eg.options.TCPKeepAlive > 0 {
        socket.SetKeepAlivePeriod(connFd,
            int(a.eg.options.TCPKeepAlive.Seconds()))
    }

    // 5. é€‰æ‹©SubReactorï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
    subReactor := a.reactorSubByConnFd(connFd)

    // 6. ç”Ÿæˆå®¢æˆ·ç«¯ID
    clientId := a.eg.GenClientID()

    // 7. åˆ›å»ºConnå¯¹è±¡
    var conn Conn
    if ws {
        conn, err = a.eg.eventHandler.OnNewWSConn(...)
    } else {
        conn, err = a.eg.eventHandler.OnNewConn(...)
    }

    // 8. æ·»åŠ åˆ°SubReactor
    err = subReactor.AddConn(conn)

    // 9. è§¦å‘OnConnectå›è°ƒ
    err = a.eg.eventHandler.OnConnect(conn)

    return nil
}
```

---

### **B. Connå¯¹è±¡åˆå§‹åŒ–**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/conn.go:152-187`

```go
func (d *DefaultConn) init(
    fd NetFd,
    localAddr, remoteAddr net.Addr,
    eg *Engine,
    reactorSub *ReactorSub,
    id int64,
) {
    // åŸºæœ¬å±æ€§
    d.fd = fd
    d.localAddr = localAddr
    d.remoteAddr = remoteAddr
    d.eg = eg
    d.reactorSub = reactorSub
    d.id.Store(id)

    // ç¼“å†²åŒºåˆå§‹åŒ–
    d.inboundBuffer = ring.New(eg.options.ReadBufferSize)
    d.outboundBuffer = ring.New(eg.options.MaxWriteBufferSize)

    // æ—¶é—´åˆå§‹åŒ–
    now := time.Now()
    d.uptime.Store(now)
    d.lastActivity.Store(now)

    // çŠ¶æ€åˆå§‹åŒ–
    d.closed.Store(false)
    d.authed.Store(false)
    d.isWAdded = false

    d.Log = wklog.NewWKLog(fmt.Sprintf("Conn[%d]", id))
}
```

**åˆå§‹åŒ–çš„å…³é”®è¦ç´ **ï¼š
```
1. fdï¼šæ–‡ä»¶æè¿°ç¬¦ï¼ˆsocketï¼‰
2. åœ°å€ï¼šlocalAddrã€remoteAddr
3. ç¼“å†²åŒºï¼š
   â”œâ”€ inboundBufferï¼šæ¥æ”¶ç¼“å†²åŒºï¼ˆring bufferï¼‰
   â””â”€ outboundBufferï¼šå‘é€ç¼“å†²åŒºï¼ˆring bufferï¼‰
4. æ—¶é—´ï¼š
   â”œâ”€ uptimeï¼šè¿æ¥å»ºç«‹æ—¶é—´
   â””â”€ lastActivityï¼šæœ€åæ´»è·ƒæ—¶é—´
5. çŠ¶æ€ï¼š
   â”œâ”€ closedï¼šæ˜¯å¦å·²å…³é—­
   â””â”€ authedï¼šæ˜¯å¦å·²è®¤è¯
```

---

### **C. æ³¨å†Œåˆ°SubReactor**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/reactor_sub.go:45-49`

```go
func (r *ReactorSub) AddConn(conn Conn) error {
    // 1. æ·»åŠ åˆ°Engineçš„connMatrix
    r.eg.AddConn(conn)

    // 2. å¢åŠ SubReactorçš„è¿æ¥è®¡æ•°
    r.connCount.Inc()

    // 3. æ³¨å†Œåˆ°epollï¼ˆåªç›‘å¬è¯»äº‹ä»¶ï¼‰
    return r.poller.AddRead(conn.Fd().fd)
}
```

**epollæ³¨å†Œ**ï¼š
```go
// pkg/wknet/netpoll/epoll_default_poller.go:122-125
func (p *Poller) AddRead(fd int) error {
    return unix.EpollCtl(p.fd, unix.EPOLL_CTL_ADD, fd,
        &unix.EpollEvent{
            Fd: int32(fd),
            Events: unix.EPOLLIN | unix.EPOLLET,  // è¯»äº‹ä»¶ + è¾¹ç¼˜è§¦å‘
        })
}
```

---

### **D. OnConnectå›è°ƒ**

**WuKongIMçš„å®ç°**ï¼š`internal/server/server.go:576-617`

```go
func (s *Server) onConnect(conn wknet.Conn) error {
    // 1. è®°å½•è¿æ¥æ—¥å¿—
    s.Info("new connection",
        zap.Int64("id", conn.ID()),
        zap.String("remoteAddr", conn.RemoteAddr().String()))

    // 2. è®¾ç½®æœ€å¤§ç©ºé—²æ—¶é—´
    conn.SetMaxIdle(s.opts.ConnIdleTime)  // é»˜è®¤5åˆ†é’Ÿ

    // 3. è§¦å‘è¿æ¥å»ºç«‹äº‹ä»¶
    s.userEventPool.AddEvent(&eventbus.UserContext{
        EventType: eventbus.EventConnect,
        Conn:      conn,
    })

    return nil
}
```

**EventConnectäº‹ä»¶å¤„ç†**ï¼š`internal/user/handler/event_connect.go`

```go
func (h *ConnectHandler) Handle(ctx *eventbus.UserContext) error {
    conn := ctx.Conn

    // ç­‰å¾…å®¢æˆ·ç«¯å‘é€CONNECTåŒ…
    // å¦‚æœ30ç§’å†…æœªæ”¶åˆ°ï¼Œè¿æ¥ä¼šå› è¶…æ—¶è¢«å…³é—­
    conn.SetReadDeadline(time.Now().Add(30 * time.Second))

    return nil
}
```

---

## 3ï¸âƒ£ æ•°æ®è¯»å–æµç¨‹

### **A. è¯»äº‹ä»¶è§¦å‘**

```
epoll_wait()æ£€æµ‹åˆ°fdå¯è¯»
    â†“
SubReactor.run() â†’ callback(fd, PollEventRead)
    â†“
SubReactor.read(conn)
    â†“
conn.ReadToInboundBuffer()
    â†“
eventHandler.OnData(conn)
```

---

### **B. ReadToInboundBufferå®ç°** â­

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/conn.go:209-224`

```go
func (d *DefaultConn) ReadToInboundBuffer() (int, error) {
    // 1. ä½¿ç”¨SubReactorçš„å…±äº«è¯»ç¼“å†²åŒº
    readBuffer := d.reactorSub.ReadBuffer  // 32KB

    // 2. è°ƒç”¨ç³»ç»Ÿè°ƒç”¨read
    n, err := d.fd.Read(readBuffer)
    if err != nil || n == 0 {
        return 0, err
    }

    // 3. ç»Ÿè®¡è¯»å–å­—èŠ‚æ•°ï¼ˆå¯é€‰ï¼‰
    if d.eg.options.Event.OnReadBytes != nil {
        d.eg.options.Event.OnReadBytes(n)
    }

    // 4. æ£€æŸ¥InboundBufferæ˜¯å¦æº¢å‡º
    if d.overflowForInbound(n) {
        return 0, fmt.Errorf("inbound buffer overflow, fd: %d currentSize: %d maxSize: %d",
            d.fd, d.inboundBuffer.BoundBufferSize()+n, d.eg.options.MaxReadBufferSize)
    }

    // 5. æ›´æ–°æœ€åæ´»è·ƒæ—¶é—´
    d.KeepLastActivity()

    // 6. å†™å…¥InboundBuffer
    _, err = d.inboundBuffer.Write(readBuffer[:n])
    return n, err
}
```

---

### **C. InboundBufferï¼ˆRing Bufferï¼‰**

**è®¾è®¡**ï¼š
```
Ring Bufferï¼ˆç¯å½¢ç¼“å†²åŒºï¼‰

  head                tail
    â†“                  â†“
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚ 1 â”‚ 2 â”‚ 3 â”‚ 4 â”‚   â”‚   â”‚   â”‚   â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜
    â†‘           â†‘
  å·²è¯»å–      å¾…è¯»å–

ç‰¹ç‚¹ï¼š
âœ… æ— éœ€ç§»åŠ¨æ•°æ®ï¼Œåªéœ€ç§»åŠ¨æŒ‡é’ˆ
âœ… è‡ªåŠ¨å¾ªç¯ä½¿ç”¨ï¼Œæ— æµªè´¹
âœ… O(1)å¤æ‚åº¦çš„è¯»å†™æ“ä½œ
```

**ä»£ç ä½ç½®**ï¼š`pkg/ring/ring.go`

```go
type RingBuffer struct {
    buf  []byte  // ç¼“å†²åŒº
    head int     // è¯»æŒ‡é’ˆ
    tail int     // å†™æŒ‡é’ˆ
    size int     // æ•°æ®å¤§å°
    cap  int     // å®¹é‡
}

// å†™å…¥æ•°æ®
func (r *RingBuffer) Write(p []byte) (n int, err error) {
    // å†™å…¥åˆ°tailä½ç½®
    // tailè‡ªåŠ¨å¾ªç¯
}

// è¯»å–æ•°æ®
func (r *RingBuffer) Read(p []byte) (n int, err error) {
    // ä»headä½ç½®è¯»å–
    // headè‡ªåŠ¨å‰è¿›
}
```

---

### **D. OnDataå›è°ƒ**

**WuKongIMçš„å®ç°**ï¼š`internal/server/server.go:619-652`

```go
func (s *Server) onData(conn wknet.Conn) error {
    // 1. è¯»å–InboundBufferä¸­çš„æ•°æ®
    for {
        // æ£€æŸ¥ç¼“å†²åŒºæ˜¯å¦ä¸ºç©º
        if conn.InboundBuffer().IsEmpty() {
            break
        }

        // 2. è§£æåè®®å¸§
        frame, err := s.protocol.Decode(conn)
        if err != nil {
            if err == io.ErrShortBuffer {
                break  // æ•°æ®ä¸å®Œæ•´ï¼Œç­‰å¾…æ›´å¤šæ•°æ®
            }
            return err
        }

        // 3. æ ¹æ®å¸§ç±»å‹åˆ†å‘äº‹ä»¶
        switch frame.FrameType {
        case wkproto.CONNECT:
            // è¿æ¥åŒ…
            s.userEventPool.AddEvent(&eventbus.UserContext{
                EventType: eventbus.EventOnConnect,
                Conn:      conn,
                Frame:     frame,
            })

        case wkproto.SEND:
            // å‘é€æ¶ˆæ¯åŒ…
            s.userEventPool.AddEvent(&eventbus.UserContext{
                EventType: eventbus.EventOnSend,
                Conn:      conn,
                Frame:     frame,
            })

        case wkproto.PING:
            // å¿ƒè·³åŒ…
            conn.Write(wkproto.EncodePong())

        case wkproto.RECVACK:
            // æ¥æ”¶ç¡®è®¤åŒ…
            s.userEventPool.AddEvent(&eventbus.UserContext{
                EventType: eventbus.EventRecvAck,
                Conn:      conn,
                Frame:     frame,
            })

        // ... å…¶ä»–å¸§ç±»å‹
        }
    }

    return nil
}
```

---

### **E. åè®®è§£æï¼ˆç²˜åŒ…/åŠåŒ…å¤„ç†ï¼‰**

**ç²˜åŒ…é—®é¢˜**ï¼š
```
å®¢æˆ·ç«¯å‘é€ï¼š
â”œâ”€ æ¶ˆæ¯1ï¼š10å­—èŠ‚
â””â”€ æ¶ˆæ¯2ï¼š20å­—èŠ‚

TCPæ¥æ”¶å¯èƒ½ï¼š
æƒ…å†µ1ï¼šä¸€æ¬¡æ€§æ”¶åˆ°30å­—èŠ‚ï¼ˆç²˜åŒ…ï¼‰
æƒ…å†µ2ï¼šç¬¬ä¸€æ¬¡10å­—èŠ‚ï¼Œç¬¬äºŒæ¬¡20å­—èŠ‚ï¼ˆæ­£å¸¸ï¼‰
æƒ…å†µ3ï¼šç¬¬ä¸€æ¬¡5å­—èŠ‚ï¼Œç¬¬äºŒæ¬¡25å­—èŠ‚ï¼ˆåŠåŒ…ï¼‰
```

**è§£å†³æ–¹æ¡ˆ**ï¼šåè®®å¤´åŒ…å«é•¿åº¦å­—æ®µ

```
WuKongIMåè®®æ ¼å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç±»å‹  â”‚  æ ‡å¿—  â”‚  é•¿åº¦  â”‚  æ•°æ®    â”‚
â”‚ 1å­—èŠ‚  â”‚ 1å­—èŠ‚  â”‚ 4å­—èŠ‚  â”‚ Nå­—èŠ‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è§£ææµç¨‹ï¼š
1. è¯»å–6å­—èŠ‚åŒ…å¤´ï¼ˆç±»å‹+æ ‡å¿—+é•¿åº¦ï¼‰
2. æ ¹æ®é•¿åº¦å­—æ®µçŸ¥é“æ•°æ®éƒ¨åˆ†æœ‰Nå­—èŠ‚
3. è¯»å–Nå­—èŠ‚æ•°æ®
4. å®Œæ•´å¸§è§£æå®Œæˆ

åŠåŒ…å¤„ç†ï¼š
â”œâ”€ å¦‚æœæ•°æ®ä¸è¶³ï¼Œè¿”å› io.ErrShortBuffer
â”œâ”€ æ•°æ®ä¿ç•™åœ¨InboundBufferä¸­
â””â”€ ç­‰å¾…ä¸‹æ¬¡è¯»äº‹ä»¶ï¼Œç»§ç»­è§£æ
```

---

## 4ï¸âƒ£ æ•°æ®å‘é€æµç¨‹

### **A. å‘é€API**

**ä¸¤ç§å‘é€æ–¹å¼**ï¼š

```go
// æ–¹å¼1ï¼šç›´æ¥å‘é€ï¼ˆéçº¿ç¨‹å®‰å…¨ï¼‰
conn.Write(data)

// æ–¹å¼2ï¼šå†™å…¥OutboundBufferï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
conn.WriteToOutboundBuffer(data)
conn.WakeWrite()  // å”¤é†’å†™äº‹ä»¶
```

---

### **B. Writeå®ç°**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/conn.go:241-253`

```go
func (d *DefaultConn) Write(b []byte) (int, error) {
    if d.closed.Load() {
        return -1, net.ErrClosed
    }

    n, err := d.write(b)
    if err != nil {
        return 0, err
    }
    return n, nil
}

func (d *DefaultConn) write(b []byte) (int, error) {
    // 1. å…ˆå°è¯•ç›´æ¥å†™å…¥socket
    n, err := d.fd.Write(b)
    if err != nil {
        if err == unix.EAGAIN {
            // å†…æ ¸ç¼“å†²åŒºæ»¡ï¼Œå†™å…¥OutboundBuffer
            _, err = d.outboundBuffer.Write(b)
            if err != nil {
                return 0, err
            }
            // æ³¨å†Œå†™äº‹ä»¶
            return len(b), d.addWriteIfNotExist()
        }
        return 0, err
    }

    // 2. å¦‚æœåªå†™å…¥äº†éƒ¨åˆ†æ•°æ®
    if n < len(b) {
        // å‰©ä½™æ•°æ®å†™å…¥OutboundBuffer
        _, err = d.outboundBuffer.Write(b[n:])
        if err != nil {
            return 0, err
        }
        // æ³¨å†Œå†™äº‹ä»¶
        return len(b), d.addWriteIfNotExist()
    }

    return n, nil
}
```

---

### **C. WriteToOutboundBufferå®ç°**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/conn.go:256-267`

```go
func (d *DefaultConn) WriteToOutboundBuffer(b []byte) (int, error) {
    if len(b) == 0 {
        return 0, nil
    }
    if d.closed.Load() {
        return -1, net.ErrClosed
    }

    d.mu.Lock()
    defer d.mu.Unlock()

    // ç›´æ¥å†™å…¥OutboundBuffer
    return d.outboundBuffer.Write(b)
}

// å”¤é†’å†™äº‹ä»¶
func (d *DefaultConn) WakeWrite() error {
    d.mu.Lock()
    defer d.mu.Unlock()

    if d.closed.Load() {
        return net.ErrClosed
    }

    // æ³¨å†Œå†™äº‹ä»¶ï¼ˆå¦‚æœæœªæ³¨å†Œï¼‰
    return d.addWriteIfNotExist()
}
```

---

### **D. æ³¨å†Œå†™äº‹ä»¶**

```go
func (d *DefaultConn) addWriteIfNotExist() error {
    if d.isWAdded {
        return nil  // å·²æ³¨å†Œï¼Œæ— éœ€é‡å¤
    }

    // å°†fdä¿®æ”¹ä¸ºç›‘å¬è¯»å†™äº‹ä»¶
    err := d.reactorSub.AddWrite(d)
    if err != nil {
        return err
    }

    d.isWAdded = true
    return nil
}
```

**epollä¿®æ”¹**ï¼š
```go
// pkg/wknet/netpoll/epoll_default_poller.go:127-130
func (p *Poller) AddWrite(fd int) error {
    return unix.EpollCtl(p.fd, unix.EPOLL_CTL_MOD, fd,
        &unix.EpollEvent{
            Fd: int32(fd),
            Events: unix.EPOLLIN | unix.EPOLLOUT | unix.EPOLLET,  // è¯»+å†™äº‹ä»¶
        })
}
```

---

### **E. Flushå®ç°ï¼ˆå†™äº‹ä»¶å›è°ƒï¼‰**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/conn.go:283-288`

```go
func (d *DefaultConn) Flush() error {
    if d.closed.Load() {
        return net.ErrClosed
    }
    return d.flush()
}

func (d *DefaultConn) flush() error {
    // 1. å¦‚æœOutboundBufferä¸ºç©ºï¼Œç§»é™¤å†™äº‹ä»¶
    if d.outboundBuffer.IsEmpty() {
        if d.isWAdded {
            err := d.reactorSub.RemoveWrite(d)
            if err != nil {
                return err
            }
            d.isWAdded = false
        }
        return nil
    }

    // 2. ä»OutboundBufferè¯»å–æ•°æ®å¹¶å‘é€
    for {
        // è·å–å¯è¯»æ•°æ®
        data, _ := d.outboundBuffer.Peek(d.outboundBuffer.BoundBufferSize())
        if len(data) == 0 {
            break
        }

        // è°ƒç”¨ç³»ç»Ÿè°ƒç”¨write
        n, err := d.fd.Write(data)
        if err != nil {
            if err == unix.EAGAIN {
                break  // å†…æ ¸ç¼“å†²åŒºæ»¡ï¼Œç­‰å¾…ä¸‹æ¬¡
            }
            return err
        }

        // ä¸¢å¼ƒå·²å‘é€çš„æ•°æ®
        d.outboundBuffer.Discard(n)

        // ç»Ÿè®¡å‘é€å­—èŠ‚æ•°
        if d.eg.options.Event.OnWirteBytes != nil {
            d.eg.options.Event.OnWirteBytes(n)
        }
    }

    // 3. å¦‚æœç¼“å†²åŒºæ¸…ç©ºï¼Œç§»é™¤å†™äº‹ä»¶
    if d.outboundBuffer.IsEmpty() && d.isWAdded {
        err := d.reactorSub.RemoveWrite(d)
        if err != nil {
            return err
        }
        d.isWAdded = false
    }

    return nil
}
```

---

### **F. å‘é€æµç¨‹æ€»ç»“**

```
ä¸šåŠ¡å±‚è°ƒç”¨ conn.Write(data)
    â†“
1. å°è¯•ç›´æ¥å†™å…¥socket
    â”œâ”€ æˆåŠŸ â†’ è¿”å›
    â””â”€ EAGAINæˆ–éƒ¨åˆ†å†™å…¥ â†’ ç»§ç»­
    â†“
2. å‰©ä½™æ•°æ®å†™å…¥OutboundBuffer
    â†“
3. æ³¨å†Œå†™äº‹ä»¶ï¼ˆEPOLLOUTï¼‰
    â†“
4. epollé€šçŸ¥fdå¯å†™
    â†“
5. SubReactor.write(conn) â†’ conn.Flush()
    â†“
6. ä»OutboundBufferè¯»å–æ•°æ®å¹¶å‘é€
    â”œâ”€ å…¨éƒ¨å‘é€ â†’ ç§»é™¤å†™äº‹ä»¶
    â””â”€ éƒ¨åˆ†å‘é€ â†’ ä¿ç•™å†™äº‹ä»¶ï¼Œç­‰å¾…ä¸‹æ¬¡
```

---

## 5ï¸âƒ£ å¿ƒè·³ä¸è¶…æ—¶ç®¡ç†

### **A. å¿ƒè·³æœºåˆ¶**

**å®¢æˆ·ç«¯å‘é€å¿ƒè·³**ï¼š
```
å®¢æˆ·ç«¯æ¯30ç§’å‘é€ä¸€æ¬¡PINGåŒ…
    â†“
æœåŠ¡ç«¯æ”¶åˆ°PING
    â†“
æœåŠ¡ç«¯å›å¤PONGåŒ…
    â†“
æ›´æ–°è¿æ¥çš„lastActivityæ—¶é—´
```

**ä»£ç å®ç°**ï¼š`internal/server/server.go:onData`

```go
case wkproto.PING:
    // æ”¶åˆ°å¿ƒè·³åŒ…ï¼Œç›´æ¥å›å¤PONG
    conn.Write(wkproto.EncodePong())
    // lastActivityä¼šåœ¨ReadToInboundBufferä¸­è‡ªåŠ¨æ›´æ–°
```

---

### **B. è¶…æ—¶æ£€æµ‹**

**SetMaxIdleè®¾ç½®æœ€å¤§ç©ºé—²æ—¶é—´**ï¼š

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/conn.go`

```go
func (d *DefaultConn) SetMaxIdle(duration time.Duration) {
    d.maxIdleLock.Lock()
    defer d.maxIdleLock.Unlock()

    d.maxIdle = duration

    // å–æ¶ˆæ—§çš„å®šæ—¶å™¨
    if d.idleTimer != nil {
        d.idleTimer.Stop()
    }

    // åˆ›å»ºæ–°çš„ç©ºé—²æ£€æµ‹å®šæ—¶å™¨
    d.idleTimer = d.eg.Schedule(duration, func() {
        // æ£€æŸ¥æ˜¯å¦è¶…æ—¶
        if time.Since(d.lastActivity.Load()) > d.maxIdle {
            // è¶…æ—¶ï¼Œå…³é—­è¿æ¥
            d.Close()
        } else {
            // æœªè¶…æ—¶ï¼Œç»§ç»­ä¸‹ä¸€è½®æ£€æµ‹
            d.SetMaxIdle(d.maxIdle)
        }
    })
}
```

---

### **C. æ—¶é—´è½®ï¼ˆTimingWheelï¼‰**

**ä½œç”¨**ï¼šé«˜æ•ˆç®¡ç†å¤§é‡å®šæ—¶ä»»åŠ¡

**ä¼ ç»Ÿæ–¹æ¡ˆé—®é¢˜**ï¼š
```go
// âŒ ä¸ºæ¯ä¸ªè¿æ¥åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨
for _, conn := range conns {
    time.AfterFunc(5*time.Minute, func() {
        checkTimeout(conn)
    })
}

é—®é¢˜ï¼š
- 100ä¸‡è¿æ¥ = 100ä¸‡ä¸ªtimer
- å†…å­˜å ç”¨å¤§
- è°ƒåº¦å¼€é”€é«˜
```

**æ—¶é—´è½®æ–¹æ¡ˆ**ï¼š
```
æ—¶é—´è½®ç»“æ„ï¼š
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚ 0 â”‚ 1 â”‚ 2 â”‚ 3 â”‚ 4 â”‚ 5 â”‚ 6 â”‚ 7 â”‚ ... 1000ä¸ªæ§½ä½
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜
  â†‘
æŒ‡é’ˆæ¯10msè½¬åŠ¨ä¸€æ¬¡

ä¼˜ç‚¹ï¼š
âœ… 100ä¸‡è¿æ¥å…±äº«ä¸€ä¸ªæ—¶é—´è½®
âœ… å†…å­˜å ç”¨ä½
âœ… O(1)æ’å…¥å’Œåˆ é™¤
```

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/engine.go:38`

```go
timingWheel: timingwheel.NewTimingWheel(
    time.Millisecond*10,  // tické—´éš”ï¼š10ms
    1000,                 // æ§½ä½æ•°ï¼š1000
)
```

---

### **D. æœ€åæ´»è·ƒæ—¶é—´æ›´æ–°**

**KeepLastActivityè‡ªåŠ¨æ›´æ–°**ï¼š

```go
// pkg/wknet/conn.go:226-228
func (d *DefaultConn) KeepLastActivity() {
    d.lastActivity.Store(time.Now())
}
```

**è°ƒç”¨æ—¶æœº**ï¼š
```
1. ReadToInboundBuffer() è¯»å–æ•°æ®æ—¶
2. OnData() å¤„ç†æ•°æ®æ—¶
3. å¿ƒè·³åŒ…åˆ°è¾¾æ—¶

æ•ˆæœï¼š
- åªè¦æœ‰æ•°æ®äº¤äº’ï¼Œè¿æ¥å°±ä¸ä¼šè¶…æ—¶
- å¦‚æœ5åˆ†é’Ÿæ— ä»»ä½•æ•°æ®ï¼Œè¿æ¥å…³é—­
```

---

## 6ï¸âƒ£ è¿æ¥å…³é—­æµç¨‹

### **A. å…³é—­è§¦å‘æ¡ä»¶**

```
1. å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­
   â””â”€ epollæ£€æµ‹åˆ°EPOLLHUPäº‹ä»¶

2. æœåŠ¡ç«¯ä¸»åŠ¨å…³é—­
   â””â”€ è°ƒç”¨ conn.Close()

3. è¶…æ—¶å…³é—­
   â””â”€ ç©ºé—²æ—¶é—´è¶…è¿‡maxIdle

4. é”™è¯¯å…³é—­
   â””â”€ è¯»å†™é”™è¯¯ã€åè®®é”™è¯¯
```

---

### **B. Closeå®ç°**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/conn.go:295-350`

```go
func (d *DefaultConn) close(closeErr error) error {
    d.mu.Lock()
    defer d.mu.Unlock()

    // 1. æ£€æŸ¥æ˜¯å¦å·²å…³é—­
    if d.closed.Load() {
        return nil
    }
    d.closed.Store(true)

    // 2. ä»epollç§»é™¤
    if closeErr != nil && !errors.Is(closeErr, syscall.ECONNRESET) {
        err := d.reactorSub.DeleteFd(d)
        if err != nil {
            d.Debug("delete fd from poller error", zap.Error(err))
        }
    }

    // 3. åœæ­¢ç©ºé—²æ£€æµ‹å®šæ—¶å™¨
    if d.idleTimer != nil {
        d.idleTimer.Stop()
        d.idleTimer = nil
    }

    // 4. ä»connMatrixç§»é™¤
    d.eg.RemoveConn(d)

    // 5. SubReactorè¿æ¥è®¡æ•°å‡1
    d.reactorSub.ConnDec()

    // 6. è§¦å‘OnCloseå›è°ƒ
    if d.eg.eventHandler.OnClose != nil {
        err := d.eg.eventHandler.OnClose(d, closeErr)
        if err != nil {
            d.Warn("OnClose error", zap.Error(err))
        }
    }

    // 7. æ¸…ç†ç¼“å†²åŒº
    d.inboundBuffer.Reset()
    d.outboundBuffer.Reset()

    // 8. å…³é—­socket
    err := d.fd.Close()
    if err != nil {
        d.Debug("close fd error", zap.Error(err))
    }

    return nil
}
```

---

### **C. OnCloseå›è°ƒ**

**WuKongIMçš„å®ç°**ï¼š`internal/server/server.go:654-680`

```go
func (s *Server) onClose(conn wknet.Conn, err error) error {
    // 1. è®°å½•å…³é—­æ—¥å¿—
    s.Info("connection closed",
        zap.Int64("id", conn.ID()),
        zap.String("uid", conn.UID()),
        zap.String("remoteAddr", conn.RemoteAddr().String()),
        zap.Error(err))

    // 2. å¦‚æœè¿æ¥æœªè®¤è¯ï¼Œç›´æ¥è¿”å›
    if !conn.IsAuthed() {
        return nil
    }

    // 3. è§¦å‘è¿æ¥å…³é—­äº‹ä»¶
    s.userEventPool.AddEvent(&eventbus.UserContext{
        EventType: eventbus.EventConnClose,
        Conn:      conn,
    })

    return nil
}
```

**EventConnCloseäº‹ä»¶å¤„ç†**ï¼š`internal/user/handler/event_close.go`

```go
func (h *CloseHandler) Handle(ctx *eventbus.UserContext) error {
    conn := ctx.Conn

    // 1. æ¸…ç†ç”¨æˆ·åœ¨çº¿çŠ¶æ€
    s.connManager.RemoveConn(conn.UID(), conn.ID())

    // 2. å¦‚æœç”¨æˆ·æ‰€æœ‰è®¾å¤‡éƒ½ç¦»çº¿ï¼Œè§¦å‘ç¦»çº¿äº‹ä»¶
    if s.connManager.GetConnCount(conn.UID()) == 0 {
        s.eventBus.Publish(&eventbus.Event{
            Type: eventbus.EventUserOffline,
            Data: conn.UID(),
        })
    }

    // 3. æ¸…ç†è®¢é˜…å…³ç³»ï¼ˆå¦‚æœéœ€è¦ï¼‰
    // ...

    return nil
}
```

---

### **D. ä¼˜é›…å…³é—­**

**ä»€ä¹ˆæ˜¯ä¼˜é›…å…³é—­ï¼Ÿ**
```
ä¼˜é›…å…³é—­ï¼ˆGraceful Shutdownï¼‰ï¼š
1. åœæ­¢æ¥å—æ–°è¿æ¥
2. ç­‰å¾…ç°æœ‰è¿æ¥å¤„ç†å®Œæˆ
3. å‘é€å…³é—­é€šçŸ¥
4. æ¸…ç†èµ„æº
5. å…³é—­æœåŠ¡
```

**WuKongIMçš„å®ç°**ï¼š`pkg/wknet/engine.go:54-61`

```go
func (e *Engine) Stop() error {
    // 1. åœæ­¢æ—¶é—´è½®
    e.timingWheel.Stop()

    // 2. åœæ­¢MainReactorï¼ˆåœæ­¢æ¥å—æ–°è¿æ¥ï¼‰
    err := e.reactorMain.Stop()
    if err != nil {
        return err
    }

    return nil
}
```

**Acceptoråœæ­¢**ï¼š`pkg/wknet/acceptor.go:100-148`

```go
func (a *acceptor) Stop() error {
    // 1. å…³é—­ç›‘å¬Poller
    a.listenPoller.Close()
    a.listenWSPoller.Close()
    a.listenWSSPoller.Close()

    // 2. å…³é—­ç›‘å¬socket
    if a.listen != nil {
        a.listen.Close()
    }
    if a.listenWS != nil {
        a.listenWS.Close()
    }
    if a.listenWSS != nil {
        a.listenWSS.Close()
    }

    // 3. åœæ­¢æ‰€æœ‰SubReactor
    for _, reactorSub := range a.reactorSubs {
        reactorSub.Stop()
    }

    return nil
}
```

**SubReactoråœæ­¢**ï¼š`pkg/wknet/reactor_sub.go:58-61`

```go
func (r *ReactorSub) Stop() error {
    // è®¾ç½®åœæ­¢æ ‡å¿—
    r.stopped.Store(true)

    // å…³é—­Pollerï¼ˆä¼šé€€å‡ºäº‹ä»¶å¾ªç¯ï¼‰
    return r.poller.Close()
}
```

---

## 7ï¸âƒ£ æ€»ç»“

### **æ ¸å¿ƒè¦ç‚¹**

1. **è¿æ¥ç”Ÿå‘½å‘¨æœŸ**ï¼š
   - å»ºç«‹ â†’ è®¤è¯ â†’ æ´»è·ƒ â†’ å…³é—­
   - æ¯ä¸ªé˜¶æ®µéƒ½æœ‰æ˜ç¡®çš„çŠ¶æ€å’Œå¤„ç†é€»è¾‘

2. **æ•°æ®è¯»å–**ï¼š
   - ReadToInboundBuffer()è¯»å–åˆ°Ring Buffer
   - OnData()è§£æåè®®å¹¶åˆ†å‘äº‹ä»¶
   - è‡ªåŠ¨å¤„ç†ç²˜åŒ…/åŠåŒ…é—®é¢˜

3. **æ•°æ®å‘é€**ï¼š
   - ä¼˜å…ˆç›´æ¥å‘é€ï¼ˆå‡å°‘æ‹·è´ï¼‰
   - å‘ä¸å‡ºå»å†™OutboundBuffer
   - æŒ‰éœ€æ³¨å†Œå†™äº‹ä»¶
   - Flush()æ—¶æ‰¹é‡å‘é€

4. **å¿ƒè·³ä¿æ´»**ï¼š
   - å®¢æˆ·ç«¯30ç§’å‘ä¸€æ¬¡PING
   - æœåŠ¡ç«¯å›å¤PONG
   - æ›´æ–°lastActivityæ—¶é—´
   - 5åˆ†é’Ÿæ— æ•°æ®è‡ªåŠ¨å…³é—­

5. **ä¼˜é›…å…³é—­**ï¼š
   - åœæ­¢æ¥å—æ–°è¿æ¥
   - ç­‰å¾…ç°æœ‰è¿æ¥å¤„ç†å®Œ
   - æ¸…ç†èµ„æº
   - è§¦å‘å›è°ƒ

---

### **è®¾è®¡äº®ç‚¹**

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **Ring Buffer** | æ— éœ€ç§»åŠ¨æ•°æ®ï¼Œé«˜æ•ˆè¯»å†™ |
| **æŒ‰éœ€å†™äº‹ä»¶** | å‡å°‘epolläº‹ä»¶æ•°é‡ |
| **æ—¶é—´è½®** | é«˜æ•ˆç®¡ç†100ä¸‡+è¿æ¥çš„è¶…æ—¶ |
| **åŸå­æ“ä½œ** | æ— é”æ›´æ–°çŠ¶æ€å’Œæ—¶é—´ |
| **ä¼˜é›…å…³é—­** | ä¸ä¸¢å¤±æ•°æ®ï¼Œå®Œæ•´æ¸…ç† |

---

### **ä¸‹ä¸€èŠ‚é¢„å‘Š**

**3.4 æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯**
- TimingWheelæ—¶é—´è½®è¯¦è§£
- ConnMatrixè¿æ¥çŸ©é˜µä¼˜åŒ–
- å¯¹è±¡æ± æŠ€æœ¯
- é›¶æ‹·è´æŠ€æœ¯

---

> **ğŸ”— ç›¸å…³ä»£ç **ï¼š
> - è¿æ¥å¯¹è±¡ï¼š`pkg/wknet/conn.go:124-149`
> - è¯»å–å®ç°ï¼š`pkg/wknet/conn.go:209-224`
> - å‘é€å®ç°ï¼š`pkg/wknet/conn.go:241-288`
> - å…³é—­å®ç°ï¼š`pkg/wknet/conn.go:295-350`
> - Ring Bufferï¼š`pkg/ring/ring.go`
