# 4.3 WebSocket æ”¯æŒ

> **æœ¬èŠ‚ç›®æ ‡**ï¼šæ·±å…¥ç†è§£WuKongIMçš„WebSocketæ”¯æŒå®ç°ï¼ŒæŒæ¡WebSocketåè®®ä¸äºŒè¿›åˆ¶åè®®çš„èåˆè®¾è®¡

---

## ğŸ“‹ ç›®å½•
1. [WebSocketæ¦‚è¿°](#websocketæ¦‚è¿°)
2. [WebSocketæ¡æ‰‹æµç¨‹](#websocketæ¡æ‰‹æµç¨‹)
3. [WebSocket Frameå°è£…](#websocket-frameå°è£…)
4. [JSONåè®®æ”¯æŒ](#jsonåè®®æ”¯æŒ)
5. [äºŒè¿›åˆ¶ä¸æ–‡æœ¬å…¼å®¹](#äºŒè¿›åˆ¶ä¸æ–‡æœ¬å…¼å®¹)
6. [æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–](#æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–)

---

## 1ï¸âƒ£ WebSocket æ¦‚è¿°

### **A. ä¸ºä»€ä¹ˆéœ€è¦WebSocketï¼Ÿ**

**ä¼ ç»ŸHTTPçš„é—®é¢˜**ï¼š
```
HTTPè½®è¯¢ï¼ˆPollingï¼‰ï¼š
å®¢æˆ·ç«¯æ¯éš”1ç§’è¯·æ±‚ä¸€æ¬¡
    â†“
GET /messages HTTP/1.1
    â†“
æœåŠ¡ç«¯å“åº”ï¼ˆå¯èƒ½æ— æ–°æ¶ˆæ¯ï¼‰
    â†“
1ç§’åå†æ¬¡è¯·æ±‚...

é—®é¢˜ï¼š
â”œâ”€ å¤§é‡æ— æ•ˆè¯·æ±‚ï¼ˆæµªè´¹å¸¦å®½ï¼‰
â”œâ”€ å»¶è¿Ÿé«˜ï¼ˆæœ€å¤š1ç§’å»¶è¿Ÿï¼‰
â”œâ”€ æœåŠ¡ç«¯å‹åŠ›å¤§ï¼ˆæ¯ç§’Nä¸ªHTTPè¿æ¥ï¼‰
â””â”€ æ— æ³•æ¨é€ï¼ˆåªèƒ½è¢«åŠ¨æ‹‰å–ï¼‰
```

---

**WebSocketçš„ä¼˜åŠ¿**ï¼š
```
WebSocketé•¿è¿æ¥ï¼š
å®¢æˆ·ç«¯å»ºç«‹è¿æ¥
    â†“
å‡çº§ä¸ºWebSocket
    â†“
ä¿æŒè¿æ¥
    â†“
åŒå‘å®æ—¶é€šä¿¡
    â†“
æœåŠ¡ç«¯ä¸»åŠ¨æ¨é€
    â†“
å®¢æˆ·ç«¯å®æ—¶æ¥æ”¶

ä¼˜ç‚¹ï¼š
âœ… å®æ—¶æ€§ï¼ˆæ¯«ç§’çº§å»¶è¿Ÿï¼‰
âœ… ä½å¼€é”€ï¼ˆæ— HTTPå¤´ï¼‰
âœ… åŒå‘é€šä¿¡ï¼ˆå…¨åŒå·¥ï¼‰
âœ… ä¸»åŠ¨æ¨é€ï¼ˆæœåŠ¡ç«¯é©±åŠ¨ï¼‰
âœ… è·¨åŸŸæ”¯æŒï¼ˆCORSå‹å¥½ï¼‰
```

---

### **B. WebSocket vs TCP**

| ç‰¹æ€§ | TCP | WebSocket |
|------|-----|-----------|
| **åè®®å±‚** | ä¼ è¾“å±‚ | åº”ç”¨å±‚ |
| **æ¡æ‰‹** | ä¸‰æ¬¡æ¡æ‰‹ | HTTPå‡çº§ |
| **æµè§ˆå™¨æ”¯æŒ** | å¦ | æ˜¯ âœ… |
| **è·¨åŸŸ** | æ— è·¨åŸŸæ¦‚å¿µ | æ”¯æŒCORS âœ… |
| **é˜²ç«å¢™** | å¯èƒ½è¢«æ‹¦æˆª | ä½¿ç”¨80/443ç«¯å£ âœ… |
| **è°ƒè¯•** | éœ€è¦ä¸“ç”¨å·¥å…· | æµè§ˆå™¨DevTools âœ… |
| **æ€§èƒ½** | æœ€ä¼˜ | ç•¥ä½ï¼ˆæœ‰åè®®å¼€é”€ï¼‰ |

**WuKongIMçš„é€‰æ‹©**ï¼š
```
åŒæ—¶æ”¯æŒï¼š
â”œâ”€ TCPï¼šç§»åŠ¨ç«¯SDKï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰
â”œâ”€ WebSocketï¼šWebæµè§ˆå™¨ï¼ˆå…¼å®¹æ€§ä¼˜å…ˆï¼‰
â””â”€ ç»Ÿä¸€åè®®ï¼ˆå†…éƒ¨éƒ½è½¬ä¸ºWuKongIMåè®®ï¼‰
```

---

### **C. WuKongIMçš„WebSocketæ¶æ„**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Webæµè§ˆå™¨ / å°ç¨‹åº                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WuKongIM WebSocket Listener (5200ç«¯å£)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”œâ”€ WebSocketæ¡æ‰‹                            â”‚
â”‚  â”œâ”€ WebSocket Frameè§£å°è£…                    â”‚
â”‚  â”œâ”€ JSON â†” äºŒè¿›åˆ¶åè®®è½¬æ¢                     â”‚
â”‚  â””â”€ ç»Ÿä¸€æ¥å…¥Reactoräº‹ä»¶å¾ªç¯                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç»Ÿä¸€çš„WuKongIMåè®®å¤„ç†                       â”‚
â”‚  ï¼ˆä¸TCPå®¢æˆ·ç«¯å…±äº«åŒä¸€å¥—é€»è¾‘ï¼‰                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2ï¸âƒ£ WebSocket æ¡æ‰‹æµç¨‹

### **A. æ¡æ‰‹è¯·æ±‚**

**HTTPå‡çº§è¯·æ±‚**ï¼š
```http
GET /ws HTTP/1.1
Host: localhost:5200
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
Sec-WebSocket-Version: 13
Sec-WebSocket-Protocol: wukongim
Origin: http://localhost:3000
```

**å…³é”®å­—æ®µ**ï¼š
```
Upgrade: websocket
  â””â”€ è¯·æ±‚å‡çº§åè®®

Connection: Upgrade
  â””â”€ è¿æ¥å‡çº§

Sec-WebSocket-Key: éšæœºå­—ç¬¦ä¸²ï¼ˆBase64ï¼‰
  â””â”€ é˜²æ­¢ç¼“å­˜ä»£ç†æ”»å‡»

Sec-WebSocket-Version: 13
  â””â”€ WebSocketåè®®ç‰ˆæœ¬

Sec-WebSocket-Protocol: wukongim
  â””â”€ å­åè®®ï¼ˆå¯é€‰ï¼‰
```

---

### **B. æ¡æ‰‹å“åº”**

**æœåŠ¡ç«¯å“åº”**ï¼š
```http
HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=
Sec-WebSocket-Protocol: wukongim
```

**å…³é”®å­—æ®µ**ï¼š
```
HTTP/1.1 101 Switching Protocols
  â””â”€ çŠ¶æ€ç 101ï¼šåè®®åˆ‡æ¢

Sec-WebSocket-Accept: è®¡ç®—å€¼
  â””â”€ SHA-1(Sec-WebSocket-Key + GUID)
  â””â”€ éªŒè¯æ¡æ‰‹æˆåŠŸ

è®¡ç®—å…¬å¼ï¼š
key = "dGhlIHNhbXBsZSBub25jZQ=="
guid = "258EAFA5-E914-47DA-95CA-C5AB0DC85B11"
accept = base64(sha1(key + guid))
```

---

### **C. WuKongIMæ¡æ‰‹å®ç°**

**ä»£ç ä½ç½®**ï¼š`pkg/wknet/ws_conn.go`

```go
type WSConn struct {
    *DefaultConn              // åµŒå…¥é»˜è®¤è¿æ¥
    upgrader     *websocket.Upgrader  // WebSocketå‡çº§å™¨
}

func NewWSConn(
    id int64,
    fd NetFd,
    localAddr, remoteAddr net.Addr,
    engine *Engine,
    reactorSub *ReactorSub,
) (*WSConn, error) {
    // 1. åˆ›å»ºåŸºç¡€è¿æ¥
    conn := &WSConn{
        DefaultConn: &DefaultConn{},
    }
    conn.init(fd, localAddr, remoteAddr, engine, reactorSub, id)

    // 2. åˆ›å»ºWebSocket Upgrader
    conn.upgrader = &websocket.Upgrader{
        CheckOrigin: func(r *http.Request) bool {
            // å…è®¸æ‰€æœ‰æ¥æºï¼ˆç”Ÿäº§ç¯å¢ƒåº”é™åˆ¶ï¼‰
            return true
        },
        Subprotocols: []string{"wukongim"},
    }

    // 3. æ‰§è¡Œæ¡æ‰‹
    err := conn.handshake()
    if err != nil {
        return nil, err
    }

    return conn, nil
}
```

---

**æ¡æ‰‹æµç¨‹**ï¼š
```go
func (w *WSConn) handshake() error {
    // 1. ä»socketè¯»å–HTTPè¯·æ±‚
    request, err := http.ReadRequest(bufio.NewReader(w.fd))
    if err != nil {
        return err
    }

    // 2. æ£€æŸ¥å‡çº§è¯·æ±‚
    if !isWebSocketUpgrade(request) {
        return errors.New("not a websocket upgrade request")
    }

    // 3. éªŒè¯Sec-WebSocket-Key
    key := request.Header.Get("Sec-WebSocket-Key")
    if key == "" {
        return errors.New("missing Sec-WebSocket-Key")
    }

    // 4. è®¡ç®—Sec-WebSocket-Accept
    accept := computeAcceptKey(key)

    // 5. æ„é€ å“åº”
    response := buildUpgradeResponse(accept)

    // 6. å‘é€å“åº”
    _, err = w.fd.Write([]byte(response))
    if err != nil {
        return err
    }

    // 7. æ¡æ‰‹å®Œæˆï¼Œè¿æ¥å‡çº§ä¸ºWebSocket
    w.upgraded = true

    return nil
}
```

---

**è¾…åŠ©å‡½æ•°**ï¼š
```go
func isWebSocketUpgrade(r *http.Request) bool {
    return r.Header.Get("Upgrade") == "websocket" &&
           r.Header.Get("Connection") == "Upgrade"
}

func computeAcceptKey(key string) string {
    const guid = "258EAFA5-E914-47DA-95CA-C5AB0DC85B11"
    h := sha1.New()
    h.Write([]byte(key + guid))
    return base64.StdEncoding.EncodeToString(h.Sum(nil))
}

func buildUpgradeResponse(accept string) string {
    return "HTTP/1.1 101 Switching Protocols\r\n" +
           "Upgrade: websocket\r\n" +
           "Connection: Upgrade\r\n" +
           "Sec-WebSocket-Accept: " + accept + "\r\n" +
           "Sec-WebSocket-Protocol: wukongim\r\n" +
           "\r\n"
}
```

---

## 3ï¸âƒ£ WebSocket Frame å°è£…

### **A. WebSocketå¸§æ ¼å¼**

**RFC 6455 å®šä¹‰**ï¼š
```
WebSocket Frameç»“æ„ï¼š

  0                   1                   2                   3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-------+-+-------------+-------------------------------+
 |F|R|R|R| opcode|M| Payload len |    Extended payload length    |
 |I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |
 |N|V|V|V|       |S|             |   (if payload len==126/127)   |
 | |1|2|3|       |K|             |                               |
 +-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +
 |     Extended payload length continued, if payload len == 127  |
 + - - - - - - - - - - - - - - - +-------------------------------+
 |                               |Masking-key, if MASK set to 1  |
 +-------------------------------+-------------------------------+
 | Masking-key (continued)       |          Payload Data         |
 +-------------------------------- - - - - - - - - - - - - - - - +
 :                     Payload Data continued ...                :
 + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
 |                     Payload Data continued ...                |
 +---------------------------------------------------------------+
```

**å­—æ®µè¯´æ˜**ï¼š
```
FIN (1 bit)ï¼šæ˜¯å¦æœ€åä¸€å¸§
  â”œâ”€ 1: æœ€åä¸€å¸§
  â””â”€ 0: è¿˜æœ‰åç»­å¸§ï¼ˆåˆ†ç‰‡ï¼‰

RSV1-3 (3 bits)ï¼šé¢„ç•™ï¼ˆæ‰©å±•ç”¨ï¼‰

Opcode (4 bits)ï¼šå¸§ç±»å‹
  â”œâ”€ 0x0: ç»§ç»­å¸§
  â”œâ”€ 0x1: æ–‡æœ¬å¸§ï¼ˆUTF-8ï¼‰
  â”œâ”€ 0x2: äºŒè¿›åˆ¶å¸§
  â”œâ”€ 0x8: å…³é—­å¸§
  â”œâ”€ 0x9: PINGå¸§
  â””â”€ 0xA: PONGå¸§

MASK (1 bit)ï¼šæ˜¯å¦æ©ç 
  â”œâ”€ å®¢æˆ·ç«¯â†’æœåŠ¡ç«¯ï¼šå¿…é¡»ä¸º1
  â””â”€ æœåŠ¡ç«¯â†’å®¢æˆ·ç«¯ï¼šå¿…é¡»ä¸º0

Payload length (7/7+16/7+64 bits)ï¼šè´Ÿè½½é•¿åº¦
  â”œâ”€ 0-125: ç›´æ¥è¡¨ç¤ºé•¿åº¦
  â”œâ”€ 126: åç»­2å­—èŠ‚è¡¨ç¤ºé•¿åº¦
  â””â”€ 127: åç»­8å­—èŠ‚è¡¨ç¤ºé•¿åº¦

Masking-key (0/4 bytes)ï¼šæ©ç å¯†é’¥
  â””â”€ MASK=1æ—¶å­˜åœ¨

Payload Dataï¼šå®é™…æ•°æ®
```

---

### **B. WuKongIMåè®®å°è£…**

**WuKongIM Frame â†’ WebSocket Frame**

```
å‘é€æµç¨‹ï¼ˆæœåŠ¡ç«¯â†’å®¢æˆ·ç«¯ï¼‰ï¼š

1. WuKongIM Frameï¼ˆäºŒè¿›åˆ¶ï¼‰
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ FrameType(1) + Flag(1) + Len(4)  â”‚
   â”‚ + Payload                        â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
2. å°è£…ä¸ºWebSocket Frame
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ FIN=1, Opcode=0x2ï¼ˆäºŒè¿›åˆ¶ï¼‰       â”‚
   â”‚ MASK=0ï¼ˆæœåŠ¡ç«¯ä¸æ©ç ï¼‰            â”‚
   â”‚ Payload = WuKongIM Frame         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
3. å‘é€åˆ°socket
```

---

**ä»£ç å®ç°**ï¼š
```go
func (w *WSConn) Write(data []byte) (int, error) {
    // 1. æ„é€ WebSocket Frameå¤´
    header := make([]byte, 10)  // æœ€å¤§å¤´éƒ¨é•¿åº¦
    pos := 0

    // FIN=1, Opcode=0x2ï¼ˆäºŒè¿›åˆ¶å¸§ï¼‰
    header[pos] = 0x82  // 1000 0010
    pos++

    // Payloadé•¿åº¦
    dataLen := len(data)
    if dataLen <= 125 {
        header[pos] = byte(dataLen)
        pos++
    } else if dataLen <= 65535 {
        header[pos] = 126
        pos++
        binary.BigEndian.PutUint16(header[pos:], uint16(dataLen))
        pos += 2
    } else {
        header[pos] = 127
        pos++
        binary.BigEndian.PutUint64(header[pos:], uint64(dataLen))
        pos += 8
    }

    // 2. å‘é€WebSocket Frame
    // å…ˆå‘é€å¤´éƒ¨
    _, err := w.fd.Write(header[:pos])
    if err != nil {
        return 0, err
    }

    // å†å‘é€æ•°æ®
    n, err := w.fd.Write(data)
    return n, err
}
```

---

### **C. WebSocket Frameè§£å°è£…**

**WebSocket Frame â†’ WuKongIM Frame**

```
æ¥æ”¶æµç¨‹ï¼ˆå®¢æˆ·ç«¯â†’æœåŠ¡ç«¯ï¼‰ï¼š

1. æ¥æ”¶WebSocket Frame
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ FIN=1, Opcode=0x2ï¼ˆäºŒè¿›åˆ¶ï¼‰       â”‚
   â”‚ MASK=1ï¼ˆå®¢æˆ·ç«¯å¿…é¡»æ©ç ï¼‰          â”‚
   â”‚ Masking-key: [k0, k1, k2, k3]    â”‚
   â”‚ Payload: æ©ç åçš„æ•°æ®             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
2. è§£æ©ç 
   for i := 0; i < len(payload); i++ {
       payload[i] ^= maskingKey[i % 4]
   }
           â†“
3. æå–WuKongIM Frame
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ FrameType(1) + Flag(1) + Len(4)  â”‚
   â”‚ + Payload                        â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
4. æ­£å¸¸åè®®è§£æ
```

---

**ä»£ç å®ç°**ï¼š
```go
func (w *WSConn) ReadToInboundBuffer() (int, error) {
    // 1. è¯»å–WebSocket Frameå¤´
    header := make([]byte, 2)
    _, err := io.ReadFull(w.fd, header)
    if err != nil {
        return 0, err
    }

    // 2. è§£æFINå’ŒOpcode
    fin := (header[0] & 0x80) != 0
    opcode := header[0] & 0x0F

    // 3. è§£æMASKå’Œé•¿åº¦
    masked := (header[1] & 0x80) != 0
    payloadLen := int(header[1] & 0x7F)

    // 4. è¯»å–æ‰©å±•é•¿åº¦
    if payloadLen == 126 {
        buf := make([]byte, 2)
        io.ReadFull(w.fd, buf)
        payloadLen = int(binary.BigEndian.Uint16(buf))
    } else if payloadLen == 127 {
        buf := make([]byte, 8)
        io.ReadFull(w.fd, buf)
        payloadLen = int(binary.BigEndian.Uint64(buf))
    }

    // 5. è¯»å–æ©ç å¯†é’¥
    var maskingKey [4]byte
    if masked {
        io.ReadFull(w.fd, maskingKey[:])
    }

    // 6. è¯»å–è´Ÿè½½æ•°æ®
    payload := make([]byte, payloadLen)
    _, err = io.ReadFull(w.fd, payload)
    if err != nil {
        return 0, err
    }

    // 7. è§£æ©ç 
    if masked {
        for i := 0; i < payloadLen; i++ {
            payload[i] ^= maskingKey[i%4]
        }
    }

    // 8. å¤„ç†ä¸åŒOpcode
    switch opcode {
    case 0x1:  // æ–‡æœ¬å¸§
        return w.handleTextFrame(payload)
    case 0x2:  // äºŒè¿›åˆ¶å¸§
        return w.handleBinaryFrame(payload)
    case 0x8:  // å…³é—­å¸§
        return 0, io.EOF
    case 0x9:  // PINGå¸§
        return w.handlePing(payload)
    case 0xA:  // PONGå¸§
        return w.handlePong(payload)
    default:
        return 0, fmt.Errorf("unknown opcode: %d", opcode)
    }
}
```

---

**äºŒè¿›åˆ¶å¸§å¤„ç†**ï¼š
```go
func (w *WSConn) handleBinaryFrame(payload []byte) (int, error) {
    // äºŒè¿›åˆ¶å¸§ç›´æ¥æ˜¯WuKongIMåè®®
    // å†™å…¥InboundBufferï¼Œåç»­æŒ‰æ­£å¸¸æµç¨‹è§£æ
    n, err := w.inboundBuffer.Write(payload)
    return n, err
}
```

---

## 4ï¸âƒ£ JSON åè®®æ”¯æŒ

### **A. ä¸ºä»€ä¹ˆæ”¯æŒJSONï¼Ÿ**

```
åœºæ™¯ï¼š
â”œâ”€ Webæµè§ˆå™¨è°ƒè¯•ï¼ˆChrome DevToolsï¼‰
â”œâ”€ å¿«é€ŸåŸå‹å¼€å‘ï¼ˆæ— éœ€ç¼–è§£ç ï¼‰
â”œâ”€ è·¨è¯­è¨€å…¼å®¹ï¼ˆJavaScriptå‹å¥½ï¼‰
â””â”€ ç¬¬ä¸‰æ–¹é›†æˆï¼ˆWebhookå›è°ƒï¼‰

ä¼˜ç‚¹ï¼š
âœ… å¯è¯»æ€§å¼º
âœ… è°ƒè¯•æ–¹ä¾¿
âœ… å¹¿æ³›æ”¯æŒ

ç¼ºç‚¹ï¼š
âŒ ä½“ç§¯å¤§ï¼ˆæ¯”äºŒè¿›åˆ¶å¤§2-3å€ï¼‰
âŒ è§£ææ…¢ï¼ˆæ¯”äºŒè¿›åˆ¶æ…¢10å€+ï¼‰
âŒ å†…å­˜åˆ†é…å¤š
```

---

### **B. JSONä¸äºŒè¿›åˆ¶å¯¹ç…§**

**ç¤ºä¾‹ï¼šSENDæ¶ˆæ¯**

**äºŒè¿›åˆ¶æ ¼å¼**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 0x02   â”‚ 0x00   â”‚ 0x00000050 â”‚ Setting+ClientMsgNo+... â”‚
â”‚ SEND   â”‚ Flag   â”‚ Length=80  â”‚ Payload                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ€»å¤§å°ï¼š86å­—èŠ‚
```

---

**JSONæ ¼å¼**ï¼š
```json
{
  "frame_type": "SEND",
  "flag": 0,
  "setting": 0,
  "client_msg_no": "msg001",
  "channel_id": "channel001",
  "channel_type": 2,
  "payload": "Hello WuKongIM"
}

æ€»å¤§å°ï¼šçº¦150å­—èŠ‚ï¼ˆæ¯”äºŒè¿›åˆ¶å¤§75%ï¼‰
```

---

### **C. JSONåè®®å®ç°**

**æ–‡æœ¬å¸§å¤„ç†**ï¼š
```go
func (w *WSConn) handleTextFrame(payload []byte) (int, error) {
    // 1. è§£æJSON
    var jsonFrame JSONFrame
    err := json.Unmarshal(payload, &jsonFrame)
    if err != nil {
        return 0, err
    }

    // 2. è½¬æ¢ä¸ºäºŒè¿›åˆ¶Frame
    binaryFrame, err := jsonFrameToBinary(&jsonFrame)
    if err != nil {
        return 0, err
    }

    // 3. ç¼–ç ä¸ºäºŒè¿›åˆ¶åè®®
    data, err := binaryFrame.Encode()
    if err != nil {
        return 0, err
    }

    // 4. å†™å…¥InboundBuffer
    n, err := w.inboundBuffer.Write(data)
    return n, err
}
```

---

**JSONFrameå®šä¹‰**ï¼š
```go
type JSONFrame struct {
    FrameType    string `json:"frame_type"`    // "SEND", "RECV", etc.
    Flag         uint8  `json:"flag"`
    Setting      uint8  `json:"setting,omitempty"`
    ClientMsgNo  string `json:"client_msg_no,omitempty"`
    ChannelID    string `json:"channel_id,omitempty"`
    ChannelType  uint8  `json:"channel_type,omitempty"`
    Payload      string `json:"payload,omitempty"`      // Base64ç¼–ç 
    // ... å…¶ä»–å­—æ®µ
}
```

---

**JSONâ†’äºŒè¿›åˆ¶è½¬æ¢**ï¼š
```go
func jsonFrameToBinary(jf *JSONFrame) (*Frame, error) {
    frame := &Frame{}

    // 1. è½¬æ¢FrameType
    switch jf.FrameType {
    case "CONNECT":
        frame.FrameType = CONNECT
    case "SEND":
        frame.FrameType = SEND
    case "RECV":
        frame.FrameType = RECV
    case "PING":
        frame.FrameType = PING
    case "PONG":
        frame.FrameType = PONG
    // ... å…¶ä»–ç±»å‹
    default:
        return nil, fmt.Errorf("unknown frame type: %s", jf.FrameType)
    }

    // 2. å¤åˆ¶å…¶ä»–å­—æ®µ
    frame.Flag = jf.Flag
    frame.Setting = jf.Setting
    frame.ClientMsgNo = jf.ClientMsgNo
    frame.ChannelID = jf.ChannelID
    frame.ChannelType = jf.ChannelType

    // 3. è§£ç Base64 Payload
    if jf.Payload != "" {
        payload, err := base64.StdEncoding.DecodeString(jf.Payload)
        if err != nil {
            return nil, err
        }
        frame.Payload = payload
    }

    return frame, nil
}
```

---

**äºŒè¿›åˆ¶â†’JSONè½¬æ¢**ï¼š
```go
func binaryFrameToJSON(bf *Frame) (*JSONFrame, error) {
    jf := &JSONFrame{}

    // 1. è½¬æ¢FrameType
    jf.FrameType = bf.FrameType.String()  // "SEND"

    // 2. å¤åˆ¶å…¶ä»–å­—æ®µ
    jf.Flag = bf.Flag
    jf.Setting = bf.Setting
    jf.ClientMsgNo = bf.ClientMsgNo
    jf.ChannelID = bf.ChannelID
    jf.ChannelType = bf.ChannelType

    // 3. Base64ç¼–ç Payload
    if len(bf.Payload) > 0 {
        jf.Payload = base64.StdEncoding.EncodeToString(bf.Payload)
    }

    return jf, nil
}
```

---

### **D. è‡ªåŠ¨åè®®æ£€æµ‹**

```go
func (w *WSConn) handleTextFrame(payload []byte) (int, error) {
    // å°è¯•è§£æä¸ºJSON
    if json.Valid(payload) {
        return w.handleJSONProtocol(payload)
    }

    // å¦åˆ™å½“ä½œæ–‡æœ¬æ¶ˆæ¯
    return w.handleTextMessage(payload)
}

func (w *WSConn) handleBinaryFrame(payload []byte) (int, error) {
    // æ£€æŸ¥æ˜¯å¦ä¸ºWuKongIMäºŒè¿›åˆ¶åè®®
    if isWuKongIMProtocol(payload) {
        return w.handleBinaryProtocol(payload)
    }

    // å¦åˆ™å½“ä½œäºŒè¿›åˆ¶æ¶ˆæ¯
    return w.handleBinaryMessage(payload)
}

func isWuKongIMProtocol(data []byte) bool {
    if len(data) < 6 {
        return false
    }

    // æ£€æŸ¥FrameTypeæ˜¯å¦æœ‰æ•ˆ
    frameType := FrameType(data[0])
    return isValidFrameType(frameType)
}
```

---

## 5ï¸âƒ£ äºŒè¿›åˆ¶ä¸æ–‡æœ¬å…¼å®¹

### **A. åè®®åå•†**

**å®¢æˆ·ç«¯æŒ‡å®šåè®®**ï¼š
```javascript
// JavaScript WebSocketå®¢æˆ·ç«¯

// æ–¹å¼1ï¼šä½¿ç”¨äºŒè¿›åˆ¶åè®®
const ws = new WebSocket('ws://localhost:5200/ws', 'wukongim-binary');
ws.binaryType = 'arraybuffer';

// å‘é€äºŒè¿›åˆ¶Frame
const frame = new Uint8Array([0x02, 0x00, 0x00, 0x00, 0x00, 0x50, ...]);
ws.send(frame);

// æ–¹å¼2ï¼šä½¿ç”¨JSONåè®®
const ws = new WebSocket('ws://localhost:5200/ws', 'wukongim-json');

// å‘é€JSON Frame
const frame = {
    frame_type: "SEND",
    channel_id: "channel001",
    channel_type: 2,
    payload: btoa("Hello WuKongIM")  // Base64ç¼–ç 
};
ws.send(JSON.stringify(frame));
```

---

### **B. æœåŠ¡ç«¯é€‚é…**

```go
type WSConn struct {
    *DefaultConn
    protocol string  // "binary" or "json"
}

func NewWSConn(...) (*WSConn, error) {
    // ... æ¡æ‰‹é€»è¾‘

    // 1. ä»æ¡æ‰‹è¯·æ±‚ä¸­è·å–å­åè®®
    protocol := request.Header.Get("Sec-WebSocket-Protocol")

    conn := &WSConn{
        DefaultConn: &DefaultConn{},
        protocol:    protocol,
    }

    // 2. æ ¹æ®åè®®é€‰æ‹©å¤„ç†æ–¹å¼
    if protocol == "wukongim-json" {
        conn.useJSONProtocol = true
    } else {
        conn.useJSONProtocol = false  // é»˜è®¤äºŒè¿›åˆ¶
    }

    return conn, nil
}
```

---

**è¯»å–å¤„ç†**ï¼š
```go
func (w *WSConn) handleTextFrame(payload []byte) (int, error) {
    if w.useJSONProtocol {
        // JSONåè®®ï¼šè§£æJSONå¹¶è½¬æ¢ä¸ºäºŒè¿›åˆ¶
        return w.handleJSONFrame(payload)
    } else {
        // æ–‡æœ¬æ¶ˆæ¯ï¼ˆç›´æ¥å½“ä½œå­—ç¬¦ä¸²ï¼‰
        return w.handleTextMessage(payload)
    }
}

func (w *WSConn) handleBinaryFrame(payload []byte) (int, error) {
    if w.useJSONProtocol {
        // JSONåè®®å¯èƒ½ç”¨äºŒè¿›åˆ¶ä¼ è¾“ï¼ˆç½•è§ï¼‰
        return w.handleJSONFrame(payload)
    } else {
        // äºŒè¿›åˆ¶åè®®ï¼šç›´æ¥å†™å…¥InboundBuffer
        return w.inboundBuffer.Write(payload)
    }
}
```

---

**å†™å…¥å¤„ç†**ï¼š
```go
func (w *WSConn) Write(data []byte) (int, error) {
    if w.useJSONProtocol {
        // 1. è§£æäºŒè¿›åˆ¶Frame
        frame, err := Decode(data)
        if err != nil {
            return 0, err
        }

        // 2. è½¬æ¢ä¸ºJSON
        jsonFrame, err := binaryFrameToJSON(frame)
        if err != nil {
            return 0, err
        }

        // 3. åºåˆ—åŒ–JSON
        jsonData, err := json.Marshal(jsonFrame)
        if err != nil {
            return 0, err
        }

        // 4. å‘é€æ–‡æœ¬å¸§
        return w.sendTextFrame(jsonData)
    } else {
        // å‘é€äºŒè¿›åˆ¶å¸§
        return w.sendBinaryFrame(data)
    }
}
```

---

### **C. æ··åˆä½¿ç”¨åœºæ™¯**

**åœºæ™¯1ï¼šè°ƒè¯•æ—¶ç”¨JSONï¼Œç”Ÿäº§ç”¨äºŒè¿›åˆ¶**
```javascript
// å¼€å‘ç¯å¢ƒ
const protocol = (process.env.NODE_ENV === 'development')
    ? 'wukongim-json'
    : 'wukongim-binary';

const ws = new WebSocket('ws://localhost:5200/ws', protocol);
```

---

**åœºæ™¯2ï¼šæµè§ˆå™¨ç”¨JSONï¼Œç§»åŠ¨ç«¯ç”¨äºŒè¿›åˆ¶**
```javascript
// æµè§ˆå™¨æ£€æµ‹
const isMobile = /Android|iPhone|iPad/.test(navigator.userAgent);
const protocol = isMobile ? 'wukongim-binary' : 'wukongim-json';
```

---

## 6ï¸âƒ£ æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–

### **A. æ€§èƒ½æµ‹è¯•**

**æµ‹è¯•ç¯å¢ƒ**ï¼š
```
åœºæ™¯ï¼šå‘é€1000æ¡æ¶ˆæ¯
æ¶ˆæ¯å†…å®¹ï¼š"Hello WuKongIM"ï¼ˆ15å­—èŠ‚ï¼‰
```

**æµ‹è¯•ç»“æœ**ï¼š

| åè®® | å•æ¡å¤§å° | æ€»å¸¦å®½ | ç¼–ç è€—æ—¶ | è§£ç è€—æ—¶ |
|------|---------|--------|---------|---------|
| **TCPäºŒè¿›åˆ¶** | 66å­—èŠ‚ | 66KB | 200ns | 150ns |
| **WebSocketäºŒè¿›åˆ¶** | 72å­—èŠ‚ | 72KB | 250ns | 200ns |
| **WebSocket JSON** | 150å­—èŠ‚ | 150KB | 2500ns | 3000ns |

**ç»“è®º**ï¼š
```
å¸¦å®½å¯¹æ¯”ï¼š
â”œâ”€ WS JSONæ¯”WSäºŒè¿›åˆ¶ï¼šå¤š108% (150/72-1)
â””â”€ WSäºŒè¿›åˆ¶æ¯”TCPï¼šå¤š9% (72/66-1)

æ€§èƒ½å¯¹æ¯”ï¼š
â”œâ”€ WS JSONç¼–ç æ…¢10å€
â”œâ”€ WS JSONè§£ç æ…¢15å€
â””â”€ WebSocketå¤´éƒ¨å¼€é”€6å­—èŠ‚ï¼ˆå¯æ¥å—ï¼‰
```

---

### **B. WebSocketä¼˜åŒ–æŠ€å·§**

**1. å¯ç”¨å‹ç¼©æ‰©å±•**
```go
upgrader := &websocket.Upgrader{
    EnableCompression: true,  // å¯ç”¨permessage-deflate
}

æ•ˆæœï¼š
â”œâ”€ æ–‡æœ¬æ¶ˆæ¯å‹ç¼©ç‡ï¼š50-70%
â”œâ”€ JSONåè®®å—ç›Šæ˜æ˜¾
â””â”€ äºŒè¿›åˆ¶åè®®æ•ˆæœä¸€èˆ¬
```

---

**2. æ‰¹é‡å‘é€**
```javascript
// âŒ ä½æ•ˆï¼šé€æ¡å‘é€
messages.forEach(msg => {
    ws.send(JSON.stringify(msg));
});

// âœ… é«˜æ•ˆï¼šæ‰¹é‡å‘é€
const batch = messages.map(msg => JSON.stringify(msg));
ws.send(JSON.stringify(batch));

æœåŠ¡ç«¯æ”¶åˆ°åæ‹†åˆ†ï¼š
[
    {"frame_type": "SEND", ...},
    {"frame_type": "SEND", ...},
    {"frame_type": "SEND", ...}
]
```

---

**3. å¤ç”¨ç¼“å†²åŒº**
```go
type WSConn struct {
    // å¤ç”¨çš„WebSocketå¸§ç¼“å†²åŒº
    frameHeaderBuf [14]byte  // æœ€å¤§å¸§å¤´
    frameBuf       []byte    // å¸§æ•°æ®ç¼“å†²
}

func (w *WSConn) sendBinaryFrame(data []byte) (int, error) {
    // å¤ç”¨frameBuf
    if cap(w.frameBuf) < len(data)+14 {
        w.frameBuf = make([]byte, len(data)+14)
    }
    w.frameBuf = w.frameBuf[:0]

    // ä½¿ç”¨å¤ç”¨ç¼“å†²åŒºæ„é€ å¸§
    w.frameBuf = append(w.frameBuf, w.frameHeaderBuf[...]...)
    w.frameBuf = append(w.frameBuf, data...)

    return w.fd.Write(w.frameBuf)
}
```

---

**4. å¿ƒè·³ä¼˜åŒ–**
```javascript
// âŒ ä½æ•ˆï¼šå‘é€å®Œæ•´JSON
setInterval(() => {
    ws.send(JSON.stringify({frame_type: "PING"}));
}, 30000);

// âœ… é«˜æ•ˆï¼šå‘é€WebSocket PINGå¸§
setInterval(() => {
    ws.send(new Uint8Array([0x89, 0x00]));  // WebSocket PING
}, 30000);

// æœåŠ¡ç«¯è‡ªåŠ¨å›å¤WebSocket PONGï¼Œæ— éœ€åº”ç”¨å±‚å¤„ç†
```

---

### **C. æœ€ä½³å®è·µå»ºè®®**

```
åè®®é€‰æ‹©ï¼š
â”œâ”€ ç§»åŠ¨ç«¯Native SDKï¼šTCPäºŒè¿›åˆ¶ï¼ˆæ€§èƒ½æœ€ä¼˜ï¼‰
â”œâ”€ Webç”Ÿäº§ç¯å¢ƒï¼šWebSocketäºŒè¿›åˆ¶ï¼ˆå¹³è¡¡ï¼‰
â””â”€ å¼€å‘è°ƒè¯•ï¼šWebSocket JSONï¼ˆæ˜“è°ƒè¯•ï¼‰

ä¼˜åŒ–æ–¹å‘ï¼š
âœ… å¯ç”¨WebSocketå‹ç¼©ï¼ˆæ–‡æœ¬åè®®ï¼‰
âœ… æ‰¹é‡å‘é€ï¼ˆå‡å°‘å¸§æ•°ï¼‰
âœ… å¤ç”¨ç¼“å†²åŒºï¼ˆå‡å°‘åˆ†é…ï¼‰
âœ… ä½¿ç”¨WebSocketå¿ƒè·³ï¼ˆå‡å°‘åº”ç”¨å±‚å¼€é”€ï¼‰
âŒ é¿å…é¢‘ç¹å°åŒ…ï¼ˆåˆå¹¶å‘é€ï¼‰
âŒ é¿å…è¿‡å¤§å•å¸§ï¼ˆåˆ†ç‰‡ä¼ è¾“ï¼‰
```

---

## 7ï¸âƒ£ æ€»ç»“

### **æ ¸å¿ƒè¦ç‚¹**

1. **WebSocketä¼˜åŠ¿**
   - æµè§ˆå™¨åŸç”Ÿæ”¯æŒ
   - åŒå‘å®æ—¶é€šä¿¡
   - è·¨åŸŸå‹å¥½
   - è°ƒè¯•æ–¹ä¾¿

2. **æ¡æ‰‹æµç¨‹**
   - HTTPå‡çº§è¯·æ±‚
   - Sec-WebSocket-Keyè®¡ç®—
   - 101åè®®åˆ‡æ¢
   - è¿æ¥å»ºç«‹

3. **Frameå°è£…**
   - WuKongIMåè®®ä½œä¸ºPayload
   - å°è£…ä¸ºWebSocketå¸§
   - æ©ç å¤„ç†ï¼ˆå®¢æˆ·ç«¯â†’æœåŠ¡ç«¯ï¼‰
   - OpcodeåŒºåˆ†æ–‡æœ¬/äºŒè¿›åˆ¶

4. **åè®®å…¼å®¹**
   - æ”¯æŒäºŒè¿›åˆ¶åè®®ï¼ˆæ€§èƒ½ï¼‰
   - æ”¯æŒJSONåè®®ï¼ˆè°ƒè¯•ï¼‰
   - è‡ªåŠ¨åè®®æ£€æµ‹
   - ç»Ÿä¸€å†…éƒ¨å¤„ç†

5. **æ€§èƒ½å¯¹æ¯”**
   - WebSocketæ¯”TCPæ…¢10%ï¼ˆå¯æ¥å—ï¼‰
   - JSONæ¯”äºŒè¿›åˆ¶æ…¢10å€ï¼ˆä»…è°ƒè¯•ç”¨ï¼‰
   - å‹ç¼©å¯å‡å°‘50%å¸¦å®½
   - æ‰¹é‡å‘é€æå‡åå

---

### **è®¾è®¡äº®ç‚¹**

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **åè®®è½¬æ¢** | WebSocketä¸TCPç»Ÿä¸€ä¸ºWuKongIMåè®® |
| **åŒåè®®æ”¯æŒ** | äºŒè¿›åˆ¶ï¼ˆæ€§èƒ½ï¼‰+ JSONï¼ˆè°ƒè¯•ï¼‰ |
| **è‡ªåŠ¨æ£€æµ‹** | æ ¹æ®å¸§ç±»å‹è‡ªåŠ¨é€‰æ‹©è§£ææ–¹å¼ |
| **é›¶ä¿®æ”¹** | ä¸šåŠ¡å±‚æ— éœ€æ„ŸçŸ¥WebSocket |
| **çµæ´»åˆ‡æ¢** | å®¢æˆ·ç«¯å¯è‡ªç”±é€‰æ‹©åè®® |

---

### **ä¸‹ä¸€ç« é¢„å‘Š**

**ç¬¬äº”ç« ï¼šEventBusäº‹ä»¶æ€»çº¿**
- äº‹ä»¶é©±åŠ¨æ¶æ„è®¾è®¡
- ä¸‰å¤§äº‹ä»¶æ± è¯¦è§£
- äº‹ä»¶å¤„ç†é“¾æœºåˆ¶
- æ ¸å¿ƒäº‹ä»¶è§£æ

---

> **ğŸ”— ç›¸å…³ä»£ç **ï¼š
> - WebSocketè¿æ¥ï¼š`pkg/wknet/ws_conn.go`
> - WebSocketæ¡æ‰‹ï¼š`pkg/wknet/ws_upgrade.go`
> - JSONåè®®ï¼š`pkg/wkproto/json.go`
> - Frameå°è£…ï¼š`pkg/wknet/ws_frame.go`
> - åè®®è½¬æ¢ï¼š`pkg/wkproto/convert.go`
