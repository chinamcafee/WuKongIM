# 5.1 äº‹ä»¶é©±åŠ¨æ¶æ„æ¦‚è¿°

> **æœ¬èŠ‚ç›®æ ‡**ï¼šç†è§£äº‹ä»¶é©±åŠ¨æ¶æ„çš„æ ¸å¿ƒæ€æƒ³ï¼ŒæŒæ¡WuKongIMä¸ºä»€ä¹ˆé€‰æ‹©äº‹ä»¶é©±åŠ¨æ¨¡å¼

---

## ğŸ“‹ ç›®å½•
1. [ä»€ä¹ˆæ˜¯äº‹ä»¶é©±åŠ¨æ¶æ„](#ä»€ä¹ˆæ˜¯äº‹ä»¶é©±åŠ¨æ¶æ„)
2. [ä¸ºä»€ä¹ˆä½¿ç”¨äº‹ä»¶é©±åŠ¨](#ä¸ºä»€ä¹ˆä½¿ç”¨äº‹ä»¶é©±åŠ¨)
3. [ä¸ä¼ ç»Ÿè¯·æ±‚å“åº”çš„åŒºåˆ«](#ä¸ä¼ ç»Ÿè¯·æ±‚å“åº”çš„åŒºåˆ«)
4. [è§£è€¦ä¸æ‰©å±•æ€§](#è§£è€¦ä¸æ‰©å±•æ€§)
5. [WuKongIMçš„äº‹ä»¶é©±åŠ¨è®¾è®¡](#wukongimçš„äº‹ä»¶é©±åŠ¨è®¾è®¡)

---

## 1ï¸âƒ£ ä»€ä¹ˆæ˜¯äº‹ä»¶é©±åŠ¨æ¶æ„

### **A. åŸºæœ¬æ¦‚å¿µ**

**äº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆEvent-Driven Architecture, EDAï¼‰**ï¼š
```
å®šä¹‰ï¼š
ç³»ç»Ÿé€šè¿‡äº§ç”Ÿã€æ£€æµ‹ã€æ¶ˆè´¹å’Œå“åº”äº‹ä»¶æ¥è¿›è¡Œé€šä¿¡å’Œåä½œçš„æ¶æ„æ¨¡å¼

æ ¸å¿ƒè¦ç´ ï¼š
1. äº‹ä»¶ï¼ˆEventï¼‰ï¼šç³»ç»Ÿä¸­å‘ç”Ÿçš„é‡è¦çŠ¶æ€å˜åŒ–
2. äº‹ä»¶ç”Ÿäº§è€…ï¼ˆProducerï¼‰ï¼šäº§ç”Ÿäº‹ä»¶çš„ç»„ä»¶
3. äº‹ä»¶æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰ï¼šå¤„ç†äº‹ä»¶çš„ç»„ä»¶
4. äº‹ä»¶æ€»çº¿ï¼ˆEvent Busï¼‰ï¼šä¼ é€’äº‹ä»¶çš„é€šé“
```

---

**ç±»æ¯”ç†è§£**ï¼š
```
ä¼ ç»Ÿæ¨¡å¼ = ç”µè¯æ²Ÿé€š
â”œâ”€ å‘èµ·è€…ç›´æ¥æ‹¨æ‰“æ¥æ”¶è€…ç”µè¯
â”œâ”€ åŒæ­¥ç­‰å¾…å¯¹æ–¹æ¥å¬
â”œâ”€ åŒæ–¹å®æ—¶å¯¹è¯
â””â”€ ç´§å¯†è€¦åˆ

äº‹ä»¶é©±åŠ¨ = å¹¿æ’­ç”µå°
â”œâ”€ å‘èµ·è€…å¹¿æ’­æ¶ˆæ¯ï¼ˆå‘å¸ƒäº‹ä»¶ï¼‰
â”œâ”€ æ‰€æœ‰è®¢é˜…è€…éƒ½èƒ½æ”¶åˆ°
â”œâ”€ å¼‚æ­¥å¤„ç†ï¼Œä¸ç­‰å¾…å“åº”
â””â”€ æ¾æ•£è€¦åˆ
```

---

### **B. äº‹ä»¶é©±åŠ¨æ¶æ„å›¾**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  äº‹ä»¶é©±åŠ¨æ¶æ„                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”Ÿäº§è€…A   â”‚ â”€â”                â”Œâ”€â†’â”‚  æ¶ˆè´¹è€…1    â”‚
â”‚ (è¿æ¥å»ºç«‹)  â”‚  â”‚                â”‚  â”‚ (è®°å½•æ—¥å¿—)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”Ÿäº§è€…B   â”‚ â”€â”¼â”€â†’â”‚ äº‹ä»¶æ€»çº¿ â”‚â”€â”¼â”€â†’â”‚  æ¶ˆè´¹è€…2    â”‚
â”‚ (æ¶ˆæ¯å‘é€)  â”‚  â”‚  â”‚(EventBus)â”‚ â”‚  â”‚ (æƒé™æ ¡éªŒ)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”Ÿäº§è€…C   â”‚ â”€â”˜                â””â”€â†’â”‚  æ¶ˆè´¹è€…3    â”‚
â”‚ (è¿æ¥å…³é—­)  â”‚                      â”‚ (çŠ¶æ€æ›´æ–°)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‰¹ç‚¹ï¼š
â”œâ”€ ç”Ÿäº§è€…ä¸çŸ¥é“æœ‰å“ªäº›æ¶ˆè´¹è€…
â”œâ”€ æ¶ˆè´¹è€…ä¸çŸ¥é“è°äº§ç”Ÿäº†äº‹ä»¶
â”œâ”€ é€šè¿‡äº‹ä»¶æ€»çº¿è§£è€¦
â””â”€ å¤šå¯¹å¤šå…³ç³»
```

---

### **C. äº‹ä»¶çš„ç”Ÿå‘½å‘¨æœŸ**

```
äº‹ä»¶ç”Ÿå‘½å‘¨æœŸï¼š

1ï¸âƒ£ äº‹ä»¶äº§ç”Ÿ
   â””â”€ æŸä¸ªæ“ä½œè§¦å‘äº‹ä»¶ï¼ˆå¦‚ï¼šç”¨æˆ·å‘é€æ¶ˆæ¯ï¼‰

2ï¸âƒ£ äº‹ä»¶å°è£…
   â””â”€ åŒ…è£…æˆäº‹ä»¶å¯¹è±¡ï¼ˆåŒ…å«äº‹ä»¶ç±»å‹ã€æ•°æ®ç­‰ï¼‰

3ï¸âƒ£ äº‹ä»¶å‘å¸ƒ
   â””â”€ æ”¾å…¥äº‹ä»¶æ€»çº¿/äº‹ä»¶é˜Ÿåˆ—

4ï¸âƒ£ äº‹ä»¶è·¯ç”±
   â””â”€ æ ¹æ®äº‹ä»¶ç±»å‹åˆ†å‘åˆ°å¯¹åº”çš„Handler

5ï¸âƒ£ äº‹ä»¶å¤„ç†
   â””â”€ Handleræ‰§è¡Œä¸šåŠ¡é€»è¾‘

6ï¸âƒ£ äº‹ä»¶å®Œæˆ
   â””â”€ å¤„ç†å®Œæˆï¼Œå¯èƒ½äº§ç”Ÿæ–°äº‹ä»¶

ç¤ºä¾‹æµç¨‹ï¼š
ç”¨æˆ·å‘é€æ¶ˆæ¯
    â†“ï¼ˆäº§ç”Ÿï¼‰
EventOnSendäº‹ä»¶
    â†“ï¼ˆå‘å¸ƒï¼‰
UserEventPool
    â†“ï¼ˆè·¯ç”±ï¼‰
OnSendHandler
    â†“ï¼ˆå¤„ç†ï¼‰
æƒé™æ ¡éªŒ â†’ Webhookå›è°ƒ â†’ æäº¤åˆ°ChannelEventPool
    â†“ï¼ˆäº§ç”Ÿæ–°äº‹ä»¶ï¼‰
EventChannelDistributeäº‹ä»¶
    â†“
...ç»§ç»­å¤„ç†
```

---

## 2ï¸âƒ£ ä¸ºä»€ä¹ˆä½¿ç”¨äº‹ä»¶é©±åŠ¨

### **A. ä¼ ç»Ÿæ¶æ„çš„é—®é¢˜**

**é—®é¢˜1ï¼šç´§å¯†è€¦åˆ**

```go
// âŒ ä¼ ç»ŸåŒæ­¥è°ƒç”¨
func HandleSendMessage(msg *Message) error {
    // 1. æƒé™æ ¡éªŒ
    if err := permissionService.Check(msg); err != nil {
        return err
    }

    // 2. Webhookå›è°ƒ
    if err := webhookService.Call(msg); err != nil {
        return err
    }

    // 3. å­˜å‚¨æ¶ˆæ¯
    if err := storageService.Save(msg); err != nil {
        return err
    }

    // 4. æ¨é€æ¶ˆæ¯
    if err := pusherService.Push(msg); err != nil {
        return err
    }

    // 5. æ›´æ–°ä¼šè¯
    if err := conversationService.Update(msg); err != nil {
        return err
    }

    return nil
}

é—®é¢˜ï¼š
â”œâ”€ HandleSendMessageç›´æ¥ä¾èµ–5ä¸ªæœåŠ¡
â”œâ”€ ä»»ä½•ä¸€ä¸ªæœåŠ¡ä¿®æ”¹ï¼Œéƒ½è¦æ”¹è¿™é‡Œ
â”œâ”€ æ— æ³•ç‹¬ç«‹æµ‹è¯•æŸä¸ªåŠŸèƒ½
â””â”€ éš¾ä»¥æ‰©å±•æ–°åŠŸèƒ½
```

---

**é—®é¢˜2ï¼šæ€§èƒ½ç“¶é¢ˆ**

```go
// âŒ åŒæ­¥ä¸²è¡Œå¤„ç†
func HandleSendMessage(msg *Message) error {
    permissionService.Check(msg)    // 10ms
    webhookService.Call(msg)        // 100ms âš ï¸ æ…¢
    storageService.Save(msg)        // 50ms
    pusherService.Push(msg)         // 20ms
    conversationService.Update(msg) // 30ms

    // æ€»è€—æ—¶ï¼š210ms ğŸ’¥
    return nil
}

é—®é¢˜ï¼š
â”œâ”€ ä¸²è¡Œæ‰§è¡Œï¼Œå»¶è¿Ÿç´¯åŠ 
â”œâ”€ Webhookæ…¢ä¼šæ‹–ç´¯æ•´ä½“
â”œâ”€ å®¢æˆ·ç«¯ç­‰å¾…æ—¶é—´é•¿
â””â”€ ååé‡ä½
```

---

**é—®é¢˜3ï¼šå¯é æ€§é—®é¢˜**

```go
// âŒ éƒ¨åˆ†å¤±è´¥éš¾å¤„ç†
func HandleSendMessage(msg *Message) error {
    permissionService.Check(msg)    // âœ… æˆåŠŸ
    webhookService.Call(msg)        // âœ… æˆåŠŸ
    storageService.Save(msg)        // âŒ å¤±è´¥ï¼

    // é—®é¢˜ï¼š
    // 1. å‰é¢çš„æ“ä½œå·²å®Œæˆï¼Œå¦‚ä½•å›æ»šï¼Ÿ
    // 2. Webhookå·²è°ƒç”¨ï¼Œæ— æ³•æ’¤é”€
    // 3. ç”¨æˆ·å·²æ”¶åˆ°å‘é€æˆåŠŸçš„å“åº”ï¼Ÿ

    return err
}
```

---

### **B. äº‹ä»¶é©±åŠ¨çš„ä¼˜åŠ¿**

**ä¼˜åŠ¿1ï¼šè§£è€¦**

```go
// âœ… äº‹ä»¶é©±åŠ¨
func HandleSendMessage(msg *Message) error {
    // 1. åªåšæ ¸å¿ƒé€»è¾‘ï¼šå‘å¸ƒäº‹ä»¶
    event := &Event{
        Type: EventOnSend,
        Data: msg,
    }
    eventBus.Publish(event)

    // 2. ç«‹å³è¿”å›ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
    return nil
}

// å„ä¸ªHandlerç‹¬ç«‹è®¢é˜…
permissionHandler.Subscribe(EventOnSend)
webhookHandler.Subscribe(EventOnSend)
storageHandler.Subscribe(EventOnSend)
pusherHandler.Subscribe(EventOnSend)

ä¼˜ç‚¹ï¼š
âœ… HandleSendMessageä¸ä¾èµ–ä»»ä½•æœåŠ¡
âœ… æ–°å¢åŠŸèƒ½åªéœ€æ·»åŠ Handler
âœ… åˆ é™¤åŠŸèƒ½åªéœ€ç§»é™¤Handler
âœ… å„Handlerç‹¬ç«‹å¼€å‘ã€æµ‹è¯•
```

---

**ä¼˜åŠ¿2ï¼šå¼‚æ­¥å¤„ç†**

```go
// âœ… å¼‚æ­¥å¹¶è¡Œ
func HandleSendMessage(msg *Message) error {
    // å‘å¸ƒäº‹ä»¶åç«‹å³è¿”å›
    eventBus.Publish(EventOnSend, msg)
    return nil  // è€—æ—¶ï¼š<1ms âœ…
}

// å¤šä¸ªHandlerå¹¶è¡Œå¤„ç†
go permissionHandler.Handle(event)    // 10ms
go webhookHandler.Handle(event)       // 100msï¼ˆä¸é˜»å¡ï¼‰
go storageHandler.Handle(event)       // 50ms
go pusherHandler.Handle(event)        // 20ms

ä¼˜ç‚¹ï¼š
âœ… å®¢æˆ·ç«¯å¿«é€Ÿå¾—åˆ°å“åº”
âœ… åå°å¼‚æ­¥å¤„ç†
âœ… æ…¢æ“ä½œä¸å½±å“ä¸»æµç¨‹
âœ… ååé‡å¤§å¹…æå‡
```

---

**ä¼˜åŠ¿3ï¼šå¯é æ€§**

```go
// âœ… äº‹ä»¶æŒä¹…åŒ– + é‡è¯•
eventBus.Publish(event)
    â†“
äº‹ä»¶å†™å…¥é˜Ÿåˆ—ï¼ˆæŒä¹…åŒ–ï¼‰
    â†“
Handlerå¤„ç†
    â”œâ”€ æˆåŠŸ â†’ æ ‡è®°å®Œæˆ
    â””â”€ å¤±è´¥ â†’ é‡è¯•ï¼ˆæœ€å¤š3æ¬¡ï¼‰
        â”œâ”€ ä»å¤±è´¥ â†’ è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—
        â””â”€ äººå·¥ä»‹å…¥æˆ–è‡ªåŠ¨è¡¥å¿

ä¼˜ç‚¹ï¼š
âœ… äº‹ä»¶ä¸ä¸¢å¤±
âœ… è‡ªåŠ¨é‡è¯•
âœ… å¤±è´¥éš”ç¦»ï¼ˆä¸å½±å“å…¶ä»–Handlerï¼‰
âœ… å¯è¿½æº¯ï¼ˆäº‹ä»¶æ—¥å¿—ï¼‰
```

---

**ä¼˜åŠ¿4ï¼šæ‰©å±•æ€§**

```go
// âœ… æ–°å¢åŠŸèƒ½æ— éœ€ä¿®æ”¹åŸæœ‰ä»£ç 
// éœ€æ±‚ï¼šæ–°å¢æ¶ˆæ¯ç»Ÿè®¡åŠŸèƒ½

// åªéœ€æ·»åŠ æ–°çš„Handler
type StatisticsHandler struct {}

func (h *StatisticsHandler) Handle(event *Event) error {
    // ç»Ÿè®¡æ¶ˆæ¯æ•°é‡
    statistics.Increment("message_count")
    return nil
}

// æ³¨å†ŒHandler
eventBus.Subscribe(EventOnSend, statisticsHandler)

ä¼˜ç‚¹ï¼š
âœ… æ— éœ€ä¿®æ”¹HandleSendMessage
âœ… æ— éœ€ä¿®æ”¹å…¶ä»–Handler
âœ… å¼€é—­åŸåˆ™ï¼ˆå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼‰
âœ… çƒ­æ’æ‹”ï¼ˆåŠ¨æ€æ³¨å†Œ/æ³¨é”€ï¼‰
```

---

## 3ï¸âƒ£ ä¸ä¼ ç»Ÿè¯·æ±‚å“åº”çš„åŒºåˆ«

### **A. å¯¹æ¯”è¡¨**

| ç»´åº¦ | ä¼ ç»Ÿè¯·æ±‚-å“åº” | äº‹ä»¶é©±åŠ¨ |
|------|--------------|---------|
| **é€šä¿¡æ–¹å¼** | åŒæ­¥è°ƒç”¨ | å¼‚æ­¥æ¶ˆæ¯ |
| **è€¦åˆåº¦** | ç´§å¯†è€¦åˆ | æ¾æ•£è€¦åˆ |
| **ä¾èµ–å…³ç³»** | è°ƒç”¨è€…ä¾èµ–è¢«è°ƒç”¨è€… | é€šè¿‡äº‹ä»¶è§£è€¦ |
| **å“åº”æ—¶é—´** | ç­‰å¾…æ‰€æœ‰æ“ä½œå®Œæˆ | ç«‹å³è¿”å› |
| **æ‰©å±•æ€§** | å·®ï¼ˆä¿®æ”¹è°ƒç”¨ä»£ç ï¼‰ | å¥½ï¼ˆæ·»åŠ Handlerï¼‰ |
| **å¯æµ‹è¯•æ€§** | éš¾ï¼ˆéœ€è¦æ¨¡æ‹Ÿæ‰€æœ‰ä¾èµ–ï¼‰ | æ˜“ï¼ˆç‹¬ç«‹æµ‹è¯•ï¼‰ |
| **å¯é æ€§** | éƒ¨åˆ†å¤±è´¥éš¾å¤„ç† | äº‹ä»¶é‡è¯•æœºåˆ¶ |
| **æ€§èƒ½** | ä¸²è¡Œæ‰§è¡Œ | å¹¶è¡Œå¤„ç† |
| **å¤æ‚åº¦** | ç®€å• | è¾ƒå¤æ‚ |

---

### **B. è°ƒç”¨é“¾å¯¹æ¯”**

**ä¼ ç»Ÿè¯·æ±‚-å“åº”**ï¼š
```
å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MessageController                 â”‚
â”‚  â”œâ”€ permissionService.Check()  â± 10ms
â”‚  â”œâ”€ webhookService.Call()      â± 100ms
â”‚  â”œâ”€ storageService.Save()      â± 50ms
â”‚  â”œâ”€ pusherService.Push()       â± 20ms
â”‚  â””â”€ conversationService.Update()â± 30ms
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ æ€»è€—æ—¶ï¼š210ms
è¿”å›å“åº”ç»™å®¢æˆ·ç«¯

ç‰¹ç‚¹ï¼š
â”œâ”€ åŒæ­¥ä¸²è¡Œ
â”œâ”€ å»¶è¿Ÿç´¯åŠ 
â”œâ”€ è°ƒç”¨è€…ç­‰å¾…
â””â”€ ç´§å¯†è€¦åˆ
```

---

**äº‹ä»¶é©±åŠ¨**ï¼š
```
å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MessageController                 â”‚
â”‚  â””â”€ eventBus.Publish(EventOnSend)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ è€—æ—¶ï¼š<1ms âœ…
è¿”å›å“åº”ç»™å®¢æˆ·ç«¯

åå°å¼‚æ­¥å¤„ç†ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EventBus                          â”‚
â”‚  â”œâ”€â†’ PermissionHandler    â± 10ms  â”‚
â”‚  â”œâ”€â†’ WebhookHandler       â± 100ms â”‚ï¼ˆå¹¶è¡Œï¼‰
â”‚  â”œâ”€â†’ StorageHandler       â± 50ms  â”‚
â”‚  â”œâ”€â†’ PusherHandler        â± 20ms  â”‚
â”‚  â””â”€â†’ ConversationHandler  â± 30ms  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‰¹ç‚¹ï¼š
â”œâ”€ å¼‚æ­¥å¹¶è¡Œ
â”œâ”€ å¿«é€Ÿå“åº”
â”œâ”€ åå°å¤„ç†
â””â”€ æ¾æ•£è€¦åˆ
```

---

### **C. ä»£ç å¯¹æ¯”**

**ä¼ ç»Ÿæ¨¡å¼**ï¼š
```go
// âŒ ä¼ ç»ŸåŒæ­¥ä»£ç 
type MessageService struct {
    permissionSvc   *PermissionService
    webhookSvc      *WebhookService
    storageSvc      *StorageService
    pusherSvc       *PusherService
    conversationSvc *ConversationService
}

func (s *MessageService) Send(msg *Message) error {
    // ä¾èµ–5ä¸ªæœåŠ¡
    if err := s.permissionSvc.Check(msg); err != nil {
        return err
    }
    if err := s.webhookSvc.Call(msg); err != nil {
        return err
    }
    if err := s.storageSvc.Save(msg); err != nil {
        return err
    }
    if err := s.pusherSvc.Push(msg); err != nil {
        return err
    }
    if err := s.conversationSvc.Update(msg); err != nil {
        return err
    }
    return nil
}
```

---

**äº‹ä»¶é©±åŠ¨æ¨¡å¼**ï¼š
```go
// âœ… äº‹ä»¶é©±åŠ¨ä»£ç 
type MessageService struct {
    eventBus *EventBus  // åªä¾èµ–EventBus
}

func (s *MessageService) Send(msg *Message) error {
    // å‘å¸ƒäº‹ä»¶ï¼Œç«‹å³è¿”å›
    event := &UserContext{
        EventType: EventOnSend,
        Frame:     msg.Frame,
        Conn:      msg.Conn,
    }
    s.eventBus.AddEvent(event)
    return nil
}

// Handlerç‹¬ç«‹æ³¨å†Œï¼ˆåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶ï¼‰
func InitHandlers(eventBus *EventBus) {
    eventBus.RegisterHandler(EventOnSend, permissionHandler)
    eventBus.RegisterHandler(EventOnSend, webhookHandler)
    eventBus.RegisterHandler(EventOnSend, storageHandler)
    eventBus.RegisterHandler(EventOnSend, pusherHandler)
    eventBus.RegisterHandler(EventOnSend, conversationHandler)
}
```

---

## 4ï¸âƒ£ è§£è€¦ä¸æ‰©å±•æ€§

### **A. è§£è€¦çš„å±‚æ¬¡**

**1. æ¨¡å—è§£è€¦**
```
ä¼ ç»Ÿï¼š
MessageService â†’ PermissionService
             â†“
             WebhookService
             â†“
             StorageService

äº‹ä»¶é©±åŠ¨ï¼š
MessageService â†’ EventBus â† PermissionHandler
                         â† WebhookHandler
                         â† StorageHandler

ä¼˜ç‚¹ï¼š
â”œâ”€ MessageServiceä¸çŸ¥é“æœ‰å“ªäº›Handler
â”œâ”€ Handlerä¹‹é—´äº’ä¸ä¾èµ–
â””â”€ é€šè¿‡EventBusè§£è€¦
```

---

**2. æ—¶é—´è§£è€¦**
```
ä¼ ç»Ÿï¼š
è°ƒç”¨è€…å¿…é¡»ç­‰å¾…è¢«è°ƒç”¨è€…å®Œæˆ

äº‹ä»¶é©±åŠ¨ï¼š
â”œâ”€ å‘å¸ƒäº‹ä»¶åç«‹å³è¿”å›
â”œâ”€ Handlerå¼‚æ­¥å¤„ç†
â””â”€ ä¸åŒHandlerå¤„ç†æ—¶é—´ä¸åŒ
```

---

**3. ç©ºé—´è§£è€¦**
```
ä¼ ç»Ÿï¼š
è°ƒç”¨è€…å’Œè¢«è°ƒç”¨è€…å¿…é¡»åœ¨åŒä¸€è¿›ç¨‹

äº‹ä»¶é©±åŠ¨ï¼ˆåˆ†å¸ƒå¼ï¼‰ï¼š
â”œâ”€ å‘å¸ƒäº‹ä»¶åˆ°æ¶ˆæ¯é˜Ÿåˆ—
â”œâ”€ Handlerå¯ä»¥åœ¨ä¸åŒæœåŠ¡å™¨
â”œâ”€ è·¨è¿›ç¨‹ã€è·¨æœºå™¨
â””â”€ åˆ†å¸ƒå¼äº‹ä»¶é©±åŠ¨
```

---

### **B. æ‰©å±•æ€§æ¡ˆä¾‹**

**æ¡ˆä¾‹1ï¼šæ–°å¢å®¡æ ¸åŠŸèƒ½**

```
éœ€æ±‚ï¼šæ¶ˆæ¯å‘é€å‰éœ€è¦å†…å®¹å®¡æ ¸

ä¼ ç»Ÿæ¨¡å¼ï¼š
1. ä¿®æ”¹MessageService.Send()
2. æ·»åŠ auditService.Check()è°ƒç”¨
3. è°ƒæ•´é”™è¯¯å¤„ç†
4. ä¿®æ”¹æµ‹è¯•ç”¨ä¾‹
5. å½±å“èŒƒå›´ï¼šæ•´ä¸ªSend()æ–¹æ³•

äº‹ä»¶é©±åŠ¨ï¼š
1. å®ç°AuditHandler
2. æ³¨å†Œåˆ°EventOnSend
3. ä¸ä¿®æ”¹ä»»ä½•ç°æœ‰ä»£ç 
4. ç‹¬ç«‹æµ‹è¯•AuditHandler
5. å½±å“èŒƒå›´ï¼š0ï¼ˆæ–°å¢ä»£ç ï¼‰

ä»£ç ï¼š
type AuditHandler struct {}

func (h *AuditHandler) Handle(ctx *UserContext) error {
    msg := ctx.Frame.(*SendPacket)
    if containsSensitiveWords(msg.Payload) {
        return errors.New("sensitive content")
    }
    return nil
}

// æ³¨å†Œ
eventBus.RegisterHandler(EventOnSend, auditHandler)
```

---

**æ¡ˆä¾‹2ï¼šæ¶ˆæ¯å‘é€ç»Ÿè®¡**

```
éœ€æ±‚ï¼šç»Ÿè®¡æ¯ä¸ªç”¨æˆ·çš„æ¶ˆæ¯å‘é€é‡

ä¼ ç»Ÿæ¨¡å¼ï¼š
ä¿®æ”¹MessageService.Send()ï¼Œæ·»åŠ ç»Ÿè®¡ä»£ç 

äº‹ä»¶é©±åŠ¨ï¼š
type StatisticsHandler struct {}

func (h *StatisticsHandler) Handle(ctx *UserContext) error {
    uid := ctx.Conn.UID()
    redis.Incr(fmt.Sprintf("user:%s:msg_count", uid))
    return nil
}

// æ³¨å†Œ
eventBus.RegisterHandler(EventOnSend, statisticsHandler)

ä¼˜ç‚¹ï¼š
âœ… æ— éœ€ä¿®æ”¹åŸæœ‰ä»£ç 
âœ… ç»Ÿè®¡é€»è¾‘ç‹¬ç«‹
âœ… å¯ä»¥åŠ¨æ€å¼€å¯/å…³é—­
```

---

**æ¡ˆä¾‹3ï¼šA/Bæµ‹è¯•**

```
éœ€æ±‚ï¼šå¯¹10%çš„ç”¨æˆ·å¯ç”¨æ–°åŠŸèƒ½

ä¼ ç»Ÿæ¨¡å¼ï¼š
åœ¨ä»£ç ä¸­æ·»åŠ ifåˆ¤æ–­ï¼Œä¾µå…¥æ€§å¼º

äº‹ä»¶é©±åŠ¨ï¼š
type ABTestHandler struct {}

func (h *ABTestHandler) Handle(ctx *UserContext) error {
    uid := ctx.Conn.UID()
    if hashUID(uid) % 100 < 10 {
        // 10%ç”¨æˆ·ä½¿ç”¨æ–°é€»è¾‘
        return newLogic(ctx)
    }
    return nil
}

// ä¸´æ—¶æ³¨å†Œ
eventBus.RegisterHandler(EventOnSend, abTestHandler)

// A/Bæµ‹è¯•ç»“æŸåï¼Œç›´æ¥æ³¨é”€
eventBus.UnregisterHandler(EventOnSend, abTestHandler)

ä¼˜ç‚¹ï¼š
âœ… ä¸å½±å“åŸæœ‰é€»è¾‘
âœ… ç°åº¦å‘å¸ƒ
âœ… å¿«é€Ÿå›æ»š
```

---

### **C. å¯æµ‹è¯•æ€§æå‡**

**ä¼ ç»Ÿæ¨¡å¼æµ‹è¯•**ï¼š
```go
// âŒ éœ€è¦æ¨¡æ‹Ÿæ‰€æœ‰ä¾èµ–
func TestMessageService_Send(t *testing.T) {
    mockPermission := NewMockPermissionService()
    mockWebhook := NewMockWebhookService()
    mockStorage := NewMockStorageService()
    mockPusher := NewMockPusherService()
    mockConversation := NewMockConversationService()

    svc := &MessageService{
        permissionSvc:   mockPermission,
        webhookSvc:      mockWebhook,
        storageSvc:      mockStorage,
        pusherSvc:       mockPusher,
        conversationSvc: mockConversation,
    }

    // å¤æ‚çš„æ¨¡æ‹Ÿé€»è¾‘
    mockPermission.On("Check").Return(nil)
    mockWebhook.On("Call").Return(nil)
    // ...

    err := svc.Send(msg)
    assert.NoError(t, err)
}
```

---

**äº‹ä»¶é©±åŠ¨æµ‹è¯•**ï¼š
```go
// âœ… ç‹¬ç«‹æµ‹è¯•Handler
func TestPermissionHandler(t *testing.T) {
    handler := &PermissionHandler{}

    // æµ‹è¯•å…è®¸çš„æƒ…å†µ
    ctx := &UserContext{
        EventType: EventOnSend,
        Conn:      newMockConn("user001"),
    }
    err := handler.Handle(ctx)
    assert.NoError(t, err)

    // æµ‹è¯•ç¦æ­¢çš„æƒ…å†µ
    ctx.Conn.SetBlocked(true)
    err = handler.Handle(ctx)
    assert.Error(t, err)
}

ä¼˜ç‚¹ï¼š
âœ… åªæµ‹è¯•å•ä¸ªHandler
âœ… æ— éœ€æ¨¡æ‹Ÿä¾èµ–
âœ… æµ‹è¯•ç®€å•æ¸…æ™°
âœ… å¿«é€Ÿå®šä½é—®é¢˜
```

---

## 5ï¸âƒ£ WuKongIM çš„äº‹ä»¶é©±åŠ¨è®¾è®¡

### **A. æ•´ä½“æ¶æ„**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              WuKongIM äº‹ä»¶é©±åŠ¨æ¶æ„                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç½‘ç»œå±‚ï¼ˆwknetï¼‰
    â†“ äº§ç”Ÿäº‹ä»¶
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸‰å¤§äº‹ä»¶æ±                                            â”‚
â”‚  â”œâ”€ UserEventPool    ï¼ˆç”¨æˆ·è¿æ¥äº‹ä»¶ï¼‰                 â”‚
â”‚  â”œâ”€ ChannelEventPool ï¼ˆé¢‘é“æ¶ˆæ¯äº‹ä»¶ï¼‰                 â”‚
â”‚  â””â”€ PusherEventPool  ï¼ˆæ¶ˆæ¯æ¨é€äº‹ä»¶ï¼‰                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ äº‹ä»¶è·¯ç”±
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Handlerè´£ä»»é“¾                                        â”‚
â”‚  â”œâ”€ ConnectHandler    ï¼ˆè¿æ¥å»ºç«‹ï¼‰                    â”‚
â”‚  â”œâ”€ OnSendHandler     ï¼ˆæ¶ˆæ¯å‘é€ï¼‰                    â”‚
â”‚  â”œâ”€ RecvAckHandler    ï¼ˆæ¥æ”¶ç¡®è®¤ï¼‰                    â”‚
â”‚  â”œâ”€ DistributeHandler ï¼ˆæ¶ˆæ¯åˆ†å‘ï¼‰                    â”‚
â”‚  â””â”€ PushHandler       ï¼ˆåœ¨çº¿æ¨é€ï¼‰                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ ä¸šåŠ¡å¤„ç†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ ¸å¿ƒæœåŠ¡                                             â”‚
â”‚  â”œâ”€ Permission  ï¼ˆæƒé™æ ¡éªŒï¼‰                          â”‚
â”‚  â”œâ”€ Webhook     ï¼ˆä¸šåŠ¡å›è°ƒï¼‰                          â”‚
â”‚  â”œâ”€ Storage     ï¼ˆå­˜å‚¨æŒä¹…åŒ–ï¼‰                        â”‚
â”‚  â””â”€ Cluster     ï¼ˆåˆ†å¸ƒå¼å…±è¯†ï¼‰                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **B. äº‹ä»¶ç±»å‹**

**ä»£ç ä½ç½®**ï¼š`internal/eventbus/event.go`

```go
type EventType uint8

const (
    // ç”¨æˆ·è¿æ¥äº‹ä»¶
    EventConnect    EventType = 1   // è¿æ¥å»ºç«‹
    EventOnConnect  EventType = 2   // è®¤è¯å®Œæˆ
    EventOnSend     EventType = 3   // æ¶ˆæ¯å‘é€
    EventRecvAck    EventType = 4   // æ¥æ”¶ç¡®è®¤
    EventConnClose  EventType = 5   // è¿æ¥å…³é—­

    // é¢‘é“æ¶ˆæ¯äº‹ä»¶
    EventChannelDistribute EventType = 10  // æ¶ˆæ¯åˆ†å‘
    EventChannelStore      EventType = 11  // æ¶ˆæ¯å­˜å‚¨

    // æ¨é€äº‹ä»¶
    EventPushOnline  EventType = 20  // åœ¨çº¿æ¨é€
    EventPushOffline EventType = 21  // ç¦»çº¿æ¨é€
)
```

---

### **C. äº‹ä»¶ä¸Šä¸‹æ–‡**

```go
// ç”¨æˆ·äº‹ä»¶ä¸Šä¸‹æ–‡
type UserContext struct {
    EventType EventType     // äº‹ä»¶ç±»å‹
    Conn      wknet.Conn    // è¿æ¥å¯¹è±¡
    Frame     *wkproto.Frame // åè®®å¸§
    // ... å…¶ä»–å­—æ®µ
}

// é¢‘é“äº‹ä»¶ä¸Šä¸‹æ–‡
type ChannelContext struct {
    EventType  EventType
    ChannelID  string
    ChannelType uint8
    Messages   []*Message
    // ... å…¶ä»–å­—æ®µ
}

// æ¨é€äº‹ä»¶ä¸Šä¸‹æ–‡
type PushContext struct {
    EventType EventType
    Message   *Message
    Subscribers []string
    // ... å…¶ä»–å­—æ®µ
}
```

---

### **D. äº‹ä»¶æµè½¬ç¤ºä¾‹**

**æ¶ˆæ¯å‘é€å®Œæ•´æµç¨‹**ï¼š
```
1. å®¢æˆ·ç«¯å‘é€SENDåŒ…
    â†“
2. wknetæ¥æ”¶åˆ°æ•°æ®
    â†“ Server.onData()
3. è§£æSEND Frame
    â†“
4. ç”ŸæˆEventOnSendäº‹ä»¶
    â†“ UserEventPool.AddEvent()
5. UserEventPoolå·¥ä½œåç¨‹å¤„ç†
    â†“
6. è·¯ç”±åˆ°OnSendHandler
    â†“ OnSendHandler.Handle()
7. æƒé™æ ¡éªŒ + Webhookå›è°ƒ
    â†“
8. ç”ŸæˆEventChannelDistributeäº‹ä»¶
    â†“ ChannelEventPool.AddEvent()
9. ChannelEventPoolå¤„ç†
    â†“
10. æ¶ˆæ¯å­˜å‚¨ + Raftå…±è¯†
    â†“
11. ç”ŸæˆEventPushOnlineäº‹ä»¶
    â†“ PusherEventPool.AddEvent()
12. PusherEventPoolå¤„ç†
    â†“
13. æ¨é€ç»™è®¢é˜…è€…
    â†“
14. å®¢æˆ·ç«¯æ”¶åˆ°RECVåŒ…
```

---

### **E. è®¾è®¡äº®ç‚¹**

**1. åˆ†å±‚äº‹ä»¶æ± **
```
ä¸ºä»€ä¹ˆåˆ†ä¸ºä¸‰ä¸ªäº‹ä»¶æ± ï¼Ÿ

UserEventPoolï¼š
â”œâ”€ å¤„ç†è¿æ¥ç›¸å…³äº‹ä»¶
â”œâ”€ è½»é‡çº§ã€é«˜é¢‘ç‡
â””â”€ å¿«é€Ÿå“åº”ï¼ˆ<1msï¼‰

ChannelEventPoolï¼š
â”œâ”€ å¤„ç†é¢‘é“æ¶ˆæ¯äº‹ä»¶
â”œâ”€ æ¶‰åŠå­˜å‚¨ã€å…±è¯†
â””â”€ ç›¸å¯¹è¾ƒé‡ï¼ˆ10-50msï¼‰

PusherEventPoolï¼š
â”œâ”€ å¤„ç†æ¶ˆæ¯æ¨é€äº‹ä»¶
â”œâ”€ æ¶‰åŠç½‘ç»œI/O
â””â”€ å¯èƒ½è¾ƒæ…¢ï¼ˆå–å†³äºè®¢é˜…è€…æ•°é‡ï¼‰

ä¼˜ç‚¹ï¼š
âœ… æ•…éšœéš”ç¦»ï¼ˆä¸€ä¸ªæ± é˜»å¡ä¸å½±å“å…¶ä»–ï¼‰
âœ… èµ„æºéš”ç¦»ï¼ˆç‹¬ç«‹çš„å·¥ä½œåç¨‹ï¼‰
âœ… æ€§èƒ½ä¼˜åŒ–ï¼ˆè½»é‡åˆ†ç¦»ï¼‰
```

---

**2. å¼‚æ­¥å¤„ç†**
```
åŒæ­¥å¤„ç†é—®é¢˜ï¼š
å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ â†’ ç­‰å¾…210ms â†’ æ”¶åˆ°å“åº”

å¼‚æ­¥å¤„ç†ï¼š
å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ â†’ <1ms â†’ æ”¶åˆ°ACK
                 â†“ï¼ˆåå°å¼‚æ­¥ï¼‰
            æƒé™æ ¡éªŒ â†’ Webhook â†’ å­˜å‚¨ â†’ æ¨é€

ä¼˜ç‚¹ï¼š
âœ… å®¢æˆ·ç«¯å¿«é€Ÿå“åº”
âœ… ååé‡æå‡100å€+
âœ… æ…¢æ“ä½œä¸é˜»å¡
```

---

**3. äº‹ä»¶æŒä¹…åŒ–**
```
äº‹ä»¶é˜Ÿåˆ—æŒä¹…åŒ–ï¼ˆå¯é€‰ï¼‰ï¼š
â”œâ”€ äº‹ä»¶å†™å…¥ç£ç›˜é˜Ÿåˆ—
â”œâ”€ å¤„ç†å¤±è´¥è‡ªåŠ¨é‡è¯•
â”œâ”€ æœåŠ¡é‡å¯åç»§ç»­å¤„ç†
â””â”€ ä¿è¯æœ€ç»ˆä¸€è‡´æ€§

åº”ç”¨åœºæ™¯ï¼š
â”œâ”€ å…³é”®ä¸šåŠ¡äº‹ä»¶
â”œâ”€ Webhookå›è°ƒï¼ˆå¯èƒ½å¤±è´¥ï¼‰
â””â”€ ç¦»çº¿æ¶ˆæ¯æ¨é€
```

---

## 6ï¸âƒ£ æ€»ç»“

### **æ ¸å¿ƒè¦ç‚¹**

1. **äº‹ä»¶é©±åŠ¨æ¶æ„**
   - é€šè¿‡äº‹ä»¶è¿›è¡Œé€šä¿¡
   - ç”Ÿäº§è€…/æ¶ˆè´¹è€…è§£è€¦
   - å¼‚æ­¥ã€å¹¶è¡Œå¤„ç†

2. **ä¸ºä»€ä¹ˆä½¿ç”¨äº‹ä»¶é©±åŠ¨**
   - è§£è€¦ï¼šæ¨¡å—ç‹¬ç«‹ã€æ˜“æ‰©å±•
   - æ€§èƒ½ï¼šå¼‚æ­¥å¹¶è¡Œã€é«˜åå
   - å¯é ï¼šäº‹ä»¶é‡è¯•ã€æ•…éšœéš”ç¦»
   - æ‰©å±•ï¼šå¼€é—­åŸåˆ™ã€çƒ­æ’æ‹”

3. **ä¸ä¼ ç»Ÿæ¨¡å¼çš„åŒºåˆ«**
   - åŒæ­¥ vs å¼‚æ­¥
   - ç´§è€¦åˆ vs æ¾è€¦åˆ
   - ä¸²è¡Œ vs å¹¶è¡Œ
   - å¤æ‚ä¾èµ– vs ç®€å•å‘å¸ƒ

4. **WuKongIMçš„è®¾è®¡**
   - ä¸‰å¤§äº‹ä»¶æ± ï¼ˆåˆ†å±‚éš”ç¦»ï¼‰
   - ä¸°å¯Œçš„äº‹ä»¶ç±»å‹
   - Handlerè´£ä»»é“¾
   - å¼‚æ­¥å¤„ç†ã€å¿«é€Ÿå“åº”

---

### **è®¾è®¡åŸåˆ™**

```
âœ… å•ä¸€èŒè´£ï¼šæ¯ä¸ªHandleråªåšä¸€ä»¶äº‹
âœ… å¼€é—­åŸåˆ™ï¼šå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
âœ… ä¾èµ–å€’ç½®ï¼šä¾èµ–æŠ½è±¡ï¼ˆEventBusï¼‰ï¼Œä¸ä¾èµ–å…·ä½“
âœ… æ¥å£éš”ç¦»ï¼šHandleræ¥å£ç®€å•æ¸…æ™°
âœ… æœ€å°çŸ¥è¯†ï¼šHandleråªçŸ¥é“Eventï¼Œä¸çŸ¥é“å…¶ä»–Handler
```

---

### **ä¸‹ä¸€èŠ‚é¢„å‘Š**

**5.2 ä¸‰å¤§äº‹ä»¶æ± **
- UserEventPoolå®ç°
- ChannelEventPoolå®ç°
- PusherEventPoolå®ç°
- äº‹ä»¶æ± å·¥ä½œæœºåˆ¶

---

> **ğŸ”— ç›¸å…³ä»£ç **ï¼š
> - äº‹ä»¶å®šä¹‰ï¼š`internal/eventbus/event.go`
> - äº‹ä»¶æ± æ¥å£ï¼š`internal/eventbus/eventbus.go`
> - ç”¨æˆ·äº‹ä»¶æ± ï¼š`internal/eventbus/user_event_pool.go`
> - é¢‘é“äº‹ä»¶æ± ï¼š`internal/eventbus/channel_event_pool.go`
> - æ¨é€äº‹ä»¶æ± ï¼š`internal/eventbus/pusher_event_pool.go`
