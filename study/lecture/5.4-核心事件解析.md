# 5.4 æ ¸å¿ƒäº‹ä»¶è§£æ

> **æœ¬èŠ‚ç›®æ ‡**ï¼šæ·±å…¥ç†è§£WuKongIMæ ¸å¿ƒäº‹ä»¶çš„å®Œæ•´å¤„ç†æµç¨‹ï¼ŒæŒæ¡IMç³»ç»Ÿçš„å…³é”®ä¸šåŠ¡é€»è¾‘

---

## ğŸ“‹ ç›®å½•
1. [EventConnect - è¿æ¥å»ºç«‹](#eventconnect---è¿æ¥å»ºç«‹)
2. [EventOnSend - æ¶ˆæ¯å‘é€](#eventonsend---æ¶ˆæ¯å‘é€)
3. [EventChannelDistribute - æ¶ˆæ¯åˆ†å‘](#eventchanneldistribute---æ¶ˆæ¯åˆ†å‘)
4. [EventPushOnline - åœ¨çº¿æ¨é€](#eventpushonline---åœ¨çº¿æ¨é€)
5. [å…¶ä»–æ ¸å¿ƒäº‹ä»¶](#å…¶ä»–æ ¸å¿ƒäº‹ä»¶)
6. [äº‹ä»¶æµè½¬å®Œæ•´æ¡ˆä¾‹](#äº‹ä»¶æµè½¬å®Œæ•´æ¡ˆä¾‹)

---

## 1ï¸âƒ£ EventConnect - è¿æ¥å»ºç«‹

### **A. äº‹ä»¶è§¦å‘æ—¶æœº**

```
å®¢æˆ·ç«¯è¿æ¥æµç¨‹ï¼š

1. TCPè¿æ¥å»ºç«‹
   â”œâ”€ å®¢æˆ·ç«¯å‘èµ·TCPè¿æ¥
   â”œâ”€ ä¸‰æ¬¡æ¡æ‰‹å®Œæˆ
   â””â”€ è¿æ¥å»ºç«‹æˆåŠŸ
       â†“
2. å‘é€CONNECTåŒ…
   â”œâ”€ åŒ…å«ï¼šVersionã€DeviceIDã€UIDã€Tokenã€ClientTimestamp
   â””â”€ å®¢æˆ·ç«¯ä¸»åŠ¨å‘é€ï¼ˆè¿æ¥åç«‹å³å‘é€ï¼‰
       â†“
3. æœåŠ¡ç«¯æ¥æ”¶
   â”œâ”€ wknet.onData() æ¥æ”¶æ•°æ®
   â”œâ”€ Protocol.Decode() è§£æCONNECT Frame
   â””â”€ ç”Ÿæˆ EventConnect äº‹ä»¶
       â†“
4. EventConnectå¤„ç†
   â”œâ”€ è®¤è¯Token
   â”œâ”€ åŠ è½½ä¼šè¯
   â”œâ”€ å‘é€CONNACK
   â””â”€ è¿æ¥å»ºç«‹å®Œæˆ
```

---

### **B. Handlerè´£ä»»é“¾**

**ä»£ç ä½ç½®**ï¼š`internal/server/server.go:initHandlers()`

```go
RegisterUserHandlers(EventConnect,
	s.connectHandler.Authenticate,   // 1. è®¤è¯
	s.connectHandler.LoadSession,    // 2. åŠ è½½ä¼šè¯
	s.connectHandler.SendConnack,    // 3. å‘é€è¿æ¥ç¡®è®¤
)
```

---

### **C. Handlerè¯¦è§£**

#### **Handler 1: Authenticateï¼ˆè®¤è¯ï¼‰**

**ä»£ç ä½ç½®**ï¼š`internal/user/handler/connect.go`

```go
func (h *ConnectHandler) Authenticate(ctx *UserContext) error {
	connectPacket := ctx.Frame.(*wkproto.ConnectPacket)

	// 1. è§£æToken
	token := connectPacket.Token
	if token == "" {
		return errors.New("token is empty")
	}

	// 2. è°ƒç”¨ä¸šåŠ¡æ–¹TokenéªŒè¯API
	req := &TokenVerifyRequest{
		UID:      connectPacket.UID,
		DeviceID: connectPacket.DeviceID,
		Token:    token,
	}

	resp, err := h.httpClient.Post(h.config.TokenVerifyURL, req)
	if err != nil {
		log.Error("token verify failed",
			zap.String("uid", connectPacket.UID),
			zap.Error(err))
		return errors.New("token verify failed")
	}

	// 3. æ£€æŸ¥éªŒè¯ç»“æœ
	if resp.Code != 0 {
		log.Warn("token invalid",
			zap.String("uid", connectPacket.UID),
			zap.String("reason", resp.Message))
		return errors.New("token invalid")
	}

	// 4. ä¿å­˜è®¤è¯ä¿¡æ¯åˆ°è¿æ¥
	ctx.Conn.SetUID(connectPacket.UID)
	ctx.Conn.SetDeviceID(connectPacket.DeviceID)
	ctx.Conn.SetDeviceLevel(resp.DeviceLevel)  // è®¾å¤‡ç­‰çº§ï¼ˆç”¨äºè¸¢äººç­–ç•¥ï¼‰

	// 5. æ›´æ–°åœ¨çº¿çŠ¶æ€ï¼ˆå†™å…¥Redisï¼‰
	err = h.updateOnlineStatus(connectPacket.UID, h.nodeID)
	if err != nil {
		log.Error("update online status failed", zap.Error(err))
	}

	return nil
}
```

**TokenéªŒè¯æµç¨‹**ï¼š
```
å®¢æˆ·ç«¯CONNECTåŒ…
    â†“
æå–Token
    â†“
HTTPè¯·æ±‚ä¸šåŠ¡æ–¹TokenéªŒè¯API
    â†“
ä¸šåŠ¡æ–¹éªŒè¯ï¼š
â”œâ”€ æ£€æŸ¥Tokenæ˜¯å¦æœ‰æ•ˆ
â”œâ”€ æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ
â”œâ”€ æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
â””â”€ æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¢«å°ç¦
    â†“
è¿”å›éªŒè¯ç»“æœï¼š
â”œâ”€ Code=0ï¼šéªŒè¯é€šè¿‡
â”‚   â””â”€ DeviceLevel: è®¾å¤‡ç­‰çº§ï¼ˆç”¨äºå¤šç«¯ç™»å½•è¸¢äººç­–ç•¥ï¼‰
â””â”€ Code!=0ï¼šéªŒè¯å¤±è´¥
    â””â”€ Message: å¤±è´¥åŸå› 
```

---

#### **Handler 2: LoadSessionï¼ˆåŠ è½½ä¼šè¯ï¼‰**

```go
func (h *ConnectHandler) LoadSession(ctx *UserContext) error {
	uid := ctx.Conn.UID()

	// 1. æŸ¥è¯¢ç”¨æˆ·è®¢é˜…çš„é¢‘é“åˆ—è¡¨
	channels, err := h.channelService.GetUserChannels(uid)
	if err != nil {
		log.Error("get user channels failed", zap.Error(err))
		return err
	}

	// 2. è‡ªåŠ¨è®¢é˜…é¢‘é“
	for _, ch := range channels {
		// æ·»åŠ è®¢é˜…å…³ç³»
		h.subscriber.AddSubscriber(ch.ChannelID, ch.ChannelType, uid)
	}

	// 3. åŠ è½½ç¦»çº¿æ¶ˆæ¯æ•°é‡
	offlineMsgCount, err := h.messageService.GetOfflineMessageCount(uid)
	if err != nil {
		log.Error("get offline message count failed", zap.Error(err))
	}

	// 4. ä¿å­˜åˆ°è¿æ¥ä¸Šä¸‹æ–‡
	ctx.Conn.SetContext("offlineMsgCount", offlineMsgCount)

	log.Info("session loaded",
		zap.String("uid", uid),
		zap.Int("channelCount", len(channels)),
		zap.Int("offlineMsgCount", offlineMsgCount))

	return nil
}
```

**ä¼šè¯åŠ è½½å†…å®¹**ï¼š
```
ä¼šè¯ä¿¡æ¯ï¼š
â”œâ”€ è®¢é˜…çš„é¢‘é“åˆ—è¡¨
â”‚   â”œâ”€ å•èŠé¢‘é“ï¼ˆChannelType=1ï¼‰
â”‚   â”œâ”€ ç¾¤èŠé¢‘é“ï¼ˆChannelType=2ï¼‰
â”‚   â””â”€ ç³»ç»Ÿé¢‘é“ï¼ˆChannelType=3ï¼‰
â”œâ”€ ç¦»çº¿æ¶ˆæ¯æ•°é‡
â”‚   â””â”€ ç”¨äºå®¢æˆ·ç«¯æ˜¾ç¤ºçº¢ç‚¹
â””â”€ ç”¨æˆ·è®¾ç½®
    â”œâ”€ æ¶ˆæ¯å…æ‰“æ‰°è®¾ç½®
    â””â”€ å…¶ä»–ç”¨æˆ·åå¥½è®¾ç½®
```

---

#### **Handler 3: SendConnackï¼ˆå‘é€è¿æ¥ç¡®è®¤ï¼‰**

```go
func (h *ConnectHandler) SendConnack(ctx *UserContext) error {
	connectPacket := ctx.Frame.(*wkproto.ConnectPacket)

	// 1. è®¡ç®—æ—¶é—´å·®ï¼ˆå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ï¼‰
	clientTime := connectPacket.ClientTimestamp
	serverTime := time.Now().UnixMilli()
	timeDiff := serverTime - clientTime

	// 2. è·å–ç¦»çº¿æ¶ˆæ¯æ•°é‡
	offlineMsgCount, _ := ctx.Conn.Context("offlineMsgCount").(int)

	// 3. æ„é€ CONNACKåŒ…
	connackPacket := &wkproto.ConnackPacket{
		ReasonCode:      wkproto.ReasonSuccess,
		ServerTime:      serverTime,
		TimeDiff:        timeDiff,
		OfflineMsgCount: offlineMsgCount,
		NodeID:          h.nodeID,
	}

	// 4. å‘é€CONNACK
	err := ctx.Conn.WriteFrame(connackPacket)
	if err != nil {
		log.Error("write connack failed", zap.Error(err))
		return err
	}

	log.Info("connack sent",
		zap.String("uid", ctx.Conn.UID()),
		zap.Int64("timeDiff", timeDiff),
		zap.Int("offlineMsgCount", offlineMsgCount))

	return nil
}
```

**CONNACKåŒ…å†…å®¹**ï¼š
```
CONNACKåŒ…å­—æ®µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ReasonCode: 0ï¼ˆæˆåŠŸï¼‰                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ServerTime: 1704067200000            â”‚
â”‚ â”œâ”€ æœåŠ¡ç«¯æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰               â”‚
â”‚ â””â”€ ç”¨äºå®¢æˆ·ç«¯åŒæ­¥æ—¶é—´                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TimeDiff: 50                         â”‚
â”‚ â”œâ”€ å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯æ—¶é—´å·®ï¼ˆæ¯«ç§’ï¼‰        â”‚
â”‚ â””â”€ ç”¨äºå®¢æˆ·ç«¯æ ¡å‡†æ—¶é—´                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ OfflineMsgCount: 10                  â”‚
â”‚ â”œâ”€ ç¦»çº¿æ¶ˆæ¯æ•°é‡                       â”‚
â”‚ â””â”€ ç”¨äºæ˜¾ç¤ºçº¢ç‚¹                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ NodeID: 1                            â”‚
â”‚ â””â”€ æœåŠ¡ç«¯èŠ‚ç‚¹ID                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **D. è¿æ¥å»ºç«‹å®Œæ•´æ—¶åºå›¾**

```
å®¢æˆ·ç«¯                 ç½‘ç»œå±‚                  EventHandler               ä¸šåŠ¡API
  â”‚                     â”‚                        â”‚                        â”‚
  â”‚â”€â”€TCPè¿æ¥â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                        â”‚                        â”‚
  â”‚                     â”‚                        â”‚                        â”‚
  â”‚â”€â”€CONNECTåŒ…â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                        â”‚                        â”‚
  â”‚                     â”‚â”€â”€è§£æFrameâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                        â”‚
  â”‚                     â”‚                        â”‚â”€â”€TokenéªŒè¯â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚                     â”‚                        â”‚â†â”€éªŒè¯ç»“æœâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                     â”‚                        â”‚                        â”‚
  â”‚                     â”‚                        â”‚â”€â”€åŠ è½½ä¼šè¯ï¼ˆè®¢é˜…é¢‘é“ï¼‰â”€â”€â”€â†’â”‚
  â”‚                     â”‚                        â”‚â†â”€ä¼šè¯æ•°æ®â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                     â”‚                        â”‚                        â”‚
  â”‚                     â”‚â†â”€CONNACKåŒ…â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚
  â”‚â†â”€CONNACKåŒ…â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚                        â”‚
  â”‚                     â”‚                        â”‚                        â”‚
  â”‚   è¿æ¥å»ºç«‹å®Œæˆ       â”‚                        â”‚                        â”‚
  â”‚                     â”‚                        â”‚                        â”‚
```

---

## 2ï¸âƒ£ EventOnSend - æ¶ˆæ¯å‘é€

### **A. äº‹ä»¶è§¦å‘æ—¶æœº**

```
å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯æµç¨‹ï¼š

1. å®¢æˆ·ç«¯æ„é€ SENDåŒ…
   â”œâ”€ ClientMsgNo: å®¢æˆ·ç«¯æ¶ˆæ¯IDï¼ˆå»é‡ï¼‰
   â”œâ”€ ChannelID: ç›®æ ‡é¢‘é“
   â”œâ”€ ChannelType: é¢‘é“ç±»å‹
   â””â”€ Payload: æ¶ˆæ¯å†…å®¹
       â†“
2. å‘é€SENDåŒ…
   â””â”€ TCPè¿æ¥å‘é€æ•°æ®
       â†“
3. æœåŠ¡ç«¯æ¥æ”¶
   â”œâ”€ wknet.onData() æ¥æ”¶
   â”œâ”€ Protocol.Decode() è§£æ
   â””â”€ ç”Ÿæˆ EventOnSend äº‹ä»¶
       â†“
4. EventOnSendå¤„ç†
   â”œâ”€ æƒé™æ ¡éªŒ
   â”œâ”€ Webhookå›è°ƒ
   â”œâ”€ ç”ŸæˆMessage
   â”œâ”€ å‘é€SENDACK
   â””â”€ è§¦å‘ EventChannelDistribute
```

---

### **B. Handlerè´£ä»»é“¾**

```go
RegisterUserHandlers(EventOnSend,
	s.permissionHandler.Check,       // 1. æƒé™æ ¡éªŒ
	s.webhookHandler.OnSend,         // 2. Webhookå›è°ƒ
	s.onSendHandler.Handle,          // 3. æ ¸å¿ƒå¤„ç†
)
```

---

### **C. Handlerè¯¦è§£**

#### **Handler 1: æƒé™æ ¡éªŒ**

**ä»£ç ä½ç½®**ï¼š`internal/service/permission.go`

```go
func (h *PermissionHandler) Check(ctx *UserContext) error {
	sendPacket := ctx.Frame.(*wkproto.SendPacket)
	uid := ctx.Conn.UID()

	// 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¢«å°ç¦
	banned, err := h.userService.IsUserBanned(uid)
	if err != nil {
		return err
	}
	if banned {
		return errors.New("user is banned")
	}

	// 2. æ£€æŸ¥æ˜¯å¦åœ¨é»‘åå•
	inBlacklist, err := h.channelService.IsInBlacklist(
		sendPacket.ChannelID,
		sendPacket.ChannelType,
		uid,
	)
	if err != nil {
		return err
	}
	if inBlacklist {
		return errors.New("in blacklist")
	}

	// 3. æ£€æŸ¥æ˜¯å¦è¢«ç¦è¨€
	muted, err := h.channelService.IsMuted(
		sendPacket.ChannelID,
		sendPacket.ChannelType,
		uid,
	)
	if err != nil {
		return err
	}
	if muted {
		return errors.New("user is muted")
	}

	// 4. æ£€æŸ¥é¢‘é“æ˜¯å¦å­˜åœ¨
	exists, err := h.channelService.ChannelExists(
		sendPacket.ChannelID,
		sendPacket.ChannelType,
	)
	if err != nil {
		return err
	}
	if !exists {
		return errors.New("channel not found")
	}

	// 5. æ£€æŸ¥å‘é€æƒé™ï¼ˆç¾¤èŠç‰¹æ®Šæƒé™ï¼‰
	if sendPacket.ChannelType == wkproto.ChannelTypeGroup {
		hasPermission, err := h.channelService.HasSendPermission(
			sendPacket.ChannelID,
			uid,
		)
		if err != nil {
			return err
		}
		if !hasPermission {
			return errors.New("no permission to send")
		}
	}

	return nil
}
```

**æƒé™æ£€æŸ¥é¡¹**ï¼š
```
æƒé™æ ¡éªŒæ¸…å•ï¼š
â”œâ”€ ç”¨æˆ·æ˜¯å¦è¢«å°ç¦
â”œâ”€ ç”¨æˆ·æ˜¯å¦åœ¨é¢‘é“é»‘åå•
â”œâ”€ ç”¨æˆ·æ˜¯å¦è¢«ç¦è¨€
â”œâ”€ é¢‘é“æ˜¯å¦å­˜åœ¨
â””â”€ ç”¨æˆ·æ˜¯å¦æœ‰å‘é€æƒé™ï¼ˆç¾¤èŠï¼‰
    â”œâ”€ æ™®é€šç¾¤ï¼šæ‰€æœ‰æˆå‘˜å¯å‘
    â”œâ”€ ç¦è¨€ç¾¤ï¼šåªæœ‰ç®¡ç†å‘˜å¯å‘
    â””â”€ å…¬å‘Šç¾¤ï¼šåªæœ‰ç¾¤ä¸»å¯å‘
```

---

#### **Handler 2: Webhookå›è°ƒ**

**ä»£ç ä½ç½®**ï¼š`internal/service/webhook.go`

```go
func (h *WebhookHandler) OnSend(ctx *UserContext) error {
	sendPacket := ctx.Frame.(*wkproto.SendPacket)

	// 1. æ„é€ Webhookè¯·æ±‚
	req := &WebhookSendRequest{
		Event:       "message.send",
		FromUID:     ctx.Conn.UID(),
		ChannelID:   sendPacket.ChannelID,
		ChannelType: sendPacket.ChannelType,
		Payload:     base64.StdEncoding.EncodeToString(sendPacket.Payload),
		ClientMsgNo: sendPacket.ClientMsgNo,
	}

	// 2. å‘é€HTTPè¯·æ±‚
	resp, err := h.callWebhook(req)
	if err != nil {
		log.Error("webhook call failed", zap.Error(err))
		// Webhookå¤±è´¥ä¸å½±å“æ¶ˆæ¯å‘é€ï¼ˆé…ç½®å†³å®šï¼‰
		if h.config.WebhookRequired {
			return err
		}
		return nil
	}

	// 3. æ£€æŸ¥ä¸šåŠ¡æ–¹å“åº”
	if resp.Code != 0 {
		// ä¸šåŠ¡æ–¹æ‹’ç»æ¶ˆæ¯
		log.Warn("webhook reject message",
			zap.String("reason", resp.Message))
		return fmt.Errorf("webhook reject: %s", resp.Message)
	}

	// 4. ä¿å­˜ä¸šåŠ¡æ–¹è¿”å›çš„æ‰©å±•ä¿¡æ¯
	if resp.Extra != nil {
		ctx.Extra = resp.Extra
	}

	// 5. ä¸šåŠ¡æ–¹å¯ä¿®æ”¹æ¶ˆæ¯å†…å®¹
	if resp.NewPayload != "" {
		newPayload, _ := base64.StdEncoding.DecodeString(resp.NewPayload)
		sendPacket.Payload = newPayload
	}

	return nil
}
```

**Webhookåº”ç”¨åœºæ™¯**ï¼š
```
ä¸šåŠ¡æ–¹å¯é€šè¿‡Webhookå®ç°ï¼š

1. æ•æ„Ÿè¯è¿‡æ»¤
   â””â”€ æ£€æµ‹æ¶ˆæ¯å†…å®¹ï¼Œæ‹’ç»è¿è§„æ¶ˆæ¯

2. æ¶ˆæ¯å®¡æ ¸
   â””â”€ äººå·¥å®¡æ ¸æˆ–AIå®¡æ ¸

3. æ¶ˆæ¯æ‰©å±•
   â””â”€ æ·»åŠ é¢å¤–ä¿¡æ¯ï¼ˆå¦‚@æé†’ã€å¼•ç”¨æ¶ˆæ¯ï¼‰

4. æ¶ˆæ¯è½¬æ¢
   â””â”€ ä¿®æ”¹æ¶ˆæ¯å†…å®¹ï¼ˆå¦‚æ›¿æ¢æ•æ„Ÿè¯ï¼‰

5. ç»Ÿè®¡åˆ†æ
   â””â”€ è®°å½•æ¶ˆæ¯å‘é€æ—¥å¿—

6. ä¸šåŠ¡é€»è¾‘
   â””â”€ è§¦å‘ä¸šåŠ¡æµç¨‹ï¼ˆå¦‚ç§¯åˆ†å¢åŠ ï¼‰
```

---

#### **Handler 3: æ ¸å¿ƒå¤„ç†**

**ä»£ç ä½ç½®**ï¼š`internal/user/handler/event_onsend.go`

```go
func (h *OnSendHandler) Handle(ctx *UserContext) error {
	sendPacket := ctx.Frame.(*wkproto.SendPacket)
	fromUID := ctx.Conn.UID()

	// 1. ç”ŸæˆMessageIDï¼ˆå…¨å±€å”¯ä¸€ï¼‰
	messageID := h.genMessageID()

	// 2. æ„é€ Messageå¯¹è±¡
	msg := &Message{
		MessageID:   messageID,
		MessageSeq:  0,  // æš‚æœªåˆ†é…ï¼ˆChannelEventPoolä¸­åˆ†é…ï¼‰
		ClientMsgNo: sendPacket.ClientMsgNo,
		FromUID:     fromUID,
		ChannelID:   sendPacket.ChannelID,
		ChannelType: sendPacket.ChannelType,
		Payload:     sendPacket.Payload,
		Timestamp:   time.Now().UnixMilli(),
		Extra:       ctx.Extra,  // Webhookè¿”å›çš„æ‰©å±•ä¿¡æ¯
	}

	// 3. å‘é€SENDACKç»™å®¢æˆ·ç«¯
	sendackPacket := &wkproto.SendackPacket{
		ClientMsgNo: sendPacket.ClientMsgNo,
		MessageID:   messageID,
		MessageSeq:  0,  // æš‚æœªåˆ†é…
		ReasonCode:  wkproto.ReasonSuccess,
	}
	ctx.Conn.WriteFrame(sendackPacket)

	// 4. ç”Ÿæˆé¢‘é“äº‹ä»¶
	channelEvent := &ChannelContext{
		EventType:   EventChannelDistribute,
		ChannelID:   sendPacket.ChannelID,
		ChannelType: sendPacket.ChannelType,
		Messages:    []*Message{msg},
		FromUID:     fromUID,
	}

	// 5. æäº¤åˆ°é¢‘é“äº‹ä»¶æ± 
	h.channelEventPool.AddEvent(
		sendPacket.ChannelID,
		sendPacket.ChannelType,
		channelEvent,
	)

	log.Info("message send",
		zap.String("messageID", messageID),
		zap.String("fromUID", fromUID),
		zap.String("channelID", sendPacket.ChannelID))

	return nil
}
```

**MessageIDç”Ÿæˆç®—æ³•**ï¼š
```go
func (h *OnSendHandler) genMessageID() string {
	// Snowflakeç®—æ³•ç”Ÿæˆå…¨å±€å”¯ä¸€ID
	// 64ä½ï¼š
	// â”œâ”€ 1ä½ï¼šç¬¦å·ä½ï¼ˆ0ï¼‰
	// â”œâ”€ 41ä½ï¼šæ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
	// â”œâ”€ 10ä½ï¼šæœºå™¨ID
	// â””â”€ 12ä½ï¼šåºåˆ—å·

	timestamp := time.Now().UnixMilli() - epoch  // 41ä½
	machineID := h.nodeID                         // 10ä½
	sequence := h.sequence.Add(1) & 0xFFF         // 12ä½

	id := (timestamp << 22) | (machineID << 12) | sequence

	return fmt.Sprintf("%d", id)
}
```

---

### **D. æ¶ˆæ¯å‘é€å®Œæ•´æ—¶åºå›¾**

```
å®¢æˆ·ç«¯          ç½‘ç»œå±‚           UserEventPool       ChannelEventPool
  â”‚              â”‚                    â”‚                    â”‚
  â”‚â”€â”€SENDåŒ…â”€â”€â”€â”€â”€â†’â”‚                    â”‚                    â”‚
  â”‚              â”‚â”€â”€EventOnSendâ”€â”€â”€â”€â”€â”€â†’â”‚                    â”‚
  â”‚              â”‚                    â”‚â”€â”€æƒé™æ ¡éªŒâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’Business API
  â”‚              â”‚                    â”‚â†â”€é€šè¿‡â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚              â”‚                    â”‚                    â”‚
  â”‚              â”‚                    â”‚â”€â”€Webhookå›è°ƒâ”€â”€â”€â”€â”€â”€â”€â†’Business API
  â”‚              â”‚                    â”‚â†â”€é€šè¿‡â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚              â”‚                    â”‚                    â”‚
  â”‚              â”‚                    â”‚â”€â”€ç”ŸæˆMessageIDâ”€â”€â”€â”€â”€â†’â”‚
  â”‚              â”‚                    â”‚â”€â”€å‘é€SENDACKâ”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚â†â”€SENDACKâ”€â”€â”€â”€â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
  â”‚              â”‚                    â”‚                    â”‚
  â”‚              â”‚                    â”‚â”€â”€EventChannelDistributeâ†’â”‚
  â”‚              â”‚                    â”‚                    â”‚â”€â”€å­˜å‚¨æ¶ˆæ¯
  â”‚              â”‚                    â”‚                    â”‚â”€â”€Raftå¤åˆ¶
  â”‚              â”‚                    â”‚                    â”‚
```

---

## 3ï¸âƒ£ EventChannelDistribute - æ¶ˆæ¯åˆ†å‘

### **A. äº‹ä»¶è§¦å‘æ—¶æœº**

```
EventChannelDistribute è§¦å‘ï¼š

ç”± EventOnSend çš„ OnSendHandler è§¦å‘ï¼š
â”œâ”€ OnSendHandler.Handle()
â”œâ”€ æ„é€  ChannelContext{EventChannelDistribute}
â””â”€ ChannelEventPool.AddEvent()
    â†“
EventChannelDistribute èŒè´£ï¼š
â”œâ”€ æ¶ˆæ¯å­˜å‚¨
â”œâ”€ Raftå…±è¯†
â”œâ”€ åˆ†é…MessageSeq
â””â”€ è§¦å‘æ¨é€äº‹ä»¶
```

---

### **B. Handlerè´£ä»»é“¾**

```go
RegisterChannelHandlers(EventChannelDistribute,
	s.distributeHandler.PreCheck,    // 1. é¢„æ£€æŸ¥
	s.distributeHandler.Store,       // 2. å­˜å‚¨æ¶ˆæ¯
	s.distributeHandler.Replicate,   // 3. Raftå¤åˆ¶
	s.distributeHandler.PostProcess, // 4. åå¤„ç†
)
```

---

### **C. Handlerè¯¦è§£**

#### **Handler 1: PreCheckï¼ˆé¢„æ£€æŸ¥ï¼‰**

```go
func (h *DistributeHandler) PreCheck(ctx *ChannelContext) error {
	// 1. æ£€æŸ¥æ¶ˆæ¯åˆ—è¡¨
	if len(ctx.Messages) == 0 {
		return errors.New("no messages")
	}

	// 2. æ£€æŸ¥é¢‘é“æ˜¯å¦å­˜åœ¨
	exists, err := h.channelService.ChannelExists(ctx.ChannelID, ctx.ChannelType)
	if err != nil {
		return err
	}
	if !exists {
		return errors.New("channel not found")
	}

	// 3. å»é‡æ£€æŸ¥ï¼ˆClientMsgNoï¼‰
	for _, msg := range ctx.Messages {
		exists, err := h.messageService.MessageExists(msg.ClientMsgNo)
		if err != nil {
			log.Error("check message exists failed", zap.Error(err))
			continue
		}
		if exists {
			// æ¶ˆæ¯å·²å­˜åœ¨ï¼Œè·³è¿‡
			msg.Skip = true
		}
	}

	return nil
}
```

---

#### **Handler 2: Storeï¼ˆå­˜å‚¨æ¶ˆæ¯ï¼‰**

**ä»£ç ä½ç½®**ï¼š`internal/channel/handler/distribute.go`

```go
func (h *DistributeHandler) Store(ctx *ChannelContext) error {
	// 1. æ‰¹é‡åˆ†é…MessageSeq
	startSeq, err := h.seqService.AllocSeq(ctx.ChannelID, ctx.ChannelType, len(ctx.Messages))
	if err != nil {
		return err
	}

	// 2. åˆ†é…Seqç»™æ¯æ¡æ¶ˆæ¯
	for i, msg := range ctx.Messages {
		if msg.Skip {
			continue
		}
		msg.MessageSeq = startSeq + uint64(i)
	}

	// 3. æ‰¹é‡å†™å…¥æ•°æ®åº“ï¼ˆPebbleDBï¼‰
	batch := h.db.NewBatch()
	for _, msg := range ctx.Messages {
		if msg.Skip {
			continue
		}

		// æ„é€ å­˜å‚¨Key
		key := messageKey(msg.ChannelID, msg.MessageSeq)

		// åºåˆ—åŒ–æ¶ˆæ¯
		data, err := msg.Encode()
		if err != nil {
			return err
		}

		// å†™å…¥Batch
		batch.Put(key, data)
	}

	// 4. æäº¤Batch
	err = batch.Commit()
	if err != nil {
		return err
	}

	log.Info("messages stored",
		zap.String("channelID", ctx.ChannelID),
		zap.Int("count", len(ctx.Messages)),
		zap.Uint64("startSeq", startSeq))

	return nil
}
```

**MessageSeqåˆ†é…**ï¼š
```
MessageSeqç”Ÿæˆï¼š

æ¯ä¸ªé¢‘é“ç‹¬ç«‹çš„é€’å¢åºå·ï¼š
â”œâ”€ Channel A: 1, 2, 3, 4, ...
â”œâ”€ Channel B: 1, 2, 3, 4, ...
â””â”€ Channel C: 1, 2, 3, 4, ...

æ‰¹é‡åˆ†é…ï¼š
â”œâ”€ ä¸€æ¬¡åˆ†é…Nä¸ªè¿ç»­åºå·
â”œâ”€ å‡å°‘åˆ†é…æ¬¡æ•°
â””â”€ æé«˜æ€§èƒ½

å­˜å‚¨ï¼š
â”œâ”€ Key: channel:channelID:seq:messageSeq
â”œâ”€ Value: æ¶ˆæ¯æ•°æ®ï¼ˆåºåˆ—åŒ–ï¼‰
â””â”€ PebbleDB LSM-Tree å­˜å‚¨
```

---

#### **Handler 3: Replicateï¼ˆRaftå¤åˆ¶ï¼‰**

```go
func (h *DistributeHandler) Replicate(ctx *ChannelContext) error {
	// 1. æ„é€ Raft Proposal
	proposal := &Proposal{
		Type:        ProposalTypeMessage,
		ChannelID:   ctx.ChannelID,
		ChannelType: ctx.ChannelType,
		Messages:    ctx.Messages,
	}

	// 2. åºåˆ—åŒ–Proposal
	data, err := proposal.Encode()
	if err != nil {
		return err
	}

	// 3. æè®®åˆ°Raft
	err = h.raftServer.Propose(ctx.ChannelID, data)
	if err != nil {
		return err
	}

	// 4. ç­‰å¾…Raftæäº¤ï¼ˆé˜»å¡ï¼‰
	select {
	case <-ctx.ApplyChan:
		// Raftå·²åº”ç”¨åˆ°çŠ¶æ€æœº
		return nil

	case <-time.After(5 * time.Second):
		// è¶…æ—¶
		return errors.New("raft replicate timeout")
	}
}
```

**Raftå¤åˆ¶æµç¨‹**ï¼š
```
Raftå¤åˆ¶ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ï¼š

1. Leaderæè®®
   â””â”€ DistributeHandler.Replicate()
       â†“
2. å¤åˆ¶åˆ°Follower
   â”œâ”€ Leaderå‘é€AppendEntries RPC
   â””â”€ Followerå†™å…¥Raftæ—¥å¿—
       â†“
3. ç­‰å¾…å¤šæ•°æ´¾ç¡®è®¤
   â”œâ”€ 3èŠ‚ç‚¹é›†ç¾¤ï¼šéœ€è¦2ä¸ªèŠ‚ç‚¹ç¡®è®¤
   â””â”€ 5èŠ‚ç‚¹é›†ç¾¤ï¼šéœ€è¦3ä¸ªèŠ‚ç‚¹ç¡®è®¤
       â†“
4. æäº¤æ—¥å¿—
   â””â”€ Leaderæ ‡è®°æ—¥å¿—ä¸ºå·²æäº¤
       â†“
5. åº”ç”¨åˆ°çŠ¶æ€æœº
   â”œâ”€ è°ƒç”¨Apply()å›è°ƒ
   â””â”€ è§¦å‘ApplyChané€šçŸ¥
       â†“
6. Replicateè¿”å›æˆåŠŸ
```

---

#### **Handler 4: PostProcessï¼ˆåå¤„ç†ï¼‰**

```go
func (h *DistributeHandler) PostProcess(ctx *ChannelContext) error {
	// 1. æŸ¥æ‰¾è®¢é˜…è€…
	subscribers, err := h.subscriberService.GetSubscribers(
		ctx.ChannelID,
		ctx.ChannelType,
	)
	if err != nil {
		return err
	}

	// 2. ç”Ÿæˆæ¨é€äº‹ä»¶
	for _, msg := range ctx.Messages {
		if msg.Skip {
			continue
		}

		pushEvent := &PushContext{
			EventType:   EventPushOnline,
			Message:     msg,
			Subscribers: subscribers,
		}

		// 3. æäº¤åˆ°æ¨é€äº‹ä»¶æ± 
		h.pusherEventPool.AddEvent(pushEvent)
	}

	// 4. æ›´æ–°ç»Ÿè®¡æ•°æ®
	metrics.MessageCount.Add(float64(len(ctx.Messages)))

	log.Info("distribute post process",
		zap.String("channelID", ctx.ChannelID),
		zap.Int("subscriberCount", len(subscribers)))

	return nil
}
```

---

## 4ï¸âƒ£ EventPushOnline - åœ¨çº¿æ¨é€

### **A. äº‹ä»¶è§¦å‘æ—¶æœº**

```
EventPushOnline è§¦å‘ï¼š

ç”± EventChannelDistribute çš„ PostProcess è§¦å‘ï¼š
â”œâ”€ æŸ¥æ‰¾è®¢é˜…è€…
â”œâ”€ æ„é€  PushContext{EventPushOnline}
â””â”€ PusherEventPool.AddEvent()
    â†“
EventPushOnline èŒè´£ï¼š
â”œâ”€ è¿‡æ»¤åœ¨çº¿è®¢é˜…è€…
â”œâ”€ ç¼–ç RECVåŒ…
â”œâ”€ å†™å…¥è¿æ¥
â””â”€ è·¨èŠ‚ç‚¹æ¨é€
```

---

### **B. Handlerè´£ä»»é“¾**

```go
RegisterPusherHandlers(EventPushOnline,
	s.pushHandler.FilterOnline,      // 1. è¿‡æ»¤åœ¨çº¿è®¢é˜…è€…
	s.pushHandler.Encode,            // 2. ç¼–ç RECVåŒ…
	s.pushHandler.Write,             // 3. å†™å…¥è¿æ¥
)
```

---

### **C. Handlerè¯¦è§£**

#### **Handler 1: FilterOnlineï¼ˆè¿‡æ»¤åœ¨çº¿è®¢é˜…è€…ï¼‰**

```go
func (h *PushOnlineHandler) FilterOnline(ctx *PushContext) error {
	onlineSubscribers := make([]Subscriber, 0, len(ctx.Subscribers))

	// 1. è¿‡æ»¤åœ¨çº¿è®¢é˜…è€…
	for _, sub := range ctx.Subscribers {
		// æŸ¥è¯¢ç”¨æˆ·åœ¨çº¿çŠ¶æ€
		nodeID, err := h.redis.HGet(context.Background(), "user:online", sub.UID).Uint64()
		if err != nil || nodeID == 0 {
			// ç¦»çº¿ï¼Œè·³è¿‡
			continue
		}

		sub.NodeID = nodeID
		onlineSubscribers = append(onlineSubscribers, sub)
	}

	// 2. æŒ‰èŠ‚ç‚¹åˆ†ç»„
	ctx.NodeGroups = h.groupByNode(onlineSubscribers)

	log.Info("filter online",
		zap.Int("totalCount", len(ctx.Subscribers)),
		zap.Int("onlineCount", len(onlineSubscribers)),
		zap.Int("nodeCount", len(ctx.NodeGroups)))

	return nil
}

func (h *PushOnlineHandler) groupByNode(subscribers []Subscriber) map[uint64][]string {
	groups := make(map[uint64][]string)

	for _, sub := range subscribers {
		groups[sub.NodeID] = append(groups[sub.NodeID], sub.UID)
	}

	return groups
}
```

---

#### **Handler 2: Encodeï¼ˆç¼–ç RECVåŒ…ï¼‰**

```go
func (h *PushOnlineHandler) Encode(ctx *PushContext) error {
	msg := ctx.Message

	// 1. æ„é€ RECVåŒ…
	recvPacket := &wkproto.RecvPacket{
		Setting:     0,
		MessageID:   msg.MessageID,
		MessageSeq:  msg.MessageSeq,
		ClientMsgNo: msg.ClientMsgNo,
		FromUID:     msg.FromUID,
		ChannelID:   msg.ChannelID,
		ChannelType: msg.ChannelType,
		Payload:     msg.Payload,
		Timestamp:   msg.Timestamp,
	}

	// 2. ç¼–ç ä¸ºäºŒè¿›åˆ¶
	data, err := wkproto.EncodeFrame(recvPacket, wkproto.LatestVersion)
	if err != nil {
		return err
	}

	// 3. ä¿å­˜åˆ°Context
	ctx.EncodedData = data

	return nil
}
```

---

#### **Handler 3: Writeï¼ˆå†™å…¥è¿æ¥ï¼‰**

```go
func (h *PushOnlineHandler) Write(ctx *PushContext) error {
	// 1. æœ¬åœ°æ¨é€
	localUIDs := ctx.NodeGroups[h.nodeID]
	if len(localUIDs) > 0 {
		h.pushLocal(localUIDs, ctx.EncodedData)
	}

	// 2. è·¨èŠ‚ç‚¹æ¨é€
	for nodeID, uids := range ctx.NodeGroups {
		if nodeID == h.nodeID {
			continue  // è·³è¿‡æœ¬åœ°
		}

		// å‘é€RPCåˆ°ç›®æ ‡èŠ‚ç‚¹
		go h.pushRemote(nodeID, uids, ctx.Message)
	}

	return nil
}

func (h *PushOnlineHandler) pushLocal(uids []string, data []byte) {
	for _, uid := range uids {
		// æŸ¥æ‰¾ç”¨æˆ·çš„æ‰€æœ‰è¿æ¥ï¼ˆå¤šç«¯ï¼‰
		conns := h.connMgr.ConnsByUID(uid)

		for _, conn := range conns {
			// å†™å…¥è¿æ¥
			_, err := conn.Write(data)
			if err != nil {
				log.Error("write data failed",
					zap.String("uid", uid),
					zap.Error(err))
			}
		}
	}
}

func (h *PushOnlineHandler) pushRemote(nodeID uint64, uids []string, msg *Message) {
	// æ„é€ RPCè¯·æ±‚
	req := &pb.PushRequest{
		Uids:    uids,
		Message: convertMessage(msg),
	}

	// å‘é€RPC
	ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
	defer cancel()

	resp, err := h.rpcClient.Push(ctx, nodeID, req)
	if err != nil {
		log.Error("push remote failed",
			zap.Uint64("nodeID", nodeID),
			zap.Error(err))
		return
	}

	log.Info("push remote success",
		zap.Uint64("nodeID", nodeID),
		zap.Int("successCount", int(resp.SuccessCount)))
}
```

---

## 5ï¸âƒ£ å…¶ä»–æ ¸å¿ƒäº‹ä»¶

### **A. EventRecvAck - æ¥æ”¶ç¡®è®¤**

```
EventRecvAck æµç¨‹ï¼š

1. å®¢æˆ·ç«¯æ”¶åˆ°RECVåŒ…
   â””â”€ å¤„ç†æ¶ˆæ¯ï¼ˆæ˜¾ç¤ºåˆ°ç•Œé¢ï¼‰

2. å®¢æˆ·ç«¯å‘é€RECVACKåŒ…
   â””â”€ MessageIDã€MessageSeq

3. æœåŠ¡ç«¯å¤„ç†
   â”œâ”€ æ›´æ–°å®¢æˆ·ç«¯å·²æ¥æ”¶åºå·ï¼ˆOffsetï¼‰
   â”œâ”€ æ¸…ç†å·²ç¡®è®¤çš„ç¦»çº¿æ¶ˆæ¯é˜Ÿåˆ—
   â””â”€ ç”¨äºæ¶ˆæ¯åŒæ­¥
```

**ä»£ç ä½ç½®**ï¼š`internal/user/handler/event_recvack.go`

```go
func (h *RecvAckHandler) Handle(ctx *UserContext) error {
	recvackPacket := ctx.Frame.(*wkproto.RecvackPacket)
	uid := ctx.Conn.UID()

	// 1. æ›´æ–°ç”¨æˆ·çš„å·²æ¥æ”¶åºå·
	err := h.offsetService.UpdateOffset(
		uid,
		recvackPacket.ChannelID,
		recvackPacket.ChannelType,
		recvackPacket.MessageSeq,
	)
	if err != nil {
		return err
	}

	// 2. æ¸…ç†å·²ç¡®è®¤çš„æ¶ˆæ¯
	err = h.messageQueue.ClearBefore(
		uid,
		recvackPacket.ChannelID,
		recvackPacket.MessageSeq,
	)

	return err
}
```

---

### **B. EventPing - å¿ƒè·³**

```
EventPing æµç¨‹ï¼š

1. å®¢æˆ·ç«¯å®šæ—¶å‘é€PINGåŒ…
   â””â”€ é»˜è®¤30ç§’ä¸€æ¬¡

2. æœåŠ¡ç«¯å¤„ç†
   â”œâ”€ æ›´æ–°è¿æ¥æœ€åæ´»è·ƒæ—¶é—´
   â””â”€ ç«‹å³è¿”å›PONGåŒ…

3. å®¢æˆ·ç«¯æ”¶åˆ°PONGåŒ…
   â””â”€ è®¡ç®—RTTï¼ˆå¾€è¿”æ—¶å»¶ï¼‰
```

**ä»£ç ä½ç½®**ï¼š`internal/user/handler/event_ping.go`

```go
func (h *PingHandler) Handle(ctx *UserContext) error {
	// 1. æ›´æ–°æœ€åæ´»è·ƒæ—¶é—´
	ctx.Conn.KeepLastActivity()

	// 2. æ„é€ PONGåŒ…
	pongPacket := &wkproto.PongPacket{}

	// 3. å‘é€PONG
	err := ctx.Conn.WriteFrame(pongPacket)

	return err
}
```

---

### **C. EventConnClose - è¿æ¥å…³é—­**

```
EventConnClose æµç¨‹ï¼š

1. è§¦å‘æ—¶æœº
   â”œâ”€ å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­
   â”œâ”€ è¿æ¥è¶…æ—¶ï¼ˆ60ç§’æ— æ´»åŠ¨ï¼‰
   â””â”€ åè®®é”™è¯¯

2. æ¸…ç†å·¥ä½œ
   â”œâ”€ ç§»é™¤è®¢é˜…å…³ç³»
   â”œâ”€ æ›´æ–°åœ¨çº¿çŠ¶æ€ï¼ˆRedisï¼‰
   â”œâ”€ é‡Šæ”¾èµ„æº
   â””â”€ è®°å½•æ—¥å¿—
```

**ä»£ç ä½ç½®**ï¼š`internal/user/handler/event_close.go`

```go
func (h *CloseHandler) Handle(ctx *UserContext) error {
	uid := ctx.Conn.UID()

	// 1. ç§»é™¤è®¢é˜…å…³ç³»
	h.subscriberService.RemoveAllSubscriptions(uid)

	// 2. æ›´æ–°åœ¨çº¿çŠ¶æ€
	h.redis.HDel(context.Background(), "user:online", uid)

	// 3. æ¸…ç†è¿æ¥ç®¡ç†å™¨
	h.connMgr.RemoveConn(ctx.Conn)

	log.Info("connection closed",
		zap.String("uid", uid),
		zap.String("remoteAddr", ctx.Conn.RemoteAddr().String()))

	return nil
}
```

---

## 6ï¸âƒ£ äº‹ä»¶æµè½¬å®Œæ•´æ¡ˆä¾‹

### **å®Œæ•´æ¶ˆæ¯å‘é€æµç¨‹**

```
å®Œæ•´æµç¨‹ï¼ˆä»å®¢æˆ·ç«¯å‘é€åˆ°æ¥æ”¶è€…æ”¶åˆ°ï¼‰ï¼š

å®¢æˆ·ç«¯Aï¼ˆuser001ï¼‰å‘é€æ¶ˆæ¯åˆ°ç¾¤èŠï¼ˆgroup_001ï¼‰

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: å®¢æˆ·ç«¯å‘é€                                    â”‚
â”‚ â”œâ”€ å®¢æˆ·ç«¯Aæ„é€ SENDåŒ…                                  â”‚
â”‚ â”œâ”€ ClientMsgNo: "msg_20240101_001"                   â”‚
â”‚ â”œâ”€ ChannelID: "group_001"                            â”‚
â”‚ â”œâ”€ ChannelType: 2 (GROUP)                            â”‚
â”‚ â””â”€ Payload: "Hello everyone!"                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: ç½‘ç»œå±‚æ¥æ”¶                                    â”‚
â”‚ â”œâ”€ wknet.onData() æ¥æ”¶æ•°æ®                            â”‚
â”‚ â”œâ”€ Protocol.Decode() è§£æSEND Frame                  â”‚
â”‚ â””â”€ ç”Ÿæˆ UserContext{EventOnSend}                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: UserEventPool å¤„ç†                           â”‚
â”‚ â”œâ”€ UserEventPool.AddEvent("user001", event)         â”‚
â”‚ â”œâ”€ å†™å…¥user001çš„äº‹ä»¶é˜Ÿåˆ—                              â”‚
â”‚ â””â”€ Workeræ‰§è¡ŒHandleré“¾                               â”‚
â”‚     â”œâ”€ PermissionHandler: æƒé™æ ¡éªŒé€šè¿‡                â”‚
â”‚     â”œâ”€ WebhookHandler: ä¸šåŠ¡å›è°ƒé€šè¿‡                   â”‚
â”‚     â””â”€ OnSendHandler:                                â”‚
â”‚         â”œâ”€ ç”ŸæˆMessageID: "1234567890"               â”‚
â”‚         â”œâ”€ å‘é€SENDACKç»™å®¢æˆ·ç«¯A                       â”‚
â”‚         â””â”€ ç”ŸæˆChannelContext{EventChannelDistribute}â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: ChannelEventPool å¤„ç†                        â”‚
â”‚ â”œâ”€ ChannelEventPool.AddEvent("group_001", 2, event) â”‚
â”‚ â”œâ”€ å†™å…¥group_001çš„äº‹ä»¶é˜Ÿåˆ—                            â”‚
â”‚ â””â”€ Workeræ‰§è¡ŒHandleré“¾                               â”‚
â”‚     â”œâ”€ PreCheckHandler: å»é‡æ£€æŸ¥é€šè¿‡                  â”‚
â”‚     â”œâ”€ StoreHandler:                                 â”‚
â”‚     â”‚   â”œâ”€ åˆ†é…MessageSeq: 1001                      â”‚
â”‚     â”‚   â””â”€ å†™å…¥PebbleDB                               â”‚
â”‚     â”œâ”€ ReplicateHandler:                             â”‚
â”‚     â”‚   â”œâ”€ æè®®åˆ°Raft                                 â”‚
â”‚     â”‚   â”œâ”€ å¤åˆ¶åˆ°Follower                             â”‚
â”‚     â”‚   â””â”€ ç­‰å¾…å¤šæ•°æ´¾ç¡®è®¤ï¼ˆæˆåŠŸï¼‰                      â”‚
â”‚     â””â”€ PostProcessHandler:                           â”‚
â”‚         â”œâ”€ æŸ¥æ‰¾è®¢é˜…è€…: [user002, user003, user004]    â”‚
â”‚         â””â”€ ç”ŸæˆPushContext{EventPushOnline}          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: PusherEventPool å¤„ç†                         â”‚
â”‚ â”œâ”€ PusherEventPool.AddEvent(event)                  â”‚
â”‚ â””â”€ Workeræ‰§è¡ŒHandleré“¾                               â”‚
â”‚     â”œâ”€ FilterOnlineHandler:                          â”‚
â”‚     â”‚   â”œâ”€ æŸ¥è¯¢åœ¨çº¿çŠ¶æ€:                              â”‚
â”‚     â”‚   â”‚   â”œâ”€ user002: èŠ‚ç‚¹1ï¼ˆåœ¨çº¿ï¼‰                 â”‚
â”‚     â”‚   â”‚   â”œâ”€ user003: èŠ‚ç‚¹2ï¼ˆåœ¨çº¿ï¼‰                 â”‚
â”‚     â”‚   â”‚   â””â”€ user004: 0ï¼ˆç¦»çº¿ï¼Œè·³è¿‡ï¼‰               â”‚
â”‚     â”‚   â””â”€ æŒ‰èŠ‚ç‚¹åˆ†ç»„:                                â”‚
â”‚     â”‚       â”œâ”€ èŠ‚ç‚¹1: [user002]                       â”‚
â”‚     â”‚       â””â”€ èŠ‚ç‚¹2: [user003]                       â”‚
â”‚     â”œâ”€ EncodeHandler:                                â”‚
â”‚     â”‚   â””â”€ ç¼–ç RECVåŒ…ï¼ˆäºŒè¿›åˆ¶ï¼‰                        â”‚
â”‚     â””â”€ WriteHandler:                                 â”‚
â”‚         â”œâ”€ æœ¬åœ°æ¨é€ï¼ˆèŠ‚ç‚¹1ï¼‰:                          â”‚
â”‚         â”‚   â””â”€ æŸ¥æ‰¾user002è¿æ¥ï¼Œå†™å…¥æ•°æ®               â”‚
â”‚         â””â”€ è·¨èŠ‚ç‚¹æ¨é€ï¼ˆèŠ‚ç‚¹2ï¼‰:                        â”‚
â”‚             â””â”€ RPCæ¨é€åˆ°èŠ‚ç‚¹2                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 6: æ¥æ”¶è€…æ”¶åˆ°æ¶ˆæ¯                                 â”‚
â”‚ â”œâ”€ user002æ”¶åˆ°RECVåŒ…ï¼ˆèŠ‚ç‚¹1æœ¬åœ°æ¨é€ï¼‰                  â”‚
â”‚ â”œâ”€ user003æ”¶åˆ°RECVåŒ…ï¼ˆèŠ‚ç‚¹2 RPCæ¨é€ï¼‰                  â”‚
â”‚ â””â”€ user004ç¦»çº¿ï¼Œæ¶ˆæ¯å­˜å…¥ç¦»çº¿é˜Ÿåˆ—                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 7: å®¢æˆ·ç«¯ç¡®è®¤                                    â”‚
â”‚ â”œâ”€ user002å‘é€RECVACK                                â”‚
â”‚ â””â”€ user003å‘é€RECVACK                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®Œæˆï¼
```

---

### **æ€§èƒ½æ•°æ®**

```
å®Œæ•´æµç¨‹è€—æ—¶åˆ†æï¼š

Step 1: å®¢æˆ·ç«¯å‘é€          0ms
Step 2: ç½‘ç»œå±‚æ¥æ”¶          0.5ms
Step 3: UserEventPool      2ms
  â”œâ”€ æƒé™æ ¡éªŒ              0.5ms
  â”œâ”€ Webhookå›è°ƒ           1ms
  â””â”€ æ ¸å¿ƒå¤„ç†              0.5ms
Step 4: ChannelEventPool   30ms
  â”œâ”€ å­˜å‚¨æ¶ˆæ¯              5ms
  â”œâ”€ Raftå¤åˆ¶             20msï¼ˆä¸»è¦è€—æ—¶ï¼‰
  â””â”€ åå¤„ç†               5ms
Step 5: PusherEventPool    5ms
  â”œâ”€ è¿‡æ»¤åœ¨çº¿              1ms
  â”œâ”€ ç¼–ç RECV             0.5ms
  â””â”€ å†™å…¥è¿æ¥              3.5ms

æ€»è€—æ—¶ï¼šçº¦40msï¼ˆP99 < 50msï¼‰

ååé‡ï¼š
â”œâ”€ å•æœºï¼š10ä¸‡æ¡æ¶ˆæ¯/ç§’
â”œâ”€ 3èŠ‚ç‚¹é›†ç¾¤ï¼š25ä¸‡æ¡æ¶ˆæ¯/ç§’
â””â”€ 5èŠ‚ç‚¹é›†ç¾¤ï¼š40ä¸‡æ¡æ¶ˆæ¯/ç§’
```

---

## 7ï¸âƒ£ æ€»ç»“

### **æ ¸å¿ƒè¦ç‚¹**

1. **EventConnect - è¿æ¥å»ºç«‹**
   - è®¤è¯Token
   - åŠ è½½ä¼šè¯ï¼ˆè®¢é˜…é¢‘é“ï¼‰
   - å‘é€CONNACK

2. **EventOnSend - æ¶ˆæ¯å‘é€**
   - æƒé™æ ¡éªŒ
   - Webhookå›è°ƒ
   - ç”ŸæˆMessageID
   - å‘é€SENDACK
   - è§¦å‘ChannelEvent

3. **EventChannelDistribute - æ¶ˆæ¯åˆ†å‘**
   - é¢„æ£€æŸ¥ï¼ˆå»é‡ï¼‰
   - å­˜å‚¨æ¶ˆæ¯ï¼ˆåˆ†é…Seqï¼‰
   - Raftå¤åˆ¶ï¼ˆä¿è¯å¯é æ€§ï¼‰
   - åå¤„ç†ï¼ˆè§¦å‘æ¨é€ï¼‰

4. **EventPushOnline - åœ¨çº¿æ¨é€**
   - è¿‡æ»¤åœ¨çº¿è®¢é˜…è€…
   - ç¼–ç RECVåŒ…
   - æœ¬åœ°æ¨é€
   - è·¨èŠ‚ç‚¹æ¨é€

---

### **äº‹ä»¶é©±åŠ¨æ¶æ„ä¼˜åŠ¿**

```
âœ… è§£è€¦ï¼šå„å±‚é€šè¿‡äº‹ä»¶é€šä¿¡ï¼Œäº’ä¸ä¾èµ–
âœ… å¼‚æ­¥ï¼šå¿«é€Ÿå“åº”ï¼Œä¸é˜»å¡
âœ… åˆ†å±‚ï¼šèŒè´£æ¸…æ™°ï¼Œæ˜“ç»´æŠ¤
âœ… æ‰©å±•ï¼šæ–°å¢åŠŸèƒ½åªéœ€æ·»åŠ Handler
âœ… å¯é ï¼šRaftå¤åˆ¶ï¼Œæ¶ˆæ¯ä¸ä¸¢å¤±
âœ… åˆ†å¸ƒå¼ï¼šè·¨èŠ‚ç‚¹è½¬å‘ï¼Œæ— å•ç‚¹
```

---

### **æœ¬ç« æ€»ç»“**

**ç¬¬äº”ç« ï¼šEventBusäº‹ä»¶æ€»çº¿**

æˆ‘ä»¬å­¦ä¹ äº†ï¼š
- 5.1ï¼šäº‹ä»¶é©±åŠ¨æ¶æ„æ¦‚è¿°
- 5.2ï¼šä¸‰å¤§äº‹ä»¶æ± ï¼ˆUser/Channel/Pusherï¼‰
- 5.3ï¼šäº‹ä»¶å¤„ç†é“¾ï¼ˆç”Ÿæˆâ†’å…¥é˜Ÿâ†’è·¯ç”±â†’æ‰§è¡Œï¼‰
- 5.4ï¼šæ ¸å¿ƒäº‹ä»¶è§£æï¼ˆConnect/OnSend/Distribute/Pushï¼‰

**ä¸‹ä¸€ç« é¢„å‘Š**ï¼š

**ç¬¬å…­ç« ï¼šå­˜å‚¨å±‚è®¾è®¡**
- 6.1ï¼šPebbleDBå­˜å‚¨å¼•æ“
- 6.2ï¼šæ¶ˆæ¯å­˜å‚¨è®¾è®¡
- 6.3ï¼šç´¢å¼•è®¾è®¡ä¸ä¼˜åŒ–
- 6.4ï¼šæ•°æ®å‹ç¼©ä¸æ¸…ç†

---

> **ğŸ”— ç›¸å…³ä»£ç **ï¼š
> - è¿æ¥Handlerï¼š`internal/user/handler/connect.go`
> - å‘é€Handlerï¼š`internal/user/handler/event_onsend.go`
> - åˆ†å‘Handlerï¼š`internal/channel/handler/distribute.go`
> - æ¨é€Handlerï¼š`internal/pusher/handler/push_online.go`
> - æƒé™æ£€æŸ¥ï¼š`internal/service/permission.go`
> - Webhookï¼š`internal/service/webhook.go`
> - Raftå¤åˆ¶ï¼š`pkg/cluster/raft/replication.go`
