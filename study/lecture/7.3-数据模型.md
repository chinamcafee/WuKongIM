# 7.3 æ•°æ®æ¨¡å‹

> **æœ¬èŠ‚ç›®æ ‡**ï¼šæ·±å…¥ç†è§£WuKongDBçš„å››å¤§æ ¸å¿ƒæ•°æ®æ¨¡å‹ï¼šæ¶ˆæ¯ã€é¢‘é“ã€ä¼šè¯ã€è®¢é˜…å…³ç³»ï¼ŒæŒæ¡IMç³»ç»Ÿçš„æ•°æ®ç»“æ„è®¾è®¡

---

## ğŸ“‹ ç›®å½•
1. [æ¶ˆæ¯æ•°æ®æ¨¡å‹](#æ¶ˆæ¯æ•°æ®æ¨¡å‹)
2. [é¢‘é“æ•°æ®æ¨¡å‹](#é¢‘é“æ•°æ®æ¨¡å‹)
3. [ä¼šè¯æ•°æ®æ¨¡å‹](#ä¼šè¯æ•°æ®æ¨¡å‹)
4. [è®¢é˜…å…³ç³»æ¨¡å‹](#è®¢é˜…å…³ç³»æ¨¡å‹)
5. [è®¾å¤‡ä¸ç”¨æˆ·æ¨¡å‹](#è®¾å¤‡ä¸ç”¨æˆ·æ¨¡å‹)

---

## 1ï¸âƒ£ æ¶ˆæ¯æ•°æ®æ¨¡å‹

### **A. Message ç»“æ„**

**æ ¸å¿ƒå®šä¹‰**ï¼š
```go
// pkg/wkdb/model.go:22-26
type Message struct {
    wkproto.RecvPacket  // ç»§æ‰¿RecvPacketï¼ˆæ¶ˆæ¯åŒ…ï¼‰
    Term    uint64      // Raftä»»æœŸå·
    version uint8       // æ•°æ®åè®®ç‰ˆæœ¬
}
```

**RecvPacket å­—æ®µ**ï¼ˆç»§æ‰¿è‡ªwkprotoï¼‰ï¼š
```go
type RecvPacket struct {
    // åŸºç¡€å­—æ®µ
    Setting       uint8   // è®¾ç½®æ ‡è®°
    MessageID     int64   // æ¶ˆæ¯å…¨å±€å”¯ä¸€IDï¼ˆé›ªèŠ±ç®—æ³•ï¼‰
    MessageSeq    uint32  // æ¶ˆæ¯åºå·ï¼ˆé¢‘é“å†…é€’å¢ï¼‰
    ClientMsgNo   string  // å®¢æˆ·ç«¯æ¶ˆæ¯ç¼–å·ï¼ˆå»é‡ç”¨ï¼‰
    StreamNo      string  // æµå¼æ¶ˆæ¯ç¼–å·
    StreamSeq     uint32  // æµå¼æ¶ˆæ¯åºå·
    StreamFlag    uint8   // æµå¼æ¶ˆæ¯æ ‡è®°

    // é¢‘é“ä¿¡æ¯
    ChannelID   string  // é¢‘é“ID
    ChannelType uint8   // é¢‘é“ç±»å‹ï¼ˆ1=ä¸ªäºº,2=ç¾¤èŠï¼‰

    // æ¶ˆæ¯å†…å®¹
    FromUID     string  // å‘é€è€…UID
    Payload     []byte  // æ¶ˆæ¯å†…å®¹ï¼ˆåŠ å¯†åçš„ï¼‰

    // æ—¶é—´æˆ³
    Timestamp   int32   // æ¶ˆæ¯æ—¶é—´æˆ³ï¼ˆç§’ï¼‰

    // æ‰©å±•å­—æ®µ
    Expire      uint32  // è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
    Topic       string  // ä¸»é¢˜
    MsgKey      string  // æ¶ˆæ¯å¯†é’¥ï¼ˆç«¯åˆ°ç«¯åŠ å¯†ï¼‰

    // æ¶ˆæ¯æ‰©å±•
    MessageExtra MessageExtra  // æ‰©å±•å­—æ®µ
}
```

---

### **B. æ¶ˆæ¯åºåˆ—åŒ–**

**Marshalï¼ˆç¼–ç ï¼‰**ï¼š
```go
// pkg/wkdb/model.go:83-101
func (m *Message) Marshal() ([]byte, error) {
    // 1. ç¼–ç RecvPacketï¼ˆwkprotoåè®®ï¼‰
    data, err := proto.EncodeFrame(&m.RecvPacket, wkproto.LatestVersion)

    // 2. æ„å»ºå®Œæ•´æ¶ˆæ¯æ ¼å¼
    fixVersion := uint8(100)  // ç‰ˆæœ¬æ ‡è¯†
    enc := wkproto.NewEncoder()

    enc.WriteUint8(wkproto.LatestVersion + fixVersion)  // ç‰ˆæœ¬å·
    enc.WriteUint8(m.version)                            // æ•°æ®ç‰ˆæœ¬
    enc.WriteUint32(uint32(len(data)))                   // RecvPacketé•¿åº¦
    enc.WriteBytes(data)                                 // RecvPacketæ•°æ®
    enc.WriteUint64(m.Term)                              // Raft Term

    return enc.Bytes(), nil
}

å­˜å‚¨æ ¼å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Version(1) â”‚ DataVer(1) â”‚ Len(4) â”‚ ...   â”‚
â”‚ ç‰ˆæœ¬å·     â”‚ æ•°æ®ç‰ˆæœ¬    â”‚ é•¿åº¦   â”‚ æ•°æ®  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ RecvPacket Data (å˜é•¿)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Term(8)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **C. æ¶ˆæ¯å­˜å‚¨ç¤ºä¾‹**

**å­˜å‚¨Key**ï¼š
```
æ¶ˆæ¯Keyæ ¼å¼ï¼š
channel:{channelId}:{channelType}:msg:{messageSeq}

ç¤ºä¾‹ï¼š
é¢‘é“ï¼šchannel_001ï¼ˆç¾¤èŠï¼‰
æ¶ˆæ¯åºå·ï¼š100
â†’ Key: channel:channel_001:2:msg:100

ä¼˜åŠ¿ï¼š
âœ… æŒ‰é¢‘é“åˆ†ç»„ï¼ŒèŒƒå›´æŸ¥è¯¢é«˜æ•ˆ
âœ… æŒ‰åºå·æ’åºï¼ŒæŸ¥è¯¢æœ€æ–°æ¶ˆæ¯å¿«
âœ… Keyæœ‰åºï¼ŒLSM-Treeå‹å¥½
```

**æŸ¥è¯¢ç¤ºä¾‹**ï¼š
```go
// æŸ¥è¯¢æœ€æ–°100æ¡æ¶ˆæ¯
func GetLastMessages(channelId string, channelType uint8, limit int) []Message {
    startKey := fmt.Sprintf("channel:%s:%d:msg:%d", channelId, channelType, math.MaxUint32)
    endKey   := fmt.Sprintf("channel:%s:%d:msg:%d", channelId, channelType, 0)

    // åå‘è¿­ä»£ï¼ˆä»å¤§åˆ°å°ï¼‰
    iter := db.NewIter(&pebble.IterOptions{
        LowerBound: []byte(endKey),
        UpperBound: []byte(startKey),
    })

    messages := make([]Message, 0, limit)
    for iter.Last(); iter.Valid() && len(messages) < limit; iter.Prev() {
        var msg Message
        msg.Unmarshal(iter.Value())
        messages = append(messages, msg)
    }

    return messages
}
```

---

### **D. æ¶ˆæ¯IDç”Ÿæˆ**

**é›ªèŠ±ç®—æ³•ï¼ˆSnowflakeï¼‰**ï¼š
```
MessageIDï¼ˆ64ä½ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Timestamp(41) â”‚ NodeID(10) â”‚ Sequence(12) â”‚ 1bit  â”‚
â”‚ æ—¶é—´æˆ³41ä½    â”‚ èŠ‚ç‚¹10ä½   â”‚ åºåˆ—å·12ä½   â”‚ ç¬¦å·ä½â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¤ºä¾‹ï¼š
æ—¶é—´æˆ³ï¼š2025-01-04 12:00:00 â†’ 1735977600000
èŠ‚ç‚¹IDï¼š5
åºåˆ—å·ï¼š123
â†’ MessageID: 123456789012345678

ç‰¹ç‚¹ï¼š
âœ… å…¨å±€å”¯ä¸€ï¼ˆåˆ†å¸ƒå¼ç¯å¢ƒï¼‰
âœ… æ—¶é—´æœ‰åºï¼ˆå¯æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢ï¼‰
âœ… é«˜æ€§èƒ½ï¼ˆæœ¬åœ°ç”Ÿæˆï¼Œæ— ç½‘ç»œå¼€é”€ï¼‰
```

**ç”Ÿæˆä»£ç **ï¼š
```go
// pkg/wkdb/wukongdb.go:51-55
prmaryKeyGen, err := snowflake.NewNode(int64(opts.NodeId))

// ç”Ÿæˆæ¶ˆæ¯ID
messageId := wk.prmaryKeyGen.Generate().Int64()
```

---

## 2ï¸âƒ£ é¢‘é“æ•°æ®æ¨¡å‹

### **A. ChannelInfo ç»“æ„**

```go
// pkg/wkdb/model.go:147-174
type ChannelInfo struct {
    Id              uint64     // ä¸»é”®ID
    ChannelId       string     // é¢‘é“IDï¼ˆä¸šåŠ¡IDï¼‰
    ChannelType     uint8      // é¢‘é“ç±»å‹

    // é¢‘é“é…ç½®
    Ban             bool       // æ˜¯å¦å°ç¦
    Disband         bool       // æ˜¯å¦è§£æ•£
    Large           bool       // æ˜¯å¦å¤§ç¾¤ï¼ˆ>500äººï¼‰

    // æ¶ˆæ¯åºå·
    MessageSeq      uint32     // å½“å‰æœ€å¤§æ¶ˆæ¯åºå·

    // è®¢é˜…å…³ç³»
    SubscriberCount int        // è®¢é˜…è€…æ•°é‡
    AllowlistCount  int        // ç™½åå•æ•°é‡
    DenylistCount   int        // é»‘åå•æ•°é‡

    // æ—¶é—´æˆ³
    LastMsgTime     int64      // æœ€åä¸€æ¡æ¶ˆæ¯æ—¶é—´
    CreatedAt       *time.Time // åˆ›å»ºæ—¶é—´
    UpdatedAt       *time.Time // æ›´æ–°æ—¶é—´

    // ç‰ˆæœ¬æ§åˆ¶
    Version         uint64     // ç‰ˆæœ¬å·ï¼ˆç¼“å­˜å¤±æ•ˆç”¨ï¼‰
}
```

---

### **B. é¢‘é“ç±»å‹**

```go
é¢‘é“ç±»å‹å®šä¹‰ï¼š
const (
    ChannelTypePerson        = 1  // ä¸ªäººé¢‘é“ï¼ˆ1v1ï¼‰
    ChannelTypeGroup         = 2  // ç¾¤èŠ
    ChannelTypeCommunity     = 3  // ç¤¾åŒº/é¢‘é“
    ChannelTypeCustomerService = 4 // å®¢æœ
    ChannelTypeInfo          = 5  // ç³»ç»Ÿæ¶ˆæ¯
)

ç¤ºä¾‹ï¼š
1. ä¸ªäººé¢‘é“ï¼šuser001 ä¸ user002 èŠå¤©
   â†’ ChannelId: "user002"ï¼ˆå¯¹ç«¯IDï¼‰
   â†’ ChannelType: 1

2. ç¾¤èŠï¼šç¾¤IDä¸º group_123
   â†’ ChannelId: "group_123"
   â†’ ChannelType: 2

3. ç¤¾åŒºé¢‘é“ï¼šé¢‘é“IDä¸º channel_456
   â†’ ChannelId: "channel_456"
   â†’ ChannelType: 3
```

---

### **C. é¢‘é“é…ç½®å­˜å‚¨**

**å­˜å‚¨Keyè®¾è®¡**ï¼š
```
é¢‘é“ä¿¡æ¯Keyï¼š
channel_info:{primaryKey}

ç´¢å¼•Keyï¼š
channel_info_index:{channelId}:{channelType} â†’ primaryKey

ç¤ºä¾‹ï¼š
é¢‘é“ï¼šgroup_123ï¼ˆç¾¤èŠï¼‰
PrimaryKeyï¼š987654321

ä¸»æ•°æ®ï¼š
Key:   channel_info:987654321
Value: {ChannelInfoå¯¹è±¡åºåˆ—åŒ–}

ç´¢å¼•ï¼š
Key:   channel_info_index:group_123:2
Value: 987654321ï¼ˆPrimaryKeyï¼‰

æŸ¥è¯¢æµç¨‹ï¼š
1. é€šè¿‡ç´¢å¼•è·å–PrimaryKey
2. é€šè¿‡PrimaryKeyè·å–å®Œæ•´ChannelInfo
```

---

### **D. é¢‘é“æ“ä½œ**

**æ–°å¢é¢‘é“**ï¼š
```go
// pkg/wkdb/channel.go:14-59
func (wk *wukongDB) AddChannel(channelInfo ChannelInfo) (uint64, error) {
    // 1. ç”Ÿæˆä¸»é”®
    primaryKey, err := wk.getChannelPrimaryKey(channelInfo.ChannelId, channelInfo.ChannelType)

    // 2. åˆ›å»ºBatch
    w := wk.channelDb(channelInfo.ChannelId, channelInfo.ChannelType).NewBatch()
    defer w.Close()

    // 3. å†™å…¥é¢‘é“ä¿¡æ¯
    if err := wk.writeChannelInfo(primaryKey, channelInfo, w); err != nil {
        return 0, err
    }

    // 4. æäº¤
    err = w.Commit(wk.sync)

    // 5. æ›´æ–°ç¼“å­˜
    channelInfo.Id = primaryKey
    wk.channelInfoCache.SetChannelInfo(channelInfo)

    return primaryKey, nil
}
```

---

**æ›´æ–°é¢‘é“**ï¼š
```go
// pkg/wkdb/channel.go:61-116
func (wk *wukongDB) UpdateChannel(channelInfo ChannelInfo) error {
    // 1. è·å–ä¸»é”®
    primaryKey, err := wk.getChannelPrimaryKey(channelInfo.ChannelId, channelInfo.ChannelType)

    // 2. è·å–æ—§æ•°æ®
    oldChannelInfo, err := wk.GetChannel(channelInfo.ChannelId, channelInfo.ChannelType)

    // 3. åˆ é™¤æ—§ç´¢å¼•
    if !IsEmptyChannelInfo(oldChannelInfo) {
        if err := wk.deleteChannelInfoBaseIndex(oldChannelInfo, w); err != nil {
            return err
        }
    }

    // 4. å†™å…¥æ–°æ•°æ®å’Œç´¢å¼•
    if err := wk.writeChannelInfo(primaryKey, newChannelInfo, w); err != nil {
        return err
    }

    // 5. æäº¤
    err = w.Commit(wk.sync)

    // 6. æ›´æ–°ç¼“å­˜
    wk.channelInfoCache.SetChannelInfo(newChannelInfo)

    return nil
}
```

---

## 3ï¸âƒ£ ä¼šè¯æ•°æ®æ¨¡å‹

### **A. Conversation ç»“æ„**

```go
// pkg/wkdb/model.go:322
type Conversation struct {
    Id            uint64     // ä¸»é”®ID
    Uid           string     // ç”¨æˆ·ID
    ChannelId     string     // é¢‘é“ID
    ChannelType   uint8      // é¢‘é“ç±»å‹

    // ä¼šè¯çŠ¶æ€
    Type          int        // ä¼šè¯ç±»å‹
    UnreadCount   int        // æœªè¯»æ•°

    // æ¶ˆæ¯ä¿¡æ¯
    LastMsgSeq      uint64   // æœ€åä¸€æ¡æ¶ˆæ¯åºå·
    LastClientMsgNo string   // æœ€åä¸€æ¡å®¢æˆ·ç«¯æ¶ˆæ¯å·
    LastMsgTime     int64    // æœ€åä¸€æ¡æ¶ˆæ¯æ—¶é—´

    // å·²è¯»ä½ç½®
    ReadToMsgSeq  uint64     // å·²è¯»åˆ°çš„æ¶ˆæ¯åºå·

    // æ—¶é—´æˆ³
    Timestamp     int64      // ä¼šè¯æ—¶é—´æˆ³ï¼ˆç”¨äºæ’åºï¼‰
    CreatedAt     *time.Time // åˆ›å»ºæ—¶é—´
    UpdatedAt     *time.Time // æ›´æ–°æ—¶é—´

    // ç‰ˆæœ¬æ§åˆ¶
    Version       uint64     // ç‰ˆæœ¬å·
}
```

---

### **B. ä¼šè¯åˆ—è¡¨å­˜å‚¨**

**å­˜å‚¨Keyè®¾è®¡**ï¼š
```
ä¼šè¯æ•°æ®Keyï¼š
conversation:{uid}:{primaryKey}

ä¼šè¯ç´¢å¼•Keyï¼ˆæŒ‰æ—¶é—´æ’åºï¼‰ï¼š
conversation_index:{uid}:{timestamp}:{channelId}:{channelType} â†’ primaryKey

ç¤ºä¾‹ï¼š
ç”¨æˆ·ï¼šuser001
é¢‘é“ï¼šgroup_123ï¼ˆç¾¤èŠï¼‰
æ—¶é—´æˆ³ï¼š1735977600
PrimaryKeyï¼š123456789

ä¸»æ•°æ®ï¼š
Key:   conversation:user001:123456789
Value: {Conversationå¯¹è±¡}

ç´¢å¼•ï¼š
Key:   conversation_index:user001:1735977600:group_123:2
Value: 123456789

æŸ¥è¯¢æœ€è¿‘ä¼šè¯ï¼š
StartKey: conversation_index:user001:999999999999:
EndKey:   conversation_index:user001:0:
åå‘è¿­ä»£ â†’ è·å–æœ€æ–°çš„ä¼šè¯
```

---

### **C. ä¼šè¯æ“ä½œ**

**æ–°å¢/æ›´æ–°ä¼šè¯**ï¼š
```go
// pkg/wkdb/conversation.go:14-77
func (wk *wukongDB) AddOrUpdateConversations(conversations []Conversation) error {
    userBatchMap := make(map[uint32]*Batch)

    for _, conversation := range conversations {
        // 1. æŒ‰ç”¨æˆ·åˆ†ç‰‡
        shardId := wk.shardId(conversation.Uid)
        batch := userBatchMap[shardId]
        if batch == nil {
            batch = wk.shardBatchDBById(shardId).NewBatch()
            userBatchMap[shardId] = batch
        }

        // 2. è·å–æ—§ä¼šè¯
        oldConversation, err := wk.GetConversation(conversation.Uid, conversation.ChannelId, conversation.ChannelType)

        // 3. å¦‚æœä¼šè¯å­˜åœ¨ï¼Œåˆ é™¤æ—§ç´¢å¼•
        if !IsEmptyConversation(oldConversation) {
            err = wk.deleteConversationIndex(oldConversation, batch)
            conversation.Id = oldConversation.Id
        }

        // 4. å†™å…¥æ–°ä¼šè¯
        if err := wk.writeConversation(conversation, batch); err != nil {
            return err
        }
    }

    // 5. æ‰¹é‡æäº¤
    err := Commits(batchs)

    // 6. æ™ºèƒ½æ›´æ–°ç¼“å­˜
    wk.conversationCache.UpdateConversationsInCache(conversations)

    return nil
}
```

---

### **D. ä¼šè¯æŸ¥è¯¢**

**æŸ¥è¯¢æœ€è¿‘ä¼šè¯åˆ—è¡¨**ï¼š
```go
func GetLastConversations(uid string, limit int) []Conversation {
    // 1. æ£€æŸ¥ç¼“å­˜
    cached, ok := wk.conversationCache.Get(uid)
    if ok {
        return cached[:limit]
    }

    // 2. ä»DBæŸ¥è¯¢
    startKey := fmt.Sprintf("conversation_index:%s:%d:", uid, math.MaxInt64)
    endKey   := fmt.Sprintf("conversation_index:%s:%d:", uid, 0)

    iter := db.NewIter(&pebble.IterOptions{
        LowerBound: []byte(endKey),
        UpperBound: []byte(startKey),
    })

    conversations := make([]Conversation, 0, limit)
    for iter.Last(); iter.Valid() && len(conversations) < limit; iter.Prev() {
        primaryKey := binary.BigEndian.Uint64(iter.Value())
        conv := wk.getConversationByPrimaryKey(uid, primaryKey)
        conversations = append(conversations, conv)
    }

    // 3. å†™å…¥ç¼“å­˜
    wk.conversationCache.Set(uid, conversations)

    return conversations
}
```

---

## 4ï¸âƒ£ è®¢é˜…å…³ç³»æ¨¡å‹

### **A. Subscriber ç»“æ„**

```go
type Subscriber struct {
    Id            uint64     // ä¸»é”®ID
    Uid           string     // è®¢é˜…è€…UID
    ChannelId     string     // é¢‘é“ID
    ChannelType   uint8      // é¢‘é“ç±»å‹

    CreatedAt     *time.Time // åˆ›å»ºæ—¶é—´
    UpdatedAt     *time.Time // æ›´æ–°æ—¶é—´
}
```

---

### **B. è®¢é˜…å…³ç³»å­˜å‚¨**

**å­˜å‚¨Keyè®¾è®¡**ï¼š
```
è®¢é˜…è€…åˆ—è¡¨ï¼š
subscriber:{channelId}:{channelType}:{uid}

ç¤ºä¾‹ï¼š
é¢‘é“ï¼šgroup_123ï¼ˆç¾¤èŠï¼‰
è®¢é˜…è€…ï¼šuser001, user002, user003

Keys:
- subscriber:group_123:2:user001 â†’ {Subscriberå¯¹è±¡}
- subscriber:group_123:2:user002 â†’ {Subscriberå¯¹è±¡}
- subscriber:group_123:2:user003 â†’ {Subscriberå¯¹è±¡}

æŸ¥è¯¢è®¢é˜…è€…ï¼š
StartKey: subscriber:group_123:2:
EndKey:   subscriber:group_123:2:~
èŒƒå›´æŸ¥è¯¢ â†’ è·å–æ‰€æœ‰è®¢é˜…è€…
```

---

### **C. é»‘ç™½åå•**

**é»‘åå•ï¼ˆDenylistï¼‰**ï¼š
```
é»‘åå•Keyï¼š
denylist:{channelId}:{channelType}:{uid}

ç¤ºä¾‹ï¼š
é¢‘é“ï¼šgroup_123
æ‹‰é»‘ç”¨æˆ·ï¼šuser999

Key: denylist:group_123:2:user999 â†’ {Denylistå¯¹è±¡}

æƒé™æ£€æŸ¥ï¼š
if db.Exists("denylist:group_123:2:user999") {
    return "ç”¨æˆ·å·²è¢«æ‹‰é»‘ï¼Œæ— æ³•å‘é€æ¶ˆæ¯"
}
```

---

**ç™½åå•ï¼ˆAllowlistï¼‰**ï¼š
```
ç™½åå•Keyï¼š
allowlist:{channelId}:{channelType}:{uid}

ç¤ºä¾‹ï¼š
é¢‘é“ï¼šgroup_123ï¼ˆä»…ç™½åå•å¯å‘è¨€ï¼‰
ç™½åå•ç”¨æˆ·ï¼šuser001, user002

Keys:
- allowlist:group_123:2:user001
- allowlist:group_123:2:user002

æƒé™æ£€æŸ¥ï¼š
if channel.OnlyAllowlistSend {
    if !db.Exists("allowlist:group_123:2:user001") {
        return "ä¸åœ¨ç™½åå•ï¼Œæ— æ³•å‘é€æ¶ˆæ¯"
    }
}
```

---

## 5ï¸âƒ£ è®¾å¤‡ä¸ç”¨æˆ·æ¨¡å‹

### **A. Device ç»“æ„**

```go
// pkg/wkdb/model.go:109-122
type Device struct {
    Id           uint64     // ä¸»é”®ID
    Uid          string     // ç”¨æˆ·UID
    Token        string     // è®¾å¤‡Token
    DeviceFlag   uint64     // è®¾å¤‡æ ‡è®°
    DeviceLevel  uint8      // è®¾å¤‡ç­‰çº§

    // è¿æ¥ç»Ÿè®¡
    ConnCount    uint32     // è¿æ¥æ•°é‡
    SendMsgCount uint64     // å‘é€æ¶ˆæ¯æ•°é‡
    RecvMsgCount uint64     // æ¥æ”¶æ¶ˆæ¯æ•°é‡
    SendMsgBytes uint64     // å‘é€å­—èŠ‚æ•°
    RecvMsgBytes uint64     // æ¥æ”¶å­—èŠ‚æ•°

    CreatedAt    *time.Time // åˆ›å»ºæ—¶é—´
    UpdatedAt    *time.Time // æ›´æ–°æ—¶é—´
}
```

**è®¾å¤‡æ ‡è¯†ï¼ˆDeviceFlagï¼‰**ï¼š
```
è®¾å¤‡æ ‡è¯†ç”¨äºåŒºåˆ†åŒä¸€ç”¨æˆ·çš„å¤šä¸ªè®¾å¤‡ï¼š
â”œâ”€ Webç«¯ï¼š   DeviceFlag = 1
â”œâ”€ iOSç«¯ï¼š   DeviceFlag = 2
â”œâ”€ Androidç«¯ï¼šDeviceFlag = 3
â”œâ”€ PCç«¯ï¼š    DeviceFlag = 4
â””â”€ ...

å¤šè®¾å¤‡åœ¨çº¿ï¼š
ç”¨æˆ·user001åŒæ—¶ç™»å½•3ä¸ªè®¾å¤‡
â†’ Devices: [
    {Uid: "user001", DeviceFlag: 1, ...},  // Web
    {Uid: "user001", DeviceFlag: 2, ...},  // iOS
    {Uid: "user001", DeviceFlag: 3, ...},  // Android
]
```

---

### **B. User ç»“æ„**

```go
// pkg/wkdb/model.go:130-143
type User struct {
    Id                uint64     // ä¸»é”®ID
    Uid               string     // ç”¨æˆ·UID

    // è®¾å¤‡ç»Ÿè®¡
    DeviceCount       uint32     // è®¾å¤‡æ€»æ•°
    OnlineDeviceCount uint32     // åœ¨çº¿è®¾å¤‡æ•°
    ConnCount         uint32     // è¿æ¥æ€»æ•°

    // æ¶ˆæ¯ç»Ÿè®¡
    SendMsgCount      uint64     // å‘é€æ¶ˆæ¯æ•°
    RecvMsgCount      uint64     // æ¥æ”¶æ¶ˆæ¯æ•°
    SendMsgBytes      uint64     // å‘é€å­—èŠ‚æ•°
    RecvMsgBytes      uint64     // æ¥æ”¶å­—èŠ‚æ•°

    // æ‰©å±•
    PluginNo          string     // æ’ä»¶ç¼–å·
    CreatedAt         *time.Time // åˆ›å»ºæ—¶é—´
    UpdatedAt         *time.Time // æ›´æ–°æ—¶é—´
}
```

---

### **C. è®¾å¤‡å­˜å‚¨**

**å­˜å‚¨Keyè®¾è®¡**ï¼š
```
è®¾å¤‡åˆ—è¡¨ï¼š
device:{uid}:{deviceFlag} â†’ {Deviceå¯¹è±¡}

ç¤ºä¾‹ï¼š
ç”¨æˆ·ï¼šuser001
è®¾å¤‡ï¼šiOSï¼ˆDeviceFlag=2ï¼‰

Key:   device:user001:2
Value: {Deviceå¯¹è±¡}

æŸ¥è¯¢ç”¨æˆ·æ‰€æœ‰è®¾å¤‡ï¼š
StartKey: device:user001:
EndKey:   device:user001:~
èŒƒå›´æŸ¥è¯¢ â†’ è·å–æ‰€æœ‰è®¾å¤‡
```

---

## 6ï¸âƒ£ æ•°æ®å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°æ®å…³ç³»å›¾                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

            [User]
              â”‚
              â”‚ 1:N
              â†“
          [Device]  â† ç”¨æˆ·çš„å¤šä¸ªè®¾å¤‡
              â”‚
              â”‚ N:M
              â†“
        [Conversation]  â† ç”¨æˆ·çš„ä¼šè¯åˆ—è¡¨
              â”‚
              â”‚ N:1
              â†“
         [Channel]  â† é¢‘é“ä¿¡æ¯
              â”‚
              â”œâ”€ 1:N â†’ [Message]      â† é¢‘é“çš„æ¶ˆæ¯
              â”œâ”€ 1:N â†’ [Subscriber]   â† é¢‘é“çš„è®¢é˜…è€…
              â”œâ”€ 1:N â†’ [Denylist]     â† é¢‘é“çš„é»‘åå•
              â””â”€ 1:N â†’ [Allowlist]    â† é¢‘é“çš„ç™½åå•

ç¤ºä¾‹ï¼š
ç”¨æˆ·user001ï¼š
â”œâ”€ è®¾å¤‡ï¼š[Web, iOS, Android]
â”œâ”€ ä¼šè¯ï¼š[
â”‚    {é¢‘é“: group_123, æœªè¯»: 5},
â”‚    {é¢‘é“: user002, æœªè¯»: 2},
â”‚  ]
â””â”€ ...

é¢‘é“group_123ï¼š
â”œâ”€ æ¶ˆæ¯ï¼š[msg1, msg2, msg3, ...]
â”œâ”€ è®¢é˜…è€…ï¼š[user001, user002, user003, ...]
â”œâ”€ é»‘åå•ï¼š[user999]
â””â”€ ç™½åå•ï¼š[user001, user002]
```

---

## 7ï¸âƒ£ æ€»ç»“

### **æ ¸å¿ƒè¦ç‚¹**

1. **æ¶ˆæ¯æ¨¡å‹ï¼ˆMessageï¼‰**ï¼š
   - ç»§æ‰¿RecvPacketï¼ŒåŒ…å«å®Œæ•´æ¶ˆæ¯ä¿¡æ¯
   - é›ªèŠ±ç®—æ³•ç”Ÿæˆå…¨å±€å”¯ä¸€MessageID
   - æŒ‰é¢‘é“+åºå·å­˜å‚¨ï¼Œæ”¯æŒé«˜æ•ˆèŒƒå›´æŸ¥è¯¢
   - åºåˆ—åŒ–æ”¯æŒç‰ˆæœ¬å…¼å®¹

2. **é¢‘é“æ¨¡å‹ï¼ˆChannelInfoï¼‰**ï¼š
   - æ”¯æŒ5ç§é¢‘é“ç±»å‹ï¼ˆä¸ªäººã€ç¾¤èŠã€ç¤¾åŒºã€å®¢æœã€ç³»ç»Ÿï¼‰
   - ä¸»é”®+ç´¢å¼•åŒå­˜å‚¨ï¼ŒæŸ¥è¯¢é«˜æ•ˆ
   - ç‰ˆæœ¬æ§åˆ¶ï¼Œæ”¯æŒç¼“å­˜å¤±æ•ˆ
   - è®°å½•è®¢é˜…è€…æ•°ã€é»‘ç™½åå•æ•°

3. **ä¼šè¯æ¨¡å‹ï¼ˆConversationï¼‰**ï¼š
   - ç”¨æˆ·ç»´åº¦çš„ä¼šè¯åˆ—è¡¨
   - æŒ‰æ—¶é—´æˆ³æ’åºï¼ŒæŸ¥è¯¢æœ€è¿‘ä¼šè¯å¿«
   - è®°å½•æœªè¯»æ•°ã€å·²è¯»ä½ç½®
   - æ™ºèƒ½ç¼“å­˜æ›´æ–°

4. **è®¢é˜…å…³ç³»ï¼ˆSubscriberï¼‰**ï¼š
   - é¢‘é“-ç”¨æˆ·å¤šå¯¹å¤šå…³ç³»
   - é»‘åå•æ§åˆ¶ï¼ˆç¦æ­¢å‘è¨€ï¼‰
   - ç™½åå•æ§åˆ¶ï¼ˆä»…å…è®¸å‘è¨€ï¼‰
   - èŒƒå›´æŸ¥è¯¢è·å–æ‰€æœ‰è®¢é˜…è€…

5. **è®¾å¤‡ä¸ç”¨æˆ·ï¼ˆDevice/Userï¼‰**ï¼š
   - å¤šè®¾å¤‡åœ¨çº¿æ”¯æŒï¼ˆDeviceFlagåŒºåˆ†ï¼‰
   - ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ¶ˆæ¯æ•°ã€å­—èŠ‚æ•°ï¼‰
   - è®¾å¤‡çº§åˆ«æ§åˆ¶

---

### **ä¸‹ä¸€èŠ‚é¢„å‘Š**

**7.4 ç´¢å¼•è®¾è®¡**
- æ¶ˆæ¯IDç´¢å¼•ï¼ˆå…¨å±€å”¯ä¸€æŸ¥è¯¢ï¼‰
- é¢‘é“æ¶ˆæ¯ç´¢å¼•ï¼ˆèŒƒå›´æŸ¥è¯¢ï¼‰
- ç”¨æˆ·ä¼šè¯ç´¢å¼•ï¼ˆæ—¶é—´æ’åºï¼‰
- æ—¶é—´åºåˆ—ä¼˜åŒ–

---

> **ğŸ”— ç›¸å…³ä»£ç **ï¼š
> - Messageæ¨¡å‹ï¼š`pkg/wkdb/model.go:22-101`
> - ChannelInfoæ¨¡å‹ï¼š`pkg/wkdb/model.go:147-174`
> - Conversationæ¨¡å‹ï¼š`pkg/wkdb/model.go:322`
> - Deviceæ¨¡å‹ï¼š`pkg/wkdb/model.go:109-122`
> - é¢‘é“æ“ä½œï¼š`pkg/wkdb/channel.go:14-116`
> - ä¼šè¯æ“ä½œï¼š`pkg/wkdb/conversation.go:14-77`
