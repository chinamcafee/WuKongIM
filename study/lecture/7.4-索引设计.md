# 7.4 ç´¢å¼•è®¾è®¡

> **æœ¬èŠ‚ç›®æ ‡**ï¼šæ·±å…¥ç†è§£WuKongDBçš„ç´¢å¼•ä½“ç³»è®¾è®¡ï¼ŒæŒæ¡æ¶ˆæ¯IDç´¢å¼•ã€é¢‘é“æ¶ˆæ¯ç´¢å¼•ã€ç”¨æˆ·ä¼šè¯ç´¢å¼•ä»¥åŠæ—¶é—´åºåˆ—ä¼˜åŒ–çš„æ ¸å¿ƒæŠ€æœ¯

---

## ğŸ“‹ ç›®å½•
1. [ç´¢å¼•ä½“ç³»æ¦‚è§ˆ](#ç´¢å¼•ä½“ç³»æ¦‚è§ˆ)
2. [æ¶ˆæ¯IDç´¢å¼•](#æ¶ˆæ¯idç´¢å¼•)
3. [é¢‘é“æ¶ˆæ¯ç´¢å¼•](#é¢‘é“æ¶ˆæ¯ç´¢å¼•)
4. [ç”¨æˆ·ä¼šè¯ç´¢å¼•](#ç”¨æˆ·ä¼šè¯ç´¢å¼•)
5. [æ—¶é—´åºåˆ—ä¼˜åŒ–](#æ—¶é—´åºåˆ—ä¼˜åŒ–)
6. [ç´¢å¼•æ€§èƒ½åˆ†æ](#ç´¢å¼•æ€§èƒ½åˆ†æ)

---

## 1ï¸âƒ£ ç´¢å¼•ä½“ç³»æ¦‚è§ˆ

### **A. ç´¢å¼•ç±»å‹**

**WuKongDBç´¢å¼•åˆ†ç±»**ï¼š
```
ç´¢å¼•ç±»å‹ï¼š
â”œâ”€ ä¸»é”®ç´¢å¼•ï¼ˆPrimary Keyï¼‰
â”‚  â””â”€ å”¯ä¸€æ ‡è¯†ï¼Œç›´æ¥å®šä½æ•°æ®
â”‚
â”œâ”€ å”¯ä¸€ç´¢å¼•ï¼ˆUnique Indexï¼‰
â”‚  â””â”€ å­—æ®µå”¯ä¸€ï¼Œè¿”å›PrimaryKey
â”‚
â”œâ”€ äºŒçº§ç´¢å¼•ï¼ˆSecondary Indexï¼‰
â”‚  â””â”€ éå”¯ä¸€ï¼Œæ”¯æŒèŒƒå›´æŸ¥è¯¢
â”‚
â””â”€ ç»„åˆç´¢å¼•ï¼ˆComposite Indexï¼‰
   â””â”€ å¤šå­—æ®µç»„åˆï¼Œæ”¯æŒå¤æ‚æŸ¥è¯¢
```

---

### **B. Keyè®¾è®¡åŸåˆ™**

**è¡¨ç»“æ„ï¼ˆé€šç”¨æ ¼å¼ï¼‰**ï¼š
```
// pkg/wkdb/key/table.go:3-7
Keyç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TableID â”‚ DataType â”‚ PrimaryKey â”‚ ColumnKey     â”‚
â”‚ 2 byte  â”‚ 1 byte   â”‚ 8 byte     â”‚ 2 byte        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

DataTypeç±»å‹ï¼š
â”œâ”€ 0x01: è¡¨æ•°æ®ï¼ˆTableï¼‰
â”œâ”€ 0x02: å”¯ä¸€ç´¢å¼•ï¼ˆIndexï¼‰
â”œâ”€ 0x03: äºŒçº§ç´¢å¼•ï¼ˆSecondIndexï¼‰
â””â”€ 0x04: å…¶ä»–æ•°æ®ï¼ˆOtherï¼‰
```

**è®¾è®¡åŸåˆ™**ï¼š
```
1ï¸âƒ£ å‰ç¼€ä¸€è‡´ï¼šåŒç±»æ•°æ®Keyå‰ç¼€ç›¸åŒï¼Œæ”¯æŒèŒƒå›´æŸ¥è¯¢
2ï¸âƒ£ æœ‰åºå­˜å‚¨ï¼šKeyæŒ‰å­—å…¸åºæ’åºï¼ŒLSM-Treeå‹å¥½
3ï¸âƒ£ å›ºå®šé•¿åº¦ï¼šæ ¸å¿ƒå­—æ®µå›ºå®šé•¿åº¦ï¼ŒæŸ¥è¯¢é«˜æ•ˆ
4ï¸âƒ£ å“ˆå¸Œä¼˜åŒ–ï¼šé•¿å­—ç¬¦ä¸²ç”¨Hashï¼Œå‡å°‘Keyé•¿åº¦
```

---

## 2ï¸âƒ£ æ¶ˆæ¯ ID ç´¢å¼•

### **A. ç´¢å¼•ç»“æ„**

**æ¶ˆæ¯è¡¨ç»“æ„**ï¼š
```go
// pkg/wkdb/key/table.go:17-22
æ¶ˆæ¯Keyæ ¼å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TableID â”‚ DataType â”‚ ChannelHash â”‚ MessageSeq â”‚ ColumnKeyâ”‚
â”‚ 2 byte  â”‚ 1 byte   â”‚ 8 byte      â”‚ 8 byte     â”‚ 2 byte   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¤ºä¾‹ï¼š
TableMessage.Id    = [0x01, 0x01]  // æ¶ˆæ¯è¡¨ID
dataTypeTable      = 0x01          // è¡¨æ•°æ®
ChannelHash        = Hash("channel_001:2")  // é¢‘é“å“ˆå¸Œ
MessageSeq         = 100                     // æ¶ˆæ¯åºå·
ColumnKey          = [0x01, 0x04]           // MessageIdå­—æ®µ
```

---

### **B. MessageID å”¯ä¸€ç´¢å¼•**

**ç´¢å¼•Keyè®¾è®¡**ï¼š
```go
// pkg/wkdb/key/table.go:44-46
MessageIDç´¢å¼•ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TableID â”‚ DataType â”‚ IndexName â”‚ MsgIdHashâ”‚
â”‚ 2 byte  â”‚ 1 byte   â”‚ 2 byte    â”‚ 8 byte   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

IndexSize = 2 + 1 + 2 + 8 = 13 bytes

ç¤ºä¾‹ï¼š
TableID     = [0x01, 0x01]         // æ¶ˆæ¯è¡¨
DataType    = 0x02                 // å”¯ä¸€ç´¢å¼•
IndexName   = [0x01, 0x01]         // MessageIdç´¢å¼•
MsgIdHash   = Hash(MessageId)      // æ¶ˆæ¯IDå“ˆå¸Œ

Key:   [0x01, 0x01, 0x02, 0x01, 0x01, <8å­—èŠ‚Hash>]
Value: PrimaryKeyï¼ˆ8å­—èŠ‚ï¼‰
```

---

### **C. æŸ¥è¯¢æµç¨‹**

**é€šè¿‡MessageIDæŸ¥è¯¢æ¶ˆæ¯**ï¼š
```go
func GetMessageByMessageID(messageId int64) (Message, error) {
    // 1. æ„é€ ç´¢å¼•Key
    msgIdHash := Hash(messageId)
    indexKey := NewMessageIndexKey(TableMessage.Index.MessageId, msgIdHash)

    // 2. æŸ¥è¯¢ç´¢å¼•ï¼Œè·å–PrimaryKey
    primaryKeyBytes, err := db.Get(indexKey)
    if err != nil {
        return nil, err
    }
    primaryKey := binary.BigEndian.Uint64(primaryKeyBytes)

    // 3. æ„é€ æ•°æ®Key
    channelHash, messageSeq := parsePrimaryKey(primaryKey)
    dataKey := NewMessageTableKey(channelHash, messageSeq, TableMessage.Column.Payload)

    // 4. æŸ¥è¯¢æ•°æ®
    data, err := db.Get(dataKey)
    if err != nil {
        return nil, err
    }

    // 5. ååºåˆ—åŒ–
    var msg Message
    msg.Unmarshal(data)
    return msg, nil
}

æŸ¥è¯¢å¤æ‚åº¦ï¼š
- ç´¢å¼•æŸ¥è¯¢ï¼šO(1)ï¼ˆHashå®šä½ï¼‰
- æ•°æ®æŸ¥è¯¢ï¼šO(1)ï¼ˆPrimaryKeyç›´æ¥å®šä½ï¼‰
- æ€»å¤æ‚åº¦ï¼šO(1) âœ…
```

---

### **D. äºŒçº§ç´¢å¼•**

**ClientMsgNoç´¢å¼•ï¼ˆå®¢æˆ·ç«¯æ¶ˆæ¯å·ï¼‰**ï¼š
```go
// pkg/wkdb/key/table.go:47-52
ClientMsgNoç´¢å¼•ï¼ˆç”¨äºå»é‡ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TableID â”‚ DataType â”‚ IndexName â”‚ ClientMsgNoHash â”‚ PrimaryKey â”‚
â”‚ 2 byte  â”‚ 1 byte   â”‚ 2 byte    â”‚ 8 byte          â”‚ 8 byte     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SecondIndexSize = 2 + 1 + 2 + 8 + 8 = 21 bytes

ä¸ºä»€ä¹ˆéœ€è¦PrimaryKeyï¼Ÿ
- ClientMsgNoå¯èƒ½é‡å¤ï¼ˆä¸åŒé¢‘é“ï¼‰
- PrimaryKeyä¿è¯å”¯ä¸€æ€§
- æ”¯æŒèŒƒå›´æŸ¥è¯¢

ç¤ºä¾‹ï¼š
å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼šClientMsgNo="client_msg_123"

ç´¢å¼•Keyï¼š
[0x01, 0x01, 0x03, 0x01, 0x06, Hash("client_msg_123"), PrimaryKey]

æŸ¥è¯¢ï¼šæ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å­˜åœ¨ï¼ˆå»é‡ï¼‰
db.Get(indexKey) â†’ å­˜åœ¨ â†’ è¿”å›"æ¶ˆæ¯å·²å‘é€"
```

---

**Timestampç´¢å¼•ï¼ˆæ—¶é—´æˆ³ï¼‰**ï¼š
```go
Timestampç´¢å¼•ï¼ˆæŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TableID â”‚ DataType â”‚ IndexName â”‚ Timestamp â”‚ PrimaryKey       â”‚
â”‚ 2 byte  â”‚ 1 byte   â”‚ 2 byte    â”‚ 8 byte    â”‚ 8 byte           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¤ºä¾‹ï¼š
æŸ¥è¯¢æŸé¢‘é“æ˜¨å¤©çš„æ‰€æœ‰æ¶ˆæ¯

startTime = æ˜¨å¤©00:00:00 â†’ 1735891200
endTime   = æ˜¨å¤©23:59:59 â†’ 1735977599

startKey = [TableID, 0x03, TimestampIndex, 1735891200, 0]
endKey   = [TableID, 0x03, TimestampIndex, 1735977599, MaxUint64]

iter := db.NewIter(&pebble.IterOptions{
    LowerBound: startKey,
    UpperBound: endKey,
})

for iter.First(); iter.Valid(); iter.Next() {
    _, primaryKey := parseSecondIndexKey(iter.Key())
    msg := getMessageByPrimaryKey(primaryKey)
    messages = append(messages, msg)
}

å¤æ‚åº¦ï¼šO(n)ï¼ˆnä¸ºæ—¶é—´èŒƒå›´å†…çš„æ¶ˆæ¯æ•°ï¼‰
```

---

## 3ï¸âƒ£ é¢‘é“æ¶ˆæ¯ç´¢å¼•

### **A. é¢‘é“æ¶ˆæ¯Keyè®¾è®¡**

**ä¸»æ•°æ®Key**ï¼š
```
é¢‘é“æ¶ˆæ¯Keyï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TableID â”‚ DataType â”‚ ChannelHash â”‚ MessageSeq â”‚ ColumnKeyâ”‚
â”‚ 2 byte  â”‚ 1 byte   â”‚ 8 byte      â”‚ 8 byte     â”‚ 2 byte   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ChannelHashè®¡ç®—ï¼š
channelKey := fmt.Sprintf("%s:%d", channelId, channelType)
channelHash := fnv.New64a()
channelHash.Write([]byte(channelKey))
hash := channelHash.Sum64()

ç¤ºä¾‹ï¼š
é¢‘é“ï¼šchannel_001ï¼ˆç¾¤èŠï¼‰
ChannelKey: "channel_001:2"
ChannelHash: 0x1234567890ABCDEF

æ¶ˆæ¯åºå·ï¼š100

Key: [0x01, 0x01, 0x01, 0x12, 0x34, 0x56, 0x78, 0x90, 0xAB, 0xCD, 0xEF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x64, 0x01, 0x04]
```

---

### **B. èŒƒå›´æŸ¥è¯¢ä¼˜åŒ–**

**æŸ¥è¯¢æœ€æ–°Næ¡æ¶ˆæ¯**ï¼š
```go
func GetLastMessages(channelId string, channelType uint8, limit int) []Message {
    // 1. è®¡ç®—ChannelHash
    channelHash := calcChannelHash(channelId, channelType)

    // 2. æ„é€ èŒƒå›´Key
    startSeq := uint64(math.MaxUint64)  // æœ€å¤§å€¼
    endSeq   := uint64(0)                // æœ€å°å€¼

    startKey := NewMessageTableKey(channelHash, startSeq, TableMessage.Column.Payload)
    endKey   := NewMessageTableKey(channelHash, endSeq, TableMessage.Column.Payload)

    // 3. åå‘è¿­ä»£ï¼ˆä»æ–°åˆ°æ—§ï¼‰
    iter := db.NewIter(&pebble.IterOptions{
        LowerBound: endKey,
        UpperBound: startKey,
    })

    messages := make([]Message, 0, limit)
    for iter.Last(); iter.Valid() && len(messages) < limit; iter.Prev() {
        var msg Message
        msg.Unmarshal(iter.Value())
        messages = append(messages, msg)
    }

    return messages
}

æ€§èƒ½åˆ†æï¼š
- è¿­ä»£å™¨å®šä½ï¼šO(log n)ï¼ˆLSM-TreeæŸ¥æ‰¾ï¼‰
- è¿­ä»£Næ¡ï¼šO(N)
- æ€»å¤æ‚åº¦ï¼šO(log n + N)
- å®é™…å»¶è¿Ÿï¼š<5msï¼ˆçƒ­æ•°æ®åœ¨MemTableï¼‰
```

---

### **C. Bloom Filter åŠ é€Ÿ**

**Bloom FilteråŸç†**ï¼š
```
Bloom Filterï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ï¼‰ï¼š
- ä½œç”¨ï¼šå¿«é€Ÿåˆ¤æ–­Keyæ˜¯å¦å­˜åœ¨
- ç‰¹ç‚¹ï¼šå¯èƒ½è¯¯åˆ¤"å­˜åœ¨"ï¼Œä½†ç»ä¸è¯¯åˆ¤"ä¸å­˜åœ¨"
- å­˜å‚¨ï¼šä½å›¾ï¼ˆBitmapï¼‰

ç¤ºä¾‹ï¼š
æŸ¥è¯¢æ¶ˆæ¯ï¼šchannel_001:2:msg:999999

1. æ£€æŸ¥Bloom Filter
   if !bloomFilter.MayContain(key) {
       return ErrNotFound  // å¿«é€Ÿè¿”å›ï¼ˆ99%å‡†ç¡®ï¼‰
   }

2. æŸ¥è¯¢SSTæ–‡ä»¶
   data, err := sst.Get(key)

æ€§èƒ½æå‡ï¼š
- é¿å…æ— æ•ˆçš„ç£ç›˜I/O
- å‡å°‘90%+çš„æŸ¥è¯¢å»¶è¿Ÿ
```

**PebbleDBçš„Bloom Filteré…ç½®**ï¼š
```go
opts := &pebble.Options{
    Levels: []pebble.LevelOptions{
        {
            FilterPolicy: bloom.FilterPolicy(10),  // 10ä½/Key
            // è¯¯åˆ¤ç‡ï¼š(1/2)^10 â‰ˆ 0.1%
        },
    },
}
```

---

## 4ï¸âƒ£ ç”¨æˆ·ä¼šè¯ç´¢å¼•

### **A. ä¼šè¯ç´¢å¼•ç»“æ„**

**ä¼šè¯æ•°æ®Key**ï¼š
```
ä¼šè¯Keyï¼š
conversation:{uid}:{primaryKey}

ä¼šè¯ç´¢å¼•Keyï¼ˆæŒ‰æ—¶é—´æ’åºï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TableID â”‚ DataType â”‚ UidHash â”‚ Timestamp â”‚ ChannelHash â”‚ PrimaryKeyâ”‚
â”‚ 2 byte  â”‚ 1 byte   â”‚ 8 byte  â”‚ 8 byte    â”‚ 8 byte      â”‚ 8 byte    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¸ºä»€ä¹ˆåŒ…å«ChannelHashï¼Ÿ
- åŒä¸€ç”¨æˆ·å¯èƒ½åŒæ—¶æ›´æ–°å¤šä¸ªä¼šè¯ï¼ˆåŒä¸€æ—¶é—´æˆ³ï¼‰
- ChannelHashä¿è¯å”¯ä¸€æ€§

ç¤ºä¾‹ï¼š
ç”¨æˆ·ï¼šuser001
æ—¶é—´æˆ³ï¼š1735977600ï¼ˆ2025-01-04 12:00:00ï¼‰
é¢‘é“ï¼šgroup_123ï¼ˆç¾¤èŠï¼‰

UidHash     = Hash("user001")     = 0xAABBCCDDEEFF0011
Timestamp   = 1735977600           = 0x00000000677A1E80
ChannelHash = Hash("group_123:2") = 0x1122334455667788
PrimaryKey  = 987654321            = 0x000000003ADE68B1

ç´¢å¼•Keyï¼š
[TableID, 0x03, 0xAA, 0xBB, 0xCC, 0xDD, 0xEE, 0xFF, 0x00, 0x11,
 0x00, 0x00, 0x00, 0x00, 0x67, 0x7A, 0x1E, 0x80,
 0x11, 0x22, 0x33, 0x44, 0x55, 0x66, 0x77, 0x88,
 0x00, 0x00, 0x00, 0x00, 0x3A, 0xDE, 0x68, 0xB1]
```

---

### **B. ä¼šè¯åˆ—è¡¨æŸ¥è¯¢**

**æŸ¥è¯¢æœ€è¿‘ä¼šè¯**ï¼š
```go
func GetLastConversations(uid string, limit int) []Conversation {
    // 1. æ„é€ èŒƒå›´Key
    uidHash := Hash(uid)
    startTime := uint64(math.MaxUint64)  // æœ€æ–°æ—¶é—´
    endTime   := uint64(0)                // æœ€æ—©æ—¶é—´

    startKey := NewConversationIndexKey(uidHash, startTime, 0, 0)
    endKey   := NewConversationIndexKey(uidHash, endTime, 0, 0)

    // 2. åå‘è¿­ä»£
    iter := db.NewIter(&pebble.IterOptions{
        LowerBound: endKey,
        UpperBound: startKey,
    })

    conversations := make([]Conversation, 0, limit)
    for iter.Last(); iter.Valid() && len(conversations) < limit; iter.Prev() {
        // è§£æç´¢å¼•Key
        _, _, _, primaryKey := parseConversationIndexKey(iter.Key())

        // è·å–ä¼šè¯æ•°æ®
        conv := getConversationByPrimaryKey(uid, primaryKey)
        conversations = append(conversations, conv)
    }

    return conversations
}

æ€§èƒ½ï¼š
- å®šä½ï¼šO(log n)
- è¿­ä»£ï¼šO(limit)
- æ€»è®¡ï¼šO(log n + limit)
- å»¶è¿Ÿï¼š<3msï¼ˆçƒ­æ•°æ®ï¼‰
```

---

### **C. ä¼šè¯æ›´æ–°ä¼˜åŒ–**

**æ™ºèƒ½ç¼“å­˜æ›´æ–°**ï¼š
```go
// pkg/wkdb/conversation.go:73
func (wk *wukongDB) AddOrUpdateConversations(conversations []Conversation) error {
    // 1. æ‰¹é‡å†™å…¥DB
    err := Commits(batchs)

    // 2. æ™ºèƒ½æ›´æ–°ç¼“å­˜
    wk.conversationCache.UpdateConversationsInCache(conversations)

    return nil
}

// æ™ºèƒ½æ›´æ–°ç­–ç•¥
func (cc *ConversationCache) UpdateConversationsInCache(newConvs []Conversation) {
    for _, newConv := range newConvs {
        cached, ok := cc.cache.Get(newConv.Uid)
        if !ok {
            continue  // ç¼“å­˜æœªå‘½ä¸­ï¼Œè·³è¿‡
        }

        // æŸ¥æ‰¾å¹¶æ›´æ–°
        for i, oldConv := range cached {
            if oldConv.ChannelId == newConv.ChannelId &&
               oldConv.ChannelType == newConv.ChannelType {
                cached[i] = newConv  // æ›´æ–°
                break
            }
        }

        // é‡æ–°æ’åºï¼ˆæŒ‰æ—¶é—´æˆ³ï¼‰
        sort.Slice(cached, func(i, j int) bool {
            return cached[i].Timestamp > cached[j].Timestamp
        })

        // æ›´æ–°ç¼“å­˜
        cc.cache.Set(newConv.Uid, cached)
    }
}

ä¼˜åŠ¿ï¼š
âœ… åªæ›´æ–°å˜åŒ–çš„ä¼šè¯
âœ… é¿å…å…¨é‡åˆ·æ–°ç¼“å­˜
âœ… å‡å°‘DBæŸ¥è¯¢
```

---

## 5ï¸âƒ£ æ—¶é—´åºåˆ—ä¼˜åŒ–

### **A. æ—¶é—´å€’åºå­˜å‚¨**

**ä¸ºä»€ä¹ˆå€’åºï¼Ÿ**
```
IMåœºæ™¯ç‰¹ç‚¹ï¼š
- ç”¨æˆ·ä¸»è¦æŸ¥è¯¢æœ€æ–°æ¶ˆæ¯
- å†å²æ¶ˆæ¯è®¿é—®å°‘

ä¼ ç»Ÿæ­£åºå­˜å‚¨ï¼š
MessageSeq: 1, 2, 3, ..., 10000
æŸ¥è¯¢æœ€æ–°100æ¡ï¼šä»10000å€’åºæ‰«æ â†’ æ…¢

å€’åºå­˜å‚¨ï¼ˆWuKongDBï¼‰ï¼š
ä½¿ç”¨ (MaxUint64 - Timestamp) ä½œä¸ºKeyçš„ä¸€éƒ¨åˆ†

ç¤ºä¾‹ï¼š
Timestamp = 1735977600
Keyä¸­çš„æ—¶é—´æˆ³ = MaxUint64 - 1735977600 = 18446744071973574015

æ•ˆæœï¼š
- æœ€æ–°çš„æ¶ˆæ¯Keyæœ€å°
- èŒƒå›´æŸ¥è¯¢ä»å‰å¾€åæ‰«æ â†’ å¿« âœ…
```

---

### **B. åˆ†åŒºå‹ç¼©**

**æŒ‰æ—¶é—´åˆ†åŒº**ï¼š
```
å†å²æ¶ˆæ¯å‹ç¼©ç­–ç•¥ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœ€è¿‘1å¤©ï¼šæ— å‹ç¼©ï¼ˆçƒ­æ•°æ®ï¼ŒæŸ¥è¯¢é¢‘ç¹ï¼‰      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1-7å¤©ï¼š  Snappyå‹ç¼©ï¼ˆæ¸©æ•°æ®ï¼‰            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 7-30å¤©ï¼š Zstdå‹ç¼©ï¼ˆå†·æ•°æ®ï¼‰              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ >30å¤©ï¼š  é«˜å‹ç¼©æ¯”Zstdï¼ˆå½’æ¡£æ•°æ®ï¼‰        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PebbleDBé…ç½®ï¼š
opts := &pebble.Options{
    Levels: []pebble.LevelOptions{
        {Compression: pebble.NoCompression},       // L0-L1ï¼šä¸å‹ç¼©
        {Compression: pebble.SnappyCompression},  // L2-L3ï¼šSnappy
        {Compression: pebble.ZstdCompression},    // L4+ï¼šZstd
    },
}

æ•ˆæœï¼š
- çƒ­æ•°æ®å¿«é€Ÿè®¿é—®ï¼ˆæ— è§£å‹å¼€é”€ï¼‰
- å†·æ•°æ®é«˜å‹ç¼©æ¯”ï¼ˆèŠ‚çœå­˜å‚¨ï¼‰
- å‹ç¼©æ¯”ï¼š2-3å€
```

---

### **C. TTLè¿‡æœŸåˆ é™¤**

**æ¶ˆæ¯è¿‡æœŸæœºåˆ¶**ï¼š
```go
type Message struct {
    Expire uint32  // è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
    ...
}

è¿‡æœŸåˆ é™¤æµç¨‹ï¼š
1ï¸âƒ£ å†™å…¥æ¶ˆæ¯æ—¶è®°å½•Expire
2ï¸âƒ£ åå°Compactionæ—¶æ£€æŸ¥è¿‡æœŸ
3ï¸âƒ£ åˆ é™¤è¿‡æœŸæ¶ˆæ¯

Compaction Filterï¼ˆPebbleDBï¼‰ï¼š
filter := func(key, value []byte) (bool, error) {
    msg := unmarshalMessage(value)

    if msg.Expire > 0 {
        expireTime := msg.Timestamp + msg.Expire
        if time.Now().Unix() > expireTime {
            return true, nil  // åˆ é™¤
        }
    }

    return false, nil  // ä¿ç•™
}

ä¼˜åŠ¿ï¼š
âœ… è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®
âœ… èŠ‚çœå­˜å‚¨ç©ºé—´
âœ… æ— éœ€å®šæ—¶ä»»åŠ¡
```

---

## 6ï¸âƒ£ ç´¢å¼•æ€§èƒ½åˆ†æ

### **A. æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”**

| æŸ¥è¯¢ç±»å‹ | ä¼ ç»ŸB+Tree | LSM-Tree+ç´¢å¼• | æ€§èƒ½æå‡ |
|---------|-----------|--------------|---------|
| **MessageIDç²¾ç¡®æŸ¥è¯¢** | 10-20ms | 1-3ms | 5å€ |
| **é¢‘é“æœ€æ–°100æ¡** | 20-50ms | 2-5ms | 8å€ |
| **ç”¨æˆ·ä¼šè¯åˆ—è¡¨** | 30-100ms | 3-10ms | 8å€ |
| **æ—¶é—´èŒƒå›´æŸ¥è¯¢** | 50-200ms | 10-30ms | 6å€ |

---

### **B. ç´¢å¼•å¼€é”€**

**å­˜å‚¨å¼€é”€**ï¼š
```
å‡è®¾ï¼š1äº¿æ¡æ¶ˆæ¯

ä¸»æ•°æ®ï¼š
- æ¯æ¡æ¶ˆæ¯ï¼š1KB
- æ€»è®¡ï¼š100GB

ç´¢å¼•ï¼š
- MessageIDç´¢å¼•ï¼š13 bytes Ã— 1äº¿ = 1.3GB
- ClientMsgNoç´¢å¼•ï¼š21 bytes Ã— 1äº¿ = 2.1GB
- Timestampç´¢å¼•ï¼š21 bytes Ã— 1äº¿ = 2.1GB
- æ€»è®¡ï¼š5.5GBï¼ˆä¸»æ•°æ®çš„5.5%ï¼‰

ç»“è®ºï¼š
- ç´¢å¼•å¼€é”€å°ï¼ˆ<6%ï¼‰
- æŸ¥è¯¢æ€§èƒ½æå‡å·¨å¤§ï¼ˆ5-10å€ï¼‰
- æ€§ä»·æ¯”é«˜ âœ…
```

---

### **C. å†™å…¥æ€§èƒ½**

**ç´¢å¼•å†™å…¥å¼€é”€**ï¼š
```
å†™å…¥1æ¡æ¶ˆæ¯ï¼š
â”œâ”€ ä¸»æ•°æ®å†™å…¥ï¼š1æ¬¡
â”œâ”€ MessageIDç´¢å¼•ï¼š1æ¬¡
â”œâ”€ ClientMsgNoç´¢å¼•ï¼š1æ¬¡
â”œâ”€ Timestampç´¢å¼•ï¼š1æ¬¡
â””â”€ æ€»è®¡ï¼š4æ¬¡å†™å…¥

æ‰¹é‡å†™å…¥ä¼˜åŒ–ï¼ˆBatchDBï¼‰ï¼š
- èšåˆ100æ¡æ¶ˆæ¯
- 1æ¬¡Commitï¼ˆ4 Ã— 100 = 400æ¬¡å†™å…¥ï¼‰
- fsyncå¼€é”€ï¼šå¹³æ‘Šåˆ°100æ¡æ¶ˆæ¯
- å†™å…¥å»¶è¿Ÿï¼š<10ms

å†™å…¥æ”¾å¤§ï¼š
- LSM-Treeï¼š2-3å€
- ç´¢å¼•ï¼š1.5å€
- æ€»è®¡ï¼š3-4.5å€
- ä»ä¼˜äºB+Treeï¼ˆ5-10å€ï¼‰
```

---

## 7ï¸âƒ£ æ€»ç»“

### **æ ¸å¿ƒè¦ç‚¹**

1. **ç´¢å¼•ä½“ç³»**ï¼š
   - ä¸»é”®ç´¢å¼•ï¼šç›´æ¥å®šä½æ•°æ®
   - å”¯ä¸€ç´¢å¼•ï¼šMessageID â†’ PrimaryKey
   - äºŒçº§ç´¢å¼•ï¼šClientMsgNoã€Timestamp
   - ç»„åˆç´¢å¼•ï¼šæ”¯æŒå¤æ‚æŸ¥è¯¢

2. **Keyè®¾è®¡åŸåˆ™**ï¼š
   - å‰ç¼€ä¸€è‡´ï¼Œæ”¯æŒèŒƒå›´æŸ¥è¯¢
   - å›ºå®šé•¿åº¦ï¼ŒæŸ¥è¯¢é«˜æ•ˆ
   - å“ˆå¸Œä¼˜åŒ–ï¼Œå‡å°‘Keyé•¿åº¦
   - LSM-Treeå‹å¥½ï¼Œæœ‰åºå­˜å‚¨

3. **æ¶ˆæ¯IDç´¢å¼•**ï¼š
   - MessageID â†’ PrimaryKeyï¼ˆO(1)æŸ¥è¯¢ï¼‰
   - æ”¯æŒå…¨å±€å”¯ä¸€æŸ¥è¯¢
   - Bloom FilteråŠ é€Ÿï¼ˆå‡å°‘90%æ— æ•ˆI/Oï¼‰

4. **é¢‘é“æ¶ˆæ¯ç´¢å¼•**ï¼š
   - ChannelHash + MessageSeqï¼ˆèŒƒå›´æŸ¥è¯¢ï¼‰
   - æŸ¥è¯¢æœ€æ–°Næ¡ï¼šO(log n + N)
   - å€’åºå­˜å‚¨ï¼ŒæŸ¥è¯¢æœ€æ–°æ¶ˆæ¯å¿«

5. **ä¼šè¯ç´¢å¼•**ï¼š
   - UidHash + Timestamp + ChannelHash
   - æŒ‰æ—¶é—´å€’åºæ’åˆ—
   - æ™ºèƒ½ç¼“å­˜æ›´æ–°ï¼Œå‡å°‘DBæŸ¥è¯¢

6. **æ—¶é—´åºåˆ—ä¼˜åŒ–**ï¼š
   - å€’åºå­˜å‚¨ï¼ˆæœ€æ–°æ•°æ®Keyæœ€å°ï¼‰
   - åˆ†åŒºå‹ç¼©ï¼ˆå†·çƒ­æ•°æ®åˆ†ç¦»ï¼‰
   - TTLè¿‡æœŸåˆ é™¤ï¼ˆè‡ªåŠ¨æ¸…ç†ï¼‰

7. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - æŸ¥è¯¢æ€§èƒ½ï¼š5-10å€æå‡
   - ç´¢å¼•å¼€é”€ï¼š<6%
   - å†™å…¥æ”¾å¤§ï¼š3-4.5å€ï¼ˆä¼˜äºB+Treeï¼‰

---

### **æœ€ä½³å®è·µ**

**1. ç´¢å¼•é€‰æ‹©**ï¼š
```
âœ… é¢‘ç¹ç²¾ç¡®æŸ¥è¯¢ â†’ å”¯ä¸€ç´¢å¼•ï¼ˆMessageIDï¼‰
âœ… èŒƒå›´æŸ¥è¯¢ â†’ äºŒçº§ç´¢å¼•ï¼ˆTimestampï¼‰
âœ… å»é‡æŸ¥è¯¢ â†’ äºŒçº§ç´¢å¼•ï¼ˆClientMsgNoï¼‰
âœ… å¤æ‚æŸ¥è¯¢ â†’ ç»„åˆç´¢å¼•ï¼ˆUidHash + Timestampï¼‰
```

**2. æ€§èƒ½ä¼˜åŒ–**ï¼š
```
âœ… æ‰¹é‡å†™å…¥ï¼ˆBatchDBï¼‰
âœ… ç¼“å­˜çƒ­æ•°æ®ï¼ˆ80%å‘½ä¸­ç‡ï¼‰
âœ… Bloom Filterè¿‡æ»¤
âœ… åˆ†åŒºå‹ç¼©ï¼ˆå†·çƒ­åˆ†ç¦»ï¼‰
```

**3. å­˜å‚¨ä¼˜åŒ–**ï¼š
```
âœ… æ§åˆ¶ç´¢å¼•æ•°é‡ï¼ˆ<5ä¸ªï¼‰
âœ… ä½¿ç”¨Hashå‡å°‘Keyé•¿åº¦
âœ… è¿‡æœŸæ•°æ®è‡ªåŠ¨æ¸…ç†
âœ… å‹ç¼©å†·æ•°æ®ï¼ˆ2-3å€å‹ç¼©æ¯”ï¼‰
```

---

> **ğŸ”— ç›¸å…³ä»£ç **ï¼š
> - Keyè®¾è®¡ï¼š`pkg/wkdb/key/table.go:1-100`
> - æ¶ˆæ¯ç´¢å¼•ï¼š`pkg/wkdb/key/table.go:23-102`
> - ä¼šè¯ç´¢å¼•ï¼š`pkg/wkdb/conversation.go`
> - ç´¢å¼•æ“ä½œï¼š`pkg/wkdb/channel_cluster_config.go:521-568`
