# 2.1 - Go embed ç‰¹æ€§è¯¦è§£ï¼šå¦‚ä½•å°†å‰ç«¯èµ„æºåµŒå…¥äºŒè¿›åˆ¶æ–‡ä»¶

> **é—®é¢˜**ï¼šä¸ºä»€ä¹ˆå£°æ˜äº† `var webFS embed.FS` å’Œ `var demoFS embed.FS` è¿™ä¸¤ä¸ªå˜é‡ï¼Œå°±å¯ä»¥å°†é™æ€èµ„æºæ‰“åŒ…å‘¢ï¼Ÿ

---

## ğŸ¯ é—®é¢˜èƒŒæ™¯

åœ¨ WuKongIM çš„ `main.go` ä¸­ï¼Œæœ‰è¿™æ ·çš„ä»£ç ï¼š

```go
//go:embed web/dist
var webFS embed.FS

//go:embed demo
var demoFS embed.FS
```

ä»…ä»…é€šè¿‡è¿™ä¸¤è¡Œä»£ç ï¼Œç¼–è¯‘å‡ºçš„äºŒè¿›åˆ¶æ–‡ä»¶å°±åŒ…å«äº†å®Œæ•´çš„å‰ç«¯èµ„æºï¼ˆç®¡ç†åå°å’ŒèŠå¤© Demoï¼‰ã€‚è¿™çœ‹èµ·æ¥å¾ˆ"é­”æ³•"ï¼Œå®é™…ä¸Šæ˜¯ Go 1.16+ å¼•å…¥çš„ **embed ç‰¹æ€§**ã€‚

---

## ğŸ“š Go embed ç‰¹æ€§è¯¦è§£

### 1ï¸âƒ£ ä»€ä¹ˆæ˜¯ embedï¼Ÿ

`embed` æ˜¯ Go æ ‡å‡†åº“æä¾›çš„ä¸€ä¸ªåŒ…ï¼Œå…è®¸åœ¨**ç¼–è¯‘æ—¶**å°†æ–‡ä»¶æˆ–ç›®å½•åµŒå…¥åˆ° Go äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **ç¼–è¯‘æ—¶åµŒå…¥**ï¼šä¸æ˜¯è¿è¡Œæ—¶è¯»å–ï¼Œè€Œæ˜¯åœ¨ç¼–è¯‘é˜¶æ®µå°±å°†æ–‡ä»¶å†…å®¹å†™å…¥äºŒè¿›åˆ¶
- **è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ**ï¼šåµŒå…¥çš„å†…å®¹å¯ä»¥åƒæ™®é€šæ–‡ä»¶ç³»ç»Ÿä¸€æ ·è®¿é—®
- **é›¶ä¾èµ–éƒ¨ç½²**ï¼šæ— éœ€åœ¨éƒ¨ç½²æ—¶æºå¸¦é™æ€æ–‡ä»¶

---

### 2ï¸âƒ£ embed çš„å·¥ä½œåŸç†

#### **å®Œæ•´æµç¨‹å›¾**

```
å¼€å‘é˜¶æ®µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æºç ç›®å½•                                        â”‚
â”‚  â”œâ”€â”€ main.go                                    â”‚
â”‚  â”‚   //go:embed web/dist                       â”‚
â”‚  â”‚   var webFS embed.FS                        â”‚
â”‚  â”œâ”€â”€ web/dist/                                  â”‚
â”‚  â”‚   â”œâ”€â”€ index.html           (10 KB)          â”‚
â”‚  â”‚   â”œâ”€â”€ assets/                               â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ app.js           (500 KB)         â”‚
â”‚  â”‚   â”‚   â””â”€â”€ style.css        (50 KB)          â”‚
â”‚  â”‚   â””â”€â”€ ...                                    â”‚
â”‚  â””â”€â”€ demo/                                      â”‚
â”‚      â”œâ”€â”€ index.html                             â”‚
â”‚      â””â”€â”€ ...                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
            go build ç¼–è¯‘
                    â†“
        ç¼–è¯‘å™¨å¤„ç† //go:embed æŒ‡ä»¤
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¼–è¯‘æ—¶ï¼šGo ç¼–è¯‘å™¨çš„å¤„ç†                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. æ‰«ææºç ï¼Œå‘ç° //go:embed æŒ‡ä»¤        â”‚   â”‚
â”‚  â”‚ 2. è¯»å–æŒ‡å®šç›®å½•/æ–‡ä»¶çš„å†…å®¹                â”‚   â”‚
â”‚  â”‚ 3. å°†å†…å®¹è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„                  â”‚   â”‚
â”‚  â”‚ 4. ç”Ÿæˆ Go ä»£ç ï¼Œåˆå§‹åŒ– embed.FS        â”‚   â”‚
â”‚  â”‚ 5. å°†ç”Ÿæˆçš„ä»£ç ç¼–è¯‘è¿›äºŒè¿›åˆ¶               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
            ç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ./wukongim (äºŒè¿›åˆ¶æ–‡ä»¶ - 54 MB)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Go ä»£ç é€»è¾‘                             â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  åµŒå…¥çš„é™æ€èµ„æºæ•°æ®ï¼ˆä»¥å­—èŠ‚æ•°ç»„å½¢å¼ï¼‰     â”‚   â”‚
â”‚  â”‚  â”œâ”€ web/dist/index.html [bytes...]      â”‚   â”‚
â”‚  â”‚  â”œâ”€ web/dist/assets/app.js [bytes...]   â”‚   â”‚
â”‚  â”‚  â”œâ”€ web/dist/assets/style.css [bytes...] â”‚   â”‚
â”‚  â”‚  â”œâ”€ demo/index.html [bytes...]          â”‚   â”‚
â”‚  â”‚  â””â”€ ...                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
            è¿è¡Œæ—¶è®¿é—®
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿è¡Œæ—¶ï¼šé€šè¿‡ embed.FS æ¥å£è®¿é—®                  â”‚
â”‚  webFS.Open("web/dist/index.html")             â”‚
â”‚    â†’ è¿”å› io.ReadCloserï¼Œè¯»å–åµŒå…¥çš„å­—èŠ‚æ•°æ®      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3ï¸âƒ£ ç¼–è¯‘å™¨å¦‚ä½•å¤„ç† `//go:embed`

#### **ç¼–è¯‘æŒ‡ä»¤è§£æ**

`//go:embed` æ˜¯ä¸€ä¸ª**ç¼–è¯‘å™¨æŒ‡ä»¤**ï¼ˆCompiler Directiveï¼‰ï¼Œç±»ä¼¼äºï¼š
- `//go:generate`
- `//go:noinline`
- `//go:linkname`

**å…³é”®ç‰¹ç‚¹**ï¼š
- å¿…é¡»ç´§æŒ¨ç€å˜é‡å£°æ˜
- ä»¥ `//go:` å¼€å¤´ï¼ˆ**æ³¨æ„æ²¡æœ‰ç©ºæ ¼ï¼**ï¼‰
- ç¼–è¯‘å™¨åœ¨**è¯æ³•åˆ†æé˜¶æ®µ**å°±ä¼šè¯†åˆ«

**æ­£ç¡®å†™æ³• âœ…**ï¼š
```go
//go:embed web/dist
var webFS embed.FS
```

**é”™è¯¯å†™æ³• âŒ**ï¼š
```go
// go:embed web/dist  â† å¤šäº†ç©ºæ ¼
var webFS embed.FS

//go:embed web/dist   â† æœ‰ç©ºè¡Œ

var webFS embed.FS
```

---

#### **è¯¦ç»†çš„ç¼–è¯‘è¿‡ç¨‹**

è®©æˆ‘ä»¬è·Ÿè¸ª Go ç¼–è¯‘å™¨å¤„ç† `//go:embed` çš„å…·ä½“æ­¥éª¤ï¼š

**ç¬¬ 1 æ­¥ï¼šè¯æ³•æ‰«æï¼ˆLexerï¼‰**

```go
// æºç 
//go:embed web/dist
var webFS embed.FS
```

ç¼–è¯‘å™¨æ‰«æåˆ°ï¼š
1. æ³¨é‡Š `//go:embed web/dist`
2. å‘ç°ç‰¹æ®Šå‰ç¼€ `//go:`
3. è¯†åˆ«ä¸ºç¼–è¯‘æŒ‡ä»¤ï¼Œè€Œéæ™®é€šæ³¨é‡Š
4. è§£æå‡ºè·¯å¾„ `web/dist`

---

**ç¬¬ 2 æ­¥ï¼šè¯­æ³•åˆ†æï¼ˆParserï¼‰**

ç¼–è¯‘å™¨æ„å»º ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰ï¼š

```
VarDecl
â”œâ”€ Comment: "//go:embed web/dist"
â”œâ”€ Name: webFS
â”œâ”€ Type: embed.FS
â””â”€ Init: nil (æš‚æ—¶ä¸ºç©º)
```

---

**ç¬¬ 3 æ­¥ï¼šæ–‡ä»¶æ‰«æï¼ˆEmbed Processorï¼‰**

ç¼–è¯‘å™¨æ‰§è¡Œ embed ä¸“é—¨çš„å¤„ç†å™¨ï¼š

```go
// Go ç¼–è¯‘å™¨å†…éƒ¨é€»è¾‘ï¼ˆç®€åŒ–ç‰ˆï¼‰
func processEmbed(dir string, pattern string) ([]byte, error) {
    // 1. è§£æè·¯å¾„
    fullPath := filepath.Join(dir, pattern)

    // 2. è¯»å–ç›®å½•/æ–‡ä»¶
    files, err := readDirRecursive(fullPath)
    if err != nil {
        return nil, err
    }

    // 3. è¯»å–æ‰€æœ‰æ–‡ä»¶å†…å®¹
    var embedData []embedFile
    for _, file := range files {
        content, _ := ioutil.ReadFile(file.Path)
        embedData = append(embedData, embedFile{
            Name: file.Name,
            Data: content,
        })
    }

    // 4. åºåˆ—åŒ–ä¸ºäºŒè¿›åˆ¶æ ¼å¼
    return serialize(embedData), nil
}
```

**æ‰«æ `web/dist` ç›®å½•**ï¼š

```
æ‰«æåˆ°çš„æ–‡ä»¶ï¼š
â”œâ”€â”€ web/dist/index.html          (è¯»å–å†…å®¹ â†’ å­—èŠ‚æ•°ç»„)
â”œâ”€â”€ web/dist/favicon.ico         (è¯»å–å†…å®¹ â†’ å­—èŠ‚æ•°ç»„)
â”œâ”€â”€ web/dist/assets/
â”‚   â”œâ”€â”€ index.js                 (è¯»å–å†…å®¹ â†’ å­—èŠ‚æ•°ç»„)
â”‚   â”œâ”€â”€ index.css                (è¯»å–å†…å®¹ â†’ å­—èŠ‚æ•°ç»„)
â”‚   â””â”€â”€ logo.png                 (è¯»å–å†…å®¹ â†’ å­—èŠ‚æ•°ç»„)
â””â”€â”€ ...

æ€»å¤§å°ï¼šçº¦ 5 MB
```

---

**ç¬¬ 4 æ­¥ï¼šç”ŸæˆåµŒå…¥ä»£ç ï¼ˆCode Generationï¼‰**

ç¼–è¯‘å™¨ç”Ÿæˆç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼ˆå®é™…ç”Ÿæˆçš„æ˜¯å†…éƒ¨è¡¨ç¤ºï¼‰ï¼š

```go
// ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆï¼ˆä¼ªä»£ç ï¼‰
var webFS = embed.FS{
    files: []embed.file{
        {
            name: "web/dist/index.html",
            data: []byte{0x3c, 0x21, 0x44, 0x4f, ...}, // å®é™…å­—èŠ‚æ•°æ®
            size: 10240,
        },
        {
            name: "web/dist/assets/app.js",
            data: []byte{0x28, 0x66, 0x75, 0x6e, ...},
            size: 512000,
        },
        // ... æ›´å¤šæ–‡ä»¶
    },
}
```

**å…³é”®ç‚¹**ï¼š
- ç”Ÿæˆçš„ä»£ç ç›´æ¥åŒ…å«**æ‰€æœ‰æ–‡ä»¶çš„å­—èŠ‚æ•°æ®**
- æ–‡ä»¶è·¯å¾„ã€å¤§å°ç­‰å…ƒä¿¡æ¯ä¹Ÿè¢«ä¿å­˜
- è¿™äº›æ•°æ®ä¼šè¢«ç¼–è¯‘åˆ°æœ€ç»ˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­

---

**ç¬¬ 5 æ­¥ï¼šç¼–è¯‘åˆ°äºŒè¿›åˆ¶**

```
æºç  + ç”Ÿæˆçš„åµŒå…¥æ•°æ®
        â†“
    ç¼–è¯‘ä¸ºæœºå™¨ç 
        â†“
    é“¾æ¥å™¨å¤„ç†
        â†“
  ç”Ÿæˆæœ€ç»ˆäºŒè¿›åˆ¶æ–‡ä»¶

äºŒè¿›åˆ¶æ–‡ä»¶ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  .text (ä»£ç æ®µ)              â”‚  â† Go ä»£ç é€»è¾‘
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  .rodata (åªè¯»æ•°æ®æ®µ)        â”‚  â† åµŒå…¥çš„æ–‡ä»¶å†…å®¹ â­
â”‚  â”œâ”€ webFS çš„å­—èŠ‚æ•°æ®         â”‚
â”‚  â””â”€ demoFS çš„å­—èŠ‚æ•°æ®        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  .data (æ•°æ®æ®µ)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  .bss (æœªåˆå§‹åŒ–æ•°æ®æ®µ)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é‡ç‚¹**ï¼šåµŒå…¥çš„æ–‡ä»¶å†…å®¹è¢«æ”¾åœ¨ `.rodata`ï¼ˆåªè¯»æ•°æ®æ®µï¼‰ï¼Œè¿™æ„å‘³ç€ï¼š
- âœ… è¿è¡Œæ—¶ä¸å¯ä¿®æ”¹
- âœ… å¯ä»¥è¢«å¤šä¸ªè¿›ç¨‹å…±äº«ï¼ˆèŠ‚çœå†…å­˜ï¼‰
- âœ… åŠ è½½é€Ÿåº¦å¿«ï¼ˆç›´æ¥æ˜ å°„åˆ°å†…å­˜ï¼‰

---

## ğŸ”¬ æ·±å…¥ embed.FS çš„å†…éƒ¨å®ç°

### **embed.FS çš„ç»“æ„**

```go
// Go æ ‡å‡†åº“ï¼šembed/embed.go
type FS struct {
    files *[]file  // åµŒå…¥çš„æ–‡ä»¶åˆ—è¡¨
}

type file struct {
    name string    // æ–‡ä»¶è·¯å¾„
    data string    // æ–‡ä»¶å†…å®¹ï¼ˆä½œä¸ºå­—ç¬¦ä¸²å­˜å‚¨ï¼‰
    hash [16]byte  // å†…å®¹å“ˆå¸Œï¼ˆç”¨äºéªŒè¯ï¼‰
}
```

---

### **è¿è¡Œæ—¶è®¿é—®æµç¨‹**

å½“ä½ è°ƒç”¨ `webFS.Open("web/dist/index.html")` æ—¶ï¼š

```go
// 1. åœ¨åµŒå…¥çš„æ–‡ä»¶åˆ—è¡¨ä¸­æŸ¥æ‰¾
func (f FS) Open(name string) (fs.File, error) {
    // äºŒåˆ†æŸ¥æ‰¾æ–‡ä»¶ï¼ˆç¼–è¯‘æ—¶å·²æ’åºï¼‰
    file := binarySearchFile(f.files, name)
    if file == nil {
        return nil, fs.ErrNotExist
    }

    // 2. è¿”å›ä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶å¯¹è±¡
    return &openFile{
        f:    file,
        data: file.data,  // æŒ‡å‘åµŒå…¥çš„å­—èŠ‚æ•°æ®
        pos:  0,
    }, nil
}

// 3. è¯»å–æ—¶ç›´æ¥ä»å­—èŠ‚æ•°ç»„å¤åˆ¶
func (f *openFile) Read(b []byte) (int, error) {
    n := copy(b, f.data[f.pos:])
    f.pos += n
    return n, nil
}
```

**å…³é”®ç‚¹**ï¼š
- âŒ ä¸ä¼šæ‰“å¼€çœŸå®æ–‡ä»¶
- âœ… ç›´æ¥ä»å†…å­˜ä¸­çš„å­—èŠ‚æ•°ç»„è¯»å–
- âš¡ æ€§èƒ½æé«˜ï¼ˆæ— ç³»ç»Ÿè°ƒç”¨ï¼Œæ— ç£ç›˜ I/Oï¼‰

---

## ğŸ“ å®æˆ˜ç¤ºä¾‹ï¼šä¼ ç»Ÿæ–¹å¼ vs embed æ–¹å¼

### **ä¼ ç»Ÿæ–¹å¼ï¼ˆè¿è¡Œæ—¶è¯»å–æ–‡ä»¶ï¼‰**

```go
// ä¼ ç»Ÿæ–¹å¼
package main

import (
    "io/ioutil"
    "net/http"
)

func main() {
    http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
        // âŒ è¿è¡Œæ—¶è¯»å–æ–‡ä»¶ï¼ˆéœ€è¦æ–‡ä»¶å­˜åœ¨ï¼‰
        data, err := ioutil.ReadFile("web/dist/index.html")
        if err != nil {
            http.Error(w, err.Error(), 500)
            return
        }
        w.Write(data)
    })
    http.ListenAndServe(":8080", nil)
}

// éƒ¨ç½²æ—¶éœ€è¦ï¼š
// â”œâ”€â”€ myapp
// â””â”€â”€ web/
//     â””â”€â”€ dist/
//         â””â”€â”€ index.html  â† å¿…é¡»å­˜åœ¨ï¼
```

**ç¼ºç‚¹**ï¼š
- âŒ éƒ¨ç½²æ—¶éœ€è¦æºå¸¦é™æ€æ–‡ä»¶
- âŒ æ–‡ä»¶å¯èƒ½ä¸¢å¤±æˆ–è¢«ä¿®æ”¹
- âŒ è·¨å¹³å°éƒ¨ç½²éº»çƒ¦
- âŒ è¿è¡Œæ—¶ç£ç›˜ I/O å¼€é”€

---

### **embed æ–¹å¼ï¼ˆç¼–è¯‘æ—¶åµŒå…¥ï¼‰**

```go
// embed æ–¹å¼
package main

import (
    "embed"
    "net/http"
)

//go:embed web/dist
var webFS embed.FS

func main() {
    http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
        // âœ… ä»åµŒå…¥çš„æ•°æ®è¯»å–ï¼ˆæ— éœ€æ–‡ä»¶å­˜åœ¨ï¼‰
        data, err := webFS.ReadFile("web/dist/index.html")
        if err != nil {
            http.Error(w, err.Error(), 500)
            return
        }
        w.Write(data)
    })
    http.ListenAndServe(":8080", nil)
}

// éƒ¨ç½²æ—¶åªéœ€è¦ï¼š
// â””â”€â”€ myapp  â† å•ä¸€å¯æ‰§è¡Œæ–‡ä»¶ï¼
```

**ä¼˜ç‚¹**ï¼š
- âœ… å•ä¸€äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œéƒ¨ç½²ç®€å•
- âœ… ä¸ä¼šä¸¢å¤±é™æ€æ–‡ä»¶
- âœ… è·¨å¹³å°éƒ¨ç½²æ–¹ä¾¿
- âœ… æ— ç£ç›˜ I/Oï¼Œæ€§èƒ½æ›´å¥½

---

## ğŸ” WuKongIM ä¸­çš„å®é™…ä½¿ç”¨

### **1. åµŒå…¥å£°æ˜**ï¼ˆ`main.go:13-17`ï¼‰

```go
//go:embed web/dist
var webFS embed.FS

//go:embed demo
var demoFS embed.FS
```

---

### **2. ä¼ é€’ç»™ version åŒ…**ï¼ˆ`main.go:31-32`ï¼‰

```go
version.WebFs = webFS
version.DemoFs = demoFS
```

---

### **3. åœ¨ HTTP æœåŠ¡ä¸­ä½¿ç”¨**ï¼ˆ`internal/api/server_manager.go:53-61`ï¼‰

```go
// æå–åµŒå…¥çš„å­ç›®å½•
st, _ := fs.Sub(version.WebFs, "web/dist")

// é…ç½®é™æ€æ–‡ä»¶æœåŠ¡
m.r.GetGinRoute().NoRoute(func(c *gin.Context) {
    if strings.HasPrefix(c.Request.URL.Path, "/web") {
        c.FileFromFS("./", http.FS(st))
        return
    }
})

// æŒ‚è½½åˆ° /web è·¯å¾„
m.r.GetGinRoute().StaticFS("/web", http.FS(st))
```

**å·¥ä½œæµç¨‹**ï¼š

```
ç”¨æˆ·è®¿é—® http://localhost:5300/web
    â†“
Gin è·¯ç”±åŒ¹é…åˆ° /web
    â†“
StaticFS å¤„ç†å™¨
    â†“
ä» version.WebFs ä¸­æŸ¥æ‰¾æ–‡ä»¶
    â†“
webFS.Open("web/dist/index.html")
    â†“
è¿”å›åµŒå…¥çš„å­—èŠ‚æ•°æ®
    â†“
å‘é€ç»™å®¢æˆ·ç«¯
```

---

## ğŸ’¡ embed çš„é«˜çº§ç”¨æ³•

### **1. åµŒå…¥å•ä¸ªæ–‡ä»¶**

```go
//go:embed version.txt
var version string
```

---

### **2. åµŒå…¥å¤šä¸ªæ–‡ä»¶**

```go
//go:embed image1.png image2.png image3.png
var images embed.FS
```

---

### **3. ä½¿ç”¨é€šé…ç¬¦**

```go
//go:embed *.txt
var textFiles embed.FS

//go:embed static/**/*
var staticFiles embed.FS
```

---

### **4. åµŒå…¥åˆ°å­—èŠ‚æ•°ç»„**

```go
//go:embed logo.png
var logo []byte
```

---

### **5. æ’é™¤éšè—æ–‡ä»¶**

```go
// .gitignoreã€.DS_Store ç­‰éšè—æ–‡ä»¶ä¼šè¢«è‡ªåŠ¨æ’é™¤
//go:embed web/dist
var webFS embed.FS
```

å¦‚æœæƒ³åŒ…å«éšè—æ–‡ä»¶ï¼š

```go
//go:embed all:web/dist
var webFS embed.FS
```

---

## ğŸ¯ embed çš„é™åˆ¶ä¸æ³¨æ„äº‹é¡¹

### **1. åªèƒ½åµŒå…¥å½“å‰æ¨¡å—çš„æ–‡ä»¶**

```go
// âŒ é”™è¯¯ï¼šä¸èƒ½åµŒå…¥ Go æ¨¡å—å¤–çš„æ–‡ä»¶
//go:embed /etc/passwd
var config embed.FS

// âŒ é”™è¯¯ï¼šä¸èƒ½åµŒå…¥çˆ¶ç›®å½•
//go:embed ../config
var config embed.FS

// âœ… æ­£ç¡®ï¼šåµŒå…¥å½“å‰æ¨¡å—å†…çš„æ–‡ä»¶
//go:embed config
var config embed.FS
```

---

### **2. å¿…é¡»åœ¨åŒ…çº§åˆ«å£°æ˜**

```go
// âŒ é”™è¯¯ï¼šä¸èƒ½åœ¨å‡½æ•°å†…å£°æ˜
func main() {
    //go:embed files
    var fs embed.FS
}

// âœ… æ­£ç¡®ï¼šåœ¨åŒ…çº§åˆ«å£°æ˜
//go:embed files
var fs embed.FS

func main() {
    // ä½¿ç”¨ fs
}
```

---

### **3. å˜é‡å¿…é¡»æ˜¯ç‰¹å®šç±»å‹**

```go
// âœ… æ”¯æŒçš„ç±»å‹
//go:embed file.txt
var s string

//go:embed file.txt
var b []byte

//go:embed dir
var fs embed.FS

// âŒ ä¸æ”¯æŒçš„ç±»å‹
//go:embed file.txt
var x int  // ç¼–è¯‘é”™è¯¯
```

---

### **4. ä¼šå¢åŠ äºŒè¿›åˆ¶æ–‡ä»¶å¤§å°**

```bash
# æœªåµŒå…¥å‰
$ go build
$ ls -lh myapp
-rwxr-xr-x  1 user  staff   5.2M  myapp

# åµŒå…¥ 10MB é™æ€èµ„æºå
$ go build
$ ls -lh myapp
-rwxr-xr-x  1 user  staff   15.3M  myapp  â† å¢åŠ äº†çº¦ 10MB
```

**ä¼˜åŒ–å»ºè®®**ï¼š
- åªåµŒå…¥å¿…éœ€çš„æ–‡ä»¶
- å¯¹å¤§æ–‡ä»¶è¿›è¡Œå‹ç¼©
- è€ƒè™‘ä½¿ç”¨ CDN æ‰˜ç®¡å¤§å‹èµ„æº

---

## ğŸ”„ å¯¹æ¯”ï¼šembed vs å…¶ä»–æ–¹æ¡ˆ

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|
| **embed** | âœ… å®˜æ–¹æ”¯æŒ<br>âœ… ç¼–è¯‘æ—¶åµŒå…¥<br>âœ… é›¶ä¾èµ– | âŒ å¢åŠ äºŒè¿›åˆ¶å¤§å°<br>âŒ ä¿®æ”¹éœ€è¦é‡æ–°ç¼–è¯‘ |
| **ç¬¬ä¸‰æ–¹å·¥å…·**<br>(go-bindata) | âœ… åŠŸèƒ½ä¸°å¯Œ<br>âœ… è€é¡¹ç›®å…¼å®¹ | âŒ éœ€è¦é¢å¤–ä¾èµ–<br>âŒ ç”Ÿæˆçš„ä»£ç å†—é•¿ |
| **è¿è¡Œæ—¶è¯»å–** | âœ… äºŒè¿›åˆ¶å°<br>âœ… ä¿®æ”¹æ— éœ€é‡ç¼–è¯‘ | âŒ éœ€è¦æºå¸¦æ–‡ä»¶<br>âŒ å¯èƒ½ä¸¢å¤±<br>âŒ I/O å¼€é”€ |
| **CDN** | âœ… äºŒè¿›åˆ¶æœ€å°<br>âœ… åˆ†å‘å¿« | âŒ éœ€è¦ç½‘ç»œ<br>âŒ é¢å¤–æˆæœ¬ |

---

## ğŸ“š å®æˆ˜ç»ƒä¹ 

### **ç»ƒä¹  1ï¼šæŸ¥çœ‹åµŒå…¥çš„æ–‡ä»¶**

```go
package main

import (
    "embed"
    "fmt"
    "io/fs"
)

//go:embed web/dist
var webFS embed.FS

func main() {
    // éå†åµŒå…¥çš„æ–‡ä»¶
    fs.WalkDir(webFS, ".", func(path string, d fs.DirEntry, err error) error {
        if err != nil {
            return err
        }
        if !d.IsDir() {
            info, _ := d.Info()
            fmt.Printf("%s (%d bytes)\n", path, info.Size())
        }
        return nil
    })
}
```

---

### **ç»ƒä¹  2ï¼šéªŒè¯ WuKongIM çš„åµŒå…¥**

```bash
# ç¼–è¯‘ WuKongIM
go build

# æŸ¥çœ‹äºŒè¿›åˆ¶å¤§å°
ls -lh wukongim

# è¿è¡Œå¹¶è®¿é—®ç®¡ç†åå°
./wukongim
# æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:5300/web

# åˆ é™¤ web/dist ç›®å½•
rm -rf web/dist

# å†æ¬¡è®¿é—®ç®¡ç†åå°
# âœ… ä¾ç„¶å¯ä»¥è®¿é—®ï¼å› ä¸ºå·²ç»åµŒå…¥åˆ°äºŒè¿›åˆ¶ä¸­
```

---

### **ç»ƒä¹  3ï¼šæå–åµŒå…¥çš„æ–‡ä»¶**

```go
package main

import (
    "embed"
    "io"
    "os"
)

//go:embed config.yaml
var configFS embed.FS

func main() {
    // ä»åµŒå…¥çš„ FS ä¸­è¯»å–
    file, _ := configFS.Open("config.yaml")
    defer file.Close()

    // å†™å…¥åˆ°ç£ç›˜
    out, _ := os.Create("extracted_config.yaml")
    defer out.Close()

    io.Copy(out, file)
}
```

---

## ğŸ“ æ€»ç»“

### **æ ¸å¿ƒè¦ç‚¹**

1. âœ… `//go:embed` æ˜¯**ç¼–è¯‘å™¨æŒ‡ä»¤**ï¼Œç¼–è¯‘æ—¶å¤„ç†
2. âœ… æ–‡ä»¶å†…å®¹è¢«è½¬æ¢ä¸º**å­—èŠ‚æ•°ç»„**åµŒå…¥äºŒè¿›åˆ¶
3. âœ… åµŒå…¥çš„æ•°æ®å­˜å‚¨åœ¨ **.rodata æ®µ**ï¼ˆåªè¯»ï¼‰
4. âœ… è¿è¡Œæ—¶é€šè¿‡ `embed.FS` æ¥å£è®¿é—®ï¼ˆæ— ç£ç›˜ I/Oï¼‰
5. âœ… æ”¯æŒ**å•æ–‡ä»¶ã€ç›®å½•ã€é€šé…ç¬¦**
6. âœ… é€‚åˆé™æ€èµ„æºã€é…ç½®æ–‡ä»¶ã€æ¨¡æ¿ç­‰

### **ä½¿ç”¨åœºæ™¯**

- âœ… Web åº”ç”¨çš„é™æ€èµ„æºï¼ˆHTML/CSS/JSï¼‰
- âœ… é…ç½®æ–‡ä»¶æ¨¡æ¿
- âœ… SQL è¿ç§»è„šæœ¬
- âœ… è¯ä¹¦æ–‡ä»¶
- âœ… å°å‹æ•°æ®é›†

### **ä¸é€‚åˆçš„åœºæ™¯**

- âŒ å¤§å‹æ–‡ä»¶ï¼ˆ>50MBï¼‰
- âŒ éœ€è¦é¢‘ç¹æ›´æ–°çš„å†…å®¹
- âŒ ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶
- âŒ åŠ¨æ€ç”Ÿæˆçš„å†…å®¹

---

## ğŸ“– å‚è€ƒèµ„æ–™

- [Go å®˜æ–¹æ–‡æ¡£ï¼šembed](https://pkg.go.dev/embed)
- [Go 1.16 Release Notes](https://go.dev/doc/go1.16#embed)
- [Embedding Files in Go](https://blog.jetbrains.com/go/2021/06/09/how-to-use-go-embed-in-go-1-16/)

---

**æ›´æ–°æ—¶é—´**ï¼š2025-10-01
**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0
